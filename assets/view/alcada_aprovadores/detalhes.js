define([],function(){return function(a){"use strict";var r=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Detalhes Alçada",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_novo_aprovador=this.dialog.find(".btn_novo_aprovador"),this.div_cbo_aprovador=this.dialog.find(".div_cbo_aprovador"),this.cbo_aprovador=this.dialog.find(".cbo_aprovador"),this.btn_salvar_alteracoes=this.dialog.find(".btn_salvar_alteracoes"),this.edt_nome_alcada=this.dialog.find(".edt_nome_alcada"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.alcada_generica_id=null,this.arr_aprovadores=new Array,this.onsave=null,this.show=function(a){create_combobox(r.cbo_aprovador,r.listar_grupos_usuarios);var o=r.cbo_aprovador.parent();r.edt_aprovador=o.find(".edt_combobox"),r.edt_aprovador.keypress(function(a){if(13==a.keyCode){var o=r.cbo_aprovador.parent().find(".ncbo_scroll").find(".row_selected"),e=o.attr("dados-adicionais")?JSON.parse(o.attr("dados-adicionais")):null;r.adicionar_linha(e),r.cbo_aprovador.parent().find(".edt_combobox").val(""),o.removeClass("row_selected")}}),a>0&&WS.get("alcada_aprovadores/objeto/",{alcada_generica_id:a},function(a){null!==a&&(r.alcada_generica_id=a.alcada_generica_id,r.edt_nome_alcada.val(a.nome_alcada_generica),$(a.aprovadores).each(function(a,o){o.usuario_id>0?o.tipo_aprovador=TIPO_APROVADOR.USUARIO:o.grupo_usuarios_id>0&&(o.tipo_aprovador=TIPO_APROVADOR.GRUPO_USUARIOS),r.arr_aprovadores.push(o)}),r.render_aprovadores())})},this.render_aprovadores=function(a,o){var e=r.tab_listagem.find("tbody"),i=e.find("tr:first");r.tab_listagem.find("tr:gt(1)").remove(),$(r.arr_aprovadores).each(function(a,o){!function(a,o){var n=i.clone();n.removeAttr("template-row"),n.removeAttr("style");var t=$(n.find("[template-field='nivel']"));t.val(a.nivel);var d=$(n.find("[template-field='label_tipo']"));a.usuario_id?(d.addClass("label-info"),d.text("U"),d.attr("tipo","usuarios")):(d.addClass("label-warning"),d.text("GU"),d.attr("tipo","grupo_usuarios")),$(n.find("[template-field='aprovador']")).text(a.usuario_id?a.aprovador_usuario_nome:a.aprovador_grupo_nome);var s=$(n.find("[template-field='tipo_aprovacao']"));s.val(a.tipo_aprovacao),t.change(function(){r.arr_aprovadores[o].nivel=$(this).val(),r.arr_aprovadores.sort(function(a,r){var o=a.nivel,e=r.nivel;return parseInt(o)<parseInt(e)?-1:parseInt(o)>parseInt(e)?1:0}),r.render_aprovadores()}),s.change(function(){r.arr_aprovadores[o].tipo_aprovacao=$(this).val()}),$(n.find(".btn_remover_aprovador")).click(function(){alert_modal("Atenção","Deseja remover este registro? "+(a.usuario_id?a.aprovador_usuario_nome:a.aprovador_grupo_nome),"Remover",function(){$(r.arr_aprovadores).each(function(o,e){return a.tipo_aprovador==TIPO_APROVADOR.USUARIO&&e.usuario_id==a.usuario_id&&e.nivel==a.nivel?(n.remove(),r.arr_aprovadores.splice(o,1),r.render_aprovadores(),!1):a.tipo_aprovador==TIPO_APROVADOR.GRUPO_USUARIOS&&e.grupo_usuarios_id==a.grupo_usuarios_id&&e.nivel==a.nivel?(n.remove(),r.arr_aprovadores.splice(o,1),r.render_aprovadores(),!1):void 0})},!0,"Não",function(){})}),n.appendTo(e)}(o,a)})},this.adicionar_linha=function(a){null!==a&&("usuarios"==a.tipo?setTimeout(function(){var o={};o.usuario_id=a.id,o.aprovador_usuario_nome=a.nome,o.nivel=void 0===r.arr_aprovadores[r.arr_aprovadores.length-1]?"1":parseInt(r.arr_aprovadores[r.arr_aprovadores.length-1].nivel),o.tipo_aprovacao="2",o.tipo_aprovador=TIPO_APROVADOR.USUARIO,r.arr_aprovadores.push(o),r.render_aprovadores()},150):"grupo_usuarios"==a.tipo&&setTimeout(function(){var o={};o.grupo_usuarios_id=a.id,o.aprovador_grupo_nome=a.nome,o.nivel=void 0===r.arr_aprovadores[r.arr_aprovadores.length-1]?"1":parseInt(r.arr_aprovadores[r.arr_aprovadores.length-1].nivel),o.tipo_aprovacao="2",o.tipo_aprovador=TIPO_APROVADOR.GRUPO_USUARIOS,r.arr_aprovadores.push(o),r.render_aprovadores()},150))},this.listar_grupos_usuarios=function(a){var o=r.cbo_aprovador.parent().find(".edt_combobox"),e=new Object;e.nome=o.val(),e.modulo=MODULOS.DOCUMENTO,WS.get("usuario/listar_usuarios_grupos/",e,function(o){limpar_combobox(r.cbo_aprovador),$(o).each(function(a,o){var e=[];e.Nome=o.nome;var i=$('<span class="label lb_tipo" style="margin: 5px;"></span>');"usuarios"==o.tipo?(i.addClass("label-info"),i.text("U"),i.attr("tipo","usuarios")):"grupo_usuarios"==o.tipo&&(i.addClass("label-warning"),i.text("GU"),i.attr("tipo","grupo_usuarios")),i.tooltip(),add_option_combobox(r.cbo_aprovador,a,o.id>0?o.id:null,e,i,JSON.stringify(o))}),o.length>0&&a(!0),$(r.cbo_aprovador.parent()).find(".ul_row").click(function(){var a=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;r.adicionar_linha(a),setTimeout(function(){var a=r.cbo_aprovador.parent().find(".ncbo_scroll").find(".row_selected");r.cbo_aprovador.parent().find(".edt_combobox").val(""),a.removeClass("row_selected")})})})},this.close=function(){void 0!==r.onsave&&r.onsave&&r.onsave()},this.unload=function(){r.close(),View.unload(this.html_id)},r.btn_cancelar.click(function(){r.unload()}),r.btn_salvar_alteracoes.click(function(){for(var a,o=!1,e=!1,i=[],n=r.arr_aprovadores.length,t=0;t<n;t++){for(var d=t;d<n;d++)1==r.arr_aprovadores[d].tipo_aprovador?t!=d&&r.arr_aprovadores[t].usuario_id==r.arr_aprovadores[d].usuario_id&&r.arr_aprovadores[t].nivel==r.arr_aprovadores[d].nivel&&(o=!0,i.push(r.arr_aprovadores[t].aprovador_usuario_nome)):2==r.arr_aprovadores[d].tipo_aprovador&&t!=d&&r.arr_aprovadores[t].grupo_usuarios_id==r.arr_aprovadores[d].grupo_usuarios_id&&r.arr_aprovadores[t].nivel==r.arr_aprovadores[d].nivel&&(o=!0,i.push(r.arr_aprovadores[t].aprovador_grupo_nome));t>0&&parseInt(r.arr_aprovadores[t].nivel)-parseInt(r.arr_aprovadores[t-1].nivel)>1&&(e=!0)}return 1==o?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Os itens abaixo estão duplicados: <br /><br />"+i)),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):1==e?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por gentileza, verifique a ordem dos niveis")),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):0==r.arr_aprovadores.length?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por gentileza, informe ao menos um usuário para salvar uma alçada.")),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):1!=r.arr_aprovadores[0].nivel?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,'A alçada sempre deverá iniciar com o nivel "1" ')),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):void WS.post("alcada_aprovadores/salvar/",{alcada_generica_id:r.alcada_generica_id,nome_alcada_generica:r.edt_nome_alcada.val(),aprovadores:JSON.stringify(r.arr_aprovadores)},function(a){r.unload()},[r.btn_salvar_alteracoes])})}});