define([],function(){return function(a){"use strict";var o=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.popup=null,this.tipo=null,this.onclose=null,this.lbl_titulo_id=this.dialog.find(".lbl_titulo_id"),this.cbo_conexao=this.dialog.find(".cbo_conexao"),this.edt_nome=this.dialog.find(".edt_nome"),this.edt_query=this.dialog.find(".edt_query"),this.tab_listagem_parametro=this.dialog.find(".tab_listagem_parametro"),this.table_generic=this.dialog.find(".table_generic"),this.div_parametros=this.dialog.find(".div_parametros"),this.lbl_tab_resultado=this.dialog.find(".lbl_tab_resultado"),this.lbl_tab_geral=this.dialog.find(".lbl_tab_geral"),this.modal_selecionar=this.dialog.find(".modal_selecionar"),this.btn_fullscreen=this.dialog.find(".btn_fullscreen"),this.div_load=this.dialog.find(".div_load"),this.chk_paginacao=this.dialog.find(".chk_paginacao"),this.dx_listagem_parametros=this.dialog.find(".dx_listagem_parametros"),this.dx_grid_colunas=this.dialog.find(".dx_grid_colunas"),this.consulta_id=null,this.params=[],this.result=null,this.array_colunas=[],this.validar=!1,this.limite=0,this.editor=null,this.valor=!0,this.dataGrid=null,this.dataGridColunasConsulta=null,this.show=function(a,t){let e=[];switch(t){case FORMULARIO.NOVO:o.listar_conexoes(),o.permite_alterar(!0);break;case FORMULARIO.EDITAR:o.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:case FORMULARIO.EXCLUIR:o.permite_alterar(!1)}o.tipo=t,o.editor=monta_editor(o.edt_query,"text/x-sql",o.valor),o.editor.on("keyup",function(a,t){o.localiza_params(),o.validar=!1}),void 0!==a&&a&&(o.consulta_id=a,o.preencher()),t===FORMULARIO.NOVO||t===FORMULARIO.EDITAR?e.push({toolbar:"bottom",location:"center",widget:"dxButton",options:{text:"Salvar",hint:"Salvar",onClick:function(){if(!o.validar){var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Realize a validação do SQL!")),void alertaPopUp("Validação",a)}const t=o.dataGridColunasConsulta.getController("editing").getChanges();for(var e=o.dataGrid.getController("data").items(),n=[],i=0;i<e.length;i++){var l=e[i];l.data.posicao=l.rowIndex,n.push(l.data)}WS.post("consulta_integracao/salvar",{consulta_id:o.consulta_id,nome:o.edt_nome.val(),query:cripto(o.editor.getValue()),conexao_integracao_id:o.cbo_conexao.val(),parametros:JSON.stringify(n),save_params:!0,colunas:JSON.stringify(t),paginacao:o.chk_paginacao.prop("checked")},function(a){o.consulta_id=a.id,alert_saved(o.edt_nome.val()+" salvo com sucesso"),o.unload()},null)}}},{toolbar:"bottom",location:"center",widget:"dxButton",options:{text:"Validar e Salvar",hint:"Validar e Salvar",onClick:function(){for(var a=o.dataGrid.getController("data").items(),t=[],e=0;e<a.length;e++){var n=a[e];n.data.posicao=n.rowIndex,t.push(n.data)}const i=o.dataGridColunasConsulta.getController("editing").getChanges();WS.post("consulta_integracao/executar_consulta",{consulta_id:o.consulta_id,nome:o.edt_nome.val(),query:cripto(o.editor.getValue()),conexao_integracao_id:o.cbo_conexao.val(),parametros:JSON.stringify(t),save_params:!0,salvar:!0,colunas:JSON.stringify(i),paginacao:o.chk_paginacao.prop("checked")},function(a){o.result=a,alert_saved(o.edt_nome.val()+" salvo com sucesso"),o.unload()},null)}}},{toolbar:"bottom",location:"before",widget:"dxButton",options:{text:"Validar",hint:"Validar",onClick:function(){o.table_generic.find("tr").remove(),o.validar_query(0)}}}):t===FORMULARIO.EXCLUIR&&e.push({toolbar:"bottom",location:"center",widget:"dxButton",options:{text:"Excluir",hint:"Excluir",elementAttr:{class:"bg-danger"},onClick:function(){WS.post("consulta_integracao/excluir",{consulta_id:o.consulta_id},function(a){alert_saved(a.nome+" excluido com sucesso"),o.unload()})}}}),alertaPopUp({titulo:"Consulta de Integração",conteudo:(a,t)=>{o.popup=t,a.replaceWith(o.dialog)},botaoCancelarTexto:"Cancelar",botaoConfirmarTexto:null,arrBotoes:e}),set_focus(o.edt_nome)},this.listar_result=function(){o.organiza_array_colunas(),o.table_generic.find(".tr_head").remove();var a,t=$("<tr>");$(o.result.colunas).each(function(a,e){var n=$('<th class="tr_head text-center">');n.text(e.titulo.toUpperCase()),n.appendTo(t),t.appendTo(o.table_generic.find("thead"))});for(let a=0;a<o.result.registros.length&&a<500;a++){const t=o.result.registros[a];var e=$("<tr>");$(o.result.colunas).each(function(a,o){var n=$('<td class="text-center">');n.text(null!=t[o.nome]?t[o.nome]:""),n.appendTo(e)}),e.appendTo(o.table_generic.find("tbody"))}o.result.registros.length>500&&(e=$("<tr>"),(a=$('<td class="text-left warning small" colspan="'+o.result.colunas.length+'">')).html("Limite de exibição de 500 registros foi atingido. Existem "+(o.result.registros.length-500)+" registros que não estão sendo exibidos."),a.appendTo(e),e.appendTo(o.table_generic.find("tbody"))),e=$("<tr>"),(a=$('<td class="text-left info small" colspan="'+o.result.colunas.length+'">')).html("Esta consulta SQL retornou um total de "+o.result.registros.length+" registros."),a.appendTo(e),e.appendTo(o.table_generic.find("tbody")),o.div_load.addClass("hidden")},this.localiza_colunas=function(){var a=o.editor.getValue(),t=(a=a.replace(/\s/g,"")).toLowerCase().indexOf("from"),e=a.substring(6,t);e=e.split(",");for(var n=[],i=0;i<e.length;i++)if(null!=e[i]&&""!=e[i]){var l=e[i].toLowerCase().indexOf("as"),r=e[i];l>-1&&(r=e[i].substring(parseInt(l)+2,e[i].length));var s={coluna_id:null,nome:r,titulo:r,excluido:"N"};n.push(s)}$(n).each(function(a,t){$(o.array_colunas).each(function(o,e){t.nome==e.nome&&(t.coluna_id=e.coluna_id,t.titulo=e.titulo,n[a]=t)})}),o.render_colunas(n)},this.render_colunas=function(a){const t=()=>{o.organiza_array_colunas(),o.dataGridColunasConsulta=o.dx_grid_colunas.dxDataGrid({dataSource:o.array_colunas,keyExpr:"coluna_id",editing:{mode:"batch",allowUpdating:!0,useIcons:!1},columns:[{caption:"Nome",dataField:"nome",allowEditing:!1},{caption:"Título",dataField:"titulo"},{caption:"Tipo",dataField:"tipo",lookup:{dataSource:[{id:"1",nome:"Texto"},{id:"2",nome:"Data"},{id:"3",nome:"Data e Hora"},{id:"4",nome:"Número"}],valueExpr:"id",displayExpr:"nome"}}],onToolbarPreparing:a=>{for(var o=0;o<a.toolbarOptions.items.length;o++){var t=a.toolbarOptions.items[o];"saveButton"==t.name&&(t.options.visible=!1)}}}).dxDataGrid("instance")},e=o.dataGridColunasConsulta?o.dataGridColunasConsulta.getController("editing").getChanges():[];e.length?WS.post("/consulta_integracao/salvar_colunas_data_grid/",{colunas:JSON.stringify(e)},a=>{o.array_colunas=a,t()}):t()},this.localiza_params=function(){for(var a=o.editor.getValue().split(""),t=!1,e=null,n=[],i=0;i<a.length;i++)if(":"==a[i]||t)if(t=!0,"↵"==a[i]||""==a[i].trim()||void 0===a[i].length){t=!1;var l={parametro_id:null,parametro:null!=e?e:":sem_nome",nome:null!=e?e.replace(":",""):"sem nome",valor:null,excluido:"N"};n.push(l),e=null}else":"!=a[i]&&""!=a[i].trim()&&(null!=e?e+=a[i]:e=":"+a[i],i==a.length-1)&&(t=!1,l={parametro_id:null,parametro:e,nome:e.replace(":",""),valor:null,excluido:"N"},n.push(l),e=null);o.render_parametros(n)},this.render_parametros=function(a){null!=o.params&&null!=a?($(a).each(function(a,t){var e=!1;$(o.params).each(function(a,o){o.parametro==t.parametro&&(e=!0)}),e||o.params.push(t)}),$(o.params).each(function(t,e){var n=!1;$(a).each(function(a,o){e.parametro==o.parametro&&(n=!0,e.excluido="N")}),n||(e.excluido="S"),o.params[t]=e})):o.params=a,a.length>0?o.div_parametros.removeClass("hidden"):o.div_parametros.addClass("hidden");for(var t=[],e=0;e<o.params.length;e++){var n=o.params[e];"N"==n.excluido&&t.push(n)}o.dataGrid=dx_Listagem_Padrao({div_html:o.div_parametros,coluna_chave:"parametro_id",colunas:dx_Parametros_Consulta_Integracao_Colunas(),editing_mode:dx_Parametros_Consulta_Integracao_Colunas_Editing_Mode(),datasource:t,reordenar:!0,nome:o.title})},this.listar_conexoes=function(a){o.cbo_conexao.find("option").remove(),add_option(o.cbo_conexao,"","-- Selecione --"),WS.get("conexao_integracao/listar/",null,function(t){for(var e=0;e<t.length;e++){var n=t[e];n.banco_dados_tipo==CONEXAO_INTEGRACAO_BANCO_DADOS.PDO_DNS_STRING?add_option(o.cbo_conexao,n.conexao_id,n.banco_dados_nome+" / "+n.pdo_dns_string):add_option(o.cbo_conexao,n.conexao_id,n.banco_dados_nome+" / "+n.database_nome)}null!==a&&o.cbo_conexao.val(a).trigger("change"),o.cbo_conexao.selectpicker("refresh")})},this.close=function(){o.popup.hide(),void 0!==o.onclose&&o.onclose&&o.onclose()},this.unload=function(){o.close(),View.unload(this.html_id)},this.permite_alterar=function(a){o.valor=!a,o.edt_query.prop("readonly",!a),o.edt_nome.prop("readonly",!a),o.cbo_conexao.prop("disabled",!a)},this.organiza_array_colunas=function(){var a,t,e,n,i=o.editor.getValue().replace(/(\r\n|\n|\r)/gm," ").toLowerCase().match(new RegExp("select(.*)from"));$.each(i[1].trim().split(","),function(a,t){$.each(o.array_colunas,function(o,e){e.nome==t.trim()&&(e.ordem=a)})}),o.array_colunas.sort((a="ordem",t=!1,e=parseInt,n=e?function(o){return e(o[a])}:function(o){return o[a]},t=t?-1:1,function(a,o){return a=n(a),o=n(o),t*((a>o)-(o>a))}))},this.preencher=function(){WS.get("consulta_integracao/objeto/",{consulta_id:o.consulta_id},function(a){setTimeout(()=>{o.lbl_titulo_id.text("Id."+a.id),o.edt_nome.val(a.nome),o.editor.getDoc().setValue(a.query),o.listar_conexoes(a.conexao_integracao_id),o.array_colunas=a.colunas,o.render_colunas(),o.params=a.parametros?object_to_array(a.parametros):[],o.localiza_params(),o.chk_paginacao.bootstrapSwitch("state","N"!=a.paginacao)},500)},null)},this.validar_query=function(a){for(var t=o.dataGrid.getController("data").items(),e=[],n=0;n<t.length;n++){var i=t[n];i.data.posicao=i.rowIndex,e.push(i.data)}WS.post("consulta_integracao/executar_consulta",{consulta_id:o.consulta_id,nome:o.edt_nome.val(),query:cripto(o.editor.getValue()),conexao_integracao_id:o.cbo_conexao.val(),parametros:JSON.stringify(e),salvar:!1,colunas:JSON.stringify(o.array_colunas),limite:a,paginacao:o.chk_paginacao.prop("checked")},function(a){o.result=a,a&&(o.validar=!0,o.lbl_tab_resultado.removeClass("hidden"),o.dialog.find(".active").removeClass("active"),o.lbl_tab_resultado.trigger("click"),$(a.colunas).each(function(t,e){$(o.array_colunas).each(function(o,n){n.nome==e.nome&&(a.colunas[t]=n)})}),o.array_colunas=a.colunas,o.listar_result(),o.render_colunas(),o.params=a.parametros?object_to_array(a.parametros):[],o.localiza_params())},null)},this.modal_selecionar.unbind("scroll"),this.modal_selecionar.scroll(function(){!o.lbl_tab_geral.hasClass("active")&&o.chk_paginacao.prop("checked")&&o.validar&&o.modal_selecionar.scrollTop()+o.modal_selecionar.height()==o.modal_selecionar.get(0).scrollHeight&&(o.div_load.removeClass("hidden"),o.limite=o.limite+50,o.validar_query(o.limite))}),this.btn_fullscreen.off("click").on("click",()=>{alert_warning('Para sair do modo "Tela Cheia" pressione a tecla "ESC"'),o.edt_query.closest(".modal").children().toggleClass("modal-dialog"),o.editor.setOption("fullScreen",!o.editor.getOption("fullScreen")),o.editor.focus()})}});