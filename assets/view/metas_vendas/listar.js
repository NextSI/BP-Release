define([],function(){return function(i){"use strict";var t=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Metas",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_novo=this.dialog.find(".btn_novo"),this.btn_listar=this.dialog.find(".btn_listar"),this.btn_limpar_filtros=this.dialog.find(".btn_limpar_filtros"),this.filtro_descricao=this.tab_listagem.find(".ipt_filtro_descricao"),this.filtro_data_ini=this.tab_listagem.find(".ipt_filtro_data_ini"),this.filtro_data_fim=this.tab_listagem.find(".ipt_filtro_data_fim"),this.filtro_valor=this.tab_listagem.find(".ipt_filtro_valor"),this.filtro_tipo=this.tab_listagem.find(".cbo_filtro_tipo"),this.div_carregar_mais=this.dialog.find(".div_carregar_mais"),this.btn_carregar_mais=this.dialog.find(".btn_carregar_mais"),this.filtros_usuario={filtro_descricao:null,filtro_data_ini:null,filtro_data_fim:null,filtro_valor:null,filtro_tipo:null},this.limite=0,this.limite_a_cada=50,this.todos_carregados=null,this.show=function(){t.filtro_tipo.selectpicker(),t.filtro_tipo.selectpicker({countSelectedText:function(i,t){return(i==t?"Todos":i)+" tipos selecionados"}}),t.filtro_tipo.selectpicker("refresh"),t.filtro_valor.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),WS.get("parametro_usuario/get/",{nome:"metas_crm"},function(i){i&&(i.filtro_descricao&&(t.filtros_usuario,t.filtro_descricao.val(i.filtro_descricao)),i.filtro_data_ini&&t.filtro_data_ini.val(i.filtro_data_ini),i.filtro_data_fim&&t.filtro_data_fim.val(i.filtro_data_fim),i.filtro_valor&&t.filtro_valor.val(i.filtro_valor),i.filtro_tipo&&(t.filtro_tipo.val(i.filtro_tipo.split(",")),t.filtro_tipo.selectpicker("refresh"))),t.listar(!0)})},this.listar=function(i){void 0===i&&(i=!0);var a=t.tab_listagem.find("tbody"),r=a.find("tr:first");i&&(t.limite=0,t.todos_carregados=!1),t.filtros_usuario.filtro_descricao=t.filtro_descricao.val(),t.filtros_usuario.filtro_data_ini=t.filtro_data_ini.val(),t.filtros_usuario.filtro_data_fim=t.filtro_data_fim.val(),t.filtros_usuario.filtro_valor=t.filtro_valor.val(),t.filtros_usuario.filtro_tipo=""==t.filtro_tipo.val()?null:t.filtro_tipo.val().toString(),WS.get("metas_vendas/listar/",{filtros_usuario:JSON.stringify(t.filtros_usuario),limite:t.limite,limite_a_cada:t.limite_a_cada},function(l){t.div_carregar_mais.removeClass("hidden"),t.btn_carregar_mais.find("span.icn_carregar_mais").remove(),l.length<t.limite_a_cada?(t.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.todos_carregados),t.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-check"></span>'),t.todos_carregados=!0):(t.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.carregar_mais_registros),t.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-arrow-down"></span>'),t.todos_carregados=!1),i&&t.tab_listagem.find("tbody > tr:not([template-row])").remove(),$(l).each(function(i,l){!function(i){var l=r.clone();l.removeAttr("template-row"),l.css("display",""),$(l.find("[template-field='descricao']")).text(i.descricao),$(l.find("[template-field='inicio']")).text(i.inicio?i.inicio.format_date():""),$(l.find("[template-field='fim']")).text(i.fim?i.fim.format_date():""),$(l.find("[template-field='valor']")).text(i.valor.format_number(2,!0));var s=$(l.find("[template-field='tipo']"));s.removeClass("label-warning"),s.removeClass("label-info"),"R"==i.tipo?(s.addClass("label-warning"),s.text("Representante")):"F"==i.tipo?(s.addClass("label-info"),s.text("Funil de Vendas")):(s.addClass("label-success"),s.text("Evento"));var o=$(l.find(".btn_visualizar"));o.unbind("click"),o.click(function(){View.load("metas_vendas/detalhes",function(a,r){r.onclose=t.listar,r.show(i.metas_vendas_id,FORMULARIO.VISUALIZAR)},View.ABA.SIM)});var e=$(l.find(".btn_editar")),n=function(){View.load("metas_vendas/detalhes",function(a,r){r.onclose=t.listar,r.show(i.metas_vendas_id,FORMULARIO.EDITAR)},View.ABA.SIM)};e.unbind("click"),e.click(n),l.dblclick(n);var _=$(l.find(".btn_excluir"));_.unbind("click"),_.click(function(){View.load("metas_vendas/detalhes",function(a,r){r.onclose=t.listar,r.show(i.metas_vendas_id,FORMULARIO.EXCLUIR)},View.ABA.SIM)}),l.appendTo(a)}(l)})})},this.btn_novo.unbind("click"),this.btn_novo.click(function(){View.load("metas_vendas/detalhes",function(i,a){a.onclose=t.listar,a.show(null,FORMULARIO.NOVO)},View.ABA.SIM)}),this.btn_listar.unbind("click"),this.btn_listar.click(function(){t.listar(!0)}),this.btn_limpar_filtros.unbind("click"),this.btn_limpar_filtros.click(function(){t.filtro_descricao.val(null),t.filtro_data_ini.val(null),t.filtro_data_fim.val(null),t.filtro_valor.val(null),t.filtro_tipo.val(null).selectpicker("refresh"),t.listar(!0)}),this.filtro_descricao.changeOrDelayedKey(function(i){t.listar(!0)},1e3,"keyup"),this.filtro_data_ini.unbind("change").change(function(){t.listar(!0)}),this.filtro_data_fim.unbind("change").change(function(){t.listar(!0)}),this.filtro_valor.changeOrDelayedKey(function(i){t.listar(!0)},1e3,"keyup"),this.filtro_tipo.unbind("change").change(function(){t.listar(!0)}),this.btn_carregar_mais.unbind("click").click(function(){if(t.todos_carregados)return!1;t.limite+=t.limite_a_cada,t.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.aguarde),$(this).find("span.icn_carregar_mais").remove(),$(this).append('<span class="icn_carregar_mais fa fa-spinner fa-spin"></span>'),t.listar(!1)}),this.unload=function(){View.unload(this.html_id)}}});