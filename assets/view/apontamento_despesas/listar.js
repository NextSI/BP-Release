define([],function(){return function(t){"use strict";var e=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.title="Apontamento de Despesas",this.btn_nova_despesa=this.dialog.find(".btn_nova_despesa"),this.tab_listagem=this.dialog.find(".tab_listagem"),this.list_minhas_pendencias=this.dialog.find(".list_minhas_pendencias"),this.list_supervisionados=this.dialog.find(".list_supervisionados"),this.list_todas=this.dialog.find(".list_todas"),this.cbo_filtro_cliente=this.dialog.find(".cbo_filtro_cliente"),this.cbo_filtro_tecnico=this.dialog.find(".cbo_filtro_tecnico"),this.div_tecnico=this.dialog.find(".div_tecnico"),this.edt_day_start=this.dialog.find(".edt_day_start"),this.edt_day_end=this.dialog.find(".edt_day_end"),this.btn_search=this.dialog.find(".btn_search"),this.btn_limpa_filtro=this.dialog.find(".btn_limpa_filtro"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.btn_gerar_relatorio=this.dialog.find(".btn_gerar_relatorio"),this.btn_config=this.dialog.find(".btn_config"),this.scrollview=this.dialog.find(".scrollview"),this.floating=this.dialog.find(".floating-menu"),this.collapse_accordion=this.dialog.find("#accordion"),this.construct=function(){},this.show=function(){if(e.collapse_accordion.attr("id","accordion"+e.html_id),e.collapse_accordion.find('[href="#list-despesas"]').attr("href","#list-despesas"+e.html_id).attr("data-parent","#accordion"+e.html_id).attr("aria-controls","list-despesas"+e.html_id),e.collapse_accordion.find("#list-despesas").attr("id","list-despesas"+e.html_id).attr("aria-labelledby","list-despesas"+e.html_id),e.div_tecnico.hide(),2!=App.temp.situacao_apontamento_despesa&&3!=App.temp.situacao_apontamento_despesa||(e.div_tecnico.show(),e.btn_gerar_relatorio.hide()),"S"==App.sessao.dados.supervisor_projeto&&e.list_supervisionados.removeClass("hidden"),(1==App.sessao.dados.admin||"S"==App.sessao.dados.tecnico&&"S"==App.sessao.dados.tecnico_visualizar_despesas&&App.sessao.dados.tipo==USUARIO_TIPO.COLABORADOR)&&e.list_todas.removeClass("hidden"),(!0===App.sessao.dados.admin||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"admin_apontamento_despesa")||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"config_modulo_projetos"))&&e.btn_config.removeClass("hidden"),set_datepicker(e.edt_day_start),set_datepicker(e.edt_day_end),create_combobox(e.cbo_filtro_cliente,e.listar_clientes),e.criar_events_cliente(e.cbo_filtro_cliente),!App.temp.dt_fim_apontamento_despesa){var t=new Date,a=t.getFullYear(),i=("0"+(t.getMonth()+1)).slice(-2),o=new Date(a,i,1),s=new Date(a,i,0),n=a+"-"+i+"-"+("0"+o.getDate()).slice(-2),d=a+"-"+i+"-"+("0"+s.getDate()).slice(-2);App.temp.dt_ini_apontamento_despesa=n,App.temp.dt_fim_apontamento_despesa=d}setTimeout(function(){set_datepicker(e.edt_day_start,App.temp.dt_ini_apontamento_despesa),set_datepicker(e.edt_day_end,App.temp.dt_fim_apontamento_despesa),App.temp.situacao_apontamento_despesa=App.temp.situacao_apontamento_despesa>0?App.temp.situacao_apontamento_despesa:1,e.listar_tecnicos(App.temp.tecnico_id_apontamento_despesa>0?App.temp.tecnico_id_apontamento_despesa:null,App.temp.tecnico_id_apontamento_despesa>0?App.temp.tecnico_id_apontamento_despesa:null),e.listar()},150)},this.unload=function(){View.unload(this.html_id)},this.listar=function(){e.add_active();var t=e.tab_listagem.find("tbody"),a=t.find("tr:first"),i={dt_ini:App.temp.dt_ini_apontamento_despesa,dt_fim:App.temp.dt_fim_apontamento_despesa,cliente_id:App.temp.cliente_id_apontamento_despesa,tecnico_id:App.temp.tecnico_id_apontamento_despesa,tipo_listagem:App.temp.situacao_apontamento_despesa};e.cbo_filtro_cliente.parent().find(".edt_combobox").val(App.temp.cliente_nome_apontamento_despesa),WS.get("apontamento_despesas/listar/",i,function(i){e.tab_listagem.find(".rows").remove();var o=0,s=0,n=0,d=0,_=0;$(i).each(function(i,p){o=parseFloat(o)+parseFloat(p.km_rodado),s=parseFloat(s)+parseFloat(p.pedagio),n=parseFloat(n)+parseFloat(p.refeicao),d=parseFloat(d)+parseFloat(p.outras_despesas),_=parseFloat(_)+parseFloat(p.km_valor),function(i){var o=a.clone();o.removeAttr("template-row"),o.css("display",""),o.addClass("rows"),$(o.find("[template-field='id']")).text(i.id),$(o.find("[template-field='dia']")).text(i.dia?i.dia.format_date_time():""),$(o.find("[template-field='dia_semana']")).text(i.dia_semana?dia_semana(parseInt(i.dia_semana,10)):""),$(o.find("[template-field='tecnico']")).text(i.tecnico_usuario_id+" - "+i.usuario_nome),$(o.find("[template-field='cliente']")).text(i.cliente_id+" - "+i.cliente_nome),$(o.find("[template-field='km_rodado']")).text(i.km_rodado.format_number(0,!0));var s=$(o.find("[template-field='km_valor']"));i.valor_km_tecnico=i.valor_km_tecnico.replace(".",","),s.text(i.valor_km_tecnico);var n=$(o.find("[template-field='valor']"));i.km_valor=i.km_valor.replace(".",","),n.text(i.km_valor);var d=$(o.find("[template-field='pedagio']"));i.pedagio=i.pedagio.replace(".",","),d.text(i.pedagio);var _=$(o.find("[template-field='refeicao']"));i.refeicao=i.refeicao.replace(".",","),_.text(i.refeicao);var p=$(o.find("[template-field='outras_despesas']"));i.outras_despesas=i.outras_despesas.replace(".",","),p.text(i.outras_despesas);var l=$(o.find(".btn_visualizar"));l.unbind("click"),l.click(function(){View.load("apontamento_despesas/detalhes",function(t,a){a.onclose=e.listar,a.show(FORMULARIO.VISUALIZAR,i.id)},View.ABA.MULTIPLAS)});var c=$(o.find(".btn_editar")),r=function(){View.load("apontamento_despesas/detalhes",function(t,a){a.onclose=e.listar,a.show(FORMULARIO.EDITAR,i.id)},View.ABA.MULTIPLAS)};c.unbind("click"),c.click(r),o.dblclick(r);var m=$(o.find(".btn_excluir"));m.unbind("click"),m.click(function(){View.load("apontamento_despesas/detalhes",function(t,a){a.onclose=e.listar,a.show(FORMULARIO.EXCLUIR,i.id)},View.ABA.MULTIPLAS)}),o.appendTo(t)}(p)});var p=parseFloat(_)+parseFloat(s)+parseFloat(n)+parseFloat(d);$(e.tab_listagem.find("[template-field='total_geral']")).text("Total Despesas: "+p.format_number(2,!0)),$(e.tab_listagem.find("[template-field='total_km_rodado']")).text(o.format_number(0,!0)),$(e.tab_listagem.find("[template-field='total_valor']")).text(_.format_number(2,!0)),$(e.tab_listagem.find("[template-field='total_pedagio']")).text(s.format_number(2,!0)),$(e.tab_listagem.find("[template-field='total_refeicao']")).text(n.format_number(2,!0)),$(e.tab_listagem.find("[template-field='total_outras_despesas']")).text(d.format_number(2,!0))})},this.add_active=function(){switch(e.dialog.find(".active").removeClass("active"),App.temp.situacao_apontamento_despesa){case 1:e.list_minhas_pendencias.addClass("active");break;case 2:e.list_supervisionados.addClass("active");break;case 3:e.list_todas.addClass("active");break;default:e.list_minhas_pendencias.addClass("active")}},this.listar_clientes=function(t,a){var i=a.parent(),o=i.find(".edt_combobox");WS.get("cliente/listar_clientes_projeto/",{texto_pesquisa:o.val()},function(o){limpar_combobox(a),$(o).each(function(t,e){var i=[];i.Nome=e.nome_fantasia,i["Razão"]=e.razao_social,i.CNPJ=e.cnpj,add_option_combobox(a,t,e.cliente_id>0?e.cliente_id:null,i)}),t(!0),i.find(".ul_row").click(function(){var t=$(this).parent().attr("id_registro");App.temp.dt_ini_apontamento_despesa=get_datepicker(e.edt_day_start),App.temp.dt_fim_apontamento_despesa=get_datepicker(e.edt_day_end),App.temp.cliente_id_apontamento_despesa=t,App.temp.cliente_nome_apontamento_despesa=$(this).find("li").text(),e.listar()})})},this.criar_events_cliente=function(t){var a=t.parent().find(".edt_combobox");a.keypress(function(i){13==i.keyCode?setTimeout(function(){var i=t.parent().find(".ncbo_scroll").find(".row_selected");if(App.temp.dt_ini_apontamento_despesa=get_datepicker(e.edt_day_start),App.temp.dt_fim_apontamento_despesa=get_datepicker(e.edt_day_end),""==a.val().trim())App.temp.cliente_id_apontamento_despesa=null,App.temp.cliente_nome_apontamento_despesa="";else{var o=i.attr("id_registro");o>0&&(App.temp.cliente_nome_apontamento_despesa=$(i).find("li").text(),App.temp.cliente_id_apontamento_despesa=o)}e.listar(),set_focus(a)},150):13==i.tecla_value&&(App.temp.dt_ini_apontamento_despesa=get_datepicker(e.edt_day_start),App.temp.dt_fim_apontamento_despesa=get_datepicker(e.edt_day_end),App.temp.cliente_id_apontamento_despesa=$(this).attr("selected-value"),e.listar())})},this.listar_tecnicos=function(t){e.cbo_filtro_tecnico.find("option").remove(),add_option(e.cbo_filtro_tecnico,"","Filtro Técnico"),WS.get("tecnico/listar/",null,function(a){for(var i=0;i<a.length;i++){var o=a[i];add_option(e.cbo_filtro_tecnico,o.usuario_id,o.nome)}t&&(e.cbo_filtro_tecnico.val(t).trigger("change"),e.usuario_id=t),e.cbo_filtro_tecnico.selectpicker("refresh")})},this.btn_nova_despesa.unbind("click"),this.btn_nova_despesa.click(function(){View.load("apontamento_despesas/detalhes",function(t,a){a.onclose=e.listar,a.show(FORMULARIO.NOVO,null)},View.ABA.MULTIPLAS)}),this.list_minhas_pendencias.unbind("click"),this.list_minhas_pendencias.click(function(){e.btn_gerar_relatorio.show(),e.div_tecnico.hide(),App.temp.situacao_apontamento_despesa=1,e.listar()}),this.list_supervisionados.unbind("click"),this.list_supervisionados.click(function(){e.btn_gerar_relatorio.hide(),e.div_tecnico.show(),App.temp.situacao_apontamento_despesa=2,e.listar()}),this.list_todas.unbind("click"),this.list_todas.click(function(){e.btn_gerar_relatorio.hide(),e.div_tecnico.show(),App.temp.situacao_apontamento_despesa=3,e.listar()}),this.btn_search.unbind("click"),this.btn_search.click(function(){App.temp.dt_ini_apontamento_despesa=get_datepicker(e.edt_day_start),App.temp.dt_fim_apontamento_despesa=get_datepicker(e.edt_day_end),e.listar()}),this.cbo_filtro_tecnico.unbind("change"),this.cbo_filtro_tecnico.change(function(){App.temp.dt_ini_apontamento_despesa=get_datepicker(e.edt_day_start),App.temp.dt_fim_apontamento_despesa=get_datepicker(e.edt_day_end),App.temp.tecnico_id_apontamento_despesa=e.cbo_filtro_tecnico.val(),e.listar()}),this.btn_limpa_filtro.unbind("click"),this.btn_limpa_filtro.click(function(){App.temp.cliente_id_apontamento_despesa=null,App.temp.cliente_nome_apontamento_despesa="",App.temp.tecnico_id_apontamento_despesa=null,e.cbo_filtro_cliente.parent().find(".edt_combobox").val(""),e.cbo_filtro_tecnico.val("").trigger("change")}),this.btn_refresh.unbind("click"),this.btn_refresh.click(function(){e.listar()}),this.btn_gerar_relatorio.unbind("click"),this.btn_gerar_relatorio.click(function(){var t=1;App.temp.empresa&&(t=App.temp.empresa),App.obter_token_publico(function(a){App.download(WS_URI+"apontamento_despesas/gerar_apontamento_despesas_pdf/?empresa_id="+t+"&token_publico="+a+"&cliente_id="+get_value_combobox(e.cbo_filtro_cliente)+"&dt_ini="+get_datepicker(e.edt_day_start)+"&dt_fim="+get_datepicker(e.edt_day_end)+"&tipo_listagem="+App.temp.situacao_apontamento_despesa)})}),$(document).scroll(function(){e.floating.css("top",$(this).scrollTop())}),this.btn_config.unbind("click"),this.btn_config.click(function(){View.load("apontamento_despesas/configuracoes",function(t,a){a.onclose=function(){e.listar()},a.show()})}),e.show()}});