define([],function(){return function(a){"use strict";var i=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title="Histórico Documentos - Certsign",this.onclose=null,this.onsave=null,this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.btn_solicitar_assinaturas=this.dialog.find(".btn_solicitar_assinaturas"),this.treelist_historico_documento_certsign=this.dialog.find(".treelist_historico_documento_certsign"),this.documento_revisao_id=null,this.usuario_permissao_escrita=null,this.grupo_usuario_permissao_escrita=null,this.show=function(a,t){i.documento_revisao_id=a,void 0!==t&&(i.usuario_permissao_escrita=t.usuario_permissao_escrita||"S",i.grupo_usuario_permissao_escrita=t.grupo_usuario_permissao_escrita||"S"),i.listar(),show_modal(i.modal.attr("id"))},this.listar=function(){WS.get("documento_revisao_assinatura/listar_eventos_por_revisao/",{documento_revisao_id:i.documento_revisao_id,plataforma:"certisign"},function(a){i.montaTreeList(a)})},this.montaTreeList=function(a){i.treelist_historico_documento_certsign.dxTreeList({dataSource:a,showBorders:!0,allowColumnResizing:!0,keyExpr:"id",parentIdExpr:"pai_id",editing:{useIcons:!0},rowAlternationEnabled:!1,onRowPrepared:function(a){"data"===a.rowType&&"R"===a.data.situacao&&a.rowElement.find("td").css("background","#ffcdd2")},columns:[{dataField:"solicitante_nome",caption:"Solicitante",width:140},{dataField:"data_envio",caption:"Data de Envio",width:140,dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{dataField:"situacao",caption:"Situação",width:140,alignment:"center",cellTemplate:function(a,i){var t="",o="";switch(i.data.situacao){case"A":o="Aguardando",t="label label-warning";break;case"F":o="Finalizado",t="label label-success";break;case"M":o="Aguardando Manifesto",t="label label-info";break;case"R":o="Rejeitada",t="label label-danger";break;case"C":o="Cancelado",t="label label-danger"}$("<span class='"+t+"'>"+o+"</span>").appendTo(a)}},{dataField:"nome_arquivo",caption:"Nome do Arquivo",width:140},{dataField:"nome_completo",caption:"Signatário",width:140},{dataField:"tipo_assinatura",caption:"Tipo assinatura",width:140,cellTemplate:function(a,i){var t="";switch(i.data.tipo_assinatura){case"signers":t="Digital";break;case"electronicSigners":t="Eletrônica";break;default:t=i.data.tipo_assinatura}$("<span>"+t+"</span>").appendTo(a)}},{dataField:"cpf",caption:"CPF",width:140},{dataField:"email",caption:"Email",width:140},{dataField:"event_occurred_at",caption:"Data Assinatura",width:140,dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{dataField:"mensagem",caption:"Mensagem",width:140},{type:"buttons",fixed:!0,buttons:[{hint:"Download",icon:"fa fa-download",visible:function(a){return 0===a.row.level&&"A"!==a.row.data.situacao&&parseInt(a.row.data.signed_document_tamanho,10)>0},onClick:function(a){var t=a.row.data.documento_revisao_assinatura_id;App.obter_token_publico(function(a){App.download(WS_URI+"documento/download/?documento_revisao_id="+i.documento_revisao_id+"&documento_revisao_assinatura_id="+t+"&token_publico="+a)})}},{hint:"Link para assinar",icon:"fa fa-link",visible:function(a){return a.row.level>0&&"A"===a.row.data.situacao},onClick:function(a){DevExpress.ui.dialog.alert('<a target="_blank" href="'+a.row.data.certsign_sign_url+'">'+a.row.data.certsign_sign_url+"</a>","Link para assinar")}},{hint:"Cancelar solicitação de assinaturas",icon:"fa fa-thumbs-down",cssClass:"icon_red",visible:function(a){return 0===a.row.level&&("S"===i.usuario_permissao_escrita||"S"===i.grupo_usuario_permissao_escrita)&&"A"===a.row.data.situacao},onClick:function(a){i.cancelar_documento_assinado(a.row.data.certsign_document_key)}}]}]})},this.cancelar_documento_assinado=function(a){alert_modal("Aviso","Deseja cancelar esta solicitação de assinatura?","Sim",function(){WS.get("certsign/cancelar_assinatura/",{certsign_document_key:a},function(a){alert_modal("Atenção","Solicitação de cancelamento enviado com sucesso! <br><br> A situação será atualizada automaticamente após o Certsing confirmar o cancelamento.","OK"),setTimeout(function(){try{i.listar()}catch(a){}})}),setTimeout(function(){try{i.listar()}catch(a){}})},!0,"Não")},this.close=function(){close_modal(i.modal.attr("id")),void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){i.close(),View.unload(this.html_id)},this.btn_refresh.unbind("click"),this.btn_refresh.click(function(){i.listar()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),this.btn_solicitar_assinaturas.unbind("click"),this.btn_solicitar_assinaturas.click(function(){View.load("certsign/configurar_signatarios",function(a,t){t.onclose=function(){setTimeout(function(){try{i.listar()}catch(a){}})},t.show(i.documento_revisao_id,!0)},View.ABA.SIM)})}});