define([],function(){return function(t){"use strict";var a=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.title="Sessões",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_destruir=this.dialog.find(".btn_destruir"),this.btn_listar=this.dialog.find(".btn_listar"),this.btn_selecionar=this.dialog.find(".btn_selecionar"),this.btn_deselecionar=this.dialog.find(".btn_deselecionar"),this.chk_manutencao=this.dialog.find(".chk_manutencao"),this.txt_singular=this.dialog.find(".txt_singular"),this.txt_plural=this.dialog.find(".txt_plural"),this.data_updt=this.dialog.find(".data_updt"),this.lbl_qtd=this.dialog.find(".lbl_qtd"),this.lbl_usuarios_com_sessoes_ativas=this.dialog.find(".lbl_usuarios_com_sessoes_ativas"),this.aux_manutencao=!1;var e=[],i=[],s=a.tab_listagem.find("tbody");this.listar=function(){var t=s.find("tr:first");a.tab_listagem.find(".new_row").remove(),a.lbl_qtd.text(""),a.lbl_usuarios_com_sessoes_ativas.text(""),e=[],a.btn_destruir_refresh(),a.data_updt_refresh(),WS.get("sessao/listar/",null,function(n){a.tab_listagem.find(".new_row").remove(),i=n.lista,a.chk_manutencao.prop("checked","S"==n.manutencao).change(),a.aux_manutencao=!0,a.lbl_qtd.text(i.length),a.lbl_usuarios_com_sessoes_ativas.text(n.usuarios_com_sessoes_ativas),$(i).each(function(i,n){!function(i){var n=t.clone();n.removeAttr("template-row"),n.css("display",""),n.addClass("new_row"),$(n.find("[template-field='nome']")).text(i.usuario_nome),$(n.find("[template-field='email']")).text(i.usuario_email),$(n.find("[template-field='inicio']")).text(i.inicio.format_date_time()),$(n.find("[template-field='ultimo_ping']")).text(i.ultimo_ping.format_date_time());var r=$(n.find("[template-field='ip']"));null!=i.dados&&r.text(i.dados.ip),n.appendTo(s),n.click(function(){if("true"!=n.attr("selecionado"))n.addClass("bg-primary"),n.find("td").addClass("bg-primary"),n.attr("selecionado",!0),e.push(i.token);else{n.removeClass("bg-primary"),n.find("td").removeClass("bg-primary"),n.attr("selecionado",!1);var t=e.indexOf(i.token);e.splice(t,1)}a.btn_destruir_refresh(),a.data_updt_refresh()})}(n)})})},View.setInterval(a.html_id,function(t){!e.length>=1&&(a.listar(),a.aux_manutencao=!1),a.data_updt_refresh()},12e4),this.btn_listar.unbind("click"),this.btn_listar.click(function(){a.listar(),a.aux_manutencao=!1,a.data_updt_refresh()}),this.btn_destruir.unbind("click"),this.btn_destruir.click(function(){WS.post("sessao/destruir/",{tokens:JSON.stringify(e)},function(t){a.listar()},[a.btn_listar,a.btn_destruir,a.btn_selecionar,a.btn_deselecionar])}),this.btn_selecionar.unbind("click"),this.btn_selecionar.click(function(){$(s[0].children).each(function(t,e){var i=$(e);"true"!=i.attr("selecionado")&&i.hasClass("new_row")&&(i.addClass("bg-primary"),i.find("td").addClass("bg-primary"),i.attr("selecionado",!0),a.btn_destruir.show(),a.txt_plural.show())}),e=[],$(i).each(function(t,a){e.push(a.token)})}),this.btn_deselecionar.unbind("click"),this.btn_deselecionar.click(function(){$(s[0].children).each(function(t,e){var i=$(e);"false"!=i.attr("selecionado")&&i.hasClass("new_row")&&(i.removeClass("bg-primary"),i.find("td").removeClass("bg-primary"),i.attr("selecionado",!1),a.btn_destruir.hide())}),e=[]}),this.data_updt_refresh=function(t){t=new Date,a.data_updt.text(t.toLocaleString())},this.btn_destruir_refresh=function(){e.length>0&&1==e.length&&e.length<2?(a.btn_destruir.show(),a.txt_singular.show(),a.txt_plural.hide()):e.length>=2?(a.btn_destruir.show(),a.txt_singular.hide(),a.txt_plural.show()):(a.btn_destruir.hide(),a.txt_singular.hide(),a.txt_plural.hide())},a.chk_manutencao.unbind("change").change(function(){a.aux_manutencao&&(a.chk_manutencao.prop("checked")?alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !','<div class="alert alert-danger" style="text-align: center"> <span href="#" class="alert-link"><strong>Esta ação vai </strong>deslogar<strong> todos os usuários e permitir que apenas usuários administradores loguem no sistema, deseja continuar ?  </strong></span></div>','<i class="fa fa-check" aria-hidden="true"></i> Sim',function(){WS.post("sessao/destruir_todas/",null,function(t){WS.post("sessao/alterar_manutencao/",{manutencao:a.chk_manutencao.prop("checked")},function(t){a.listar(),a.aux_manutencao=!1,alert_saved("Parâmetro salvo com sucesso")})})},!0,null,null,function(){a.chk_manutencao.prop("checked",!1).change()}):WS.post("sessao/alterar_manutencao/",{manutencao:a.chk_manutencao.prop("checked")},function(t){alert_saved("Parâmetro salvo com sucesso")}))}),this.unload=function(){View.unload(this.html_id)},a.listar()}});