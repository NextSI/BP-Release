define([],function(){return function(i){"use strict";var o=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.aoConfirmar=null,this.radio_semana=this.dialog.find(".radio_semana"),this.edt_inicio_calendario=this.dialog.find(".edt_inicio_calendario"),this.cbo_semanas=this.dialog.find(".cbo_semanas"),this.radio_dia_fim=this.dialog.find(".radio_dia_fim"),this.edt_inicio_novo_calendario=this.dialog.find(".edt_inicio_novo_calendario"),this.edt_fim_calendario=this.dialog.find(".edt_fim_calendario"),this.cbo_grupo_usuarios=this.dialog.find(".cbo_grupo_usuarios"),this.cbo_usuarios=this.dialog.find(".cbo_usuarios"),this.div_usuarios=this.dialog.find(".div_usuarios"),this.div_grupo_usuarios=this.dialog.find(".div_grupo_usuarios"),this.chk_exibir_endereco=this.dialog.find(".chk_exibir_endereco"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_filtrar=this.dialog.find(".btn_filtrar"),this.div_grupos_ativos=this.dialog.find(".div_grupos_ativos"),this.div_ativos=this.dialog.find(".div_ativos"),this.cbo_grupos_ativos=this.dialog.find(".cbo_grupos_ativos"),this.cbo_ativos=this.dialog.find(".cbo_ativos"),this.filtros=null,this.show=function(){o.filtros=App.get_parametro_usuario("agenda"),"string"==typeof o.filtros&&(o.filtros=JSON.parse(filtros)),o.filtros.tipo_agenda||(o.filtros.tipo_agenda=FILTRO_AGENDA.POR_SEMANA);var i=getSegundaFeira(new Date),a=("0"+i.getDate()).slice(-2),s=("0"+(i.getMonth()+1)).slice(-2),r=i.getFullYear()+"-"+s+"-"+a,e=new Date,t=new Date;t.setDate(e.getDate()+6);var _=("0"+t.getDate()).slice(-2),n=("0"+(t.getMonth()+1)).slice(-2);if(t=t.getFullYear()+"-"+n+"-"+_,set_datepicker(o.edt_inicio_calendario,r),set_datepicker(o.edt_inicio_novo_calendario,r),null==o.filtros.data_fim?set_datepicker(o.edt_fim_calendario,t):set_datepicker(o.edt_fim_calendario,o.filtros.data_fim),o.filtros.tipo_agenda==FILTRO_AGENDA.POR_SEMANA){o.radio_semana.prop("checked",!0),o.radio_semana.trigger("change");var d=o.filtros.qtd_dias>0?o.filtros.qtd_dias:7;o.cbo_semanas.val(d).trigger("change")}else o.filtros.tipo_agenda==FILTRO_AGENDA.POR_DATA&&(set_datepicker(o.edt_inicio_novo_calendario,o.filtros.data_inicio),o.radio_dia_fim.prop("checked",!0),o.radio_dia_fim.trigger("change"));App.verifica_permissao(App.temp.empresa,"agenda_grupo_usuario")||App.verifica_permissao(App.temp.empresa,"agenda_todas")||"S"==App.sessao.dados.supervisor_agenda?o.listar_grupos():o.listar_usuarios(),o.listar_grupos_ativos(),o.chk_exibir_endereco.prop("checked",o.filtros.exibir_endereco).change(),show_modal(o.modal.attr("id"))},this.listar_usuarios=function(){WS.get("usuario/usuarios_grupo_usuario_logado/",{grupo_usuarios_id:JSON.stringify(o.cbo_grupo_usuarios.val()),modulo:MODULOS.AGENDA},function(i){if(o.cbo_usuarios.children().remove(),i.length)for(var a=0;a<i.length;a++){var s="",r=i[a];Array.isArray(o.filtros.usuarios)&&o.filtros.usuarios.filter(function(i){if(i==r.usuario_id)return s="selected",!0}),add_option(o.cbo_usuarios,r.usuario_id,r.nome,s),a||o.cbo_usuarios.add_group_opt(),o.cbo_usuarios.selectpicker({countSelectedText:function(i){return i+" usuários selecionados"}})}o.cbo_usuarios.selectpicker("refresh"),o.div_usuarios.removeClass("hidden")})},this.listar_grupos=function(){WS.get("grupo_usuarios/listar/",{usuario_id:cripto(App.sessao.usuario_id.toString()),modulo:MODULOS.AGENDA},function(i){if(o.cbo_grupo_usuarios.children().remove(),"S"==App.sessao.dados.supervisor_agenda&&Array.isArray(o.filtros.grupo_usuarios)){var a="";o.filtros.grupo_usuarios.filter(function(i){-1==i&&(a="selected")}),add_option(o.cbo_grupo_usuarios,-1,"Supervisionados",a),o.cbo_grupo_usuarios.add_group_opt()}if((App.verifica_permissao(App.temp.empresa,"agenda_todas")||App.sessao.dados.admin)&&Array.isArray(o.filtros.grupo_usuarios)&&(a="",o.filtros.grupo_usuarios.filter(function(i){-2==i&&(a="selected")}),add_option(o.cbo_grupo_usuarios,-2,"Usuários sem grupo",a),o.cbo_grupo_usuarios.add_group_opt()),App.verifica_permissao(App.temp.empresa,"agenda_grupo_usuario")||App.verifica_permissao(App.temp.empresa,"agenda_todas"))for(var s=0;s<i.length;s++){var r=i[s];a="",Array.isArray(o.filtros.grupo_usuarios)&&o.filtros.grupo_usuarios.filter(function(i){i==r.grupo_usuarios_id&&(a="selected")}),add_option(o.cbo_grupo_usuarios,r.grupo_usuarios_id,r.nome,a)}o.cbo_grupo_usuarios.selectpicker({countSelectedText:function(i){return i+" usuários selecionados"}}),o.cbo_grupo_usuarios.selectpicker("refresh"),o.div_grupo_usuarios.removeClass("hidden"),o.listar_usuarios()})},this.listar_grupos_ativos=function(){WS.get("grupo_ativos/listar/",{usar_limite:!1,apenas_grupos_vinculados:!0},function(i){var a="";o.cbo_grupos_ativos.children().remove(),i&&i.length>0&&(i.forEach(function(i,s){a="",Array.isArray(o.filtros.grupos_ativos)&&o.filtros.grupos_ativos.filter(function(o){if(o==i.id)return a="selected",!0}),add_option(o.cbo_grupos_ativos,i.id,i.nome,a)}),o.cbo_grupos_ativos.selectpicker({countSelectedText:function(i){return i+" grupos de ativos selecionados"}}).selectpicker("refresh"),o.div_grupos_ativos.removeClass("hidden"),o.listar_ativos())})},this.listar_ativos=function(){WS.get("grupo_ativos/buscar_ativos/",{grupos_ativos_id:JSON.stringify(o.cbo_grupos_ativos.val())},function(i){var a="";o.cbo_ativos.children().remove(),i&&i.length>0?(i.forEach(function(i,s){a="",Array.isArray(o.filtros.ativos)&&o.filtros.ativos.filter(function(o){if(o==i.id)return a="selected",!0}),add_option(o.cbo_ativos,i.id,i.nome,a)}),o.cbo_ativos.selectpicker({countSelectedText:function(i){return i+" ativos selecionados"}}),o.div_ativos.removeClass("hidden")):o.div_ativos.addClass("hidden"),o.cbo_ativos.selectpicker("refresh")})},this.close=function(){close_modal(o.modal.attr("id")),void 0!==o.onclose&&o.onclose&&o.onclose()},this.unload=function(){o.close(),View.unload(this.html_id)},this.btn_filtrar.unbind("click"),this.btn_filtrar.click(function(){var i=get_datepicker(o.edt_inicio_novo_calendario),a=get_datepicker(o.edt_fim_calendario),s=null,r=null;if(o.radio_dia_fim.prop("checked")){var e=new Date(i).getTime(),t=new Date(a).getTime()-e;s=Math.ceil((t+1)/864e5),r=2}else o.radio_semana.prop("checked")&&(s=o.cbo_semanas.val(),i=get_datepicker(o.edt_inicio_calendario),r=1);var _={data_inicio:i,data_fim:a,qtd_dias:s,tipo_agenda:r,usuarios:o.cbo_usuarios.val(),grupo_usuarios:o.cbo_grupo_usuarios.val(),exibir_endereco:o.chk_exibir_endereco.prop("checked"),grupos_ativos:o.cbo_grupos_ativos.val(),ativos:o.cbo_ativos.val()};App.temp.abertura_inicial_agenda=!1,App.set_parametro_usuario("agenda",_),o.unload(),void 0!==o.aoConfirmar&&o.aoConfirmar&&o.aoConfirmar()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){o.unload()}),this.cbo_grupo_usuarios.unbind("change").change(function(){o.listar_usuarios()}),this.cbo_grupos_ativos.on("change",function(i){o.listar_ativos()}),this.radio_semana.unbind("change").change(function(){o.edt_inicio_novo_calendario.prop("readonly",!0),o.edt_fim_calendario.prop("readonly",!0),o.edt_inicio_calendario.prop("readonly",!1),o.cbo_semanas.prop("disabled",!1)}),this.radio_dia_fim.unbind("change").change(function(){o.edt_inicio_calendario.prop("readonly",!0),o.cbo_semanas.prop("disabled",!0),o.edt_inicio_novo_calendario.prop("readonly",!1),o.edt_fim_calendario.prop("readonly",!1)})}});