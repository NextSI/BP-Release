define(["react","react-dom","./DetalharMenu","./../componentes_react/CboClientes","./../central_documentos/SelectPasta","./../componentes_react/InformativoPrazo"],function(a,i,o,e,t,s){return function(r){"use strict";var c=this;this.html_id=r,this.dialog=$("#"+this.html_id),this.title="Solicitação",this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.tipo=null,this.onclose=null,this.onsave=null,this.scrollview=this.dialog.find(".scrollview"),this.div_diagrama=this.dialog.find(".div_diagrama"),this.aba_formulario=this.dialog.find(".aba_formulario"),this.aba_historico=this.dialog.find(".aba_historico"),this.aba_fluxo=this.dialog.find(".aba_fluxo"),this.aba_diagrama=this.dialog.find(".aba_diagrama"),this.detalharMenu=this.dialog.find(".detalharMenu"),this.processoDetalharMenu=null,this.processoDetalharMenuProps={},this.menu_formulario=this.dialog.find(".menu_formulario"),this.menu_historico=this.dialog.find(".menu_historico"),this.observacao_historico=this.dialog.find(".observacao_historico"),this.menu_fluxo=this.dialog.find(".menu_fluxo"),this.menu_diagrama=this.dialog.find(".menu_diagrama"),this.solicitacao_id=this.dialog.find(".solicitacao_id"),this.solicitacao_copiar_link=this.dialog.find(".solicitacao_copiar_link"),this.lbl_versao=this.dialog.find(".lbl_versao"),this.lbl_nome=this.dialog.find(".lbl_nome"),this.div_solicitante=this.dialog.find(".div_solicitante"),this.img_solicitante=this.dialog.find(".img_solicitante"),this.div_usuario_responsavel_atividade_nome=this.dialog.find(".div_usuario_responsavel_atividade_nome"),this.lbl_usuario_responsavel_atividade_nome=this.dialog.find(".lbl_usuario_responsavel_atividade_nome"),this.lbl_data=this.dialog.find(".lbl_data"),this.lbl_descricao=this.dialog.find(".lbl_descricao"),this.lbl_prazo_execucao=this.dialog.find(".lbl_prazo_execucao"),this.div_solicitacao_informativo_prazo=this.dialog.find(".div_solicitacao_informativo_prazo"),this.solicitacao_informativo_prazo=a.createElement(s,null,null),this.formulario_util=null,this.form_editor=this.dialog.find(".form-editor"),this.form_grupos=this.dialog.find(".form-grupos"),this.template_grupo=this.dialog.find("[template-grupo]"),this.template_campo=this.dialog.find("[template-campo]"),this.lbl_processo_nome=this.dialog.find(".lbl_processo_nome"),this.lbl_processo_instrucao=this.dialog.find(".lbl_processo_instrucao"),this.lbl_atividade_nome=this.dialog.find(".lbl_atividade_nome"),this.lbl_atividade_instrucao=this.dialog.find(".lbl_atividade_instrucao"),this.bar_progresso=this.dialog.find(".bar_progresso:not([template-field])"),this.div_atraso=this.dialog.find(".div_atraso"),this.div_restante=this.dialog.find(".div_restante"),this.div_cliente=this.dialog.find(".div_cliente"),this.div_seleciona_cliente=this.dialog.find(".div_seleciona_cliente"),this.div_menu_block=this.dialog.find(".div_menu_block"),this.div_usuarios=this.dialog.find(".div_usuarios"),this.div_seleciona_pasta=this.dialog.find(".div_seleciona_pasta"),this.div_pasta=this.dialog.find(".div_pasta"),this.selectPasta=a.createElement(t,null,null),this.tab_atividades=this.dialog.find(".tab_atividades"),this.tab_historico=this.dialog.find(".tab_historico"),this.aba_referencias_solicitacao=this.dialog.find(".aba_referencias_solicitacao"),this.menu_referencias_solicitacao=this.dialog.find(".menu_referencias_solicitacao"),this.div_componente_referencias_solicitacao=this.dialog.find(".div_componente_referencias_solicitacao"),this.aba_referencias_atividade=this.dialog.find(".aba_referencias_atividade"),this.menu_referencias_atividade=this.dialog.find(".menu_referencias_atividade"),this.div_componente_referencias_atividade=this.dialog.find(".div_componente_referencias_atividade"),this.edt_observacoes=this.dialog.find(".edt_observacoes"),this.contador_obs=this.dialog.find(".contador_obs"),this.div_component_cbo_clientes=this.dialog.find(".div_component_cbo_clientes"),this.div_dropdown_etiquetas=this.dialog.find(".div_dropdown_etiquetas"),this.cboClientes=null,this.divs_informativo_prazo=[],this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_pesquisa_cliente=this.dialog.find(".btn_pesquisa_cliente"),this.text_altera_usuario=this.dialog.find(".text_altera_usuario"),this.cbo_usuarios=this.dialog.find(".cbo_usuarios"),this.div_topo=this.dialog.find(".div_topo"),this.aviso_modo_teste=this.dialog.find(".aviso_modo_teste"),this.p_usuario_teste=this.dialog.find(".p_usuario_teste"),this.btn_alterar_responsavel=this.dialog.find(".btn_alterar_responsavel"),this.panel_alterar_responsavel=this.dialog.find(".panel_alterar_responsavel"),this.floating=this.dialog.find(".floating-menu"),this.th_execucao=this.dialog.find(".th_execucao"),this.th_origem=this.dialog.find(".th_origem"),this.ordenacao={crscente_execucao:!0,crscente_origem:!0},this.dados_modificados=!1,this.execucao=null,this.origem=null,this.solicitacao_atividade=null,this.versao_solicitacao_atividade=null,this.status=null,this.acesso_cancelar,this.cliente_id=null,this.filtros=null,this.documento_pasta_id=null,this.renderizar_atividades=!0,this.liberar_campos=!1,this.diagram=null,this.etiquetas=null;var d=null;this.anexos=[],this.filenames=[],this.elem_keys=[],this.versao_atividade_tipo=null,this.nome_cliente=null,this.arr_ignorar=[],this.diagramFirstLoad=!0,this.callback_clientes=$.Callbacks(),this.esconder_grupos_campos_vazios=!1,this.usuario_cliente_visualiza=null,this.show=function(a,o,e,t){if(c.scrollview.dxScrollView().dxScrollView("instance"),c.scrollview.css("height","calc(100vh - 90px)"),!0===t&&(c.aviso_modo_teste.removeClass("hidden"),c.p_usuario_teste.html("Solicitação em modo teste <br><b>Usuário:</b> "+e)),c.processoDetalharMenuProps.handleSalvarEnviarClick=c.salva_envia,c.processoDetalharMenuProps.handleDownloadPDFClick=c.download_pdf,c.processoDetalharMenuProps.handleDownloadTemplateClick=c.download_template,c.processoDetalharMenuProps.handleImprimirPdfClick=c.imprimir_pdf,c.processoDetalharMenuProps.handleNovoChamadoClick=c.novo_chamado,c.processoDetalharMenuProps.handleNovaSolicitacaoClick=c.nova_solicitacao,c.processoDetalharMenuProps.handleSalvarSairClick=c.salvarSairClick,c.processoDetalharMenuProps.handleSalvarClick=c.salvarClick,c.processoDetalharMenuProps.handleCancelarClick=c.cancelarClick,c.processoDetalharMenuProps.handleReprogramarClick=c.reprogramarClick,c.processoDetalharMenuProps.handleAlterarResponsavelClick=c.alterar_responsavelClick,c.processoDetalharMenuProps.handleAssumirAtividadeClick=c.AssumirAtividadeClick,c.processoDetalharMenuProps.handleDesvincularResponsabilidadeClick=c.DesvincularResponsabilidadeClick,c.processoDetalharMenuProps.handleCancelarSolicitacaoClick=c.cancelar_solicitacaoClick,c.processoDetalharMenuProps.handleReabrirSolicitacaoClick=c.reabrir_solicitacaoClick,c.processoDetalharMenuProps.handleRetornarAtividadeAnteriorClick=c.retornarClick,c.processoDetalharMenuProps.handleDownloadTodosAnexos=c.download_todos_anexos,c.processoDetalharMenuProps.handleHabilitarEdicaoCampos=c.habilitar_edicao_campos,c.processoDetalharMenuProps.handleAlterarProjetoVinculado=c.handleAlterarProjetoVinculado,i.render(c.selectPasta,c.div_pasta[0]),c.selectPasta.props.setDesabilitado(!1),c.renderProcessoDetalharMenu(),c.aba_formulario.attr("id","aba_formulario"+c.html_id),c.aba_historico.attr("id","aba_historico"+c.html_id),c.aba_fluxo.attr("id","aba_fluxo"+c.html_id),c.aba_diagrama.attr("id","aba_diagrama"+c.html_id),c.aba_referencias_solicitacao.attr("id","aba_referencias_solicitacao"+c.html_id),c.aba_referencias_atividade.attr("id","aba_referencias_atividade"+c.html_id),c.menu_formulario.attr("href","#"+c.aba_formulario.attr("id")),c.menu_historico.attr("href","#"+c.aba_historico.attr("id")),c.menu_fluxo.attr("href","#"+c.aba_fluxo.attr("id")),c.menu_diagrama.attr("href","#"+c.aba_diagrama.attr("id")),c.menu_referencias_solicitacao.attr("href","#"+c.aba_referencias_solicitacao.attr("id")),c.menu_referencias_atividade.attr("href","#"+c.aba_referencias_atividade.attr("id")),App.sessao.sessao_login_anonimo&&(c.menu_diagrama.addClass("hidden"),c.menu_referencias_solicitacao.addClass("hidden"),c.menu_referencias_atividade.addClass("hidden")),c.tipo=o,void 0!==a&&a?"object"==typeof a?((App.sessao.sessao_login_anonimo||!App.sessao.dados.admin&&"N"==a.permite_download_formulario_nao_concluido)&&(c.processoDetalharMenuProps.DownloadPdf="hidden"),c.solicitacao_atividade=a,o==FORMULARIO.NOVO&&c.permite_acompanhar(a.solicitacao.versao_processo.relaciona_cliente),c.esconder_grupos_campos_vazios=void 0!==a.esconder_grupos_campos_vazios&&a.esconder_grupos_campos_vazios,c.preencher()):"number"!=typeof a&&"string"!=typeof a||WS.get({route:"solicitacao/objeto/",data:{solicitacao_atividade_id:a,tipo_visualizacao:c.tipo},func_response:function(a){(App.sessao.sessao_login_anonimo||!App.sessao.dados.admin&&null==a.entrega&&"N"==a.permite_download_formulario_nao_concluido)&&(c.processoDetalharMenuProps.DownloadPdf="hidden",c.renderProcessoDetalharMenu()),c.solicitacao_atividade=a,d=c.solicitacao_atividade.cliente_id,c.esconder_grupos_campos_vazios=void 0!==a.esconder_grupos_campos_vazios&&a.esconder_grupos_campos_vazios,c.preencher(),c.permite_acompanhar(a.solicitacao.versao_processo.relaciona_cliente)},func_fail:function(){c.unload()}}):c.renderiza_componentes(),c.permite_alterar(),App.PE.Solicitacao_Detalhes_show_antes)try{App.PE.Solicitacao_Detalhes_show_antes(c)}catch(a){console.log(a)}c.listar_documento_pasta()},this.close=function(){void 0!==c.onclose&&c.onclose&&c.onclose()},this.unload=function(){var a=function(){View.canCloseTab=!0;for(var a=0;a<c.divs_informativo_prazo.length;a++)c.divs_informativo_prazo[a].props.desativarRefreshAutomatico();c.close(),View.unload(c.html_id)};!0===c.dados_modificados?(View.canCloseTab=!1,alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"Você alterou alguns campos. O que deseja fazer?","Salvar e sair",function(){c.dados_modificados=!1,alert_info("Aguarde enquanto salvamos as alterações"),c.salvarSairClick(a)},!0,"Não salvar e sair",null,function(){c.dados_modificados=!1,a()})):(c.dados_modificados=!1,a())},this.permite_alterar=function(){switch(c.tipo){case FORMULARIO.NOVO:case FORMULARIO.EDITAR:break;case FORMULARIO.VISUALIZAR:c.processoDetalharMenuProps.TextoCancelar="Sair",c.processoDetalharMenuProps.Visualizar=!0,c.renderProcessoDetalharMenu();break;case FORMULARIO.EXCLUIR:}},this.renderiza_componentes=function(){c.renderiza_combobox_cliente()},this.renderiza_combobox_cliente=function(){null===c.cboClientes&&(c.cboClientes=a.createElement(e,{initial_values:{placeholder:"Nome da Entidade",disabled:c.usuario_cliente_visualiza}},null)),i.render(c.cboClientes,c.div_component_cbo_clientes[0],()=>{if(!0===App.sessao.dados.admin||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"cliente")||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"cliente_somente_leitura")){const a=c.div_component_cbo_clientes.find(".btn_informacao");a.on("click",()=>{const a=!0===App.sessao.dados.admin||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"cliente")?window.FORMULARIO.EDITAR:window.FORMULARIO.VISUALIZAR;View.load("cliente/detalhes",(i,o)=>{o.show(c.cliente_id,a)},window.View.ABA.MULTIPLAS,null,null,{clienteId:c.cliente_id})}),a.show()}}),c.cboClientes.props.setConfiguracoes={main_externo:c,exibe_tipo_entidade:!0,placeholder:"Filtro por Cliente",WS_params:{desconsiderar_empresa:!0,desconsiderar_fornecedor:!0,desconsiderar_prospect:!0,limite:0}},c.cboClientes.props.setCliente(c.filtros),c.cboClientes.props.setFunctionSelect(c.evt_alterar_cliente)},this.evt_alterar_cliente=function(){if(c.cliente_id=c.cboClientes.props.ClienteSelecionado.id,c.nome_cliente=c.cboClientes.props.ClienteSelecionado.nome_fantasia,App.PE.Solicitacao_Detalhes_ao_selecionar_cliente)try{App.PE.Solicitacao_Detalhes_ao_selecionar_cliente(c,c.cboClientes.props.ClienteSelecionado)}catch(a){console.log(a)}c.listar_filtro_usuarios(c.cliente_id)},this.permite_acompanhar=function(a){a?(c.div_usuarios.removeClass("hidden"),c.render_usuarios_por_cliente()):c.div_usuarios.addClass("hidden")},this.adiciono_cliente=function(){!0===c.solicitacao_atividade.solicitacao.versao_processo.relaciona_cliente?$(c.solicitacao_atividade.solicitacao.versao_processo.elementos).each(function(a,i){parseInt(i.id,10)==c.solicitacao_atividade.versao_processo_atividade_id&&(parseInt(i.elemento_tipo,10)==PROCESSO_ELEMENTO_TIPO.ATIVIDADE&&parseInt(i.tipo,10)==PROCESSO_ATIVIDADE_TIPO.INICIO?(c.div_seleciona_cliente.removeClass("hidden"),c.div_cliente.addClass("hidden")):(c.div_cliente.removeClass("hidden"),c.div_seleciona_cliente.addClass("hidden")))}):(c.div_seleciona_cliente.addClass("hidden"),c.div_cliente.addClass("hidden"))},this.atualizar_progress=function(){c.lbl_prazo_execucao.show(),i.render(c.solicitacao_informativo_prazo,c.div_solicitacao_informativo_prazo[0]),c.solicitacao_informativo_prazo.props.setConfiguracoes({ViewParent:c.html_id,Alinhamento:"right",TipoGestaoTempo:c.solicitacao_atividade.tipo_prazo_execucao==SOLICITACAO_TIPO_HORA.HORAS_UTEIS?GESTAO_TEMPO.HORAS_UTEIS:GESTAO_TEMPO.DIAS_CORRIDOS,HorasEstimadas:c.solicitacao_atividade.tempo_restante_acumulado||c.solicitacao_atividade.tempo_prazo_execucao,DataPrazo:c.solicitacao_atividade.prazo_execucao,CalendarioTrabalhoId:c.solicitacao_atividade.calendario_trabalho_id,TituloDataPrazo:"Prazo",LabelExcedente:"atrasado",LabelRestante:"restante",ExibirBarraProgresso:!1,StyleWidth:null})},this.listar_documento_pasta=function(a,i){if(a){var o=void 0===i||""===i;c.selectPasta.props.setDocumentoPastaID(a,o)}void 0!==i&&""!==i&&c.selectPasta.props.setDocumentoPastaPath(i),c.selectPasta.props.handleSelecionar=function(){c.documento_pasta_id=c.selectPasta.props.documentoPastaID}},this.set_numero=function(){const a="S"==c.solicitacao_atividade.numero_solicitacao_por_processo?c.solicitacao_atividade.numero:c.solicitacao_atividade.solicitacao_id;setTimeout(()=>App.titulo_aba(c.html_id,"Solicitação #"+a)),c.solicitacao_id.text("#"+a),c.render_solicitacao_copiar_link()},this.render_solicitacao_copiar_link=(()=>{ReactDOM.unmountComponentAtNode(c.solicitacao_copiar_link[0]),ReactDOM.render(React.createElement(window.components.CopiarLink.default,{url:"#/processo/listar/"+c.solicitacao_atividade.solicitacao_id,style:{padding:"0px"}},React.createElement("span",{className:"far fa-copy"})),c.solicitacao_copiar_link[0])}),this.preencher=function(){1!=App.sessao.dados.admin&&App.sessao.dados.tipo!=USUARIO_TIPO.COLABORADOR&&(c.processoDetalharMenuProps.DownloadTemplate="hidden"),(c.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao||"S"==c.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao)&&c.div_seleciona_pasta.removeClass("hidden"),c.solicitacao_atividade.solicitacao.documento_pasta_id&&(c.documento_pasta_id=c.solicitacao_atividade.solicitacao.documento_pasta_id,c.listar_documento_pasta(c.solicitacao_atividade.solicitacao.documento_pasta_id)),c.arr_ignorar=[],c.arr_ignorar.push(c.solicitacao_atividade.solicitacao_id),c.acesso_cancelar=c.solicitacao_atividade.solicitacao.acesso_cancelar;let a=App.sessao.dados.tipo==USUARIO_TIPO.CLIENTE&&!c.solicitacao_atividade.usuario_cliente_interage&&!c.solicitacao_atividade.responsavel_id.includes(App.sessao.dados.usuario_id.toString());c.usuario_cliente_visualiza=a,c.usuario_cliente_visualiza&&(c.processoDetalharMenuProps.TextoCancelar="Sair",c.processoDetalharMenuProps.Visualizar=!0,c.renderProcessoDetalharMenu(),c.selectPasta.props.setDesabilitado(!0),c.cbo_usuarios.prop("disabled",!0),c.cbo_usuarios.selectpicker("refresh")),$(c.solicitacao_atividade.solicitacao.versao_processo.elementos).each(function(a,i){i.id==c.solicitacao_atividade.versao_processo_atividade_id&&i.elemento_tipo==PROCESSO_ELEMENTO_TIPO.ATIVIDADE&&(c.versao_solicitacao_atividade=i)}),c.set_numero(),c.cliente_id=c.solicitacao_atividade.solicitacao.cliente_id,c.nome_cliente=c.solicitacao_atividade.solicitacao.cliente?c.solicitacao_atividade.solicitacao.cliente.nome_fantasia||c.solicitacao_atividade.solicitacao.cliente.razao_social:"",c.solicitacao_atividade.solicitacao.cliente&&(ReactDOM.unmountComponentAtNode(c.div_cliente[0]),ReactDOM.render(React.createElement(window.views.entidade.EntidadeCard.default,{tipo:"C",id:c.cliente_id,nome:c.nome_cliente,logoId:c.solicitacao_atividade.solicitacao.cliente?c.solicitacao_atividade.solicitacao.cliente.logo_id:null,tamanho:20}),c.div_cliente[0])),ReactDOM.unmountComponentAtNode(c.div_solicitante[0]),ReactDOM.render(React.createElement(window.components.ColunaUsuario.cellRender,{text:c.solicitacao_atividade.usuario_nome,marginTop:"0px",column:{dataFieldUsuarioId:"usuario_id"},data:{usuario_id:c.solicitacao_atividade.solicitacao.usuario_id}}),c.div_solicitante[0]),c.filtros=spread({},c.filtros,{cliente_id:c.cliente_id,cliente_nome:c.cliente_id>0?c.solicitacao_atividade.solicitacao.cliente.nome_fantasia||c.solicitacao_atividade.solicitacao.cliente.razao_social:"",cliente_tipo:"C"}),c.renderiza_componentes(),c.lbl_versao.text(c.solicitacao_atividade.solicitacao.versao_processo.sequencia),c.lbl_versao.text(c.solicitacao_atividade.solicitacao.versao_processo.sequencia),c.solicitacao_atividade.responsavel_nome?(c.lbl_usuario_responsavel_atividade_nome.text(c.solicitacao_atividade.responsavel_nome),c.div_usuario_responsavel_atividade_nome.show()):c.div_usuario_responsavel_atividade_nome.hide(),c.lbl_data.text(c.solicitacao_atividade.data?c.solicitacao_atividade.data.format_date():""),null!=c.solicitacao_atividade.solicitacao.descricao&&""!=c.solicitacao_atividade.solicitacao.descricao&&(c.lbl_descricao.removeClass("hidden"),c.lbl_descricao.text(c.solicitacao_atividade.solicitacao.descricao)),c.lbl_processo_nome.text(c.solicitacao_atividade.solicitacao.versao_processo.nome),c.lbl_processo_instrucao.html(c.solicitacao_atividade.solicitacao.versao_processo.instrucao_trabalho),c.lbl_processo_instrucao.hide(),c.lbl_processo_nome.click(function(){c.lbl_processo_instrucao.toggle()}),c.lbl_atividade_nome.text(c.versao_solicitacao_atividade.descricao),c.lbl_atividade_instrucao.html(c.versao_solicitacao_atividade.instrucao_trabalho);var i="";""!=c.solicitacao_atividade.solicitacao.data_finalizacao&&null!=c.solicitacao_atividade.solicitacao.data_finalizacao?(c.div_topo.addClass("borda_aprovado"),i+="Solicitação concluída"):"S"==c.solicitacao_atividade.cancelada?(c.div_topo.addClass("borda_reprovado"),i+="Solicitação cancelada",c.div_topo.css("background-color","#FFCDD2")):(c.div_topo.addClass("borda_pendente"),i+="Solicitação em andamento"),""!=c.solicitacao_atividade.entrega&&null!=c.solicitacao_atividade.entrega?c.bar_progresso.append('<span class="label label-success">Atividade concluída</span>'):!0===c.solicitacao_atividade.solicitacao.cancelada?c.bar_progresso.append('<span class="label label-danger">Atividade cancelada</span>'):c.solicitacao_atividade.prazo_execucao&&c.atualizar_progress(),c.bar_progresso.tooltip({title:i,placement:"left",html:!0}),App.sessao.sessao_login_anonimo?c.processoDetalharMenuProps.SalvarEnviar="":(c.versao_solicitacao_atividade.acao_projeto_template&&!c.solicitacao_atividade.solicitacao.cancelada&&(c.processoDetalharMenuProps.VincularProjeto=""),+c.solicitacao_atividade.projeto_id>0&&WS.get("projeto/objeto/",{projeto_id:c.solicitacao_atividade.projeto_id},function(a){var i=(null!==a.porcentagem_concluido?a.porcentagem_concluido:0)+"%";parseInt(a.porcentagem_concluido)<c.versao_solicitacao_atividade.acao_projeto_template_conclusao&&(c.processoDetalharMenuProps.projetoVinculadoPendente=!0,c.processoDetalharMenuProps.PorcentagemConcluido=i,c.processoDetalharMenuProps.PorcentagemNecessario=c.versao_solicitacao_atividade.acao_projeto_template_conclusao+"%"),c.processoDetalharMenuProps.ProjetoID=a.id,c.processoDetalharMenuProps.ProjetoTemplate=a.template,c.renderProcessoDetalharMenu()})),c.setDisplayDownloadTodosAnexos(),(App.sessao.dados.admin||"S"==c.solicitacao_atividade.solicitacao.acesso_supervisor.supervisor_processo&&"S"==c.solicitacao_atividade.solicitacao.acesso_supervisor.permite_edicao)&&c.tipo==FORMULARIO.VISUALIZAR&&(c.processoDetalharMenuProps.SupervisorProcesso=!0,c.processoDetalharMenuProps.TextoCancelar="Sair"),c.adiciono_cliente(),c.listar_filtro_usuarios(c.cliente_id),c.render_formulario(),c.edt_observacoes.val(c.solicitacao_atividade.observacoes),c.render_historico(),c.verifica_status(),c.render_atividades(),c.verifica_permissao(),App.sessao.dados.admin||"S"==c.solicitacao_atividade.solicitacao.acesso_supervisor.supervisor_processo&&"S"==c.solicitacao_atividade.solicitacao.acesso_supervisor.permite_edicao||"S"==c.solicitacao_atividade.versao_processo_atividade_permite_reprogramar&&!1!==c.solicitacao_atividade.permite_edicao?c.processoDetalharMenuProps.Reprogramar="":c.processoDetalharMenuProps.Reprogramar="hidden",App.sessao.sessao_login_anonimo&&(c.processoDetalharMenuProps.NovoChamado="hidden",c.processoDetalharMenuProps.NovaSolicitacao="hidden",c.processoDetalharMenuProps.SalvarSair="hidden",c.processoDetalharMenuProps.Reprogramar="hidden",c.processoDetalharMenuProps.Cancelar="hidden",c.processoDetalharMenuProps.RetornarAtividadeAnterior="hidden"),c.renderProcessoDetalharMenu(),c.renderDropDownEtiquetas()},this.verifica_permissao=function(){$(c.versao_solicitacao_atividade.todos_usuarios_responsaveis).each(function(a,i){i.usuario_id!=App.sessao.usuario_id&&1!=App.sessao.dados.admin||"S"!=i.altera_responsavel&&!0!==i.altera_responsavel&&1!=App.sessao.dados.admin||c.panel_alterar_responsavel.removeClass("hidden")})},this.render_formulario=function(){c.solicitacao_atividade.formulario||(c.solicitacao_atividade.formulario=c.solicitacao_atividade.solicitacao.versao_processo.formulario);const a=a=>"object"==typeof a?a:"string"==typeof a&&""!==a.trim()?JSON.parse(a):{};c.solicitacao_atividade.solicitacao.formulario.evento_iniciar_construtor=a(c.solicitacao_atividade.solicitacao.formulario.evento_iniciar_construtor),c.solicitacao_atividade.formulario.evento_iniciar_construtor=a(c.solicitacao_atividade.formulario.evento_iniciar_construtor),require(["./assets/view/formulario/util"],function(a){c.formulario_util=new a,c.formulario_util.render_previsao({div_formulario:c,template_campo:c.template_campo,template_grupo:c.template_grupo,obj_formulario:c.tipo==FORMULARIO.VISUALIZAR||null!==c.solicitacao_atividade.entrega||"S"==c.solicitacao_atividade.cancelada||null!==c.solicitacao_atividade.cancelamento_hora_atividade?c.solicitacao_atividade.solicitacao.formulario:c.solicitacao_atividade.formulario,permissoes_formulario:c.versao_solicitacao_atividade.permissoes_formulario,obj_solicitacao:c.solicitacao_atividade,disabled_all:c.tipo==FORMULARIO.VISUALIZAR||!1===c.solicitacao_atividade.permite_edicao||!0===c.usuario_cliente_visualiza,persistencia_ao_editar:!1,clicksign_ativo:"S"===c.solicitacao_atividade.clicksign_ativo,permite_retrair_exibir_grupos:!0,certsign_ativo:"S"===c.solicitacao_atividade.certsign_ativo,liberar_campos:c.liberar_campos,d4sign_ativo:"S"===c.solicitacao_atividade.d4sign_ativo,esconder_grupos_campos_vazios:c.esconder_grupos_campos_vazios})})},this.verifica_status=function(){if(c.processoDetalharMenuProps.RetornarAtividadeAnterior="hidden",!0===c.solicitacao_atividade.somente_leitura||c.solicitacao_atividade.situacao==SOLICITACAO_STATUS.ATIVIDADE_CONCLUIDA||c.solicitacao_atividade.situacao==SOLICITACAO_STATUS.ATIVIDADE_RETORNADA||"S"==c.solicitacao_atividade.cancelada||c.solicitacao_atividade.situacao==SOLICITACAO_STATUS.ATIVIDADE_CANCELADA)c.processoDetalharMenuProps.Salvar="hidden",c.processoDetalharMenuProps.SalvarSair="hidden",c.processoDetalharMenuProps.CancelarSolicitacao="hidden",c.processoDetalharMenuProps.RetornarAtividadeAnterior="hidden",c.processoDetalharMenuProps.SalvarEnviar="hidden",c.processoDetalharMenuProps.AssumirAtividade="hidden",c.processoDetalharMenuProps.DesvincularResponsabilidade="hidden",1==c.acesso_cancelar&&"S"==c.solicitacao_atividade.cancelada&&(c.processoDetalharMenuProps.ReabrirSolicitacao="");else{c.processoDetalharMenuProps.Salvar="",c.processoDetalharMenuProps.SalvarSair="",1==c.acesso_cancelar?c.processoDetalharMenuProps.CancelarSolicitacao="":c.processoDetalharMenuProps.CancelarSolicitacao="hidden";var a=c.versao_solicitacao_atividade.todos_usuarios_responsaveis.find(function(a){return a.usuario_id==App.sessao.dados.usuario_id});a=void 0!==a,void 0!==c.solicitacao_atividade.permite_alterar_responsavel&&!0===c.solicitacao_atividade.permite_alterar_responsavel?("S"!==c.solicitacao_atividade.solicitante_responsavel&&"S"!==c.solicitacao_atividade.executor_responsavel_automatico&&"S"!==c.solicitacao_atividade.tornar_superior_imediato_responsavel&&void 0!==c.solicitacao_atividade.permite_vincular_responsabilidade&&!0===c.solicitacao_atividade.permite_vincular_responsabilidade&&!0===a&&(void 0!==c.versao_solicitacao_atividade.usuarios_responsaveis&&c.versao_solicitacao_atividade.usuarios_responsaveis.length>1||void 0!==c.versao_solicitacao_atividade.grupos_usuarios_responsaveis&&c.versao_solicitacao_atividade.grupos_usuarios_responsaveis.length>0)&&(void 0!==c.solicitacao_atividade.responsavel_id&&c.solicitacao_atividade.responsavel_id.length?(c.processoDetalharMenuProps.AssumirAtividade="hidden",c.solicitacao_atividade.responsavel_id.includes(App.sessao.dados.usuario_id.toString())&&(parseInt(c.versao_solicitacao_atividade.tipo,10)==PROCESSO_ATIVIDADE_TIPO.INICIO&&c.solicitacao_atividade.responsavel_id.includes(c.solicitacao_atividade.solicitacao.usuario_id.toString())?c.processoDetalharMenuProps.DesvincularResponsabilidade="hidden":c.processoDetalharMenuProps.DesvincularResponsabilidade="")):(c.processoDetalharMenuProps.AssumirAtividade="",c.processoDetalharMenuProps.DesvincularResponsabilidade="hidden")),c.processoDetalharMenuProps.AlterarResponsavel=""):(c.processoDetalharMenuProps.AlterarResponsavel="hidden",c.processoDetalharMenuProps.AssumirAtividade="hidden",c.processoDetalharMenuProps.DesvincularResponsabilidade="hidden"),parseInt(c.versao_solicitacao_atividade.tipo,10)==PROCESSO_ATIVIDADE_TIPO.INICIO||1!=c.solicitacao_atividade.permite_retorno||App.sessao.sessao_login_anonimo||(c.processoDetalharMenuProps.RetornarAtividadeAnterior=""),c.processoDetalharMenuProps.SalvarEnviar=""}c.renderProcessoDetalharMenu()},this.render_historico=function(){if(App.sessao.sessao_login_anonimo)c.menu_historico.addClass("hidden");else{var a=c.tab_historico.find("tbody"),i=a.find("[template-row='atividade']"),o=(a.find("[template-row='chamado']"),a.find("[template-row='historico']")),e=0;c.tab_historico.find(".row_historico").remove(),$(c.solicitacao_atividade.solicitacao.historico).each(function(t,s){s.id_md5||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_VINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_DESVINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.CHAMADO_VINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.CHAMADO_DESVINCULADO?s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_VINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_DESVINCULADO?function(i){var e=o.clone();e.removeAttr("template-row"),e.css("display",""),e.addClass("row_historico");var t=e.find('[template-field="descricao"]'),s=$('<label class="label label-info">Processo</label>'),r=$("<span>&nbsp;&nbsp;"+i.valor_novo+"</span>");s.appendTo(t),r.appendTo(t);var d=$(e.find(".btn_detalhes"));if(d.addClass("hidden"),i.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_VINCULADO&&i.solicitacao_atividade_id_vinculado){d.removeClass("hidden"),d.addClass("btn"),d.addClass("btn-primary"),d.addClass("btn_ver_processo"),d.attr("value",i.id),d.append('<span class="glyphicon glyphicon-list-alt"></span>');var l=function(){View.load("solicitacao/detalhes",function(a,o){o.onclose=c.detalhes_onclose,o.show(i.solicitacao_atividade_id_vinculado,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS,null,null,{solicitacaoAtividadeId:i.solicitacao_atividade_id_vinculado})};d.unbind("click"),d.click(l),e.dblclick(l)}e.appendTo(a)}(s):function(i){var e=o.clone();e.css("display","").removeAttr("template-row").addClass("row_historico");var t=null,s=e.find('[template-field="descricao"]'),r=e.find(".btn_detalhes");r.addClass("btn btn-primary");var c=$('<i class="glyphicon glyphicon-folder-open"></i>'),d=$('<label class="label label-danger">Chamado</label>');c.appendTo(r),d.appendTo(s),i.chamado_id?($("<span>&nbsp;&nbsp;"+i.valor_novo+"</span>").appendTo(s),t=i.chamado_id):($("<span>&nbsp;&nbsp;[#"+i.id+"] | "+i.assunto+"</span>").appendTo(s),t=i.id),r.unbind("click").click(function(){View.loadReact(window.views.chamado.Detalhes.default,{chamadoId:t},function(a,i){},View.ABA.MULTIPLAS)}),e.appendTo(a)}(s):function(o){var t;t=o.solicitacao_atividade_id==o.cancelamento_solicitacao_atividade_id&&"S"==o.solicitacao_cancelada;var s=i.clone();s.removeAttr("template-row"),s.css("display",""),s.addClass("row_historico"),void 0===o.solicitacao_atividade_id?s.addClass("bg-warning"):o.solicitacao_atividade_id==o.cancelamento_solicitacao_atividade_id?s.addClass("bg-danger"):c.solicitacao_atividade.id==o.solicitacao_atividade_id&&c.tipo!=FORMULARIO.VISUALIZAR&&s.addClass("bg-info");var r=$(s.find("[template-field='atividade_descricao']"));t?r.text((o.versao_processo_atividade_descricao||o.mensagem_historico)+" (CANCELADO)"):r.html(o.versao_processo_atividade_descricao||nl2br(o.mensagem_historico)||"");var d=$(s.find(".span_type"));o.mensagem_historico?d.text(str_acao_historico_processo(o.acao)).addClass("label-info"):d.addClass("label-primary");var l=$(s.find(".div_atividades_pendentes"));null!=o.solicitacao_atividade_gateway_paralelo_id&&""!=o.solicitacao_atividade_gateway_paralelo_id?l.show():l.hide();var n=$(s.find(".div_retorno")),_=$(s.find("[template-field='retorno_motivo']")),p=$(s.find(".img_retorno"));o.retorno?(p.addClass("glyphicon-thumbs-down"),_.html(o.retorno_motivo?o.retorno_motivo:""),n.show()):t?(p.addClass("glyphicon-ban-circle"),_.html(o.cancelamento_motivo?o.cancelamento_motivo:"Motivo não definido.")):n.hide();var u=$(s.find(".div_executado"));o.executor_id||o.executor_email?u.show():u.hide();var v=$(s.find(".executor_foto"));t?o.usuario_cancelamento_foto&&v.attr("src",WS_URI+"documento/midia/?documento_id="+o.usuario_cancelamento_foto+"&tamanho=20&token_midia="+App.sessao.token_midia):o.executor_foto_id&&v.attr("src",WS_URI+"documento/midia/?documento_id="+o.executor_foto_id+"&tamanho=20&token_midia="+App.sessao.token_midia);var m=$(s.find("[template-field='executado_em']"));o.entrega?m.text(o.entrega.format_date_time()):o.retorno?m.text(o.retorno.format_date_time()):o.cancelamento_hora?m.text(o.cancelamento_hora.format_date_time()):(m.text(""),v.hide());var h=$(s.find("[template-field='executado_por']"));t?(h.find("span.txt_cancelado").html("<small>Cancelado por</small><br>"),h.find("span:not(.txt_cancelado)").text(o.usuario_cancelamento_nome)):h.find("span:not(.txt_cancelado)").text(o.executor_id?o.executor_nome:o.executor_email?o.executor_email:""),$(s.find("[template-field='observacoes']")).html(o.observacoes?nl2br(o.observacoes):"");var f=$(s.find(".div_observacoes"));o.observacoes?f.show():f.hide(),(o.observacoes||o.retorno||t)&&e++,$(s.find("[template-field='solicitado_em']")).text(o.data.format_date_time()),$("<div>").html("<b>Origem:</b>").appendTo(g),$(s.find("[template-field='solicitado_por']")).find("span").text(o.usuario_nome);var g=$('<div class="text-left" style="min-width: 180px;">');if($("<div>").html("<b>Origem:</b>").appendTo(g),o.origem_versao_processo_atividade_descricao&&$("<div>").text(o.origem_versao_processo_atividade_descricao).appendTo(g),o.usuario_nome){var b=null;o.usuario_foto_id&&(b=$('<img class="img-circle" width="20px" height="20px" src="assets/img/imagem_usuario_padrao.svg">')).attr("src",WS_URI+"documento/midia/?documento_id="+o.usuario_foto_id+"&tamanho=20&token_midia="+App.sessao.token_midia);var A=$("<div>");b&&A.append(b),A.append($("<span>").text(o.usuario_nome)),A.appendTo(g)}o.data&&$("<div>").text(o.data.format_date_time()).appendTo(g),$(s.find(".imginfo")).tooltip({title:g.html(),placement:"auto"}),s.appendTo(a)}(s)}),e>0?(c.observacao_historico.removeClass("hidden"),c.observacao_historico.text(e),c.observacao_historico.tooltip({title:"Existem observações",placement:"top"}),c.observacao_historico.tooltip()):c.observacao_historico.addClass("hidden")}},this.func_ordenacao=function(a,i){var o=c.tab_historico.find("tr:not(.hidden-xs):not([template-row])"),e=/[^a-zA-Z]/g,t=/[^0-9]/g,s=/[.](.+)/g;return $(o).sort(function(o,r){var c=$(o).find('[template-field="'+a+'"]').text().replace(s,""),d=$(r).find('[template-field="'+a+'"]').text().replace(s,"");return isNaN(parseInt(c.substr(0,3).replace(t,""),10))||isNaN(parseInt(d.substr(0,3).replace(t,""),10))||""==c.substr(0,3).replace(t,"")||""==d.substr(0,3).replace(t,"")?i?c.replace(e,"").toLowerCase().localeCompare(d.replace(e,"").toLowerCase()):d.replace(e,"").toLowerCase().localeCompare(c.replace(e,"").toLowerCase()):i?parseInt(c.replace(t,""))-parseInt(d.replace(t,"")):parseInt(d.replace(t,""))-parseInt(c.replace(t,""))})},this.byexecucao=function(a,i){return c.ordenacao.crscente_execucao?a.execucao>i.execucao?-1:1:a.execucao>i.execucao?1:-1},this.byorigem=function(a,i){return c.ordenacao.crscente_origem?a.origem>i.origem?-1:1:a.origem>i.origem?1:-1},this.render_atividades=function(){if(App.sessao.sessao_login_anonimo)return c.menu_fluxo.addClass("hidden"),void require(["./assets/view/processo/util"],function(a){(new a).atribuir_dados_elementos(c.solicitacao_atividade.solicitacao.versao_processo)});var a=c.solicitacao_atividade.solicitacao.formulario,i=[c.solicitacao_atividade.versao_processo_atividade_id];c.tipo==FORMULARIO.VISUALIZAR&&(a=c.solicitacao_atividade.solicitacao.formulario,i=[],$(c.solicitacao_atividade.solicitacao.historico).each(function(a,o){if(o.solicitacao_atividade_id>0&&o.versao_processo_atividade_id>0){var e={status:o.entrega?"concluido":"andamento",versao_processo_atividade_id:o.versao_processo_atividade_id};i.push(e)}})),require(["./assets/view/processo/util"],function(o){(new o).render_atividades(c.tab_atividades,c.solicitacao_atividade.solicitacao.versao_processo,a,null,i)})},this.mapear_obrigatorios=function(){$(c.solicitacao_atividade.formulario.grupos).each(function(a,i){$(i.elementos).each(function(i,o){if(o.tipo==ELEMENTO_TIPO.TABELA)$(o.campos).each(function(o,e){var t=c.dialog.find('[ref="'+e.elem_key+'"][set_obrigatorio]');t.length>0&&(c.solicitacao_atividade.formulario.grupos[a].elementos[i].campos[o].set_obrigatorio=$(t[0]).attr("set_obrigatorio"))});else{var e=c.dialog.find('[elem-key="'+o.elem_key+'"] [set_obrigatorio]');e.length>0&&(c.solicitacao_atividade.formulario.grupos[a].elementos[i].set_obrigatorio=$(e[0]).attr("set_obrigatorio"))}})})},this.validar_data_form=function(){var a=new Date,i=("0"+a.getDate()).slice(-2),o=("0"+(a.getMonth()+1)).slice(-2),e=a.getFullYear()+"-"+o+"-"+i,t=!0;if(c.form_editor.find('[type="date"]').each(function(a,i){var o=$(i);void 0===(o.attr("disabled")||o.attr("readonly"))&&"none"!=$(i).css("display")&&""!=i.value&&null!=i.value&&("S"==o.attr("data_retroativa")&&(get_datepicker(o)<e?(o.tooltip({title:"Data Inválida",placement:"auto"}),o.tooltip("show"),t=!1):o.tooltip("destroy")),"S"==o.attr("data_retroativa_igual")&&(get_datepicker(o)<=e?(o.tooltip({title:"Data Inválida",placement:"auto"}),o.tooltip("show"),t=!1):o.tooltip("destroy")))}),!t){var s=new Validation;s.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Data informada fora do período válido.")),alert_modal("Data Inválida.",s)}return t},this.validar_campos_obrigatorios=function(){var a=!0;return c.form_editor.find("[required]").not(".selectpicker").each(function(i,o){var e=$(o);"text"==e.attr("type")&&void 0===e.attr("maskmoney")?void 0===e.attr("readonly")&&"none"!=$(o).css("display")||($(o).hasClass("input_consulta_integracao")||$(o).hasClass("input_doc"))&&void 0===e.attr("permissao")||e.attr("permissao")==PROCESSO_ATIVIDADE_FORMULARIO_PERMISSAO.EDITAR?void 0!==e.attr("maskmoney")?""!=o.value.trim()&&0!=e.maskMoney("unmasked")[0]||(a=!1,c.alerta_campo_obrigatorio(e)):""==o.value.trim()&&(a=!1,c.alerta_campo_obrigatorio(e)):e.tooltip("destroy"):void 0===e.attr("disabled")&&"none"!=$(o).css("display")?void 0!==e.attr("maskmoney")?""===o.value.trim()&&(a=!1,c.alerta_campo_obrigatorio(e)):"date"==e.attr("type")&&void 0===e.attr("disabled")&&void 0===e.attr("readonly")?""==o.value.trim()&&(a=!1,c.alerta_campo_obrigatorio(e)):""==o.value.trim()&&"date"!=e.attr("type")&&(a=!1,c.alerta_campo_obrigatorio(e)):"editor_texto"!=e.attr("type")||tinyMCE.get(e.attr("id")).readonly||""!=get_tinymce(e).trim()?e.tooltip("destroy"):(a=!1,c.alerta_campo_obrigatorio(e.parent()))}),c.form_editor.find(".vld_lista_check").each(function(i,o){var e=$(o);if(!e[0].children[0].disabled&&"none"!==e[0].children[0].style.display){var t=e.find("input:checked");t&&0!=t.length?e.tooltip("destroy"):(a=!1,c.alerta_campo_obrigatorio(e))}}),c.form_editor.find(".vld_lista_radio").each(function(i,o){var e=$(o);if(!e[0].children[0].disabled&&"none"!==e[0].children[0].style.display){var t=e.find("input:checked");t&&0!=t.length?e.tooltip("destroy"):(a=!1,c.alerta_campo_obrigatorio(e))}}),c.form_editor.find("select.selectpicker[required]").each(function(i,o){var e=$(o);if(!e[0].disabled&&"none"!==e[0].style.display){var t=e.val();t&&0!=t.length?e.tooltip("destroy"):(a=!1,c.alerta_campo_obrigatorio(e))}}),c.form_editor.find(".div_input_arquivo [required]").each(function(i,o){var e=$(o);"none"!==e[0].style.display&&""==e.val().trim()&&void 0===e.parent().find("button").attr("disabled")&&(a=!1,c.alerta_campo_obrigatorio(e))}),$("<div>").dxButton({onClick:function(i){let o=[];for(var e=0;e<i.validationGroup.validators.length;e++){let a=i.validationGroup.validators[e];a.$element().parent().attr("view_html_id")===c.html_id&&(o.push(i.validationGroup.validators[e]),a.option("adapter").editor.option("readOnly")&&a.option("validationRules",[]))}i.validationGroup.validators=o,i.validationGroup.validators.length&&(i.validationGroup.validate().isValid||(a=!1))}}).click(),a||alertaPopUp("Validação","Preencha o(s) campo(s) obrigatório(s)",null,null,null,null,"500px"),a},this.alerta_campo_obrigatorio=function(a,i){a.tooltip({title:"Campo obrigatorio",placement:void 0!==i?i:"auto"}),a.tooltip("show")},this.existe_projeto=function(){if(!c.versao_solicitacao_atividade.acao_projeto_template||null!=c.solicitacao_atividade.projeto_id&&""!=c.solicitacao_atividade.projeto_id)return!0;var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"É obrigatório vincular um projeto na atividade!")),alert_modal("Validação",a),!1},this.salvar=function(a,i){require(["./assets/view/formulario/util"],function(o){var e=new o;void 0!==c.solicitacao_atividade&&void 0!==c.solicitacao_atividade.formulario&&e.persistir_styles(c,c.solicitacao_atividade.formulario),c.mapear_obrigatorios();for(var t={solicitacao_atividade_id:c.solicitacao_atividade.id,formulario:JSON.stringify(c.solicitacao_atividade.formulario),formulario_solicitacao:JSON.stringify(c.solicitacao_atividade.solicitacao.formulario),acao:i?SOLICITACAO_ATIVIDADE_ACAO.SALVAR_CANCELAR:SOLICITACAO_ATIVIDADE_ACAO.SALVAR,observacoes:c.edt_observacoes.val(),projeto_id:c.solicitacao_atividade.projeto_id,cliente_id:c.cliente_id,usuario_id:c.cbo_usuarios.val(),documento_pasta_id:c.documento_pasta_id,edicao_cabecalho:c.liberar_campos,etiquetas:c.etiquetas?JSON.stringify(c.etiquetas):null},s=c.tipo==FORMULARIO.VISUALIZAR||null!==c.solicitacao_atividade.entrega||"S"==c.solicitacao_atividade.cancelada||null!==c.solicitacao_atividade.cancelamento_hora_atividade?c.solicitacao_atividade.solicitacao.formulario:c.solicitacao_atividade.formulario,r=0;r<s.grupos.length;r++){var d=s.grupos[r];if(d.elementos)for(var l=0;l<d.elementos.length;l++){var n=d.elementos[l];if(n.tipo==ELEMENTO_TIPO.ANEXO&&n.anexo)t[n.elem_key]=n.anexo,App.is_nativo()&&(c.anexos.push(n.anexo),c.elem_keys.push(n.elem_key));else if(n.tipo==ELEMENTO_TIPO.TABELA&&n.valor)for(var _=n.valor,p=0;p<_.length;p++)_[p].anexo&&(t[_[p].elem_key+"_linha_"+_[p].linha]=_[p].anexo)}}WS.post("solicitacao/salvar",t,function(i){c.dados_modificados=!1,alert_saved(c.versao_solicitacao_atividade.descricao+" salvo com sucesso"),a&&a()},null,null,!0)})},this.salva_envia=function(){if(!c.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao&&"S"!=c.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao||c.documento_pasta_id){if(""==c.div_component_cbo_clientes.find(".edt_combobox").val()&&(c.cliente_id=null),c.existe_projeto()&&c.validar_campos_obrigatorios()&&c.validar_data_form()){var a=function(){c.mapear_obrigatorios(),require(["./assets/view/formulario/util"],function(a){var i=new a;void 0!==c.solicitacao_atividade&&void 0!==c.solicitacao_atividade.formulario&&i.persistir_styles(c,c.solicitacao_atividade.formulario),View.load("solicitacao/enviar",function(a,i){i.onconfirm=function(){App.sessao.sessao_login_anonimo?App.logout_anonimo():(c.dados_modificados=!1,alert_saved(c.versao_solicitacao_atividade.descricao+" salvo com sucesso"),c.unload())},i.show(c.solicitacao_atividade,c.versao_solicitacao_atividade,c.solicitacao_atividade.solicitacao.versao_processo.elementos,c.edt_observacoes.val(),c.cliente_id,c.form_grupos,c.cbo_usuarios.val(),c.documento_pasta_id,c)})})};if(App.PE.Solicitacao_Atividade_Salvar_Enviar_Antes)try{App.PE.Solicitacao_Atividade_Salvar_Enviar_Antes(c,a)}catch(a){console.log(a)}else a()}}else alert_modal("Atenção","Escolha uma pasta para armazenar os anexos da solicitação.","OK",function(){$("html, body").stop().animate({scrollTop:0},500,"swing",function(){c.div_seleciona_pasta.effect("shake")})})},this.edt_observacoes.keyup(function(){msg_count(c.edt_observacoes,c.contador_obs,5e3),c.dados_modificados=!0}),this.th_execucao.unbind("click"),this.th_execucao.click(function(){c.tab_historico.find("th").find("span").remove(),c.ordenacao.crscente_execucao?(c.ordenacao.crscente_execucao=!1,c.th_execucao.append('<span class="glyphicon glyphicon-arrow-up"></span>')):(c.ordenacao.crscente_execucao=!0,c.th_execucao.append('<span class="glyphicon glyphicon-arrow-down"></span>'));var a=c.func_ordenacao("executado_em",c.ordenacao.crscente_execucao);$(a).detach().appendTo(c.tab_historico)}),this.th_origem.unbind("click"),this.th_origem.click(function(){c.tab_historico.find("th").find("span").remove(),c.ordenacao.crscente_origem?(c.ordenacao.crscente_origem=!1,c.th_origem.append('<span class="glyphicon glyphicon-arrow-up"></span>')):(c.ordenacao.crscente_origem=!0,c.th_origem.append('<span class="glyphicon glyphicon-arrow-down"></span>'));var a=c.func_ordenacao("solicitado_em",c.ordenacao.crscente_origem);$(a).detach().appendTo(c.tab_historico)}),this.salvarClick=function(){setTimeout(function(){c.validar_data_form()&&c.salvar(c.atualizar_listagens)},2e3)},this.salvarSairClick=function(a){setTimeout(function(){c.validar_data_form()&&c.salvar(function(){a&&"function"==typeof a?a():c.unload()})},2e3)},this.handleAlterarProjetoVinculado=function(a,i){const o=()=>{c.solicitacao_atividade.projeto=i,c.solicitacao_atividade.projeto_id=a,c.solicitacao_atividade.cliente_id=i.cliente_id,c.salvar();let o=(null!==i.porcentagem_concluido?i.porcentagem_concluido:0)+"%";parseInt(i.porcentagem_concluido)<c.versao_solicitacao_atividade.acao_projeto_template_conclusao?(c.processoDetalharMenuProps.projetoVinculadoPendente=!0,c.processoDetalharMenuProps.PorcentagemConcluido=o,c.processoDetalharMenuProps.PorcentagemNecessario=c.versao_solicitacao_atividade.acao_projeto_template_conclusao+"%"):c.processoDetalharMenuProps.projetoVinculadoPendente=!1,c.processoDetalharMenuProps.ProjetoID=i.id,c.processoDetalharMenuProps.ProjetoTemplate=i.template,c.renderProcessoDetalharMenu(),alert_saved("Projeto vinculado com sucesso")};+c.solicitacao_atividade.projeto_id>0?+c.solicitacao_atividade.projeto_id!=+a&&alertaPopUp("Validação","Já existe um projeto vinculado à esta atividade. Deseja substituir o projeto atualmente vinculado?","Sim",()=>{o()},"Não",()=>{}):o()},this.download_pdf=function(){var a=function(){var a=1;App.temp.empresa&&(a=App.temp.empresa),c.tipo==FORMULARIO.VISUALIZAR?App.obter_token_publico(function(i){WS.post("solicitacao/gerar_pdf_solicitacao",{solicitacao_id:c.solicitacao_atividade.solicitacao_id,empresa_filial_id:a,token_publico:i},function(a){download_arquivo(a.file,a.name)})}):App.obter_token_publico(function(i){WS.post("solicitacao/gerar_pdf_solicitacao_atividade",{solicitacao_atividade_id:c.solicitacao_atividade.id,empresa_filial_id:a,token_publico:i},function(a){download_arquivo(a.file,a.name)})})};c.solicitacao_atividade.situacao!=SOLICITACAO_STATUS.ATIVIDADE_ANDAMENTO&&c.solicitacao_atividade.situacao!=SOLICITACAO_STATUS.ATIVIDADE_ATRASADA||c.tipo==FORMULARIO.VISUALIZAR?a():c.salvar(function(){a()})},this.download_template=function(){const a={solicitacaoId:c.solicitacao_atividade.solicitacao_id,numero:c.solicitacao_atividade.numero,numeroSolicitacaoPorProcesso:c.solicitacao_atividade.numero_solicitacao_por_processo,solicitacaoAtividadeId:c.tipo==FORMULARIO.VISUALIZAR?null:c.solicitacao_atividade.id};View.loadReact(window.views.solicitacao_template_word.SolicitacaoTemplateWordListagem.default,a,a=>{},View.ABA.SIM)},this.imprimir_pdf=function(){if(App.PE.Imprimir_Formulario_Solicitacao)App.PE.Imprimir_Formulario_Solicitacao(c);else{var a=[],i=c.dialog.find(".div_topo").clone(),o=c.dialog.find(".aba_formulario").clone();i.find(".div_dropdown_etiquetas").remove();var e=o.find("select");$(e).each(function(a){let i=$(c.dialog.find(".aba_formulario").find("select")).eq(a).val();o.find("select").eq(a).val(i)}),o.find(".dx-texteditor-input").addClass("form-control"),o.find(".dx-dropdowneditor-overlay").remove(),a.push(i),a.push(o),imprimir_div(!0,a)}},this.download_todos_anexos=function(){App.obter_token_publico(function(a){App.download(WS_URI+"solicitacao/download/?solicitacao_atividade_id="+c.solicitacao_atividade.id+"&token_publico="+a)})},this.habilitar_edicao_campos=function(){c.processoDetalharMenuProps.Salvar="",c.processoDetalharMenuProps.SalvarSair="",c.processoDetalharMenuProps.CamposHabilitados=!0,c.renderProcessoDetalharMenu(),c.liberar_campos=!0,c.render_formulario()},this.setDisplayDownloadTodosAnexos=function(){for(var a=0;a<c.solicitacao_atividade.formulario.grupos.length;a++){var i=c.solicitacao_atividade.formulario.grupos[a];if(i.elementos)for(var o=0;o<i.elementos.length;o++){var e=i.elementos[o];if(e.tipo==ELEMENTO_TIPO.ANEXO&&e.valor)return void(c.processoDetalharMenuProps.DownloadTodosAnexos="")}}},this.retornarClick=function(){View.load("solicitacao/retornar",function(a,i){i.show(function(){alert_saved(c.versao_solicitacao_atividade.descricao+" retornou com sucesso"),c.unload()},c.solicitacao_atividade,c.versao_solicitacao_atividade,c.solicitacao_atividade.solicitacao.versao_processo.elementos,c.edt_observacoes.val(),d)})},this.btn_pesquisa_cliente.unbind("click"),this.btn_pesquisa_cliente.click(function(){View.load("cliente/selecionar",function(a,i){i.show(function(a){c.edt_cliente.val(a.nome_fantasia),c.cliente_id=a.cliente_id,c.nome_cliente=a.nome_fantasia,c.listar_filtro_usuarios(c.cliente_id)})})}),this.cancelar_solicitacaoClick=function(){c.salvar(function(){View.load("solicitacao/cancelar",function(a,i){i.show(function(){c.unload()},c.solicitacao_atividade)})},!0)},this.reabrir_solicitacaoClick=function(){WS.post("solicitacao/reabrir",{solicitacao_id:c.solicitacao_atividade.solicitacao_id},function(){alert_saved("Solicitação #"+c.solicitacao_atividade.solicitacao_id+" reaberta com sucesso"),c.unload(),c.onconfirm&&c.onconfirm()})},this.novo_chamado=function(){var a=c.solicitacao_atividade.solicitacao_id;"S"==c.solicitacao_atividade.numero_solicitacao_por_processo&&(a=c.solicitacao_atividade.numero);var i="Solicitação #"+a+" - "+c.solicitacao_atividade.solicitacao.versao_processo.nome,o={width:400,height:200,contentTemplate:function(){return $("<div />").append($("<div />").addClass("button-info").dxButton({text:"Somente com esta atividade",hint:c.versao_solicitacao_atividade.descricao,width:"100%",onClick:function(){t(c.solicitacao_atividade.solicitacao_id,c.solicitacao_atividade.id,i),e.hide()}}),$("<br />"),$("<div />").addClass("button-info").dxButton({text:"Com a solicitação #"+a,hint:c.solicitacao_atividade.solicitacao.versao_processo.nome,width:"100%",onClick:function(){t(c.solicitacao_atividade.solicitacao_id,null,i),e.hide()}}),$("<hr />"),$("<div />").addClass("button-info").dxButton({text:"Cancelar",width:"100%",onClick:function(){e.hide()}}))},showTitle:!0,title:"Referenciar novo chamado",visible:!1,dragEnabled:!1,hideOnOutsideClick:!0},e=$("<div/>").appendTo(c.dialog).dxPopup(o).dxPopup("instance");e.show();var t=function(a,i,o){+i>0&&(o+=" - "+c.versao_solicitacao_atividade.descricao);var e="";const t=a=>{e=""!=e?e+";"+a.email:a.email};"object"==typeof c.solicitacao_atividade.usuarios_responsaveis_atividade&&c.solicitacao_atividade.usuarios_responsaveis_atividade.length>0?c.solicitacao_atividade.usuarios_responsaveis_atividade.forEach(t):c.versao_solicitacao_atividade.todos_usuarios_responsaveis.forEach(t),View.loadReact(window.views.chamado.Detalhes.default,{onClose:c.atualizar_listagens,solicitacaoAtividadeId:i,solicitacaoId:a,entidadeId:c.cliente_id?c.cliente_id:App.sessao.dados.empresa_filial_id,entidadeTipo:c.cliente_id?TIPO_ENTIDADE.CLIENTE:TIPO_ENTIDADE.EMPRESA,assunto:o,emails:e},function(a,i){},View.ABA.MULTIPLAS)}},this.listar_filtro_usuarios=function(a){App.sessao.sessao_login_anonimo||(c.cbo_usuarios.find("option").remove(),WS.get("usuario/listar_por_cliente/",{cliente_id:a},function(a){for(var i=0;i<a.length;i++){var o=a[i];add_option(c.cbo_usuarios,o.id,o.nome)}c.cbo_usuarios.selectpicker("refresh"),c.callback_clientes.fire()}))},this.render_usuarios_por_cliente=function(){WS.get("solicitacao/usuario_acompanha/",{solicitacao_id:c.solicitacao_atividade.solicitacao_id},function(a){for(var i=c.cbo_usuarios.find("option"),o=!1,e=0;e<i.length;e++)a.filter(function(a){return a.usuario_id==i[e].value&&($(i[e]).attr("selected",!0),o=!0),o});c.cbo_usuarios.selectpicker("refresh")})},this.reprogramarClick=function(){View.load("solicitacao/reprogramar_prazo",function(a,i){i.show(function(a){c.solicitacao_atividade.tempo_restante=a.tempo_restante,c.solicitacao_atividade.percentual=a.percentual,c.solicitacao_atividade.diff_datas=a.diff_datas,c.solicitacao_atividade.prazo_execucao=a.prazo_execucao,c.atualizar_progress(),c.show(c.solicitacao_atividade.id,c.tipo)},c.solicitacao_atividade.id)})},this.alterar_responsavelClick=function(){c.salvar(function(){View.load("solicitacao/alterar_responsavel",function(a,i){i.show(function(a){c.solicitacao_atividade.responsavel_id=a.responsavel_id,c.solicitacao_atividade.grupo_usuarios_responsaveis_id=a.grupo_usuarios_responsaveis_id,App.sessao.dados.admin||"S"==c.solicitacao_atividade.solicitacao.acesso_supervisor.supervisor_processo?c.show(c.solicitacao_atividade.id,c.tipo):c.unload()},c.solicitacao_atividade.id,c.versao_solicitacao_atividade.todos_usuarios_responsaveis,c.solicitacao_atividade.responsavel_id,c.versao_solicitacao_atividade.grupos_usuarios_responsaveis,c.solicitacao_atividade.grupo_usuarios_responsaveis_id,c.versao_atividade_tipo,c.versao_solicitacao_atividade.usuarios_responsaveis,c.versao_solicitacao_atividade.grupos_usuarios_responsaveis,c.solicitacao_atividade.multiplos_responsaveis)})})},this.ValidarAssumirDesvincular=function(a){c.solicitacao_atividade.responsavel_id=a.responsavel_id,c.solicitacao_atividade.responsavel_nome=a.responsavel_nome,c.solicitacao_atividade.grupo_usuarios_responsaveis_id=a.grupo_usuarios_responsaveis_id,c.solicitacao_atividade.solicitacao.historico=a.solicitacao.historico,c.solicitacao_atividade.responsavel_id.length&&c.solicitacao_atividade.responsavel_id.includes(App.sessao.dados.usuario_id.toString())?(c.processoDetalharMenuProps.AssumirAtividade="hidden",c.processoDetalharMenuProps.DesvincularResponsabilidade="",void 0!==a.responsavel_falha&&!0===a.responsavel_falha||alert_saved("Alteração realizada com sucesso!")):c.solicitacao_atividade.responsavel_id.length?(c.processoDetalharMenuProps.AssumirAtividade="hidden",c.processoDetalharMenuProps.DesvincularResponsabilidade="hidden"):(c.processoDetalharMenuProps.AssumirAtividade="",c.processoDetalharMenuProps.DesvincularResponsabilidade="hidden",void 0!==a.responsavel_falha&&!0===a.responsavel_falha||alert_saved("Alteração realizada com sucesso!")),c.solicitacao_atividade.responsavel_nome?(c.lbl_usuario_responsavel_atividade_nome.text(c.solicitacao_atividade.responsavel_nome),c.div_usuario_responsavel_atividade_nome.show()):c.div_usuario_responsavel_atividade_nome.hide(),c.render_historico(),c.renderProcessoDetalharMenu()},this.AssumirAtividadeClick=function(){WS.post({route:"solicitacao/set_responsavel",data:{solicitacao_atividade_id:c.solicitacao_atividade.id,responsavel_id:App.sessao.dados.usuario_id,grupo_usuarios_responsaveis_id:null,ignorar_se_existir_responsavel:!0},func_response:function(a){c.ValidarAssumirDesvincular(a),void 0!==a.responsavel_falha&&1==a.responsavel_falha&&alert_modal("Ação inválida","Não foi possível assumir. <b>"+a.responsavel_nome+"</b> já o assumiu.")}})},this.DesvincularResponsabilidadeClick=function(){WS.post("solicitacao/set_responsavel",{solicitacao_atividade_id:c.solicitacao_atividade.id,responsavel_id:null,grupo_usuarios_responsaveis_id:null,ignorar_se_existir_responsavel:!0},function(a){c.ValidarAssumirDesvincular(a),void 0!==a.responsavel_falha&&1==a.responsavel_falha&&alert_modal("Ação inválida","Não foi possível desvincular. <b>"+a.responsavel_nome+"</b> é o responsável atual.")})},this.cancelarClick=function(){c.unload()},this.nova_solicitacao=function(){View.load("solicitacao/nova",function(a,i){var o={solicitacao_id:c.solicitacao_atividade.solicitacao_id,solicitacao_atividade_id:c.solicitacao_atividade.id};i.onclose=function(){c.atualizar_listagens()},i.show(o)})},this.menu_fluxo.unbind("click").click(function(){!c.menu_fluxo.parent().hasClass("active")&&c.renderizar_atividades&&(c.renderizar_atividades=!1,c.render_atividades())}),this.menu_diagrama.unbind("click").click(function(){!c.menu_diagrama.parent().hasClass("active")&&c.diagramFirstLoad&&(c.diagramFirstLoad=!1,c.render_diagrama())}),this.menu_referencias_solicitacao.unbind("click").click(function(){App.sessao.sessao_login_anonimo||c.menu_referencias_solicitacao.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(c.div_componente_referencias_solicitacao[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"solicitacao",id:c.solicitacao_atividade.solicitacao_id,documentoPastaId:c.documento_pasta_id}),c.div_componente_referencias_solicitacao[0]))}),this.menu_referencias_atividade.unbind("click").click(function(){App.sessao.sessao_login_anonimo||c.menu_referencias_atividade.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(c.div_componente_referencias_atividade[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"solicitacao_atividade",id:c.solicitacao_atividade.id,documentoPastaId:c.documento_pasta_id}),c.div_componente_referencias_atividade[0]))}),this.atualizar_listagens=function(){var a;a=c.solicitacao_atividade.formulario,WS.get("solicitacao/objeto/",{solicitacao_atividade_id:c.solicitacao_atividade.id,tipo_visualizacao:c.tipo},function(i){c.solicitacao_atividade=i,c.solicitacao_atividade.formulario=a,c.arr_ignorar=[],c.arr_ignorar.push(c.solicitacao_atividade.solicitacao_id),c.render_historico()})},this.render_diagrama=function(){App.sessao.sessao_login_anonimo?c.menu_diagrama.addClass("hidden"):require(["./assets/view/processo/util"],function(a){var i=new a,o=[],e=[];i.gerar_elem_key(c.solicitacao_atividade.solicitacao.versao_processo,o,e),setTimeout(()=>{const a={nodesDataSource:o,edgesDataSource:e,diagramDataSource:c.solicitacao_atividade.solicitacao.versao_processo.diagrama};ReactDOM.render(React.createElement(window.components.ProcessoDiagram.default,a),c.div_diagrama[0])})})},this.renderProcessoDetalharMenu=function(){i.unmountComponentAtNode(c.detalharMenu[0]),c.processoDetalharMenu=a.createElement(o,c.processoDetalharMenuProps),i.render(c.processoDetalharMenu,c.detalharMenu[0])},this.renderDropDownEtiquetas=function(){ReactDOM.unmountComponentAtNode(c.div_dropdown_etiquetas[0]);let a=[];try{a=c.solicitacao_atividade.solicitacao.etiquetas}catch(i){a=[]}const i="hidden"===c.processoDetalharMenuProps.Salvar;ReactDOM.render(React.createElement(window.components.DropDownEtiquetas.default,{pai_tabela:"processo",pai_id:c.solicitacao_atividade.processo_id,selecionados:a.map(a=>a.etiqueta_id),onValueChanged:a=>{c.etiquetas=a},readOnly:i}),c.div_dropdown_etiquetas[0])},$(document).scroll(function(){c.floating.css("top",$(this).scrollTop())})}});