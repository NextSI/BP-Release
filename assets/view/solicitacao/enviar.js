define(["react","react-dom","./../formulario/util"],function(amdReact,amdReactDOM,formulario_util){var Solicitacao_Enviar=function(html_id){"use strict";var main=this;this.html_id=html_id,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.onconfirm=null,this.onclose=null,this.onprojeto=null,this.lbl_nome_atividade=this.dialog.find(".lbl_nome_atividade"),this.div_email_terceiro_entrega=this.dialog.find(".div_email_terceiro_entrega"),this.edt_email_terceiro_entrega=this.dialog.find(".edt_email_terceiro_entrega"),this.div_acao_projeto_template=this.dialog.find(".div_acao_projeto_template"),this.btn_acao_projeto_template_novo=this.dialog.find(".btn_acao_projeto_template_novo"),this.div_acao_projeto_template_criar_novo=this.dialog.find(".div_acao_projeto_template_criar_novo"),this.div_acao_projeto_template_detalhes=this.dialog.find(".div_acao_projeto_template_detalhes"),this.lbl_acao_projeto_template_codigo=this.dialog.find(".lbl_acao_projeto_template_codigo"),this.lbl_acao_projeto_template_nome=this.dialog.find(".lbl_acao_projeto_template_nome"),this.lbl_acao_projeto_template_cliente=this.dialog.find(".lbl_acao_projeto_template_cliente"),this.body_default=this.dialog.find(".body_default"),this.div_solicitacao_salva=this.dialog.find(".div_solicitacao_salva"),this.btns_default=this.dialog.find(".btns_default"),this.num_solicitacao=this.dialog.find(".num_solicitacao"),this.desc_processo=this.dialog.find(".desc_processo"),this.nome_atividade=this.dialog.find(".nome_atividade"),this.div_atividade_concluida=this.dialog.find(".div_atividade_concluida"),this.btn_download_form=this.dialog.find(".btn_download_form"),this.btn_ok=this.dialog.find(".btn_ok"),this.lbl_proximas_atividades=this.dialog.find(".lbl_proximas_atividades"),this.lbl_nenhuma_atividade=this.dialog.find(".lbl_nenhuma_atividade"),this.list_destinos=this.dialog.find(".list_destinos"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.dx_listagem=this.dialog.find(".dx_listagem"),this.solicitacao_atividade="",this.formulario=null,this.descricao="",this.observacoes="",this.arr_usuarios=[],this.arr_grupo_usuarios=[],this.atividade=null,this.arr_elementos=null,this.arr_destinos=[],this.arr_destinos_enviar=[],this.cliente_id=null,this.tipo_prazo_execucao=null,this.atividades_pendentes_gateway=!0,this.anexos=[],this.elem_keys=[],this.form_grupos=null,this.email_terceiros_entrega=!1,this.usuario_acompanhamento=null,this.documento_pasta_id=null,this.nivel_gateway=0,this.show=function(e,i,a,o,t,n,s,r,_){main.lbl_nome_atividade.html("Entrega de Atividade: <b>"+i.descricao+"</b>"),main.documento_pasta_id=r,main.div_formulario=_,main.email_terceiros_entrega=i.email_terceiros_entrega,main.form_grupos=n,main.btn_confirmar.hide(),main.usuario_acompanhamento=s,main.solicitacao_atividade=e,main.formulario=e.formulario,main.cliente_id=t,main.disparar_eventos_gateway_destino(i),show_modal(main.modal.attr("id")),main.atividade=i,main.arr_elementos=a,main.observacoes=o,$(i.destinos).each(function(e,i){$(a).each(function(e,a){a.opcional=i.opcional,a.id==i.id&&a.elemento_tipo==i.elemento_tipo&&main.arr_destinos.push(a)})}),main.render_acoes(),main.listar()},this.close=function(){close_modal(main.modal.attr("id")),void 0!==main.onclose&&main.onclose&&main.onclose()},this.unload=function(){main.close(),View.unload(this.html_id)},this.listar=function(){View.loadPE("Solicitacao_Atividade_Enviar",main,main.render_lista)},this.disparar_eventos_gateway_destino=function(atividade_atual,ignore){var elementos=main.solicitacao_atividade.solicitacao.versao_processo.elementos,array_elementos={};$(main.form_grupos.find("[id_elemento]")).each(function(e,i){array_elementos[$(i).attr("id_elemento")]=$(main.form_grupos.find('[id_elemento="'+$(i).attr("id_elemento")+'"]'))}),atividade_atual&&$(atividade_atual.destinos).each(function(i,destinos){(ignore||parseInt(destinos.elemento_tipo,10))&&(parseInt(destinos.tipo,10)!=PROCESSO_GATEWAY_TIPO.EXCLUSIVO&&parseInt(destinos.tipo,10)!=PROCESSO_GATEWAY_TIPO.INCLUSIVO||elementos&&$(elementos).each(function(j,versao_elemento){if(destinos.id==versao_elemento.id&&parseInt(destinos.elemento_tipo,10)==parseInt(versao_elemento.elemento_tipo,10)&&parseInt(destinos.tipo,10)==parseInt(versao_elemento.tipo,10)){if(!0===ignore&&destinos.evento_enviar){var array_prop=[],campos={},key_function=md5(new Date+j);key_function="_"+key_function+"_";var execute="campos."+key_function+" = function () {\n",erro_formulario=!1,str_campos="";for(var prop in execute+=destinos.evento_enviar,null!=execute&&(str_campos+="var obj_solicitacao = main.solicitacao_atividade; ",str_campos+="var _formulario_util = (new formulario_util); var get_valor = _formulario_util.get_valor; _formulario_util.div_formulario = main.div_formulario; var get_totalizador = _formulario_util.get_totalizador;"),array_elementos)if(void 0!==prop&&"undefined"!=prop&&""!=prop)if(isNaN(prop[0]))str_campos+="var "+prop+' = array_elementos["'+prop+'"]; ';else if(campos["elemento_html_"+prop]=$(array_elementos[prop]),null!=execute&&void 0!==execute&&execute.indexOf(prop)>-1){if(array_prop.push(prop),new RegExp("var\\s*\\b"+prop+"\\b").test(execute)){alert_modal("Atenção","A variável <strong>"+prop+"</strong> já existe, favor verificar","OK",null,!0),erro_formulario=!0;break}new RegExp("\\b"+prop+"\\b").test(execute)&&(execute=execute.split(new RegExp("\\b"+prop+"\\b")).join("campos.elemento_html_"+prop))}execute=str_campos+"\n\n\n"+execute+"\n};";try{eval(execute)}catch(e){console.log(e)}$(elementos).each(function(e,i){atividade_atual.id==i.id&&parseInt(atividade_atual.elemento_tipo,10)==parseInt(i.elemento_tipo,10)&&parseInt(atividade_atual.tipo,10)==parseInt(i.tipo,10)&&$(main.solicitacao_atividade.solicitacao.versao_processo.elementos[e].destinos).each(function(i,a){a.id==destinos.id&&parseInt(a.elemento_tipo,10)==parseInt(destinos.elemento_tipo,10)&&parseInt(a.tipo,10)==parseInt(destinos.tipo,10)&&(main.solicitacao_atividade.solicitacao.versao_processo.elementos[e].destinos[i].retorno_evento=campos[key_function](),!0===main.solicitacao_atividade.solicitacao.versao_processo.elementos[e].destinos[i].retorno_evento&&parseInt(a.elemento_tipo,10)==PROCESSO_ELEMENTO_TIPO.GATEWAY&&parseInt(a.tipo,10)==PROCESSO_GATEWAY_TIPO.EXCLUSIVO&&$(elementos).each(function(e,i){i.id==a.id&&parseInt(i.elemento_tipo,10)==parseInt(a.elemento_tipo,10)&&parseInt(i.tipo,10)==parseInt(a.tipo,10)&&main.disparar_eventos_gateway_destino(i,!0)}))})})}!ignore&&versao_elemento.destinos&&$(versao_elemento.destinos).each(function(key,gateway_destino){if(gateway_destino.evento_enviar||gateway_destino.filtro_evento_enviar){var array_prop=[],campos={},key_function=md5(new Date+key+i+j);key_function="_"+key_function+"_";var execute="campos."+key_function+" = function () {\n",str_campos="";for(var prop in App.form_debugger&&(str_campos="debugger;\n"),execute+=gateway_destino.tipo_automacao==GATEWAY_DESTINO_EVENTO_TIPO_AUTOMACAO.JAVASCRIPT?gateway_destino.evento_enviar:gateway_destino.tipo_automacao==GATEWAY_DESTINO_EVENTO_TIPO_AUTOMACAO.CONSTRUTOR_FILTROS?"return "+localizar_condicao(JSON.parse(gateway_destino.filtro_evento_enviar))+";":null,null!=execute&&(str_campos+="var obj_solicitacao = main.solicitacao_atividade; ",str_campos+="var _formulario_util = (new formulario_util); var get_valor = _formulario_util.get_valor; _formulario_util.div_formulario = main.div_formulario; var get_totalizador = _formulario_util.get_totalizador;"),array_elementos)void 0!==prop&&"undefined"!=prop&&""!=prop&&(isNaN(prop[0])?str_campos+="var "+prop+' = array_elementos["'+prop+'"]; ':(campos["elemento_html_"+prop]=$(array_elementos[prop]),null!=execute&&void 0!==execute&&execute.indexOf(prop)>-1&&(array_prop.push(prop),-1==execute.indexOf("campos.elemento_html_"+prop)&&(execute=execute.split(prop).join("campos.elemento_html_"+prop)))));execute=str_campos+"\n\n\n"+execute+"\n};";try{eval(execute),main.solicitacao_atividade.solicitacao.versao_processo.elementos[j].destinos[key].retorno_evento=campos[key_function]()}catch(e){main.solicitacao_atividade.solicitacao.versao_processo.elementos[j].destinos[key].retorno_evento=!1,console.log(e)}!0===main.solicitacao_atividade.solicitacao.versao_processo.elementos[j].destinos[key].retorno_evento&&parseInt(gateway_destino.elemento_tipo,10)==PROCESSO_ELEMENTO_TIPO.GATEWAY&&parseInt(gateway_destino.tipo,10)==PROCESSO_GATEWAY_TIPO.EXCLUSIVO&&$(elementos).each(function(e,i){i.id==gateway_destino.id&&parseInt(i.elemento_tipo,10)==parseInt(gateway_destino.elemento_tipo,10)&&parseInt(i.tipo,10)==parseInt(gateway_destino.tipo,10)&&main.disparar_eventos_gateway_destino(i,!0)})}})}}))})},this.consultar_situacao_gateway=function(e,i){main.atividades_pendentes_gateway=!0,main.nivel_gateway++;var a={versao_processo_gateway_id:i,solicitacao_id:main.solicitacao_atividade.solicitacao_id,solicitacao_atividade_versao_processo_atividade_id:main.solicitacao_atividade.versao_processo_atividade_id,destinos:JSON.stringify(main.arr_destinos_enviar),solicitacao_atividade_id:main.solicitacao_atividade.id,contar_gateway:main.nivel_gateway>1};WS.post("solicitacao/consultar_situacao_gateway/",a,function(i){main.atividades_pendentes_gateway=i.atividades_pendentes,e&&e()},[main.btn_confirmar])},this.render_acoes=function(){main.atividade.acao_projeto_template&&main.div_acao_projeto_template.show(),main.solicitacao_atividade.projeto_id?(main.btn_acao_projeto_template_novo.addClass("btn-default"),main.btn_acao_projeto_template_novo.removeClass("btn-primary"),main.btn_acao_projeto_template_novo.show(),main.div_acao_projeto_template_criar_novo.hide(),main.div_acao_projeto_template_detalhes.show(),main.lbl_acao_projeto_template_codigo.text(main.solicitacao_atividade.projeto.codigo),main.lbl_acao_projeto_template_nome.text(main.solicitacao_atividade.projeto.nome),main.lbl_acao_projeto_template_cliente.text(main.solicitacao_atividade.projeto.cliente_nome)):(main.btn_acao_projeto_template_novo.addClass("btn-primary"),main.btn_acao_projeto_template_novo.removeClass("btn-default"),main.btn_acao_projeto_template_novo.show(),main.div_acao_projeto_template_criar_novo.show(),main.div_acao_projeto_template_detalhes.hide())},this.render_lista=function(){var e=main.dialog.find("[template-item]"),i=function(a,o,t){var n=e.clone();n.removeAttr("template-item"),n.css("display",""),void 0!==t&&(o.envio_key=t);var s=elem_key_random();main.arr_destinos_enviar.push(o);var r=main.arr_destinos_enviar.length-1,_=$(n.find(".div_destinos"));$(n.find(".lbl_elemento_sequencia")).text(o.sequencia),$(n.find(".lbl_elemento_descricao")).text(o.descricao);var l=$(n.find(".lbl_elemento_tipo"));if(l.text(str_processo_elemento_tipo(o.elemento_tipo,o.tipo)),o.elemento_tipo==PROCESSO_ELEMENTO_TIPO.ATIVIDADE)switch(parseInt(o.tipo,10)){case PROCESSO_ATIVIDADE_TIPO.NORMAL:l.addClass("label-info");break;case PROCESSO_ATIVIDADE_TIPO.INICIO:l.addClass("label-success");break;case PROCESSO_ATIVIDADE_TIPO.FIM:l.addClass("label-danger")}else o.elemento_tipo==PROCESSO_ELEMENTO_TIPO.GATEWAY&&l.addClass("label-warning");var d=!(!0===o.opcional),c=void 0===o.retorno_evento?d:o.retorno_evento;if(!0===o.filho_de_gateway_inclusivo){var m=1==o.pai_bloqueio_decisao||"S"==o.pai_bloqueio_decisao,p=n.find(".chk_elemento_opcional");main.arr_destinos_enviar[r].opcional_enviar=c,p.attr("type","checkbox").addClass("checkbox_bootstrap_toggle").removeClass("hidden"),setTimeout(function(){p.on("change",function(){var e=$(this).prop("checked");main.arr_destinos_enviar[r].opcional_enviar=e,o.elemento_tipo==PROCESSO_ELEMENTO_TIPO.GATEWAY&&o.tipo==PROCESSO_GATEWAY_TIPO.EXCLUSIVO?e?A.selectpicker("show"):(A.selectpicker("val",null).trigger("change"),A.selectpicker("hide")):o.elemento_tipo!=PROCESSO_ELEMENTO_TIPO.GATEWAY||o.tipo!=PROCESSO_GATEWAY_TIPO.INCLUSIVO&&o.tipo!=PROCESSO_GATEWAY_TIPO.PARALELO||(e?w():I($(_).attr("temp_elem_key")))}),p.prop("checked",c).trigger("change"),disable_checkBox(p,m||!1===o.opcional)})}parseInt(o.elemento_tipo,10)!=PROCESSO_ELEMENTO_TIPO.ATIVIDADE&&main.disparar_eventos_gateway_destino(o),main.arr_destinos_enviar[r].data_obrigatoria=!1,main.arr_destinos_enviar[r].dia_prazo_execucao=null;var u=$(n.find(".div_previsao_retorno")),v=$(n.find(".edt_prazo"));o.tipo_prazo_execucao==SOLICITACAO_TIPO_HORA.DATA_PRDECESSORA&&(u.removeClass("hidden"),v.dxDateBox({type:"date",useMaskBehavior:!0,applyValueMode:"useButtons",min:new Date,onValueChanged:function(e){main.arr_destinos_enviar[r].dia_prazo_execucao=formatDate(e.value,!0)}}),main.arr_destinos_enviar[r].data_obrigatoria=!0);var f=$(n.find(".div_elemento_responsavel")),h=$(n.find(".dropdown_responsavel"));(f.hide(),!0===o.responsavel_obrigatorio||!0===o.multiplos_responsaveis)&&(o.todos_usuarios_responsaveis&&(main.arr_usuarios=[],$(o.usuarios_responsaveis).each(function(e,i){main.arr_usuarios.push(i.usuario_id)}),main.arr_grupo_usuarios=[],$(o.grupos_usuarios_responsaveis).each(function(e,i){main.arr_grupo_usuarios.push(i.grupo_usuarios_id)})),WS.get("usuario/listar_usuarios_grupos/",{nome:"",cliente_id:-1,equipe_interna:!1,clientes:!1,fornecedores:!1,prospects:!1,considera_tecnico:!1,apenas_tecnico:!1,apenas_supervisionados:!1,modulo:null,listar_grupos:!1,arr_usuarios:main.arr_usuarios,arr_grupo_usuarios:main.arr_grupo_usuarios,limpa_conteudo_apos_selecionar:!1,listar_usuarios_grupos:!0,limite:null},function(e){h.dxDropDownBox({valueExpr:function(e){return e.chave},displayExpr:"nome",placeholder:App.lang.combobox.selecione,showClearButton:!0,dataSource:new DevExpress.data.DataSource.default({store:e,pageSize:e.length}),dropDownOptions:{container:main.modal},contentTemplate:function(e){var i=e.component.option("value"),a=$("<div>").dxDataGrid({dataSource:e.component.option("dataSource"),keyExpr:"chave",showBorders:!0,columnResizingMode:"widget",rowAlternationEnabled:!1,searchPanel:{visible:!detectmob(),width:200,placeholder:"Pesquisa geral"},scrolling:{mode:"virtual"},allowColumnResizing:!0,filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},filterPanel:{visible:!0},sorting:{mode:"multiple"},groupPanel:{visible:!0},columns:[{dataField:"nome",caption:App.lang.generico.nome,allowGrouping:!1},{dataField:"grupo_usuario_nome",caption:App.lang.generico.grupo_usuario,allowGrouping:!1,groupIndex:0}],hoverStateEnabled:!0,height:345,selection:{mode:!0===o.multiplos_responsaveis?"multiple":"single"},selectedRowKeys:i,onSelectionChanged:function(i){for(var a=i.selectedRowKeys,t=[],n=[],s=0;s<a.length;s++){var _=a[s];t.push(_.chave)}e.component.option("value",t);for(s=0;s<t.length;s++)n.push(t[s].substr(0,t[s].indexOf("_")));main.arr_destinos_enviar[r].responsavel_id=n,o.multiplos_responsaveis||e.component._popup.hide()}});return a.dxDataGrid("instance"),a}})}),f.show());var g=$(n.find(".div_elemento_grupo_responsavel")),b=$(n.find(".cbo_elemento_grupo_responsavel"));if(g.hide(),void 0!==o.grupo_usuarios_responsaveis_obrigatorio&&!0===o.grupo_usuarios_responsaveis_obrigatorio&&(o.grupos_usuarios_responsaveis&&(b.unbind("change"),b.find("option").remove(),add_option(b,""," - Selecionar - "),$(o.grupos_usuarios_responsaveis).each(function(e,i){add_option(b,i.grupo_usuarios_id,i.nome)}),b.change(function(){main.arr_destinos_enviar[r].grupo_usuarios_responsaveis_id=""!=this.value?parseInt(this.value,10):null}),b.selectpicker("refresh")),g.show()),!0===o.responsavel_anonimo){let e=$(n.find(".div_emails_responsaveis_anonimos")),i=$(n.find(".grid_emails_responsaveis_anonimos"));e.removeClass("hidden");const a=e=>{const i=e.component.getDataSource().store()._array.map(e=>e.email);main.arr_destinos_enviar[r].emails_responsaveis_anonimos=i};ReactDOM.render(React.createElement(window.components.SelecaoEmails.default,{getDataGridRef:a}),i[0])}main.div_email_terceiro_entrega.hide(),void 0!==main.email_terceiros_entrega&&main.email_terceiros_entrega&&main.div_email_terceiro_entrega.show();var O=$(n.find(".div_email_terceiro"));O.hide();var E=$(n.find(".edt_email_terceiro"));void 0!==o.email_terceiros&&!0===o.email_terceiros&&(O.show(),E.val(""),E.change(function(){main.arr_destinos_enviar[r].email_terceiros_enviar=""!=this.value?this.value:null}));_=$(n.find(".div_destinos"));var A=$(n.find(".cbo_gateway_exclusivo_destino"));A.hide(),o.elemento_tipo==PROCESSO_ELEMENTO_TIPO.GATEWAY&&n.css("background-color","#fffff5");var S=null,y=null,I=function(e){var i=[e];_.find("[temp_elem_key]").each(function(e,a){i.push($(a).attr("temp_elem_key"))}),_.html("");for(var a=function(e){return $(main.arr_destinos_enviar).each(function(i,a){if(void 0!==a.temp_elem_key_origem&&a.temp_elem_key_origem==e&&(void 0===a.removido||0==a.removido))return main.arr_destinos_enviar[i].removido=!0,!0}),!1},o=0;o<i.length;o++)for(;a(i[o]););};o.elemento_tipo==PROCESSO_ELEMENTO_TIPO.GATEWAY&&o.tipo==PROCESSO_GATEWAY_TIPO.EXCLUSIVO&&(_.html(""),add_option(A,""," - Selecionar - "),$(o.destinos).each(function(e,i){var a=$("<option>").attr("elemento_tipo",i.elemento_tipo).val(i.id).text(i.descricao);!0!==i.retorno_evento||S||(S=i.id,y=i.elemento_tipo),a.appendTo(A)}),A.attr("temp_elem_key",elem_key_random()),A.show(),A.unbind("change"),A.change(function(){I($(this).attr("temp_elem_key")),main.disparar_eventos_gateway_destino(o);var e=$(this).attr("temp_elem_key"),a=this.value,t=$(this).find("option:selected").attr("elemento_tipo");main.arr_destinos_enviar[r].destino_selecionado=a,main.arr_destinos_enviar[r].destino_selecionado_elemento_tipo=t,main.arr_destinos_enviar[r].temp_elem_key=e,$(main.arr_elementos).each(function(o,n){if(n.id==a&&n.elemento_tipo==t){var r=clone_obj(n);r.temp_elem_key_origem=e,i(_,r,s)}})}),S&&(1!=o.bloqueio_decisao&&"S"!=o.bloqueio_decisao||A.prop("disabled",!0),A.find('[elemento_tipo="'+y+'"][value="'+S+'"]').prop("selected",!0)),A.selectpicker("refresh").trigger("change"));var w=function(){_.html("");var e=elem_key_random();_.attr("temp_elem_key",e);var a=[];if($(o.destinos).each(function(i,t){$(main.arr_elementos).each(function(i,n){n.id==t.id&&n.elemento_tipo==t.elemento_tipo&&(n.temp_elem_key_origem=e,o.tipo==PROCESSO_GATEWAY_TIPO.INCLUSIVO&&(n.opcional=t.opcional,n.retorno_evento=t.retorno_evento,n.filho_de_gateway_inclusivo=!0,n.pai_bloqueio_decisao=1==o.bloqueio_decisao||"S"==o.bloqueio_decisao),n.permite_retorno=t.permite_retorno,a.push(n),main.arr_destinos.push(n))})}),o.destinos=[],$(a).each(function(e,i){o.destinos.push(i)}),o.tipo==PROCESSO_GATEWAY_TIPO.PARALELO||o.tipo==PROCESSO_GATEWAY_TIPO.INCLUSIVO){main.consultar_situacao_gateway(function(){if(0==main.atividades_pendentes_gateway)$(a).each(function(e,a){i(_,clone_obj(a),s)});else{var e=$(n.find(".div_elemento_detalhe")),t=$('<br><br><span class="label label-warning lbl_atividades_pendentes">Aguardando atividades</span>');e.append(t)}main.disparar_eventos_gateway_destino(o)},o.id)}};return o.elemento_tipo!=PROCESSO_ELEMENTO_TIPO.GATEWAY||o.tipo!=PROCESSO_GATEWAY_TIPO.PARALELO&&o.tipo!=PROCESSO_GATEWAY_TIPO.INCLUSIVO||(void 0===o.opcional||!1===o.opcional||!0===o.opcional&&!0===o.opcional_enviar)&&w(),n.appendTo(a),App.aplicar_checkbox(a),s};main.list_destinos.find("a").remove(),$(main.arr_destinos).each(function(e,a){i(main.list_destinos,clone_obj(a))}),main.arr_destinos.length>0?(main.lbl_proximas_atividades.show(),main.lbl_nenhuma_atividade.hide()):(main.lbl_proximas_atividades.hide(),main.lbl_nenhuma_atividade.show()),main.btn_confirmar.show()},this.libera_download=function(e){var i;i="S"==App.sessao.dados.parametro_processo.numero_solicitacao_por_processo?main.solicitacao_atividade.numero:main.solicitacao_atividade.solicitacao_id,main.num_solicitacao.html("Solicitação #"+i),main.desc_processo.html("Processo: "+main.formulario.nome),main.nome_atividade.html("Atividade: "+main.atividade.descricao),main.body_default.addClass("hidden"),main.div_solicitacao_salva.removeClass("hidden"),main.btns_default.addClass("hidden"),main.div_atividade_concluida.removeClass("hidden"),App.sessao.sessao_login_anonimo||main.btn_download_form.removeClass("hidden")},this.btn_download_form.click(function(){App.obter_token_publico(function(e){WS.post("solicitacao/gerar_pdf_solicitacao_atividade",{solicitacao_atividade_id:main.solicitacao_atividade.id,empresa_filial_id:App.temp.empresa,token_publico:e},function(e){download_arquivo(e.file,e.name)})})}),this.btn_ok.click(function(){main.unload(),main.onconfirm&&main.onconfirm()}),this.btn_acao_projeto_template_novo.unbind("click"),this.btn_acao_projeto_template_novo.click(function(){var e=function(e){main.onprojeto&&(main.solicitacao_atividade.projeto_id=e.id,main.solicitacao_atividade.projeto=e,main.onprojeto(e),main.render_acoes())},i=function(){View.load("projeto/detalhes",function(i,a){a.onconfirm=e,a.show(null,FORMULARIO.NOVO)},View.ABA.MULTIPLAS)};main.solicitacao_atividade.projeto_id?alert_modal("Projeto","Já existe um projeto relacionado a esta atividade. Deseja cadastrar um novo projeto e substituir o atual?","Sim, novo projeto",function(){i()},!0):i()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){main.unload()}),this.btn_confirmar.unbind("click"),this.btn_confirmar.click(function(){main.btn_cancelar.addClass("disabled").css("pointer-events","none"),main.btn_confirmar.addClass("disabled").css("pointer-events","none");setTimeout(()=>{let e=main.div_formulario?main.div_formulario.etiquetas:null,i=null!==e&&"object"==typeof e?JSON.stringify(main.div_formulario.etiquetas):null;for(var a={solicitacao_atividade_id:main.solicitacao_atividade.id,formulario:JSON.stringify(main.solicitacao_atividade.formulario),acao:SOLICITACAO_ATIVIDADE_ACAO.ENVIAR,observacoes:main.observacoes,projeto_id:main.solicitacao_atividade.projeto_id,destinos:JSON.stringify(main.arr_destinos_enviar),cliente_id:main.cliente_id,emails_terceiros_entrega:main.edt_email_terceiro_entrega.val(),usuario_id:main.usuario_acompanhamento,documento_pasta_id:main.documento_pasta_id,etiquetas:i},o=0;o<main.solicitacao_atividade.formulario.grupos.length;o++){var t=main.solicitacao_atividade.formulario.grupos[o];if(t.elementos)for(var n=0;n<t.elementos.length;n++){var s=t.elementos[n];if(s.tipo==ELEMENTO_TIPO.ANEXO&&s.anexo)a[s.elem_key]=s.anexo,App.is_nativo()&&(main.anexos.push(s.anexo),main.elem_keys.push(s.elem_key));else if(s.tipo==ELEMENTO_TIPO.TABELA&&s.valor)for(var r=s.valor,_=0;_<r.length;_++)r[_].anexo&&(a[r[_].elem_key+"_linha_"+r[_].linha]=r[_].anexo)}}App.is_nativo()?App.obter_token_publico(function(e){if(main.anexos.length>0){var i={route:"documento/salvar_anexoGP",disable_buttons:[main.btn_cancelar,main.btn_confirmar],data:{token_publico:e,documento_key:"documentos",documentos:main.anexos}};new PhoneGapWS(i,function(e){if(e.state==PhoneGapWS.STATE.SUCCESS){var i=a;i.filenames=e.return_value,i.mobile="sim";for(var o=e.return_value.split(","),t=0;t<=o.length-1;t++)i[main.elem_keys[t]]=JSON.stringify(i[main.elem_keys[t]]);WS.post("solicitacao/salvar",i,function(e){if(main.anexo=[],main.elem_keys=[],App.PE.Solicitacao_Atividade_Salvar_Enviar_Depois)try{App.PE.Solicitacao_Atividade_Salvar_Enviar_Depois(main,e)}catch(e){console.log(e)}else alert_saved(main.atividade.descricao+" salvo com sucesso"),"S"==main.solicitacao_atividade.solicitacao.versao_processo.exibir_modal_confirmacao_envio||!0===main.solicitacao_atividade.solicitacao.versao_processo.exibir_modal_confirmacao_envio?main.libera_download():(main.unload(),main.onconfirm&&main.onconfirm())},[main.btn_cancelar,main.btn_confirmar],null,!0)}else main.btn_cancelar.removeClass("disabled"),main.btn_confirmar.removeClass("disabled")})}else WS.post("solicitacao/salvar",a,function(e){if(main.anexo=[],main.elem_keys=[],App.PE.Solicitacao_Atividade_Salvar_Enviar_Depois)try{App.PE.Solicitacao_Atividade_Salvar_Enviar_Depois(main,e)}catch(e){console.log(e)}else alert_saved(main.atividade.descricao+" salvo com sucesso"),"S"==main.solicitacao_atividade.solicitacao.versao_processo.exibir_modal_confirmacao_envio||!0===main.solicitacao_atividade.solicitacao.versao_processo.exibir_modal_confirmacao_envio?main.libera_download():(main.unload(),main.onconfirm&&main.onconfirm())},[main.btn_cancelar,main.btn_confirmar],null,!0)}):WS.post("solicitacao/salvar",a,function(e){if(e.solicitacao_atividade.formulario.grupos.length){var i=!1,a=e.solicitacao_atividade.formulario.grupos[0].elementos.filter(function(e){if(e.tipo==ELEMENTO_TIPO.ANEXO)return e;e.tipo==ELEMENTO_TIPO.TABELA&&(i=!0)});if(i){var o=e.solicitacao_atividade.formulario.grupos[0].elementos.find(function(e){return e.tipo==ELEMENTO_TIPO.TABELA});o&&o.valor&&o.valor.map(function(e){a.push(e)})}$(a).each(function(e,i){if(void 0!==i.documento&&null!==i.documento){var a=void 0!==i.linha?"_"+i.linha:"",o=i.documento_revisao.id,t=i.documento.solicitacao_id.toString(),n=null,s="assets/view/clicksign/configurar_signatarios".replace(/\//g,"__"),r="assets/view/certsign/configurar_signatarios".replace(/\//g,"__"),_="assets/view/d4sign/configurar_signatarios".replace(/\//g,"__"),l=md5(s+(new Date).getTime()),d=md5(r+(new Date).getTime()),c=md5(_+(new Date).getTime());void 0!==App.temp.signatarios&&void 0!==App.temp.signatarios[t+"_"+i.elem_key+a]&&(void 0!==(n=App.temp.signatarios[t+"_"+i.elem_key+a]).certsign&&Array.isArray(n.certsign)&&n.certsign.length>0&&require(["assets/view/certsign/configurar_signatarios"],function(e){new e(d).solicitar_assinaturas(n.certsign,o),n.certsign=[]}),void 0!==n.clicksign&&Array.isArray(n.clicksign)&&n.clicksign.length>0&&require(["assets/view/clicksign/configurar_signatarios"],function(e){new e(l).solicitar_assinaturas(n.clicksign,o),n.clicksign=[]}),void 0!==n.d4sign&&Array.isArray(n.d4sign)&&n.d4sign.length>0&&require(["assets/view/d4sign/configurar_signatarios"],function(e){new e(c).solicitar_assinaturas(n.d4sign,o),n.d4sign=[]}))}})}if($(main.btn_confirmar).parent().parent().find("div.info_import").remove(),App.PE.Solicitacao_Atividade_Salvar_Enviar_Depois)try{App.PE.Solicitacao_Atividade_Salvar_Enviar_Depois(main,e)}catch(e){console.log(e)}else alert_saved(main.atividade.descricao+" salvo com sucesso"),"S"==main.solicitacao_atividade.solicitacao.versao_processo.exibir_modal_confirmacao_envio||!0===main.solicitacao_atividade.solicitacao.versao_processo.exibir_modal_confirmacao_envio?main.libera_download():(main.unload(),main.onconfirm&&main.onconfirm())},[main.btn_cancelar,main.btn_confirmar],null,!0,null,function(e){$(main.btn_confirmar).parent().parent().find("div.info_import").remove(),$(main.btn_confirmar).parent().parent().append('<div class="info_import" style="margin: 10px 0; font-size: 17px;"><span class="text-primary"> <i class="fa fa-spinner fa-pulse"></i> Salvando alterações. Por favor aguarde.</span><br><small>Este procedimento pode levar algum tempo.</small></div>')},main.html_id,function(){$(main.btn_confirmar).parent().parent().find("div.info_import").remove()})},200)})};return Solicitacao_Enviar});