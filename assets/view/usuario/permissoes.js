define([],function(){return function(e){"use strict";var s=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.edt_nome=this.dialog.find(".edt_nome"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.cbo_empresa=this.dialog.find(".cbo_empresa"),this.div_empresa=this.dialog.find(".div_empresa"),this.datagrid_permissoes=this.dialog.find(".datagrid_permissoes"),this.painel_detalhes=this.dialog.find(".painel_detalhes"),this.usuario_id=null,this.grupo_usuarios_id=null,this.tipo_usuario=null,this.admin=null,this.eh_perfil=!1,this.main_configuracoes=null,this.todas_permissoes=[],this.permissoes_selecionadas=[],this.permissoes_agrupadas=[],this.show=function(e,i,a,o,r){switch(s.tipo=i,s.tipo_usuario=a,s.admin=o,s.eh_perfil=!1,s.tipo){case FORMULARIO.EDITAR:s.btn_salvar.show(),s.btn_excluir.hide(),s.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:s.btn_salvar.hide(),s.btn_excluir.hide(),s.permite_alterar(!1)}void 0!==e&&e&&(s.usuario_id=e),void 0!==r&&r&&(s.grupo_usuarios_id=r,s.preencher("permissoes/objeto/")),show_modal(s.modal.attr("id")),s.edt_nome.prop("readonly",!0),set_focus(s.edt_nome),s.painel_detalhes.addClass("hidden"),a!=USUARIO_TIPO.ANALISTA?(s.painel_detalhes.removeClass("hidden"),s.preencher("permissoes/objeto/")):(s.div_empresa.removeClass("hidden"),s.listar_empresas()),s.permissoes_usuario()},this.show_permissoes_importacao=function(e){s.btn_excluir.hide(),s.permite_alterar(!0),s.main_configuracoes=e,s.tipo_usuario=USUARIO_TIPO.ANALISTA,show_modal(s.modal.attr("id")),s.edt_nome.val(usuario_tipo(s.tipo_usuario)),s.edt_nome.prop("readonly",!0)},this.show_permissoes_perfil=function(e,i,a){switch(s.tipo=e,s.tipo_usuario=i,s.admin=a,s.eh_perfil=!0,s.tipo){case FORMULARIO.EDITAR:s.btn_salvar.show(),s.btn_excluir.hide(),s.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:s.btn_salvar.hide(),s.btn_excluir.hide(),s.permite_alterar(!1)}s.preencher("perfil_padrao_permissao/objeto/"),show_modal(s.modal.attr("id")),s.edt_nome.val(usuario_tipo(s.tipo_usuario)),s.edt_nome.prop("readonly",!0),set_focus(s.edt_nome)},this.cbo_empresa.change(function(e){var i="";s.painel_detalhes.removeClass("hidden"),i=s.eh_perfil?"perfil_padrao_permissao/objeto/":"permissoes/objeto/",s.preencher(i)}),this.listar_empresas=function(e){s.cbo_empresa.find("option").remove(),add_option(s.cbo_empresa,"","Selecione a empresa"),WS.get("usuario_empresa/listar/",{usuario_id:s.usuario_id,grupo_usuarios_id:s.grupo_usuarios_id},function(i){if(1==i.length)add_option(s.cbo_empresa,i[0].empresa_id,i[0].nome_fantasia),s.cbo_empresa.val(i[0].empresa_id).trigger("change");else for(var a=0;a<i.length;a++)add_option(s.cbo_empresa,i[a].empresa_id,i[a].nome_fantasia);e&&s.cbo_empresa.val(e).trigger("change"),s.cbo_empresa.selectpicker("refresh")},null,null,null,null,null,s.html_id)},this.permissoes_usuario=function(){var e=App.sessao.dados.permissoes.slice(0);e.push({chave:"chamado_administrador_entidade"}),e.push({chave:"altera_responsavel"}),e.push({chave:"reclassificar_chamado"}),App.verifica_permissao(App.sessao.dados.empresa_filial_id,"manutencao_agenda")&&e.push({chave:"manutencao_propria_agenda"})},this.close=function(){close_modal(s.modal.attr("id")),void 0!==s.onclose&&s.onclose&&s.onclose()},this.unload=function(){s.close(),View.unload(this.html_id)},this.permite_alterar=function(e){s.edt_nome.prop("readonly",!e)},this.preencher=function(e){var i;WS.get(e,{usuario_id:s.usuario_id,grupo_usuarios_id:s.grupo_usuarios_id,tipo_usuario:s.tipo_usuario,empresa_filial_id:null==s.cbo_empresa.val()||""==s.cbo_empresa.val()?0:s.cbo_empresa.val()},function(e){i=null==e.nome?s.edt_nome.val():e.nome,s.permissoes_selecionadas=e.permissoes,ReactDOM.unmountComponentAtNode(s.datagrid_permissoes[0]),ReactDOM.render(React.createElement(window.views.permissoes.DataGridPermissoes.default,{empresa_filial_id:null==s.cbo_empresa.val()||""==s.cbo_empresa.val()?0:s.cbo_empresa.val(),usuario_tipo:s.tipo_usuario,todas_permissoes:e.todas_permissoes,permissoes_selecionadas:s.permissoes_selecionadas,ao_selecionar:e=>s.permissoes_selecionadas=e,ao_listar_permissoes:e=>s.permissoes_agrupadas=e}),s.datagrid_permissoes[0]),s.edt_nome.val(i),s.todas_permissoes=Object.keys(e.todas_permissoes),s.permissoes_usuario()})},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){s.unload()}),this.btn_salvar_importacao=function(){s.main_configuracoes.permissoes=s.obter_permissoes_selecionadas_para_salvar(),s.unload()},this.obter_permissoes_selecionadas_para_salvar=function(){let e=[];return s.permissoes_agrupadas.forEach(i=>{e.push({chave:i.chave,permitido:s.permissoes_selecionadas.filter(e=>e.chave===i.chave).length>0})}),e},this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){if(s.main_configuracoes)return s.btn_salvar_importacao(),!1;var e,i,a=s.obter_permissoes_selecionadas_para_salvar();i=s.eh_perfil?"perfil_padrao_permissao/salvar/":"permissoes/salvar/",WS.post(i,{usuario_id:s.usuario_id,grupo_usuarios_id:s.grupo_usuarios_id,nome:s.edt_nome.val(),tipo_usuario:s.tipo_usuario,permissoes:JSON.stringify(a),empresa_filial_id:null==s.cbo_empresa.val()||""==s.cbo_empresa.val()?0:s.cbo_empresa.val()},function(i){s.usuario_id=i.id,e=null==i.nome?"Perfil "+s.edt_nome.val():i.nome,alert_saved(e+" salvo com sucesso"),s.unload()},[s.btn_cancelar,s.btn_salvar])})}});