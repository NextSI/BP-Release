define([],function(){return function(i){"use strict";var a=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Signatários",this.grid_signatarios=this.dialog.find(".grid_signatarios"),this.txt_mensagem_signatarios=this.dialog.find(".txt_mensagem_signatarios"),this.comunica_clicksign=!1,this.id_elemento_anexo=null,this.id_linha_tabela="",this.solicitacao_id=null,this.dados_signatarios=[],this.show=function(i,o,e,n,s){a.comunica_clicksign=o,a.id_elemento_anexo=e,a.solicitacao_id=void 0!==s?s.toString():"",void 0!==n&&null!=n&&(a.id_linha_tabela="_"+n),void 0===App.temp.signatarios&&(App.temp.signatarios={}),void 0===App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela]&&(App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela]=[]),a.dados_signatarios=App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela],void 0===a.dados_signatarios.clicksign&&(a.dados_signatarios.clicksign=[]),a.grid_signatarios.dxDataGrid({dataSource:a.dados_signatarios.clicksign,showBorders:!0,allowColumnReordering:!0,allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,rowAlternationEnabled:!1,height:550,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},paging:{enabled:!1},onInitNewRow:function(i){i.data={sign_as:"sign",auths:"email"}},focusedRowEnabled:!1,editing:{mode:"batch",allowUpdating:!0,allowAdding:!0,allowDeleting:!0,useIcons:!0},onToolbarPreparing:function(e){var n=e.toolbarOptions.items;$.each(n,function(e,n){if("saveButton"===n.name)return n.options.onClick=function(e){var n=a.grid_signatarios.dxDataGrid("instance").getController("editing").getChanges().map(function(i){return i.data});o?a.solicitar_assinaturas(n,i):(a.dados_signatarios.clicksign=[],$.each(n,function(i,o){a.dados_signatarios.clicksign.push(o)}),a.unload())},!1})},onEditorPrepared:function(i){if("dataRow"===i.parentType)switch(i.dataField){case"documentation":i.editorElement.find("input").last().mask("000.000.000-00");break;case"birthday":i.editorElement.find("input").last().mask("99/99/9999");break;case"phone_number":i.editorElement.find("input").last().mask("(00)00000-0000");break;case"email":var o=i.editorElement.dxTextBox("instance");o.option("valueChangeEvent","keydown keyup"),o.option("onValueChanged",function(o){var e=!0;""!==o.value&&emailValido(o.value)&&(e=!1),i.setValue(o.value),a.grid_signatarios.find(".dx-datagrid-save-button").dxButton("instance").option("disabled",e)})}},columns:[{dataField:"email",caption:"Email",validationRules:[{type:"required",message:"Preencha o E-mail"},{type:"email",message:"E-mail inválido"}]},{dataField:"sign_as",caption:"Assinar Como",lookup:{dataSource:[{id:"sign",descricao:"Assinar"},{id:"approve",descricao:"Aprovar"},{id:"party",descricao:"Assinar como parte"},{id:"witness",descricao:"Assinar como testemunha"},{id:"intervening",descricao:"Assinar como interveniente"},{id:"receipt",descricao:"Acusar recebimento"},{id:"endorser",descricao:"Assinar como endossante"},{id:"endorsee",descricao:"Assinar como endossatário"}],valueExpr:"id",displayExpr:"descricao"}},{dataField:"auths",caption:"Autenticar Como",lookup:{dataSource:[{id:"email",descricao:"Email"},{id:"sms",descricao:"SMS"}],valueExpr:"id",displayExpr:"descricao"}},{dataField:"phone_number",caption:"Celular"},{dataField:"name",caption:"Nome Completo"},{dataField:"documentation",caption:"CPF"},{dataField:"birthday",allowEditing:!0,dataType:"date",caption:"Data de Nascimento",format:"dd/MM/yyyy",validationRules:[{type:"required",message:"Preencha a Data"}]}],rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0})},this.solicitar_assinaturas=function(i,o){WS.post("clicksign/solicitar_assinaturas",{signatarios:JSON.stringify(i),documento_revisao_id:o,mensagem_signatarios:a.txt_mensagem_signatarios.val()},function(i){var o="";if(void 0!==i.signers&&i.signers.length>0?void 0!==i.signers[0].errors&&i.signers[0].errors.length>0&&(o="<h4>Falha ao transmitir o arquivo. Possíveis causas: </h4><br>",o+=i.signers[0].errors.toString().replace(/,/g,"<br>")):void 0!==i.errors&&i.errors.length>0&&(o=i.errors[0].toString().replace(/,/g,"<br>")),""!=o)return alert_modal("Atenção",o),!1;a.comunica_clicksign&&DevExpress.ui.dialog.alert("Documento disponibilizado para o(s) signatário(s)!","Atenção").done(function(){a.unload()})})},this.close=function(){void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)}}});