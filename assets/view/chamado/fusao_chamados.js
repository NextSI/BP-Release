define(["react","react-dom","./../componentes_react/InformativoPrazo"],function(a,e,o){return function(t){"use strict";var i=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.cbo_chamado=this.dialog.find(".cbo_chamado"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.tab_chamados=this.dialog.find(".tab_chamados"),this.alerta=this.dialog.find(".alerta"),this.arr_chamados=[],this.arr_chamados_selecionados=[],this.divs_informativo_prazo=[],this.chamado_id=null,this.edt_chamado=null,this.show=function(a){i.chamado_id=a,show_modal(i.modal.attr("id")),create_combobox(i.cbo_chamado,i.listar_chamados,null,!1,{pesquisar_enter:!0});var e=i.cbo_chamado.parent();i.edt_chamado=e.find(".edt_combobox")},this.close=function(){close_modal(i.modal.attr("id")),void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){for(var a=0;a<i.divs_informativo_prazo.length;a++)i.divs_informativo_prazo[a].props.desativarRefreshAutomatico();i.close(),View.unload(this.html_id)},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){close_modal(i.modal.attr("id"))}),this.listar_chamados=function(a){var e=new Object;e.situacao=CHAMADO_FILTRO.EM_ABERTO,e.numero_chamado=i.edt_chamado.val(),e.ignora_encerrado=!1,e.chamado_principal_fusao=i.chamado_id,WS.get("chamado/listar/",e,function(e){limpar_combobox(i.cbo_chamado),$(e.chamados).each(function(a,o){i.arr_chamados=e.chamados;var t=[];t["Código"]="#"+o.id,t.Motivo=o.motivo,t.Assunto=o.assunto;var s=$('<span class="label lb_tipo" title="Empresa (Interno)" data-original-title="Empresa (Interno)" style="margin-right: 5px;"></span>'),n=null;o.cliente_id>0?(s.addClass("label-info"),s.attr("title","Cliente"),n="C"):o.fornecedor_id>0?(s.addClass("label-warning"),s.attr("title","Fornecedor"),n="F"):o.prospect_id>0?(s.addClass("label-primary"),s.attr("title","Organização"),n="O"):(s.addClass("label-danger"),s.attr("title","Empresa (Interno)"),n="E"),s.tooltip(),s.text(n),add_option_combobox(i.cbo_chamado,a,o.id,t,s,JSON.stringify(o))});var o=$(window).width();if(parseInt(o)>=992){var t=i.cbo_chamado.parent(),s=t.find(".combobox"),n=$(s).width();$(t).find(".multi-column-dropdown").css("width","600px"),n=parseInt(n)-28,$(t).find(".multi-column-dropdown").css("left","-"+n+"px")}$(i.cbo_chamado.parent()).find(".ul_row").click(function(){var a=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;null!=a&&i.fusao_chamados(a.id)}),$(i.cbo_chamado.parent()).find("input").keypress(function(a){if(13==a.keyCode||13==a.tecla_value){var e=$(this).attr("dados-adicionais")?JSON.parse($(this).attr("dados-adicionais")):null;null!=e&&i.fusao_chamados(e.id)}}),a(!0)})},this.fusao_chamados=function(t){var s,n,r=i.tab_chamados.find("tbody").find("tr:first"),d=!1;if(i.arr_chamados_selecionados.length>0&&$(i.arr_chamados_selecionados).each(function(a,e){e.id===t&&(d=!0)}),!d){var l=(s=t,n=null,$(i.arr_chamados).filter(function(a,e){if(e.id==s)return n=e,!0}),n);null!=l&&function(t){i.arr_chamados_selecionados.push(t);var s=r.clone();s.removeAttr("template-row"),s.css("display",""),s.addClass("rows");var n=$(s.find(".btn_excluir_da_fusao"));n.unbind("click"),n.click(function(){if(t.id>0){var a=new Validation;a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja remover o chamado da fusão?")),alert_modal("Atenção",a,"Remover",function(){var a;a=t.id,$(i.arr_chamados_selecionados).filter(function(e,o){o.id==a&&(i.arr_chamados_selecionados.splice(e,1),$(s).remove())})},!0)}}),$('<span class="small">'),$(s.find("[template-field='id']")).append("#"+t.id+'<span class="small text-muted"> <br> Aberto em: <br>'+(t.data_abertura?t.data_abertura.format_date():"")+'</span><br><span class="small text-muted">'+t.prioridade_nome+"</span>");var d=$(s.find("[template-field='cliente_fornecedor']")),l=$(s.find("[template-field='solicitante']")),_=$(s.find(".imagem_solicitante")),m=$(s.find(".imagem_responsavel"));null!=t.cliente_nome?d.text(t.cliente_nome):null!=t.fornecedor_nome?d.text(t.fornecedor_nome):null!=t.prospect_nome?d.text(t.prospect_nome):null!=t.empresa_nome&&d.text(t.empresa_nome),d.append('<br><span class="small text-muted">Responsável: <br>'+(t.usuario_responsavel_nome?t.usuario_responsavel_nome:"-")+"</span>");var c=$(s.find(".lb_tipo")),p="";null!=t.cliente_id&&""!=t.cliente_id?(c.addClass("label-info"),c.attr("title","Cliente"),p="C"):null!=t.fornecedor_id&&""!=t.fornecedor_id?(c.addClass("label-warning"),c.attr("title","Fornecedor"),p="F"):null!=t.prospect_id&&""!=t.prospect_id?(c.addClass("label-primary"),c.attr("title","Organização"),p="O"):null!=t.chamado_empresa_filial_id&&""!=t.chamado_empresa_filial_id&&(c.addClass("label-danger"),c.attr("title","Empresa Filial"),p="E"),c.tooltip(),c.text(p),null!=t.usuario_responsavel_nome&&""!=t.usuario_responsavel_nome?(d.append('<br><span class="small text-muted">Responsável: <br>'+(t.usuario_responsavel_nome?t.usuario_responsavel_nome:"-")+"</span>"),null!=t.foto_usuario_responsavel?m.attr("src",WS_URI+"documento/midia/?&tamanho=20&documento_id="+t.foto_usuario_responsavel+"&token_midia="+App.sessao.token_midia):m.attr("src","assets/img/imagem_usuario_padrao.svg")):m.hide(),null!=t.usuario_cliente_nome&&""!=t.usuario_cliente_nome?(l.append('<br><span class="small text-muted">Solicitante: <br>'+(t.usuario_cliente_nome?t.usuario_cliente_nome:"-")+"</span>"),null!=t.foto_usuario_cliente?_.attr("src",WS_URI+"documento/midia/?&tamanho=20&documento_id="+t.foto_usuario_cliente+"&token_midia="+App.sessao.token_midia):_.attr("src","assets/img/imagem_usuario_padrao.svg")):null!=t.usuario_empresa_nome&&""!=t.usuario_empresa_nome?(l.append('<br><span class="small text-muted">Solicitante: <br>'+(t.usuario_empresa_nome?t.usuario_empresa_nome:"-")+"</span>"),null!=t.foto_usuario_empresa?_.attr("src",WS_URI+"documento/midia/?&tamanho=20&documento_id="+t.foto_usuario_empresa+"&token_midia="+App.sessao.token_midia):_.attr("src","assets/img/imagem_usuario_padrao.svg")):null!=t.usuario_fornecedor_nome&&""!=t.usuario_fornecedor_nome?(l.append('<br><span class="small text-muted">Solicitante: <br>'+(t.usuario_fornecedor_nome?t.usuario_fornecedor_nome:"-")+"</span>"),null!=t.foto_usuario_fornecedor?_.attr("src",WS_URI+"documento/midia/?&tamanho=20&documento_id="+t.foto_usuario_fornecedor+"&token_midia="+App.sessao.token_midia):_.attr("src","assets/img/imagem_usuario_padrao.svg")):null!=t.usuario_prospect_nome&&""!=t.usuario_prospect_nome&&(l.append('<br><span class="small text-muted">Solicitante: <br>'+(t.usuario_prospect_nome?t.usuario_prospect_nome:"-")+"</span>"),null!=t.foto_usuario_prospect?_.attr("src",WS_URI+"documento/midia/?&tamanho=20&documento_id="+t.foto_usuario_prospect+"&token_midia="+App.sessao.token_midia):_.attr("src","assets/img/imagem_usuario_padrao.svg"));var u=Colors(t.motivo_cor);$(s.find("[template-field='motivo']")).append('<span class="badge"  style="background: '+u.hex+"; color: "+u.nome_hex+'; font-size: x-small">'+t.motivo+"</span><br>"+t.assunto),$(s.find("[template-img='situacao']")).attr("src","assets/img/legenda/"+ChamadoImgSituacao(parseInt(t.situacao,10),"mini"));var f=$(s.find("[template-field='situacao']")),h=ChamadoDescSituacaoHumano(t.situacao,App.sessao.dados.tipo);if(f.text(h||""),$(s.find("[template-field='previsao_retorno']")).text(4!=t.situacao&&8!=t.situacao&&(t.data_previsao_retorno||t.horas_previsao_retorno)?" Previsão de Retorno: ":"-"),t.situacao!=CHAMADO_FILTRO.AGUARDANDO_ATENDIMENTO&&t.situacao!=CHAMADO_FILTRO.MINHAS_SOLICITACOES_EM_ABERTO){var v=s.find(".div_informativo_prazo"),b=a.createElement(o,null,null),g=s.find(".div_informativo_prazo_mobile"),O=a.createElement(o,null,null);e.render(b,v[0]),e.render(O,g[0]);var C={ViewParent:i.html_id,StyleWidth:"150px",Alinhamento:"right",TipoGestaoTempo:t.tipo_gestao_tempo,HorasEstimadas:t.horas_previsao_retorno,DataPrazo:t.data_previsao_retorno,CalendarioTrabalhoId:t.calendario_trabalho_id_param,TituloDataPrazo:"Previsão de Retorno",LabelExcedente:"atrasado",LabelRestante:"restante"};if(b.props.setConfiguracoes(C),O.props.setConfiguracoes(C),i.divs_informativo_prazo.push(b,O),"S"==t.utiliza_encerramento){var A=$(s.find("[template-field='div_inatividade']")),x=$(s.find("[template-field='tempo_inativo']")),I=$(s.find("[template-field='div_progress_inatividade']")),S=$(s.find("[template-field='bar_progresso_inatividade']"));I.removeClass("hidden"),S.removeClass("hidden"),A.removeClass("hidden"),S.css("width",t.percentual_encerramento_inatividade+"%"),t.tipo_gestao_tempo_encerramento==CHAMADO_MOTIVO_TEMPO.HORAS_UTEIS?x.text(format_time(t.tempo_encerramento_inatividade)):t.tipo_gestao_tempo_encerramento==CHAMADO_MOTIVO_TEMPO.DIAS_CORRIDOS&&(x.text(t.tempo_encerramento_inatividade?t.tempo_encerramento_inatividade+" dia"+(t.tempo_encerramento_inatividade>1?"s":""):""),t.tempo_encerramento_inatividade<1&&x.text("0 dia"))}if("S"==t.utiliza_resolucao_atendimento){var E=$(s.find('[template-field="div_aguardando_resposta"]')),R=$(s.find('[template-field="div_progress_aguardando"]')),T=$(s.find('[template-field="bar_progresso_aguardando"]')),w=$(s.find('[template-field="tempo_aguardando"]'));R.removeClass("hidden"),T.removeClass("hidden"),E.removeClass("hidden"),T.css("width",t.percentual_tempo_sem_resposta+"%"),t.tipo_gestao_tempo_encerramento==CHAMADO_MOTIVO_TEMPO.HORAS_UTEIS?w.text(format_time(t.tempo_sem_resposta)):t.tipo_gestao_tempo_encerramento==CHAMADO_MOTIVO_TEMPO.DIAS_CORRIDOS&&(w.text(t.tempo_sem_resposta?t.tempo_sem_resposta+" dia"+(t.tempo_sem_resposta>1?"s":""):""),t.tempo_sem_resposta<1&&w.text("0 dia"))}}s.appendTo(i.tab_chamados)}(l)}},this.btn_confirmar.unbind("click").click(function(a){var e=new Validation;if(0==i.arr_chamados_selecionados.length)e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Informe os chamados que serão fundidos.")),alert_modal("Validação",e);else{i.alerta.removeClass("hidden");var o=[];!function(a){for(var e=0;e<a.length;e++)o.push(a[e].id)}(i.arr_chamados_selecionados),WS.post({route:"chamado/fundir/",type:"POST",data:{chamado_id:i.chamado_id,chamados_fusao:JSON.stringify(o)},func_response:function(a){a&&(alert_saved("Chamados Fundidos!"),close_modal(i.modal.attr("id")),i.unload())},func_fail:function(){i.alerta.addClass("hidden")},disable_buttons:[i.btn_confirmar,i.btn_cancelar]})}})}});