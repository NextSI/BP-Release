define([],function(){return function(e){"use strict";var a=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onsave=null,this.onremove=null,this.edt_nome=this.dialog.find(".edt_nome"),this.edt_tamanho=this.dialog.find(".edt_tamanho"),this.edt_id_elemento=this.dialog.find(".edt_id_elemento"),this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_add_campo=this.dialog.find(".btn_add_campo"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_remover=this.dialog.find(".btn_remover"),this.chk_exibir_impressao=this.dialog.find(".chk_exibir_impressao"),this.tabela={nome:null,tipo:ELEMENTO_TIPO.TABELA,tamanho:5,colunas:12,obrigatorio:!1,campos:[],id_elemento:null},this.arr_grupos=null,this.tipo_formulario=null,this.evento_iniciar_construtor=null;var t=function(e){if(void 0!==a.tabela.campos&&a.tabela.campos){for(var t=-1,i=0;i<a.tabela.campos.length;i++)a.tabela.campos[i].elem_key==e.elem_key&&(t=i);t<0?a.tabela.campos.push(e):a.tabela.campos[t]=e}a.render_lista()},i=function(e){if(void 0!==a.tabela.campos&&a.tabela.campos){for(var t=-1,i=0;i<a.tabela.campos.length;i++)a.tabela.campos[i].elem_key==e.elem_key&&(t=i);t>=0&&a.tabela.campos.splice(t,1)}a.render_lista()};this.show=function(e,t,i,o,n){switch(a.tipo=t,a.arr_grupos=i,a.tipo_formulario=o,a.evento_iniciar_construtor=n,void 0!==e&&e&&(this.tabela=e),t){case FORMULARIO.NOVO:a.btn_salvar.show(),a.btn_remover.hide(),a.permite_alterar(!0),a.chk_exibir_impressao.prop("checked",!0);break;case FORMULARIO.EDITAR:a.btn_salvar.show(),a.btn_remover.show(),a.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:a.btn_salvar.hide(),a.btn_remover.hide(),a.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:a.btn_salvar.hide(),a.btn_remover.show(),a.permite_alterar(!1)}a.preencher(),show_modal(a.modal.attr("id")),set_focus(a.edt_nome)},this.close=function(){close_modal(a.modal.attr("id")),void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)},this.permite_alterar=function(e){a.edt_id_elemento.prop("disabled",!e||a.tipo==FORMULARIO.EDITAR&&a.tabela.id_elemento)},this.preencher=function(){a.edt_nome.val(a.tabela.nome),a.edt_tamanho.val(a.tabela.tamanho),a.edt_id_elemento.val(a.tabela.id_elemento),a.chk_exibir_impressao.prop("checked",void 0===a.tabela.exibir_impressao||a.tabela.exibir_impressao).change(),a.render_lista()},this.render_lista=function(){var e=a.tab_listagem.find("tbody"),o=e.find("tr:first");a.tab_listagem.find("tr:gt(1)").remove(),$(a.tabela.campos).each(function(n,l){!function(n){var l=o.clone();l.removeAttr("template-row"),l.css("display","");var r=l.find(".btn_tab_up_campo");r.unbind("click"),r.click(function(){var e=-1;if($(a.tabela.campos).each(function(a,t){t==n&&(e=a)}),e>0){var t=e-1,i=a.tabela.campos[e],o=a.tabela.campos[t];a.tabela.campos[t]=i,a.tabela.campos[e]=o,a.render_lista()}});var s=l.find(".btn_tab_down_campo");s.unbind("click"),s.click(function(){var e=-1;if($(a.tabela.campos).each(function(a,t){t==n&&(e=a)}),e+1<a.tabela.campos.length){var t=e+1,i=a.tabela.campos[e],o=a.tabela.campos[t];a.tabela.campos[t]=i,a.tabela.campos[e]=o,a.render_lista()}});var d=l.find(".lbl_nome"),_=l.find(".lbl_tipo"),E=l.find(".lbl_id"),m=l.find(".lbl_obrigatorio"),c=l.find(".lbl_possui_evento");d.text(n.nome);var I=str_elemento_tipo(n.tipo);n.tipo!=ELEMENTO_TIPO.TEXTO&&n.tipo!=ELEMENTO_TIPO.DECIMAL&&n.tipo!=ELEMENTO_TIPO.MASCARA||(I+=" ("+(n.tipo==ELEMENTO_TIPO.DECIMAL?n.decimais:n.tamanho)+")"),_.text(I),_.text(I),n.id_elemento?E.text("ID: "+n.id_elemento):(E.text("Informe o ID"),E.toggleClass("label-default label-danger")),m.hide(),n.obrigatorio&&"true"===n.obrigatorio.toString()&&m.show(),c.hide(),(n.evento_alterar&&n.evento_alterar.trim()||n.evento_clicar&&n.evento_clicar.trim()||n.evento_limpar&&n.evento_limpar.trim()||n.evento_selecionar&&n.evento_selecionar.trim())&&c.show();var T=$(l.find(".btn_editar")),R=function(){View.load("formulario/campo",function(e,o){o.onsave=t,o.onremove=i,o.show(n,FORMULARIO.EDITAR,!0,a.tabela,a.arr_grupos,a.evento_iniciar_construtor)})};T.unbind("click"),T.click(R),l.dblclick(R),l.appendTo(e)}(l)})},this.btn_add_campo.unbind("click"),this.btn_add_campo.click(function(){View.load("formulario/campo",function(e,i){i.onsave=t,i.show(null,FORMULARIO.NOVO,!0,a.edt_id_elemento.val(),a.arr_grupos,a.evento_iniciar_construtor)})}),this.edt_nome.unbind("keyup").keyup(function(){if(!a.edt_id_elemento.prop("disabled")){var e=removerAcentos(a.edt_nome.val().replaceAll(" ","_")).replaceAll(/\W/g,"").toLowerCase().substr(0,20),t=e.substr(0,1);""==t||isNaN(t)||(e="t"+e),a.edt_id_elemento.val(e)}}),this.edt_id_elemento.unbind("keypress").bind("keypress",function(e){if(!new RegExp("^[_0-9a-zA-Z\b]+$").test(e.key))return e.preventDefault(),!1}),this.edt_id_elemento.unbind("blur").bind("blur",function(){var e=removerAcentos(a.edt_id_elemento.val()).replaceAll(/\W/g,"").toLowerCase().substr(0,20);a.edt_id_elemento.val(e)}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){a.unload()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){a.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var e=new Validation;if(""==a.edt_id_elemento.val().trim()||null==a.edt_id_elemento.val())e.add(new ValidationMessage(Validation.CODES.ERR,"Informe um ID para a tabela"));else{var t=a.edt_id_elemento.val().substr(0,1);"_"==t&&e.add(new ValidationMessage(Validation.CODES.ERR,"O nome do campo não pode começar com um underline.")),isNaN(t)||e.add(new ValidationMessage(Validation.CODES.ERR,"O nome do campo não pode começar com um número."));for(var i=["ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","COLUMNS","CONSTRAINT","CONVERT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","ELSE","ENCLOSED","ESCAPED","EXISTS","EXPLAIN","FALSE","FIELDS","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","GRANT","GROUP","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERVAL","INTO","IS","JOIN","KEY","KEYS","KILL","LEADING","LEFT","LIKE","LIMIT","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOW_PRIORITY","MATCH","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","NATURAL","NOT","NO_WRITE_TO_BINLOG","NULL","NUMERIC","ON","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUTER","OUTFILE","PRECISION","PRIMARY","PRIVILEGES","PROCEDURE","PURGE","READ","REAL","REFERENCES","REGEXP","RENAME","REPLACE","REQUIRE","RESTRICT","REVOKE","RIGHT","RLIKE","SECOND_MICROSECOND","SELECT","SEPARATOR","SET","SHOW","SMALLINT","SONAME","SPATIAL","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STRAIGHT_JOIN","TABLE","TABLES","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRUE","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHERE","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL","main","obj_solicitacao","ID"],o=0;o<i.length;o++){var n=i[o];a.edt_id_elemento.val().toUpperCase()==n.toUpperCase()&&e.add(new ValidationMessage(Validation.CODES.ERR,"O nome da tabela não pode ser "+n+" pois a mesma é uma palavra reservada"))}for(o=0;o<a.arr_grupos.length;o++)for(var l=a.arr_grupos[o],r=0;r<l.elementos.length;r++){var s=l.elementos[r];void 0!==s.id_elemento&&s.id_elemento&&a.edt_id_elemento.val().toLowerCase()==s.id_elemento.toLowerCase()&&a.tabela.elem_key!=s.elem_key&&(s.tipo==ELEMENTO_TIPO.TABELA?e.add(new ValidationMessage(Validation.CODES.ERR,"O id informado já está sendo utilizado pela tabela: "+s.nome)):e.add(new ValidationMessage(Validation.CODES.ERR,"O id informado já está sendo utilizado pelo campo: "+s.nome)))}}e.is_valid()?(void 0===a.tabela.elem_key&&(a.tabela.elem_key=String((new Date).getTime())+String(Math.round(1e4*Math.random()))+String((new Date).getTime())+String(Math.round(1e4*Math.random()))),a.tabela.nome=a.edt_nome.val(),a.tabela.tamanho=a.edt_tamanho.val(),a.tabela.id_elemento=a.edt_id_elemento.val(),a.tabela.exibir_impressao=a.chk_exibir_impressao.prop("checked"),void 0!==a.onsave&&a.onsave&&a.onsave(a.tabela,a.evento_iniciar_construtor),a.unload()):alert_modal("Validação",e)}),this.btn_remover.unbind("click"),this.btn_remover.click(function(){alert_modal(a.title.text(),"Deseja remover a tabela?","Remover",function(){void 0!==a.onremove&&a.onremove&&a.onremove(a.tabela),a.unload()},!0)})}});