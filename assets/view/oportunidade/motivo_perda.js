define([],function(){return function(a){"use strict";var o=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.onclose=null,this.onsave=null,this.cbo_motivo=this.dialog.find(".cbo_motivo"),this.edt_data_perda=this.dialog.find(".edt_data_perda"),this.edt_motivo_perda=this.dialog.find(".edt_motivo_perda"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.cbo_empresas=this.dialog.find(".cbo_empresas"),this.div_empresa=this.dialog.find(".div_empresa"),this.oportunidade_id=null,this.escolha_empresa_ganho_perda="",this.show=function(a,i){o.escolha_empresa_ganho_perda=i,"S"==i&&(o.div_empresa.removeClass("hidden"),o.lista_empresas()),o.oportunidade_id=a,set_datepicker(o.edt_data_perda);var e=new Date,t=e.getFullYear(),d=("0"+(e.getMonth()+1)).slice(-2),s=e.getDate();s<10&&(s="0"+s);var _=t+"-"+d+"-"+s;set_datepicker(o.edt_data_perda,_),o.listar_filtro_motivo(),o.edt_motivo_perda.attr("id","edt_motivo_perda"+o.html_id),WS.get("oportunidade/objeto/",{oportunidade_id:a},function(a){a.motivo_perda_negocio_id&&(o.cbo_motivo.val(a.motivo_perda_negocio_id),o.cbo_motivo.selectpicker("refresh"),o.edt_motivo_perda.val(a.observacao_oportunidade_perdida),o.edt_data_perda.val(a.data_situacao.format_date(!0)))}),show_modal(o.modal.attr("id")),set_focus(o.edt_motivo_perda)},this.listar_filtro_motivo=function(a){o.cbo_motivo.find("option").remove(),WS.get("motivo_perda_negocio/listar/",null,function(i){for(var e=0;e<i.length;e++){var t=i[e];add_option(o.cbo_motivo,t.motivo_perda_negocio_id,t.nome,'observacao_obrigatoria="'+t.observacao_obrigatoria+'"')}a&&o.cbo_motivo.val(a).trigger("change"),o.cbo_motivo.selectpicker("refresh")})},this.close=function(){close_modal(o.modal.attr("id")),void 0!==o.onclose&&o.onclose&&o.onclose()},this.lista_empresas=function(){o.cbo_empresas.find("option").remove(),add_option(o.cbo_empresas,-1,"Selecione uma empresa"),WS.get("usuario_empresa/listar/",{usuario_id:App.sessao.dados.usuario_id},function(a){for(var i=0;i<a.length;i++){var e=a[i];add_option(o.cbo_empresas,e.empresa_id,e.nome_fantasia)}o.cbo_empresas.val(App.sessao.dados.empresa_filial_id).trigger("change"),o.cbo_empresas.selectpicker("refresh")})},this.unload=function(){o.close(),View.unload(this.html_id)},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){o.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){if("S"==o.cbo_motivo.find('[value="'+o.cbo_motivo.val()+'"]').attr("observacao_obrigatoria")&&""==o.edt_motivo_perda.val()){var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Este motivo precisa de uma observação")),void alert_modal("Validação",a)}var i={oportunidade_id:o.oportunidade_id,motivo_perda_negocio_id:o.cbo_motivo.val(),observacao_oportunidade_perdida:o.edt_motivo_perda.val(),situacao:"P",data_situacao:get_datepicker(o.edt_data_perda),empresa_filial_id:"S"!=o.escolha_empresa_ganho_perda?App.sessao.dados.empresa_filial_id:o.cbo_empresas.val()};WS.post("oportunidade/atualizar_situacao",i,function(a){alert_saved("Situação alterada com sucesso"),void 0!==o.onsave&&o.onsave&&o.onsave(),o.unload()},[o.btn_salvar,o.btn_cancelar])})}});