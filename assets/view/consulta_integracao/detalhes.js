define([],function(){return function(a){"use strict";var t=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.lbl_titulo_id=this.dialog.find(".lbl_titulo_id"),this.cbo_conexao=this.dialog.find(".cbo_conexao"),this.edt_nome=this.dialog.find(".edt_nome"),this.edt_query=this.dialog.find(".edt_query"),this.tab_listagem_parametro=this.dialog.find(".tab_listagem_parametro"),this.table_generic=this.dialog.find(".table_generic"),this.div_parametros=this.dialog.find(".div_parametros"),this.lbl_tab_resultado=this.dialog.find(".lbl_tab_resultado"),this.lbl_tab_geral=this.dialog.find(".lbl_tab_geral"),this.modal_selecionar=this.dialog.find(".modal_selecionar"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_validar=this.dialog.find(".btn_validar"),this.btn_validar_salvar=this.dialog.find(".btn_validar_salvar"),this.div_load=this.dialog.find(".div_load"),this.chk_paginacao=this.dialog.find(".chk_paginacao"),this.dx_listagem_parametros=this.dialog.find(".dx_listagem_parametros"),this.dx_grid_colunas=this.dialog.find(".dx_grid_colunas"),this.consulta_id=null,this.params=[],this.result=null,this.array_colunas=[],this.validar=!1,this.limite=0,this.editor=null,this.valor=!0,this.dataGrid=null,this.dataGridColunasConsulta=null,this.show=function(a,o){switch(o){case FORMULARIO.NOVO:t.btn_salvar.show(),t.btn_excluir.hide(),t.listar_conexoes(),t.permite_alterar(!0);break;case FORMULARIO.EDITAR:t.btn_salvar.show(),t.btn_excluir.hide(),t.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:t.btn_salvar.hide(),t.btn_excluir.hide(),t.btn_validar_salvar.hide(),t.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:t.btn_validar_salvar.hide(),t.btn_validar.hide(),t.btn_salvar.hide(),t.btn_excluir.show(),t.permite_alterar(!1)}t.tipo=o,t.editor=monta_editor(t.edt_query,"text/x-sql",t.valor),t.editor.on("keyup",function(a,o){t.localiza_params(),t.validar=!1}),void 0!==a&&a&&(t.consulta_id=a,t.preencher()),show_modal(t.modal.attr("id")),set_focus(t.edt_nome)},this.listar_result=function(){t.organiza_array_colunas(),t.table_generic.find(".tr_head").remove();var a,o=$("<tr>");$(t.result.colunas).each(function(a,e){var i=$('<th class="tr_head text-center">');i.text(e.titulo.toUpperCase()),i.appendTo(o),o.appendTo(t.table_generic.find("thead"))});for(let a=0;a<t.result.registros.length&&a<500;a++){const o=t.result.registros[a];var e=$("<tr>");$(t.result.colunas).each(function(a,t){var i=$('<td class="text-center">');i.text(null!=o[t.nome]?o[t.nome]:""),i.appendTo(e)}),e.appendTo(t.table_generic.find("tbody"))}t.result.registros.length>500&&(e=$("<tr>"),(a=$('<td class="text-left warning small" colspan="'+t.result.colunas.length+'">')).html("Limite de exibição de 500 registros foi atingido. Existem "+(t.result.registros.length-500)+" registros que não estão sendo exibidos."),a.appendTo(e),e.appendTo(t.table_generic.find("tbody"))),e=$("<tr>"),(a=$('<td class="text-left info small" colspan="'+t.result.colunas.length+'">')).html("Esta consulta SQL retornou um total de "+t.result.registros.length+" registros."),a.appendTo(e),e.appendTo(t.table_generic.find("tbody")),t.div_load.addClass("hidden")},this.localiza_colunas=function(){var a=t.editor.getValue(),o=(a=a.replace(/\s/g,"")).toLowerCase().indexOf("from"),e=a.substring(6,o);e=e.split(",");for(var i=[],n=0;n<e.length;n++)if(null!=e[n]&&""!=e[n]){var l=e[n].toLowerCase().indexOf("as"),r=e[n];l>-1&&(r=e[n].substring(parseInt(l)+2,e[n].length));var s={coluna_id:null,nome:r,titulo:r,excluido:"N"};i.push(s)}$(i).each(function(a,o){$(t.array_colunas).each(function(t,e){o.nome==e.nome&&(o.coluna_id=e.coluna_id,o.titulo=e.titulo,i[a]=o)})}),t.render_colunas(i)},this.render_colunas=function(a){const o=()=>{t.organiza_array_colunas(),t.dataGridColunasConsulta=t.dx_grid_colunas.dxDataGrid({dataSource:t.array_colunas,keyExpr:"coluna_id",editing:{mode:"batch",allowUpdating:!0,useIcons:!1},columns:[{caption:"Nome",dataField:"nome",allowEditing:!1},{caption:"Título",dataField:"titulo"},{caption:"Tipo",dataField:"tipo",lookup:{dataSource:[{id:"1",nome:"Texto"},{id:"2",nome:"Data"},{id:"3",nome:"Data e Hora"}],valueExpr:"id",displayExpr:"nome"}}],onToolbarPreparing:a=>{for(var t=0;t<a.toolbarOptions.items.length;t++){var o=a.toolbarOptions.items[t];"saveButton"==o.name&&(o.options.visible=!1)}}}).dxDataGrid("instance")},e=t.dataGridColunasConsulta?t.dataGridColunasConsulta.getController("editing").getChanges():[];e.length?WS.post("/consulta_integracao/salvar_colunas_data_grid/",{colunas:JSON.stringify(e)},a=>{t.array_colunas=a,o()}):o()},this.localiza_params=function(){for(var a=t.editor.getValue().split(""),o=!1,e=null,i=[],n=0;n<a.length;n++)if(":"==a[n]||o)if(o=!0,"↵"==a[n]||""==a[n].trim()||void 0===a[n].length){o=!1;var l={parametro_id:null,parametro:null!=e?e:":sem_nome",nome:null!=e?e.replace(":",""):"sem nome",valor:null,excluido:"N"};i.push(l),e=null}else":"!=a[n]&&""!=a[n].trim()&&(null!=e?e+=a[n]:e=":"+a[n],n==a.length-1)&&(o=!1,l={parametro_id:null,parametro:e,nome:e.replace(":",""),valor:null,excluido:"N"},i.push(l),e=null);t.render_parametros(i)},this.render_parametros=function(a){null!=t.params&&null!=a?($(a).each(function(a,o){var e=!1;$(t.params).each(function(a,t){t.parametro==o.parametro&&(e=!0)}),e||t.params.push(o)}),$(t.params).each(function(o,e){var i=!1;$(a).each(function(a,t){e.parametro==t.parametro&&(i=!0,e.excluido="N")}),i||(e.excluido="S"),t.params[o]=e})):t.params=a,a.length>0?t.div_parametros.removeClass("hidden"):t.div_parametros.addClass("hidden");for(var o=[],e=0;e<t.params.length;e++){var i=t.params[e];"N"==i.excluido&&o.push(i)}t.dataGrid=dx_Listagem_Padrao({div_html:t.div_parametros,coluna_chave:"parametro_id",colunas:dx_Parametros_Consulta_Integracao_Colunas(),editing_mode:dx_Parametros_Consulta_Integracao_Colunas_Editing_Mode(),datasource:o,reordenar:!0,nome:t.title})},this.listar_conexoes=function(a){t.cbo_conexao.find("option").remove(),add_option(t.cbo_conexao,"","-- Selecione --"),WS.get("conexao_integracao/listar/",null,function(o){for(var e=0;e<o.length;e++){var i=o[e];i.banco_dados_tipo==CONEXAO_INTEGRACAO_BANCO_DADOS.PDO_DNS_STRING?add_option(t.cbo_conexao,i.conexao_id,i.banco_dados_nome+" / "+i.pdo_dns_string):add_option(t.cbo_conexao,i.conexao_id,i.banco_dados_nome+" / "+i.database_nome)}null!==a&&t.cbo_conexao.val(a).trigger("change"),t.cbo_conexao.selectpicker("refresh")})},this.close=function(){close_modal(t.modal.attr("id")),void 0!==t.onclose&&t.onclose&&t.onclose()},this.unload=function(){t.close(),View.unload(this.html_id)},this.permite_alterar=function(a){t.valor=!a,t.edt_query.prop("readonly",!a),t.edt_nome.prop("readonly",!a),t.cbo_conexao.prop("disabled",!a)},this.organiza_array_colunas=function(){var a,o,e,i,n=t.editor.getValue().replace(/(\r\n|\n|\r)/gm," ").toLowerCase().match(new RegExp("select(.*)from"));$.each(n[1].trim().split(","),function(a,o){$.each(t.array_colunas,function(t,e){e.nome==o.trim()&&(e.ordem=a)})}),t.array_colunas.sort((a="ordem",o=!1,e=parseInt,i=e?function(t){return e(t[a])}:function(t){return t[a]},o=o?-1:1,function(a,t){return a=i(a),t=i(t),o*((a>t)-(t>a))}))},this.preencher=function(){WS.get("consulta_integracao/objeto/",{consulta_id:t.consulta_id},function(a){t.lbl_titulo_id.text("Id."+a.id),t.edt_nome.val(a.nome),t.editor.getDoc().setValue(a.query),t.listar_conexoes(a.conexao_integracao_id),t.array_colunas=a.colunas,t.render_colunas(),t.params=a.parametros?object_to_array(a.parametros):[],t.localiza_params(),t.chk_paginacao.bootstrapSwitch("state","N"!=a.paginacao)},null,[t.btn_cancelar,t.btn_salvar,t.btn_validar,t.btn_excluir,t.btn_validar_salvar])},this.validar_query=function(a){for(var o=t.dataGrid.getController("data").items(),e=[],i=0;i<o.length;i++){var n=o[i];n.data.posicao=n.rowIndex,e.push(n.data)}WS.post("consulta_integracao/executar_consulta",{consulta_id:t.consulta_id,nome:t.edt_nome.val(),query:cripto(t.editor.getValue()),conexao_integracao_id:t.cbo_conexao.val(),parametros:JSON.stringify(e),salvar:!1,colunas:JSON.stringify(t.array_colunas),limite:a,paginacao:t.chk_paginacao.prop("checked")},function(a){t.result=a,a&&(t.validar=!0,t.lbl_tab_resultado.removeClass("hidden"),t.dialog.find(".active").removeClass("active"),t.lbl_tab_resultado.trigger("click"),$(a.colunas).each(function(o,e){$(t.array_colunas).each(function(t,i){i.nome==e.nome&&(a.colunas[o]=i)})}),t.array_colunas=a.colunas,t.listar_result(),t.render_colunas(),t.params=a.parametros?object_to_array(a.parametros):[],t.localiza_params())},null,[t.btn_cancelar,t.btn_salvar,t.btn_validar,t.btn_excluir,t.btn_validar_salvar])},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){t.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){if(!t.validar){var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Realize a validação do SQL!")),void alert_modal("Validação",a)}const o=t.dataGridColunasConsulta.getController("editing").getChanges();for(var e=t.dataGrid.getController("data").items(),i=[],n=0;n<e.length;n++){var l=e[n];l.data.posicao=l.rowIndex,i.push(l.data)}WS.post("consulta_integracao/salvar",{consulta_id:t.consulta_id,nome:t.edt_nome.val(),query:cripto(t.editor.getValue()),conexao_integracao_id:t.cbo_conexao.val(),parametros:JSON.stringify(i),save_params:!0,colunas:JSON.stringify(o),paginacao:t.chk_paginacao.prop("checked")},function(a){t.consulta_id=a.id,alert_saved(t.edt_nome.val()+" salvo com sucesso"),t.unload()},null,[t.btn_cancelar,t.btn_salvar,t.btn_validar,t.btn_excluir,t.btn_validar_salvar])}),this.btn_validar.unbind("click"),this.btn_validar.click(function(){t.table_generic.find("tr").remove(),t.validar_query(0)}),this.btn_validar_salvar.unbind("click"),this.btn_validar_salvar.click(function(){for(var a=t.dataGrid.getController("data").items(),o=[],e=0;e<a.length;e++){var i=a[e];i.data.posicao=i.rowIndex,o.push(i.data)}const n=t.dataGridColunasConsulta.getController("editing").getChanges();WS.post("consulta_integracao/executar_consulta",{consulta_id:t.consulta_id,nome:t.edt_nome.val(),query:cripto(t.editor.getValue()),conexao_integracao_id:t.cbo_conexao.val(),parametros:JSON.stringify(o),save_params:!0,salvar:!0,colunas:JSON.stringify(n),paginacao:t.chk_paginacao.prop("checked")},function(a){t.result=a,alert_saved(t.edt_nome.val()+" salvo com sucesso"),t.unload()},null,[t.btn_cancelar,t.btn_salvar,t.btn_validar,t.btn_excluir,t.btn_validar_salvar])}),this.modal_selecionar.unbind("scroll"),this.modal_selecionar.scroll(function(){!t.lbl_tab_geral.hasClass("active")&&t.chk_paginacao.prop("checked")&&t.validar&&t.modal_selecionar.scrollTop()+t.modal_selecionar.height()==t.modal_selecionar.get(0).scrollHeight&&(t.div_load.removeClass("hidden"),t.limite=t.limite+50,t.validar_query(t.limite))}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("consulta_integracao/excluir",{consulta_id:t.consulta_id},function(a){alert_saved(a.nome+" excluido com sucesso"),t.unload()})})}});