define(["react","react-dom","./../componentes_react/InformativoPrazo","./../atividade_projeto/ListarAtividadeProjeto"],function(e,a,i,o){return function(i){"use strict";var t=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title=null,this.onclose=null,this.onsave=null,this.ListarAtividadeProjeto=e.createElement(o,null,null),this.popup=this.dialog.find(".popup"),this.dx_listagem_atividades_predecessoras=this.dialog.find(".dx_listagem_atividades_predecessoras"),this.aba_formulario=this.dialog.find(".aba_formulario"),this.aba_financeiro=this.dialog.find(".aba_financeiro"),this.aba_executores=this.dialog.find(".aba_executores"),this.aba_atividades_predecessoras=this.dialog.find(".aba_atividades_predecessoras"),this.aba_apontamentos=this.dialog.find(".aba_apontamentos"),this.aba_custos=this.dialog.find(".aba_custos"),this.aba_tarefas=this.dialog.find(".aba_tarefas"),this.lbl_tab_predecessora=this.dialog.find(".lbl_tab_predecessora"),this.aba_referencias=this.dialog.find(".aba_referencias"),this.div_componente_referencias=this.dialog.find(".div_componente_referencias"),this.aba_movimentacao_financeira=this.dialog.find(".aba_movimentacao_financeira"),this.menu_formulario=this.dialog.find(".menu_formulario"),this.menu_financeiro=this.dialog.find(".menu_financeiro"),this.menu_apontamentos=this.dialog.find(".menu_apontamentos"),this.menu_atividade_prdecessoras=this.dialog.find(".menu_atividade_prdecessoras"),this.menu_executores=this.dialog.find(".menu_executores"),this.menu_custos=this.dialog.find(".menu_custos"),this.menu_tarefas=this.dialog.find(".menu_tarefas"),this.menu_referencias=this.dialog.find(".menu_referencias"),this.menu_movimentacao_financeira=this.dialog.find(".menu_movimentacao_financeira"),this.div_projeto=this.dialog.find(".div_projeto"),this.div_lbl_total_executores=this.dialog.find(".div_lbl_total_executores"),this.lbl_projeto_codigo=this.dialog.find(".lbl_projeto_codigo"),this.lbl_projeto_nome=this.dialog.find(".lbl_projeto_nome"),this.lbl_cliente_nome=this.dialog.find(".lbl_cliente_nome"),this.lbl_valor_total=this.dialog.find(".lbl_valor_total"),this.lbl_horas_previstas_total=this.dialog.find(".lbl_horas_previstas_total"),this.lbl_horas_previstas_saldo_total=this.dialog.find(".lbl_horas_previstas_saldo_total"),this.lbl_tab_movimentacao_financeira=this.dialog.find(".lbl_tab_movimentacao_financeira"),this.edt_codigo_projeto=this.dialog.find(".edt_codigo_projeto"),this.edt_porcentagem=this.dialog.find(".edt_porcentagem"),this.edt_data_solicitacao_projeto=this.dialog.find(".edt_data_solicitacao_projeto"),this.cbo_tipo_previsao_inicio=this.dialog.find(".cbo_tipo_previsao_inicio"),this.edt_previsao_inicio=this.dialog.find(".edt_previsao_inicio"),this.edt_inicio_projeto=this.dialog.find(".edt_inicio_projeto"),this.edt_prazo_projeto=this.dialog.find(".edt_prazo_projeto"),this.edt_conclusao_projeto=this.dialog.find(".edt_conclusao_projeto"),this.edt_horas_previstas=this.dialog.find(".edt_horas_previstas"),this.edt_nome_atividade=this.dialog.find(".edt_nome_atividade"),this.edt_valor_hora_atividade=this.dialog.find(".edt_valor_hora_atividade"),this.edt_prazo_dias=this.dialog.find(".edt_prazo_dias"),this.cbo_assunto_projeto=this.dialog.find(".cbo_assunto_projeto"),this.lbl_status=this.dialog.find(".lbl_status"),this.cbo_consultor_projeto=this.dialog.find(".cbo_consultor_projeto"),this.cbo_responsavel_projeto=this.dialog.find(".cbo_responsavel_projeto"),this.cbo_atividade_sinteticas=this.dialog.find(".cbo_atividade_sinteticas"),this.cbo_valor_previsto=this.dialog.find(".cbo_valor_previsto"),this.cbo_item=this.dialog.find(".cbo_item"),this.div_recursos=this.dialog.find(".div_recursos"),this.div_valor_hora=this.dialog.find(".div_valor_hora"),this.div_valor_total=this.dialog.find(".div_valor_total"),this.div_datas=this.dialog.find(".div_datas"),this.div_conclusao=this.dialog.find(".div_conclusao"),this.div_check_email=this.dialog.find(".div_check_email"),this.div_alert_apontamentos=this.dialog.find(".div_alert_apontamentos"),this.div_classificacao=this.dialog.find(".div_classificacao"),this.txt_atividades=this.dialog.find(".txt_atividades"),this.lbl_atividade_count=this.dialog.find(".lbl_atividade_count"),this.txt_observacoes=this.dialog.find(".txt_observacoes"),this.total_geral_horas=this.dialog.find(".total_geral_horas"),this.chk_notificar_envolvidos_email=this.dialog.find(".chk_notificar_envolvidos_email"),this.chk_marco=this.dialog.find(".chk_marco"),this.chk_cancelada=this.dialog.find(".chk_cancelada"),this.chk_tipo_cancelamento_ignorar_prev_real=this.dialog.find(".chk_tipo_cancelamento_ignorar_prev_real"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_novo_assunto=this.dialog.find(".btn_novo_assunto"),this.btn_visualizar_assunto=this.dialog.find(".btn_visualizar_assunto"),this.btn_apontamento=this.dialog.find(".btn_apontamento"),this.btn_refresh_apontamentos=this.dialog.find(".btn_refresh_apontamentos"),this.btn_incluir_item=this.dialog.find(".btn_incluir_item"),this.btn_incluir_tarefa=this.dialog.find(".btn_incluir_tarefa"),this.btn_cancelar_edicao_tarefa=this.dialog.find(".btn_cancelar_edicao_tarefa"),this.btn_editar_tarefa=this.dialog.find(".btn_editar_tarefa"),this.btn_recarregar_tarefa=this.dialog.find(".btn_recarregar_tarefa"),this.edt_nova_tarefa=this.dialog.find(".edt_nova_tarefa"),this.tab_custo_listagem=this.dialog.find(".tab_custo_listagem"),this.tab_tarefas=this.dialog.find('[data-table-name="tarefas"]').Tabela_Padrao_Next(),this.tab_apontamentos=this.dialog.find(".tab_apontamentos"),this.div_cbo_executores=this.dialog.find(".div_cbo_executores"),this.cbo_executores=this.dialog.find(".cbo_executores"),this.cbo_classificacao=this.dialog.find(".cbo_classificacao"),this.listagem_executores=this.dialog.find(".listagem_executores"),this.menu_mobile=this.dialog.find(".menu-mobile"),this.floating=this.dialog.find(".floating-menu"),this.collapse_accordion=this.dialog.find("#accordion"),this.chk_exibir_prazo_agenda=this.dialog.find(".chk_exibir_prazo_agenda"),this.div_exibir_prazo_agenda=this.dialog.find(".div_exibir_prazo_agenda"),this.div_porcentagem_peso_atividade=this.dialog.find(".div_porcentagem_peso_atividade"),this.dx_peso_atividade=this.dialog.find(".dx_peso_atividade"),this.div_componente_movimentacao_financeira=this.dialog.find(".div_componente_movimentacao_financeira"),this.divs_informativo_prazo=[],this.cliente_id=null,this.projeto_id=null,this.projeto_nome=null,this.projeto_codigo=null,this.projeto_atividade_id=null,this.template="N",this.equipe=new Array,this.arr_atividades_predecessoras=[],this.email_consultor=null,this.email_responsavel=null,this.assunto=null,this.atividade=null,this.tipo_previsao_inicio=null,this.previsao_inicio=null,this.prazo=null,this.conclusao=null,this.inicio=null,this.aba=null,this.atividade_sintetica_pai=null,this.arr_executores=[],this.arr_grupo_executores=[],this.grupo_usuarios_equipe=[],this.todos_executores=[],this.cliente_nome=null,this.projeto_atividade_classificacoes=!1,this.planejamento_datas=!1,this.documento_pasta_id=null,this.bloquear_codigo=!1,this.tabela_custos=[],this.tipo_formulario=FORMULARIO.NOVO,this.tarefa_atual=null,this.projeto_calendario_trabalho_id=null,this.permissoes_projeto=null,this.sugerir_data_prazo=!1,this.status_projeto=null,this.permitir_apontamento_projeto_concluido=null,this.projeto_apontamento_por=null,this.instanceMovimentacaoFinanceira=null,this.sortable_config={placeholder:"ui-state-highlight",revert:!0,axis:"y",cursorAt:{top:5,left:0},helper:function(e,a){var i=$(a).find(".descricao").text(),o="true"===$(a).find(".descricao").attr("data-realizado");return $('<section class="tarefas-row-helper"><article class="tarefas-row" data-realizado="'+o+'"><i class="fa '+(o?"fa-check-square":"fa-square")+' fa-fw"></i>&nbsp;&nbsp;'+i+"</article></section>")},stop:function(e,a){var i=[];$(a.item).parent().find("tr:not([template-row])").each(function(e,a){i.push({id:$(a).attr("data-id"),ordem:e})}),WS.post({route:"tarefa/alterar_ordem/",data:{ordenacao:JSON.stringify(i)},func_response:function(e){t.carregar_tarefas()},func_fail:function(){}})}},this.arr_tarefas=[],this.tabela_tarefa_config={disabled:!1},this.possui_executor_previsao_inicio=!1,this.datasource_movimentacao_financeira=[],this.input_peso_atividade=null,this.utiliza_peso_atividades=!1,this.show=function(e,a,i,o,r,s,d,_,n,l,c,p,u,v,m=!1){if("object"==typeof e&&null!=e){var h=clone_obj(e);e=null!=h.projeto_id&&""!=h.projeto_id?h.projeto_id:null,a=null!=h.projeto_atividade_id&&""!=h.projeto_atividade_id?h.projeto_atividade_id:null,i=null!=h.tipo&&""!=h.tipo?h.tipo:FORMULARIO.NOVO,o=null!=h.template&&""!=h.template?h.template:null,r=null!=h.equipe&&""!=h.equipe?h.equipe:null,s=null!=h.nome&&""!=h.nome?h.nome:null,d=null!=h.aba&&""!=h.aba?h.aba:null,_=null!=h.atividade_sintetica_pai&&""!=h.atividade_sintetica_pai?h.atividade_sintetica_pai:null,n=null!=h.grupo_usuarios_equipe&&""!=h.grupo_usuarios_equipe?h.grupo_usuarios_equipe:null,l=null!=h.sugere_codigo&&""!=h.sugere_codigo?h.sugere_codigo:null,c=null!=h.cliente_nome&&""!=h.cliente_nome?h.cliente_nome:null,p=null!=h.permitir_apontamento_projeto_concluido&&""!=h.permitir_apontamento_projeto_concluido?h.permitir_apontamento_projeto_concluido:null,u=null!=h.status_projeto&&""!=h.status_projeto?h.status_projeto:null,v=null!=h.projeto_apontamento_por&&""!=h.projeto_apontamento_por.toString()?h.projeto_apontamento_por.toString():null,m=void 0!==h.utiliza_peso_atividades&&h.utiliza_peso_atividades}t.projeto_id=e,t.tipo_formulario=i,t.aba=d,t.atividade_sintetica_pai=_,t.template=o,t.equipe=r,t.nome=s,t.permitir_apontamento_projeto_concluido=p,t.status_projeto=u,t.grupo_usuarios_equipe=n,t.sugere_codigo=l,t.cliente_nome=c,t.projeto_atividade_classificacoes="true"==App.sessao.dados.parametro_projeto.projeto_atividade_classificacoes,t.projeto_apontamento_por=v,t.utiliza_peso_atividades=m,t.btn_confirmar.hide(),t.btn_excluir.hide(),t.menu_custos.addClass("hidden"),t.menu_financeiro.addClass("hidden"),t.menu_movimentacao_financeira.addClass("hidden"),t.div_lbl_total_executores.addClass("hidden"),t.btn_apontamento.addClass("hidden");var f=function(e,i){switch(t.tipo_formulario=e,t.cliente_nome=i,t.edt_valor_hora_atividade.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),t.collapse_accordion.attr("id","accordion"+t.html_id),t.collapse_accordion.find("[href='#list-chamados2']").attr("href","#list-chamados2"+t.html_id).attr("data-parent","#accordion"+t.html_id).attr("aria-controls","list-chamados2"+t.html_id),t.collapse_accordion.find("#list-chamados2").attr("id","list-chamados2"+t.html_id).attr("aria-labelledby","list-chamados2"+t.html_id),$(t.tab_tarefas.tabela).find(".sortable").sortable(t.sortable_config),t.aba_formulario.attr("id","aba_formulario"+t.html_id),t.aba_financeiro.attr("id","aba_financeiro"+t.html_id),t.aba_executores.attr("id","aba_executores"+t.html_id),t.aba_atividades_predecessoras.attr("id","aba_atividades_predecessoras"+t.html_id),t.aba_apontamentos.attr("id","aba_apontamentos"+t.html_id),t.aba_custos.attr("id","aba_custos"+t.html_id),t.aba_tarefas.attr("id","aba_tarefas"+t.html_id),t.aba_referencias.attr("id","aba_referencias"+t.html_id),t.aba_movimentacao_financeira.attr("id","aba_movimentacao_financeira"+t.html_id),t.menu_formulario.attr("href","#"+t.aba_formulario.attr("id")),t.menu_financeiro.attr("href","#"+t.aba_financeiro.attr("id")),t.menu_atividade_prdecessoras.attr("href","#"+t.aba_atividades_predecessoras.attr("id")),t.txt_atividades.attr("id","txt_atividades"+t.html_id),t.menu_executores.attr("href","#"+t.aba_executores.attr("id")),t.menu_apontamentos.attr("href","#"+t.aba_apontamentos.attr("id")),t.menu_custos.attr("href","#"+t.aba_custos.attr("id")),t.menu_tarefas.attr("href","#"+t.aba_tarefas.attr("id")),t.menu_referencias.attr("href","#"+t.aba_referencias.attr("id")),t.menu_movimentacao_financeira.attr("href","#"+t.aba_movimentacao_financeira.attr("id")),set_datepicker(t.edt_data_solicitacao_projeto),set_datepicker(t.edt_previsao_inicio),set_datepicker(t.edt_inicio_projeto),set_datepicker(t.edt_prazo_projeto),set_datepicker(t.edt_conclusao_projeto),t.edt_horas_previstas.mask("000:00"),"S"==t.template&&(t.div_conclusao.hide(),t.div_datas.hide(),t.btn_apontamento.addClass("hidden"),t.permissoes_projeto={gerente_projeto:!0,permissao_atividade:!0,permissao_recursos:!0,permissao_financeiro:!0,permissao_datas:!0}),e){case FORMULARIO.NOVO:t.title=t.projeto_codigo+" - Nova Atividade",App.titulo_aba(t.html_id,t.title),t.btn_apontamento.addClass("hidden"),t.collapse_accordion.addClass("hidden"),t.menu_mobile.addClass("hidden"),t.btn_confirmar.show(),t.btn_excluir.hide(),t.div_check_email.removeClass("hidden"),t.menu_atividade_prdecessoras.addClass("hidden"),t.menu_apontamentos.addClass("hidden"),t.menu_financeiro.addClass("hidden"),t.menu_movimentacao_financeira.addClass("hidden"),t.menu_custos.addClass("hidden"),t.menu_tarefas.addClass("hidden"),t.menu_referencias.addClass("hidden"),t.div_lbl_total_executores.addClass("hidden"),1==t.sugere_codigo&&WS.get("atividade_projeto/get_next_codigo/",{projeto_id:t.projeto_id},function(e){t.edt_codigo_projeto.val(e)}),t.menu_executores.addClass("hidden"),t.btn_confirmar.addClass("list-group-item-warning"),t.bloqueia_codigo(),t.chk_exibir_prazo_agenda.prop("checked",!0),t.chk_exibir_prazo_agenda.removeClass("template_switch"),App.aplicar_checkbox(t.div_exibir_prazo_agenda),t.permissoes_usuario(!1,FORMULARIO.NOVO);break;case FORMULARIO.EDITAR:App.titulo_aba(t.html_id,t.nome.substring(0,10)),t.btn_confirmar.show(),t.btn_excluir.hide(),t.permite_alterar(!1),t.permissoes_usuario(!1,FORMULARIO.EDITAR),t.div_check_email.removeClass("hidden"),t.bloqueia_codigo();break;case FORMULARIO.VISUALIZAR:App.titulo_aba(t.html_id,t.nome.substring(0,10)),t.btn_confirmar.hide(),t.btn_excluir.hide(),t.permite_alterar(!1),t.permissoes_usuario(!0,FORMULARIO.VISUALIZAR);break;case FORMULARIO.EXCLUIR:t.btn_confirmar.hide(),t.btn_excluir.show().unbind("click").click(function(){WS.post("atividade_projeto/excluir",{atividade_projeto_id:t.projeto_atividade_id},function(e){alert_saved("Atividade excluida com sucesso"),t.unload()},[t.btn_excluir])}),t.permite_alterar(!1),t.permissoes_usuario(!0,FORMULARIO.EXCLUIR)}t.div_cbo_executores.addClass("hidden"),t.tipo_formulario!==FORMULARIO.EDITAR&&t.tipo_formulario!==FORMULARIO.NOVO||(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_recursos)&&(t.div_cbo_executores.removeClass("hidden"),create_combobox(t.cbo_executores,t.listar_executores)),void 0!==a&&a?(t.projeto_atividade_id=a,t.preencher(),t.title="Atividade - "+t.nome):(set_tinymce(t.txt_atividades,""),t.div_projeto.hide(),t.listar_assunto(),t.listar_responsavel(),t.render_input_peso_atividade()),t.listar_atividade_sinteticas(t.atividade_sintetica_pai),1==t.projeto_atividade_classificacoes?(t.div_classificacao.removeClass("hidden"),e==FORMULARIO.NOVO&&t.listar_classificacao()):t.div_classificacao.addClass("hidden"),set_focus(t.edt_codigo_projeto)},b=function(e){for(var a={gerente_projeto:!1,permissao_atividade:!1,permissao_recursos:!1,permissao_financeiro:!1,permissao_datas:!1},i=object_to_array(e),o=0;o<i.length;o++)if(i[o].usuario_id==App.sessao.dados.usuario_id){a.gerente_projeto="S"==i[o].gerente_projeto||1==i[o].gerente_projeto,a.permissao_atividade="S"==i[o].planejamento_atividade||1==i[o].planejamento_atividade,a.permissao_recursos="S"==i[o].planejamento_recursos||1==i[o].planejamento_recursos,a.permissao_financeiro="S"==i[o].planejamento_financeiro||1==i[o].planejamento_financeiro,a.permissao_datas="S"==i[o].planejamento_datas||1==i[o].planejamento_datas,t.permissoes_projeto=a;break}null==t.permissoes_projeto&&(t.permissoes_projeto=a)};parseInt(a,10)>0?WS.get("atividade_projeto/objeto/",{atividade_projeto_id:a},function(e){t.projeto_id=e.projeto_id,t.nome=e.atividade_simplificada.substring(0,10),t.projeto_calendario_trabalho_id=e.projeto_calendario_trabalho_id,b(e.equipe_projeto),f(i,e.cliente_nome)}):parseInt(e,10)>0?WS.get("projeto/objeto/",{projeto_id:e},function(e){t.projeto_codigo=e.codigo,t.projeto_calendario_trabalho_id=e.calendario_trabalho_id,b(e.equipe_toda),f(i,e.cliente_nome)}):f(i,response.cliente_nome)},this.cbo_valor_previsto.on("change",function(e){var a=$(e.target).val();if(a==TIPO_FINANCEIRO.HORA_TECNICO){var i=new Validation;i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja aplicar valor hora por técnico nos executores desta atividade?")),alert_modal("Validação",i,"Sim",function(){$.each(t.arr_executores,function(e,a){$.each(t.equipe,function(i,o){a.id==o.usuario_id&&(t.arr_executores[e].valor_hora=t.equipe[i].valor_projeto)})}),t.render_executores()},!0,"Não"),t.div_valor_hora.addClass("hidden")}else a==TIPO_FINANCEIRO.HORA_MANUAL?($.each(t.arr_executores,function(e,a){t.arr_executores[e].valor_hora=0}),t.div_valor_hora.addClass("hidden"),t.render_executores()):($.each(t.arr_executores,function(e,a){t.arr_executores[e].valor_hora=t.edt_valor_hora_atividade.maskMoney("unmasked")[0]}),t.render_executores(),t.div_valor_hora.removeClass("hidden"))}),this.edt_valor_hora_atividade.keyup(function(e){if(t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_ATIVIDADE){$(".edt_valor_hora").val($(e.target).val());var a=$(".listagem_executores li:not(.template_row)");$.each(a,function(e,a){var i=$(a).find(".edt_horas_alocadas"),o=$(a).find(".edt_valor_hora"),r=$(a).find(".edt_valor_total");t.custo_total(i,o,r)})}}),this.permissoes_usuario=function(e,a){a!==FORMULARIO.NOVO&&a!==FORMULARIO.EDITAR||(t.btn_confirmar.unbind("click").click(function(){t.salvar_atividade(!0)}),t.status_projeto==PROJETO_STATUS.CONCLUIDO&&"S"!=t.permitir_apontamento_projeto_concluido||t.btn_apontamento.removeClass("hidden"),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto)&&(t.chk_cancelada.prop("disabled",e),t.chk_tipo_cancelamento_ignorar_prev_real.prop("disabled",e)),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_atividade)&&(t.cbo_assunto_projeto.prop("disabled",e),t.txt_observacoes.prop("disabled",e),t.cbo_classificacao.prop("disabled",e),t.edt_codigo_projeto.prop("readonly",e),t.edt_porcentagem.prop("readonly",e),t.btn_novo_assunto.prop("disabled",e),t.btn_visualizar_assunto.prop("disabled",e),t.btn_confirmar.removeClass("hidden"),t.edt_nome_atividade.prop("disabled",e),t.cbo_atividade_sinteticas.prop("disabled",e),t.setTaskDisable(!1)),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_recursos)&&(t.cbo_responsavel_projeto.prop("disabled",e),t.cbo_consultor_projeto.prop("disabled",e),t.cbo_executores.prop("disabled",e),t.chk_exibir_prazo_agenda.prop("disabled",e)),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_datas)&&(t.edt_data_solicitacao_projeto.prop("readonly",e),t.cbo_tipo_previsao_inicio.prop("disabled",e).selectpicker("refresh"),t.edt_previsao_inicio.prop("readonly",e),t.edt_inicio_projeto.prop("readonly",e),t.edt_prazo_projeto.prop("readonly",e),t.edt_conclusao_projeto.prop("readonly",e),t.edt_prazo_dias.prop("disabled",e),t.edt_horas_previstas.prop("disabled",e)))},this.bloqueia_codigo=function(e){WS.get("projeto/objeto/",{projeto_id:t.projeto_id},function(e){t.bloquear_codigo=e.bloquear_codigo,t.documento_pasta_id=e.documento_pasta_id,t.projeto_codigo=e.codigo,1==t.bloquear_codigo||"S"==t.bloquear_codigo?t.edt_codigo_projeto.prop("disabled",!0):t.edt_codigo_projeto.prop("disabled",!1)})},this.listar_atividade_sinteticas=function(e){t.cbo_atividade_sinteticas.find("option").remove(),add_option(t.cbo_atividade_sinteticas,"","Nenhuma"),WS.get("atividade_sintetica_projeto/listar/",{projeto_id:t.projeto_id},function(a){for(var i=function(e,o,r){add_option(t.cbo_atividade_sinteticas,e.atividade_sintetica_id,o.repeat(r)+e.nome);for(var s=[],d=0;d<a.length;d++)(_=a[d]).projeto_atividade_sintetica_pai_id==e.atividade_sintetica_id&&s.push(_);for(d=0;d<s.length;d++){var _=s[d];i(_,o,r+1)}},o=0;o<a.length;o++){var r=a[o];r.projeto_atividade_sintetica_pai_id||i(r,"&mdash;",0)}t.cbo_atividade_sinteticas.selectpicker("refresh"),e&&t.cbo_atividade_sinteticas.val(e).trigger("change")})},this.listar_assunto=function(e){t.cbo_assunto_projeto.find("option").remove(),add_option(t.cbo_assunto_projeto,"","Nenhum"),WS.get("assunto_projeto/listar/",null,function(a){for(var i=0;i<a.length;i++){var o=a[i];add_option(t.cbo_assunto_projeto,o.assunto_projeto_id,o.descricao)}e&&t.cbo_assunto_projeto.val(e).trigger("change"),t.cbo_assunto_projeto.selectpicker("refresh")},null,null,null,null,null,t.html_id)},this.listar_classificacao=function(e){t.cbo_classificacao.find("option").remove(),add_option(t.cbo_classificacao,"","- Selecione -"),WS.get("projeto_atividade_classificacao/listar/",null,function(a){for(var i=0;i<a.length;i++){var o=a[i];add_option(t.cbo_classificacao,o.projeto_atividade_classificacao_id,o.nome)}e&&t.cbo_classificacao.val(e).trigger("change"),t.cbo_classificacao.selectpicker("refresh")},null,null,null,null,null,t.html_id)},this.listar_executores=function(e,a){var i=t.cbo_executores.parent(),o=i.find(".edt_combobox");if(null!=t.grupo_usuarios_equipe&&"undefined"!=t.grupo_usuarios_equipe&&t.grupo_usuarios_equipe.length>0||null!=t.equipe&&"undefined"!=t.equipe){var r=[];if(void 0!==o.val()&&""!=o.val()){if(null!=t.equipe&&"undefined"!=t.equipe)for(var s in t.equipe)"clean"!=s&&(d=t.equipe[s]).nome.toUpperCase().indexOf(o.val().toUpperCase())>-1&&r.push(d);null!=t.grupo_usuarios_equipe&&"undefined"!=t.grupo_usuarios_equipe&&t.grupo_usuarios_equipe.length>0&&$(t.grupo_usuarios_equipe).each(function(e,a){a.nome.toUpperCase().indexOf(o.val().toUpperCase())>-1&&r.push(a)})}else if(null!=t.grupo_usuarios_equipe&&"undefined"!=t.grupo_usuarios_equipe&&t.grupo_usuarios_equipe.length>0&&$(t.grupo_usuarios_equipe).each(function(e,a){r.push(a)}),null!=t.equipe&&"undefined"!=t.equipe)for(var s in t.equipe)if("clean"!=s){var d=t.equipe[s];r.push(d)}limpar_combobox(t.cbo_executores);for(var _=0;_<r.length;_++){d=r[_];var n=[];n.Nome=d.nome;var l=$('<span class="label lb_tipo" style="margin: 5px;"></span>');d.usuario_id>0&&"N"==d.substituto?(l.addClass("tipo_executor label-info"),l.attr("title","Usuário"),l.attr("data-original-title","Usuário"),l.text("U"),l.attr("tipo","usuario")):d.grupo_usuarios_id>0&&(l.addClass("tipo_executor label-warning"),l.attr("title","Grupo de Usuários"),l.attr("data-original-title","Grupo de Usuários"),l.text("GU"),l.attr("tipo","grupo_usuarios")),l.tooltip(),add_option_combobox(t.cbo_executores,_,d.usuario_id>0?d.usuario_id:d.grupo_usuarios_id,n,l,d.valor_projeto>0?d.valor_projeto:0)}e(!0),o.keypress(function(e){if(13==e.keyCode){var a=t.cbo_executores.parent().find(".ncbo_scroll").find(".row_selected"),i=a.attr("id_registro"),r=a.find(".tipo_executor").attr("tipo"),s=$(this),d=s.attr("dados-adicionais")?s.attr("dados-adicionais"):null;if(i>0){var _=!1;if("usuario"==r?$(t.arr_executores).each(function(e,a){i==a.id&&("N"==a.excluido?_=!0:t.arr_executores[e].excluido="S")}):"grupo_usuarios"==r&&$(t.arr_grupo_executores).each(function(e,a){i==a.id&&("N"==a.excluido?_=!0:t.arr_grupo_executores[e].excluido="S")}),!_){var n={id:i,nome:o.val(),tipo:r,valor_hora:t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_MANUAL?0:d,previsao_inicio:null,horas_previstas:null,valor_previsto:null,excluido:"N"};t.render_executores(n)}o.val(""),set_focus(o)}}}),i.find(".ul_row").click(function(){var e=$(this).parent().attr("id_registro"),a=$(this).find(".tipo_executor").attr("tipo"),i=$(this).parent(),r=i.attr("dados-adicionais")?i.attr("dados-adicionais"):null;if(e>0){var s=!1;"usuario"==a?$(t.arr_executores).each(function(a,i){e==i.id&&(s=!0)}):"grupo_usuarios"==a&&$(t.arr_grupo_executores).each(function(a,i){e==i.id&&(s=!0)}),setTimeout(function(){if(!s){var i={id:e,nome:o.val(),tipo:a,valor_hora:t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_MANUAL?0:r,previsao_inicio:null,horas_previstas:null,valor_previsto:null,excluido:"N"};t.render_executores(i)}},150)}o.val(""),set_focus(o)})}},this.custo_total=function(e,a,i){var o=e.val().substring(0,3),r=e.val().substring(4,6),s=60*parseInt(o,10)+parseInt(r,10),d=a.maskMoney("unmasked")[0],_=s*(parseFloat(d)/60);i.addClass("edt_executores_valor_total").attr("elem_key",md5(Math.random()+new Date)),i.maskMoney("mask",parseFloat(_)),i.trigger("change"),t.soma_total()},this.soma_total=function(){if(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_financeiro){var e="00:00",a=0;$.each(t.arr_executores,function(i,o){"N"==o.excluido&&(a+=o.valor_previsto,e=somar_horas(e,o.horas_previstas))}),t.div_lbl_total_executores.removeClass("hidden"),t.lbl_horas_previstas_total.html("Total horas alocadas <br />"+e),t.lbl_horas_previstas_saldo_total.html("Saldo horas não alocadas <br />"+subtrair_horas(t.edt_horas_previstas.val(),e)),t.lbl_valor_total.html("Valor total <br />"+a.format_number(2,!0))}},this.renderizarComponenteMovimentacaoFinanceira=function(){var e={atividadeProjetoId:t.projeto_atividade_id,arrDatasource:t.datasource_movimentacao_financeira,instanceMovimentacaoFinanceira:function(e){t.instanceMovimentacaoFinanceira=e}};ReactDOM.render(React.createElement(window.components.MovimentacaoFinanceira.default,e),t.div_componente_movimentacao_financeira[0])},this.render_executores=function(e){var a=t.listagem_executores.find(".template_row"),i=function(e,a=6){var i=new Validation,o=e.split(":"),t=o[1];return o.length,t>59||e.length>0&&e.length!=a?(i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Valor de horas inválido")),alert_modal("Validação",i),!1):!(e>"838:59"&&(i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"O valor de horas deve ser menor que 838:59")),alert_modal("Validação",i),1))},o=function(e,a){e.previsao_inicio&&e.horas_previstas&&e.previsao_inicio.length>0&&e.horas_previstas.length>0&&WS.get("/atividade_projeto/calcular_prazo_previsto/",{calendario_trabalho_id:t.projeto_calendario_trabalho_id,previsao_inicio:e.previsao_inicio,horas_previstas:e.horas_previstas,horas_dedicadas:e.horas_dedicadas},function(i){set_datepicker(a,i.substring(0,10)),e.prazo_previsto=i})},r=function(e,r){null!=r.horas_previstas&&""!=r.horas_previstas&&(r.horas_previstas=format_time(r.horas_previstas)),"00:00"!=r.horas_previstas&&"000:00"!=r.horas_previstas||(r.horas_previstas=null),r.horas_dedicadas&&(null!==r.horas_dedicadas&&""!==r.horas_dedicadas&&(r.horas_dedicadas=format_time(r.horas_dedicadas).substring(1)),"00:00"!=r.horas_dedicadas&&"000:00"!=r.horas_dedicadas||(r.horas_dedicadas=null));var s=a.clone();s.removeAttr("template-row"),s.css("display",""),s.removeClass("template_row"),s.addClass("new_row");var d=$(s.find(".table_agenda_evento")),_=$(d.find(".btn_incluir_evento_agenda"));_.unbind("click"),_.click(function(){View.load("agenda/agenda_evento",function(e,a){var i=new Object;i.projeto_id=t.projeto_id,i.projeto_nome=t.projeto_nome,i.projeto_atividade_id=t.projeto_atividade_id,i.cliente_id=t.cliente_id,i.cliente_nome=t.cliente_nome,i.previsao_inicio=r.previsao_inicio,i.horas_previstas=r.horas_previstas;var o={evento_id:null,usuario_id:r.id,dia:getDateNow(!0),usuario_nome:"",obj_dados_projeto:i,agenda_ativo_id:null,calendario_trabalho_id:r.calendario_trabalho_id};a.onsave=function(){t.listar_agenda_evento(d,{projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id,usuario_id:r.id}),t.atualizar_data_prazo()},a.show(o)})}),(f=$(s.find("[template-button='btn_agenda_recorrente']"))).unbind("click"),f.click(function(){if(d.hasClass("hidden")){var e={projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id,usuario_id:r.id};t.atualizar_data_prazo(),t.listar_agenda_evento(d,e),d.removeClass("hidden")}else d.find("tr:gt(1)").remove(),d.addClass("hidden")}),$(s.find("[template-field='nome']")).text(r.nome);var n=$(s.find("[template-field='tipo']"));"usuario"==r.tipo?(n.addClass("label-info"),n.attr("title","Usuário"),n.attr("data-original-title","Usuário"),n.text("U")):"grupo_usuarios"==r.tipo&&(n.addClass("label-warning"),n.attr("title","Grupo de Usuários"),n.attr("data-original-title","Grupo de Usuários"),n.text("GU"));var l=$(s.find(".edt_valor_total")),c=$(s.find("[template-field='edt_valor_hora']")),p=$(s.find("[template-field='edt_previsao_inicio_executor']")),u=$(s.find("[template-field='edt_horas_alocadas']")),v=$(s.find("[template-field='edt_horas_dedicadas']")),m=$(s.find("[template-field='edt_prazo_previsto_executor']")),h=$(s.find("[template-button='btn_usuario_remover']")),f=$(s.find("[template-button='btn_agenda_recorrente']")),b=$(s.find(".th_valor_hora")),g=$(s.find(".th_valor_total"));g.addClass("hidden"),b.addClass("hidden"),h.addClass("hidden"),f.addClass("hidden"),u.prop("disabled",!0),v.prop("disabled",!0),p.attr("type","date"),set_datepicker(p),m.attr("type","date"),set_datepicker(m),m.attr("readonly",!0),p.attr("readonly",!0);var j=()=>{for(var e=0,a=0;a<t.arr_executores.length;a++)"N"==(i=t.arr_executores[a]).excluido&&(e=somar_horas(i.horas_previstas,e));for(a=0;a<t.arr_grupo_executores.length;a++){var i;"N"==(i=t.arr_grupo_executores[a]).excluido&&(e=somar_horas(i.horas_previstas,e))}format_time(e)>format_time(t.edt_horas_previstas.val())&&(t.permissoes_projeto.permissao_atividade||App.sessao.dados.admin)&&alertaPopUp("Atenção","O total de horas dos executores está maior que as horas previstas da atividade.<br/>Deseja atribuir "+format_time(e)+" à hora prevista da atividade ?","Sim",function(){t.edt_horas_previstas.val(format_time(e))},"Não",function(){})};if(App.sessao.dados.admin?!0===App.sessao.dados.admin&&(g.removeClass("hidden"),b.removeClass("hidden"),u.prop("disabled",!1),v.prop("disabled",!1),h.removeClass("hidden"),"usuario"==r.tipo&&f.removeClass("hidden"),p.removeAttr("readonly"),l.unbind("change"),l.change(function(){$(s.find(".edt_valor_total")).prop("disabled",!0),l.val(this.value),r.valor_previsto=$(this).maskMoney("unmasked")[0]}),c.unbind("change"),c.change(function(){$(s.find("[template-field='edt_valor_hora']")).val(this.value),t.custo_total(u,c,l),r.valor_hora=$(this).maskMoney("unmasked")[0]}),u.on("change",function(){i($(this).val())&&($(s.find("[template-field='edt_horas_alocadas']")).val(this.value),t.custo_total(u,c,l),r.horas_previstas=$(this).val(),t.soma_total(),o(r,m))}),u.on("blur",function(){j()}),l.trigger("change"),h.unbind("click"),h.click(function(){s.remove(),"usuario"==r.tipo?t.arr_executores[e].excluido="S":"grupo_usuarios"==r.tipo&&(t.arr_grupo_executores[e].excluido="S"),t.soma_total(),t.sugerir_previsao_inicio_atividade()}),c.prop("disabled",!0),"grupo_usuarios"==r.tipo&&(b.remove(),g.remove())):(t.permissoes_projeto.permissao_financeiro&&(g.removeClass("hidden"),b.removeClass("hidden"),l.unbind("change"),l.change(function(){$(s.find(".edt_valor_total")).prop("disabled",!0),l.val(this.value),r.valor_previsto=$(this).maskMoney("unmasked")[0]}),c.unbind("change"),c.change(function(){$(s.find("[template-field='edt_valor_hora']")).val(this.value),t.custo_total(u,c,l),r.valor_hora=$(this).maskMoney("unmasked")[0]}),l.trigger("change")),t.permissoes_projeto.permissao_recursos&&(u.prop("disabled",!1),v.prop("disabled",!1),u.on("change",function(){i($(this).val())&&($(s.find("[template-field='edt_horas_alocadas']")).val(this.value),t.custo_total(u,c,l),r.horas_previstas=$(this).val(),t.soma_total(),o(r,m))}),u.on("blur",function(){j()}),h.removeClass("hidden"),h.unbind("click"),h.click(function(){s.remove(),"usuario"==r.tipo?t.arr_executores[e].excluido="S":"grupo_usuarios"==r.tipo&&(t.arr_grupo_executores[e].excluido="S"),t.soma_total(),t.sugerir_previsao_inicio_atividade()})),t.permissoes_projeto.permissao_datas&&("usuario"==r.tipo&&f.removeClass("hidden"),p.removeAttr("readonly"))),p.on("change",function(){""==get_datepicker(p)||null==get_datepicker(p)?t.possui_executor_previsao_inicio=!1:t.possui_executor_previsao_inicio=!0,r.previsao_inicio=get_datepicker(p),t.sugerir_previsao_inicio_atividade(),o(r,m)}),v.on("keyup",$.debounce(950,function(){const e=$(this).val();if(5==e.length){if(!i(e,5))return;r.horas_dedicadas=e,o(r,m)}})),null!=r.previsao_inicio?(t.possui_executor_previsao_inicio=!0,set_datepicker(p,r.previsao_inicio),t.edt_previsao_inicio.prop("readonly",!0)):(t.possui_executor_previsao_inicio=!1,t.edt_previsao_inicio.prop("readonly",!1)),null!=get_datepicker(t.edt_inicio_projeto)&&""!=get_datepicker(t.edt_inicio_projeto)&&t.edt_previsao_inicio.prop("readonly",!0),c.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),l.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),u.mask("000:00"),v.mask("00:00"),t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_ATIVIDADE){var x=t.edt_valor_hora_atividade.maskMoney("unmasked")[0];c.maskMoney("mask",x).trigger("change")}else t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_MANUAL?(c.prop("disabled",!1),c.maskMoney("mask",parseFloat(r.valor_hora)).trigger("change")):null!=r.valor_hora&&c.maskMoney("mask",parseFloat(r.valor_hora)).trigger("change");null!=r.horas_previstas&&u.val(r.horas_previstas).trigger("change"),null!==r.horas_dedicadas&&""!==r.horas_dedicadas&&v.val(r.horas_dedicadas).trigger("change"),e!=t.arr_executores.length&&"usuario"==r.tipo?t.arr_executores[e]=r:e!=t.arr_grupo_executores.length&&"grupo_usuarios"==r.tipo?t.arr_grupo_executores[e]=r:"usuario"==r.tipo?t.arr_executores.push(r):"grupo_usuarios"==r.tipo&&t.arr_grupo_executores.push(r),"grupo_usuarios"==r.tipo&&(v.parent().parent().remove(),v.remove()),s.appendTo(t.listagem_executores)};e?"usuario"==e.tipo?"N"==e.excluido&&r(t.arr_executores.length,e):"grupo_usuarios"==e.tipo&&"N"==e.excluido&&r(t.arr_grupo_executores.length,e):(t.listagem_executores.find(".new_row").remove(),$(t.arr_executores).each(function(e,a){a.excluido="N",r(e,a)}),$(t.arr_grupo_executores).each(function(e,a){a.excluido="N",r(e,a)}))},this.sugerir_previsao_inicio_atividade=function(){var e=null;$(t.arr_executores).each(function(a,i){null!=i.previsao_inicio&&""!=i.previsao_inicio&&"S"!=i.excluido&&(i.previsao_inicio<e||null==e)&&(e=i.previsao_inicio)}),$(t.arr_grupo_executores).each(function(a,i){null!=i.previsao_inicio&&""!=i.previsao_inicio&&"S"!=i.excluido&&(i.previsao_inicio<e||null==e)&&(e=i.previsao_inicio)}),null!=e||null!=get_datepicker(t.edt_inicio_projeto)&&""!=get_datepicker(t.edt_inicio_projeto)?setTimeout(function(){set_datepicker(t.edt_previsao_inicio,e),t.edt_previsao_inicio.prop("readonly",!0),t.possui_executor_previsao_inicio=!0},600):(t.edt_previsao_inicio.prop("readonly",!1),t.possui_executor_previsao_inicio=!1)},this.listar_agenda_evento=function(e,a){var i=e.find("tbody"),o=i.find("tr:first");e.find("tr:gt(1)").remove(),WS.get("agenda_evento/get_agenda_evento_by_projeto_executor/",a,function(r){$(r).each(function(r,s){!function(r){var s=o.clone();s.removeAttr("template-row"),s.css("display",""),$(s.find("[template-field='dia']")).text(r.dia?r.dia.format_date():""),$(s.find("[template-field='hora_inicio']")).text(r.hora_inicio?r.hora_inicio.substr(0,5):""),$(s.find("[template-field='hora_fim']")).text(r.hora_fim?r.hora_fim.substr(0,5):""),$(s.find("[template-field='tipo_agenda']")).text(r.agenda_tipo_nome?r.agenda_tipo_nome:""),$(s.find("[template-field='local']")).text(r.agenda_local_nome?r.agenda_local_nome:"");var d=$(s.find(".btn_editar"));d.unbind("click"),d.click(function(){View.load("agenda/agenda_evento",function(i,o){var s=new Object;o.onsave=function(){t.listar_agenda_evento(e,a),t.atualizar_data_prazo()},o.show(r.agenda_evento_id,null,null,s)})}),s.appendTo(i)}(s)})})},this.listar_responsavel=function(e){if(t.cbo_responsavel_projeto.find("option").remove(),add_option(t.cbo_responsavel_projeto,"","Nenhum"),null!=t.equipe&&"undefined"!=t.equipe){for(var a in t.equipe)if("clean"!=a){var i=t.equipe[a];add_option(t.cbo_responsavel_projeto,i.usuario_id,i.nome)}e&&t.cbo_responsavel_projeto.val(e).trigger("change")}t.cbo_responsavel_projeto.selectpicker("refresh")},this.close=function(){void 0!==t.onclose&&t.onclose&&t.onclose()},this.unload=function(){for(var e=0;e<t.divs_informativo_prazo.length;e++)t.divs_informativo_prazo[e].props.desativarRefreshAutomatico();t.close(),View.unload(this.html_id)},this.permite_alterar=function(e){t.txt_atividades.prop("disabled",!e),t.txt_observacoes.prop("disabled",!e),t.edt_codigo_projeto.prop("readonly",!e),t.edt_porcentagem.prop("readonly",!e),t.cbo_classificacao.prop("disabled",!e),t.edt_nome_atividade.prop("disabled",!e),t.cbo_atividade_sinteticas.prop("disabled",!e),t.btn_novo_assunto.prop("disabled",!e),t.btn_visualizar_assunto.prop("disabled",!e),t.edt_data_solicitacao_projeto.prop("readonly",!e),t.cbo_tipo_previsao_inicio.prop("disabled",!e).selectpicker("refresh"),t.edt_previsao_inicio.prop("readonly",!e),t.edt_inicio_projeto.prop("readonly",!e),t.edt_prazo_projeto.prop("readonly",!e),t.edt_conclusao_projeto.prop("readonly",!e),t.edt_horas_previstas.prop("disabled",!e),t.edt_prazo_dias.prop("disabled",!e),t.cbo_assunto_projeto.prop("disabled",!e),t.cbo_consultor_projeto.prop("disabled",!e),t.cbo_responsavel_projeto.prop("disabled",!e),t.chk_cancelada.prop("disabled",!e),t.chk_tipo_cancelamento_ignorar_prev_real.prop("disabled",!e),t.cbo_executores.prop("disabled",!e),t.chk_exibir_prazo_agenda.prop("disabled",!e),t.tabela_tarefa_config.disabled=!e,t.setTaskDisable(!0)},this.preencher=function(){t.limpar_tarefa(),t.limpar_custos(),WS.get("atividade_projeto/objeto/",{atividade_projeto_id:t.projeto_atividade_id},function(e){t.datasource_movimentacao_financeira=e.movimentacao_financeira,t.todos_executores=e.todos_executores,t.arr_executores=e.usuarios_executores,t.arr_grupo_executores=e.grupo_usuarios_executores,t.arr_atividades_predecessoras=e.arr_atividades_predecessoras,t.listar_atividades_predecessoras(),1==t.projeto_atividade_classificacoes&&t.listar_classificacao(e.classificacao_projeto_atividade_id),t.projeto_id=e.projeto_id,t.projeto_nome=e.projeto_nome,t.cliente_id=e.cliente_id,t.cliente_nome=e.cliente_nome,t.email_consultor=e.email_consultor,t.email_responsavel=e.email_responsavel,t.assunto=e.assunto,t.atividade=e.atividade,t.tipo_previsao_inicio=e.tipo_previsao_inicio,t.previsao_inicio=e.previsao_inicio,t.prazo=e.prazo,t.conclusao=e.conclusao,t.tabela_custos=e.tabela_custos,t.carregar_tarefas(),t.tabela_custos.map(function(e,a){e.disabled=t.tipo_formulario==FORMULARIO.VISUALIZAR||t.tipo_formulario==FORMULARIO.EXCLUIR,t.add_custo(e)}),e.prazo_dias>0&&t.edt_prazo_dias.val(e.prazo_dias),t.cliente_id<1&&t.btn_apontamento.addClass("hidden"),t.div_projeto.show(),t.lbl_projeto_codigo.text(e.projeto_codigo),t.lbl_projeto_nome.text(e.projeto_nome),t.lbl_cliente_nome.text(e.cliente_nome);var a=function(){View.load("atividade_projeto/listar",function(a,i){i.show(e.projeto_id,e.template,e.cliente_nome)},View.ABA.MULTIPLAS)};t.lbl_projeto_codigo.click(a),t.lbl_projeto_nome.click(a),t.edt_horas_previstas.val(format_time(e.horas_previstas)),t.edt_codigo_projeto.val(e.codigo),t.edt_nome_atividade.val(e.atividade_simplificada);var i=!1;null!==t.permissoes_projeto&&(i=App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_atividade),set_tinymce(t.txt_atividades,e.atividade,!i),t.listar_assunto(e.assunto_projetos_id),t.listar_responsavel(e.responsavel_id),t.listar_apontamentos(),t.listar_atividade_sinteticas(e.projeto_atividade_sintetica_pai_id),setTimeout(function(){t.cbo_tipo_previsao_inicio.val(e.tipo_previsao_inicio).trigger("change").selectpicker("refresh"),set_datepicker(t.edt_previsao_inicio,e.previsao_inicio),set_datepicker(t.edt_inicio_projeto,e.inicio),t.edt_previsao_inicio.attr("value",e.previsao_inicio),t.edt_previsao_inicio.change(),void 0!==e.data_prazo&&null!=e.data_prazo?(set_datepicker(t.edt_prazo_projeto,e.data_prazo),t.sugerir_data_prazo=!0):set_datepicker(t.edt_prazo_projeto,e.prazo),""!=e.prazo&&null!=e.prazo&&(t.edt_prazo_dias.unbind("change"),t.edt_prazo_dias.change(function(){if($(this).val()>0){var e=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());e&&set_datepicker(t.edt_prazo_projeto,e.format_date(!0))}else set_datepicker(t.edt_prazo_projeto,get_datepicker(t.edt_previsao_inicio))}),t.edt_previsao_inicio.unbind("blur"),t.edt_previsao_inicio.blur(function(e){setTimeout(function(){(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_datas)&&t.edt_prazo_dias.attr("disabled",!1);var e=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());e&&set_datepicker(t.edt_prazo_projeto,e.format_date(!0))},150)})),set_datepicker(t.edt_conclusao_projeto,e.conclusao),set_datepicker(t.edt_data_solicitacao_projeto,e.data_solicitacao),set_span_status_projeto(t.lbl_status,e.status),clearTimeout(this)},150),t.txt_observacoes.val(e.observacoes),t.edt_horas_previstas.val(e.horas_previstas),t.edt_porcentagem.val(e.porcentagem),App.sessao.dados.admin||t.permissoes_projeto.permissao_financeiro?(e.tipo_valor_hora==TIPO_FINANCEIRO.HORA_ATIVIDADE?(t.edt_valor_hora_atividade.maskMoney("mask",parseFloat(e.valor_hora)),t.cbo_valor_previsto.selectpicker("val",e.tipo_valor_hora).trigger("refresh"),t.div_valor_hora.removeClass("hidden")):e.tipo_valor_hora==TIPO_FINANCEIRO.HORA_MANUAL&&t.cbo_valor_previsto.selectpicker("val",e.tipo_valor_hora).trigger("refresh"),t.menu_custos.removeClass("hidden"),t.menu_financeiro.removeClass("hidden"),t.menu_movimentacao_financeira.removeClass("hidden"),t.tab_custo_listagem.find(".btn_incluir_item").prop("disabled",!1),t.div_lbl_total_executores.removeClass("hidden")):(t.menu_custos.addClass("hidden"),t.menu_financeiro.addClass("hidden"),t.menu_movimentacao_financeira.addClass("hidden"),t.tab_custo_listagem.find(".btn_incluir_item").prop("disabled",!0),t.div_lbl_total_executores.addClass("hidden")),t.render_executores(),t.cbo_valor_previsto.val()!=TIPO_FINANCEIRO.HORA_MANUAL&&t.dialog.find("[template-field='edt_valor_hora']").prop("disabled",!0),t.chk_exibir_prazo_agenda.prop("checked",e.exibir_prazo_agenda),t.chk_exibir_prazo_agenda.removeClass("template_switch"),App.aplicar_checkbox(t.div_exibir_prazo_agenda),t.chk_notificar_envolvidos_email.prop("checked",e.notificar_envolvidos_email).change(),t.chk_marco.prop("checked",e.marco).change(),t.chk_cancelada.prop("checked",e.cancelada).change(),t.chk_tipo_cancelamento_ignorar_prev_real.prop("checked",e.tipo_cancelamento_ignorar_prev_real).change(),t.render_input_peso_atividade(e.porcentagem_peso)})},this.listar_apontamentos=function(){var e=t.tab_apontamentos.find("tbody").find("tr:first");WS.get("apontamento_projeto/listar/",{tipo_listagem:3,projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id},function(a){var i="000:00";t.tab_apontamentos.find(".rows").remove(),$(a).each(function(a,o){null!=o.total_horas&&(i=somar_horas(subtrair_horas(o.total_horas,o.horas_traslado),i)),function(a){var i=e.clone();i.removeAttr("template-row"),i.css("display",""),i.addClass("rows"),$(i.find("[template-field='dia']")).text(a.dia?a.dia.format_date():"");var o=$(i.find("[template-field='atividade']")),r=null;$(a.atividade).each(function(e,a){r=null==r?a.descricao:r+" / "+a.descricao}),o.text(r),"N"==t.meus_apontamentos?($(i.find("[template-field='executor']")).text(a.usuario_nome),$(".th_executor").removeClass("hidden")):($(i.find("[template-field='executor']")).addClass("hidden"),$(".th_executor").addClass("hidden"));var s=$(i.find("[template-field='total_horas']")),d=$(i.find("[template-field='cliente']")),_=$(i.find("[template-field='projeto']"));null==a.total_horas?(d.text("-"),_.text("-"),i.addClass("bg-danger"),i.find("td").addClass("bg-danger"),s.append('<span class="label label-danger"> Pendente </span>')):(d.text(a.cliente_nome),_.text(a.projeto_nome),s.text(null!=a.total_horas?subtrair_horas(a.total_horas,a.horas_traslado):""));var n=$(i.find(".btn_visualizar"));n.unbind("click"),n.click(function(){View.load("apontamento_projeto/detalhes",function(e,i){i.onclose=t.listar,i.show(a.id,FORMULARIO.VISUALIZAR)},View.ABA.MULTIPLAS)});var l=$(i.find(".btn_editar")),c=function(){View.load("apontamento_projeto/detalhes",function(e,i){i.onclose=t.listar,i.show(a.id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS)};l.unbind("click"),l.click(c),i.dblclick(c);var p=$(i.find(".btn_excluir"));p.unbind("click"),p.click(function(){View.load("apontamento_projeto/detalhes",function(e,i){i.onclose=t.listar,i.show(a.id,FORMULARIO.EXCLUIR)},View.ABA.MULTIPLAS)});var u=$(i.find(".btn_gerar_os"));null==a.total_horas&&u.prop("disabled",!0),u.unbind("click"),u.click(function(){App.obter_token_publico(function(e){App.download(WS_URI+"apontamento_projeto/gerar_os/?&empresa_filial_id="+App.temp.empresa+"&apontamento_id="+a.id+"&token_publico="+e)})}),i.appendTo(t.tab_apontamentos)}(o)}),$(t.tab_apontamentos.find("[template-field='total_geral_horas']")).text(format_time(i)),t.total_geral_horas.text(i&&"000:00"!=i?format_time(i):"000:00")},null,null,null,null,null,t.html_id)},this.listar_atividades_predecessoras=function(){t.dataGrid=dx_Listagem_Padrao({div_html:t.dx_listagem_atividades_predecessoras,coluna_chave:"id",colunas:dx_Atividade_Projeto_Colunas(t),toolbar:[dx_Atividade_Projeto_Btn_Novo(t,a)],datasource:t.arr_atividades_predecessoras,nome:this.title,nome_parametro_usuario:"listagem_atividade_analitica_predecessora",editing_mode:dx_Atividade_Projeto_Editing_Mode(),on_row_prepared:function(e){"data"===e.rowType&&setTimeout(function(){var a=t.dataGrid.getCellElement(e.rowIndex,"status");a.text().trim().length&&a.html('<span class="label '+str_cor_status(str_identifica_status(e.data.inicio,e.data.prazo,e.data.conclusao,void 0,e.data.cancelada))+'">'+a.text().trim()+"</span>")})},on_editing_start:function(e){"tipo"!==e.column.dataField&&(e.cancel=!0)},on_editor_preparing:dx_Atividade_Projeto_On_Editor_Preparing(t)})},this.salvar_atividade=function(e,a){for(var i=0,o="",r=0;r<t.arr_executores.length;r++)"N"==(s=t.arr_executores[r]).excluido&&(i=parseFloat(s.valor_previsto+i).toFixed(2));for(r=0;r<t.arr_grupo_executores.length;r++){var s;"N"==(s=t.arr_grupo_executores[r]).excluido&&(i=parseFloat(s.valor_previsto+i).toFixed(2))}for(r=0;r<t.dataGrid.getController("editing").getChanges().length;r++){var d=t.dataGrid.getController("editing").getChanges()[r];const e=d.data||d.key;e.tipo||(o+="<li>"+(e.atividade_simplificada||e.atividade_simplificada)+"</li>")}""!=o?alert_modal(App.lang.modal_validacao.validacao,"Informe um tipo de Atividade predecessora para a(s) atividade(s) abaixo: <br/>"+o):function(e,a){if(!t.input_peso_atividade.option("isValid"))return window.alertaPopUp("Validação","Ajuste o valor da <strong>Porcentagem de Peso da Atividade</strong> antes de salvar as alterações."),!1;WS.post("atividade_projeto/salvar",{projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id,codigo:t.edt_codigo_projeto.val(),atividade:get_tinymce(t.txt_atividades),nome_atividade:t.edt_nome_atividade.val(),assunto_projetos_id:t.cbo_assunto_projeto.val(),consultor_id:t.cbo_consultor_projeto.val(),responsavel_id:t.cbo_responsavel_projeto.val(),tipo_previsao_inicio:t.cbo_tipo_previsao_inicio.val(),previsao_inicio:get_datepicker(t.edt_previsao_inicio),inicio:get_datepicker(t.edt_inicio_projeto),prazo:get_datepicker(t.edt_prazo_projeto),conclusao:get_datepicker(t.edt_conclusao_projeto),observacoes:t.txt_observacoes.val(),data_solicitacao:get_datepicker(t.edt_data_solicitacao_projeto),porcentagem:parseInt(t.edt_porcentagem.val(),10)>100?100:t.edt_porcentagem.val(),arr_atividades_predecessoras:t.dataGrid.getController("editing").getChanges().length?CircularJSON.stringify(t.dataGrid.getController("editing").getChanges()):null,notificar_envolvidos_email:t.chk_notificar_envolvidos_email.prop("checked"),projeto_atividade_sintetica_pai_id:t.cbo_atividade_sinteticas.val(),arr_executores:JSON.stringify(t.arr_executores),arr_grupo_executores:JSON.stringify(t.arr_grupo_executores),classificacao_projeto_atividade_id:t.cbo_classificacao.val(),valor_hora:t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_ATIVIDADE?parseFloat($(t.edt_valor_hora_atividade).maskMoney("unmasked")[0]):0,horas_previstas:t.edt_horas_previstas.val(),valor_previsto:i,exibir_prazo_agenda:t.chk_exibir_prazo_agenda.prop("checked"),tipo_valor_hora:t.cbo_valor_previsto.val(),prazo_dias:t.edt_prazo_dias.val()||0,tabela_custos:JSON.stringify(t.getItems()),marco:t.chk_marco.prop("checked"),cancelada:t.chk_cancelada.prop("checked"),tipo_cancelamento_ignorar_prev_real:t.chk_tipo_cancelamento_ignorar_prev_real.prop("checked"),projeto_calendario_trabalho_id:t.projeto_calendario_trabalho_id,porcentagem_peso:t.input_peso_atividade.instance().option("value"),arr_movimentacao_financeira:t.instanceMovimentacaoFinanceira&&t.instanceMovimentacaoFinanceira.getController("editing").getChanges()?CircularJSON.stringify(t.instanceMovimentacaoFinanceira.getController("editing").getChanges()):null},function(i){alert_saved("Atividade salva com sucesso"),t.projeto_atividade_id>0&&1==e?t.unload():(t.menu_executores.removeClass("hidden"),t.btn_confirmar.removeClass("list-group-item-warning"),t.btn_apontamento.removeClass("hidden"),t.collapse_accordion.removeClass("hidden"),t.menu_mobile.removeClass("hidden"),t.div_check_email.removeClass("hidden"),t.menu_atividade_prdecessoras.removeClass("hidden"),t.menu_apontamentos.removeClass("hidden"),t.menu_tarefas.removeClass("hidden"),t.menu_referencias.removeClass("hidden"),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_financeiro)&&(t.permissoes_projeto.permissao_financeiro&&(t.menu_financeiro.removeClass("hidden"),t.menu_movimentacao_financeira.removeClass("hidden")),t.div_lbl_total_executores.removeClass("hidden")),t.projeto_atividade_id=i.id,t.preencher()),t.projeto_atividade_id=i.id,t.tipo_formulario=FORMULARIO.EDITAR,a&&null!=a&&a()},[t.btn_confirmar,t.btn_cancelar])}(e,a)},this.btn_novo_assunto.unbind("click"),this.btn_novo_assunto.click(function(){View.load("assunto_projeto/detalhes",function(e,a){a.onclose=function(){t.listar_assunto(a.assunto_projeto_id)},a.show(null,FORMULARIO.NOVO)})}),this.btn_visualizar_assunto.unbind("click"),this.btn_visualizar_assunto.click(function(){t.cbo_assunto_projeto.val()>0&&View.load("assunto_projeto/detalhes",function(e,a){a.show(t.cbo_assunto_projeto.val(),FORMULARIO.VISUALIZAR)})}),this.btn_refresh_apontamentos.unbind("click"),this.btn_refresh_apontamentos.click(function(){t.listar_apontamentos()}),this.cbo_tipo_previsao_inicio.unbind("change").change(function(){switch(parseInt(t.cbo_tipo_previsao_inicio.val(),10)){case TIPO_PREVISAO_INICIO.DEVE_INICIAR_EM:t.possui_executor_previsao_inicio||t.edt_previsao_inicio.prop("readonly",!1),t.edt_prazo_dias.prop("readonly",!1),t.edt_prazo_projeto.prop("readonly",!1);break;default:if(t.tipo_previsao_inicio==TIPO_PREVISAO_INICIO.O_MAIS_BREVE_POSSIVEL){var e=get_datepicker(t.edt_previsao_inicio),a=get_datepicker(t.edt_prazo_projeto);null!=e&&""!=e&&null!=t.previsao_inicio&&""!=t.previsao_inicio&&e!=t.previsao_inicio?set_datepicker(t.edt_previsao_inicio,t.previsao_inicio):set_datepicker(t.edt_previsao_inicio,""),null!=a&&""!=a&&null!=t.prazo&&""!=t.prazo&&a!=t.prazo&&set_datepicker(t.edt_prazo_projeto,t.prazo)}t.edt_previsao_inicio.prop("readonly",!0),t.edt_prazo_dias.prop("readonly",!0),t.edt_prazo_projeto.prop("readonly",!0)}}),this.edt_inicio_projeto.unbind("change"),this.edt_inicio_projeto.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e),t.sugerir_previsao_inicio_atividade()}),this.edt_prazo_projeto.unbind("change"),this.edt_prazo_projeto.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e)}),this.edt_conclusao_projeto.unbind("change"),this.edt_conclusao_projeto.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e)}),this.edt_conclusao_projeto.unbind("blur"),this.edt_conclusao_projeto.blur(function(){if(""!=t.edt_conclusao_projeto.val()&&null!=t.edt_conclusao_projeto.val()&&"100"!=t.edt_porcentagem.val()){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Você está informando que a atividade está concluída.<br>Deseja alterar o "% Conclusão" para 100%?')),alert_modal("Validação",e,"Sim",function(){t.edt_porcentagem.val("100")},!0,"Não")}}),this.edt_porcentagem.unbind("blur"),this.edt_porcentagem.blur(function(){if("100"==t.edt_porcentagem.val()){if(null==t.edt_conclusao_projeto.val()||""==t.edt_conclusao_projeto.val().trim()){var e=new Date;e=e.getFullYear().toString()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2),set_datepicker(t.edt_conclusao_projeto,e)}}else t.edt_conclusao_projeto.val("")}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){t.unload()}),this.btn_apontamento.unbind("click"),this.btn_apontamento.click(function(){t.status_projeto==PROJETO_STATUS.CONCLUIDO&&"S"!=t.permitir_apontamento_projeto_concluido||t.salvar_atividade(!1,function(){View.load("apontamento_projeto/detalhes",function(e,a){var i={projeto_id:t.projeto_id,cliente_id:t.cliente_id,cliente_nome:t.cliente_nome,projeto_atividade_id:t.projeto_atividade_id,projeto_nome:t.lbl_projeto_nome.text()};a.show(i),a.onclose=function(){t.listar_apontamentos()}},View.ABA.MULTIPLAS)})}),$(document).scroll(function(){t.floating.css("top",$(this).scrollTop())}),this.atualizar_data_prazo=function(){t.sugerir_data_prazo&&WS.get("agenda_evento/get_last_evento_agenda/",{id:t.projeto_atividade_id},function(e){var a=e[0].dia;t.edt_prazo_projeto.val(a)})},this.edt_previsao_inicio.unbind("blur").blur(function(e){if(null!=this.value&&""!=this.value)if(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_datas){if(t.edt_prazo_dias.attr("disabled",!1),""!==t.edt_prazo_dias.val()){var a=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());a&&set_datepicker(t.edt_prazo_projeto,a.format_date(!0))}}else t.edt_prazo_dias.attr("disabled",!0)}),this.edt_prazo_dias.unbind("change").change(function(e){if(""!==t.edt_prazo_dias.val()){var a=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());a&&(set_datepicker(t.edt_prazo_projeto,a.format_date(!0)),t.edt_prazo_projeto.attr("disabled",!0))}else t.edt_prazo_projeto.attr("disabled",!1)}),this.edt_prazo_dias.unbind("keypress").keypress(function(e){(this.value.length>=6||null!=e.key.match(/[^\d]/g)&&e.key.match(/[^\d]/g).length>0)&&e.preventDefault()}),this.add_custo=function(e){t.render_items(e)},this.btn_incluir_item.unbind("click").click(function(){t.add_custo({item_id:null,custo_unitario_orcado:0,custo_unitario_real:0,venda_unitaria:0,total_custo_orcado:0,total_custo_real:0,total_venda:0,quantidade:0,disabled:t.tipo_formulario==FORMULARIO.VISUALIZAR||t.tipo_formulario==FORMULARIO.EXCLUIR})}),this.listar_item=function(e,a,i){var o={item_descricao:a.parent().find(".edt_combobox").val(),limite:0,filtrar_por_codigo_ou_nome:!0,modulo_projeto:!0};WS.get("itens/listar/",o,function(e){limpar_combobox(a),e.map(function(e,i){var o=[];o["Código"]=null==e.codigo||""==e.codigo?" ":e.codigo,o["Descrição"]=e.descricao,add_option_combobox(a,i,e.item_id,o,null,null,"col2")})}),e(!0)},this.getItems=function(){var e=[];return t.tab_custo_listagem.find("tr.row_item:not([template-row])").map(function(a,i){var o=$(i).find('[template-field="cbo_item"]'),t=$(i).find('[template-field="edt_quantidade"]'),r=$(i).find('[template-field="edt_custo_unitario_orcado"]'),s=$(i).find('[template-field="edt_custo_unitario_real"]'),d=$(i).find('[template-field="edt_venda_unitaria"]'),_=$(i).find('[template-field="edt_vencimento_pagamento"]'),n=$(i).find('[template-field="realizado"]'),l=$(i).find('[template-field="edt_total_custo_orcado"]'),c=$(i).find('[template-field="edt_total_custo_real"]'),p=$(i).find('[template-field="edt_total_venda"]'),u={item_id:+$(o).next().find("input").attr("selected-value")||null,quantidade:+t.val().replace(".","").replace(",",".")||0,custo_unitario_orcado:+r.val().replace(".","").replace(",",".")||0,custo_unitario_real:+s.val().replace(".","").replace(",",".")||0,venda_unitaria:+d.val().replace(".","").replace(",",".")||0,vencimento_pagamento:_.val()||null,realizado:n.prop("checked"),total_custo_orcado:+l.val().replace(".","").replace(",",".")||0,total_custo_real:+c.val().replace(".","").replace(",",".")||0,total_venda:+p.val().replace(".","").replace(",",".")||0};e.push(u)}),e},this.calcular_percentual=function(){var e=t.arr_tarefas.length,a=100*t.arr_tarefas.reduce(function(e,a){return a.realizado?e+1:e},0)/e;t.edt_porcentagem.val(a.toFixed(0)),t.arr_tarefas.length>0?t.edt_porcentagem.addClass("disabled").attr("disabled","disabled").blur():t.edt_porcentagem.removeClass("disabled").removeAttr("disabled").blur(),t.edt_conclusao_projeto.change()},this.render_items=function(e){var a=t.tab_custo_listagem.find("[template-row]").clone();a.attr("style",""),a.removeAttr("template-row"),a.addClass("row_item"),a.find('[template-field="realizado"]').removeClass("template_switch"),App.aplicar_checkbox(a);var i=a.find('[template-field="cbo_item"]');create_combobox(i,t.listar_item,"col2"),set_value_combobox(i,e.item_id,e.item_descricao);var o=a.find('[template-field="edt_quantidade"]'),r=a.find('[template-field="edt_custo_unitario_orcado"]'),s=a.find('[template-field="edt_total_custo_orcado"]'),d=a.find('[template-field="edt_custo_unitario_real"]'),_=a.find('[template-field="edt_total_custo_real"]'),n=a.find('[template-field="edt_venda_unitaria"]'),l=a.find('[template-field="edt_total_venda"]'),c=a.find('[template-field="realizado"]'),p=a.find('[template-field="edt_vencimento_pagamento"]'),u=a.find(".btn_deletar_item");r.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),s.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),_.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),d.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),n.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),l.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),o.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),void 0!==e.disabled&&e.disabled&&(i.parent().find("button").addClass("disabled").attr("disabled","disabled"),i.parent().find("input").addClass("disabled").attr("disabled","disabled"),r.addClass("disabled").attr("disabled","disabled"),d.addClass("disabled").attr("disabled","disabled"),n.addClass("disabled").attr("disabled","disabled"),p.addClass("disabled").attr("disabled","disabled"),o.addClass("disabled").attr("disabled","disabled"),c.addClass("disabled").attr("disabled","disabled"),u.addClass("hidden"));var v=$.debounce(300,function(){var e=((parseFloat(o.val().replace(",","."))||0)*(+r.val().replace(".","").replace(",",".")||0)).toFixed(2);s.val(e).maskMoney("mask")}),m=$.debounce(300,function(){var e=((parseFloat(o.val().replace(",","."))||0)*(+d.val().replace(".","").replace(",",".")||0)).toFixed(2);_.val(e).maskMoney("mask")}),h=$.debounce(300,function(){var e=((parseFloat(o.val().replace(",","."))||0)*(+n.val().replace(".","").replace(",",".")||0)).toFixed(2);l.val(e).maskMoney("mask")});o.unbind("keyup").keyup(v).keyup(m).keyup(h),r.unbind("keyup").keyup(v),d.unbind("keyup").keyup(m),n.unbind("keyup").keyup(h),u.unbind("click").click(function(){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja remover o item?")),alert_modal("Atenção",e,"Remover",function(){a.remove()},!0)}),r.val(e.custo_unitario_orcado).maskMoney("mask"),d.val(e.custo_unitario_real).maskMoney("mask"),n.val(e.venda_unitaria).maskMoney("mask"),o.val(parseFloat(e.quantidade).toFixed(2)).maskMoney("mask"),s.val(parseFloat(e.total_custo_orcado).toFixed(2)).maskMoney("mask"),_.val(parseFloat(e.total_custo_real).toFixed(2)).maskMoney("mask"),l.val(parseFloat(e.total_venda).toFixed(2)).maskMoney("mask"),p.val(e.vencimento_pagamento),c.prop("checked","S"===e.realizado).change(),a.appendTo(t.tab_custo_listagem)},this.add_tarefa=function(e){WS.post("/tarefa/salvar",{projeto_atividade_id:t.projeto_atividade_id,descricao:e.descricao},function(a){alert_saved(e.descricao.substring(0,30)+" salvo com sucesso"),t.carregar_tarefas(function(){t.calcular_percentual()})})},this.btn_incluir_tarefa.unbind("click").click(function(){""!=t.edt_nova_tarefa.val().trim()&&t.edt_nova_tarefa.val().length>0&&(t.add_tarefa({descricao:t.edt_nova_tarefa.val(),realizado:!1,disabled:t.tabela_tarefa_config.disabled}),t.edt_nova_tarefa.val(""))}),this.edt_nova_tarefa.unbind("keyup").keyup(function(e){e.which==KEYPRESS_PADRAO.ENTER&&(""!=t.edt_nova_tarefa.val().trim()&&t.edt_nova_tarefa.val().length>0&&(null!=t.tarefa_atual?t.atualizar_tarefa():t.add_tarefa({descricao:t.edt_nova_tarefa.val(),realizado:!1,disabled:t.tabela_tarefa_config.disabled})),t.edt_nova_tarefa.val(""))}),this.selecionar_tarefa=function(e,a){t.edt_nova_tarefa.val(e.descricao).focus(),t.btn_incluir_tarefa.addClass("hidden"),t.btn_cancelar_edicao_tarefa.removeClass("hidden"),t.btn_editar_tarefa.removeClass("hidden"),t.tarefa_atual=e,set_focus(t.edt_nova_tarefa)},this.limpar_selecao_tarefa=function(){t.edt_nova_tarefa.val(""),t.btn_incluir_tarefa.removeClass("hidden"),t.btn_cancelar_edicao_tarefa.addClass("hidden"),t.btn_editar_tarefa.addClass("hidden"),t.tarefa_atual=null,set_focus(t.edt_nova_tarefa)},this.atualizar_tarefa=function(){var e=t.edt_nova_tarefa.val();t.tarefa_atual.descricao=e,WS.post("/tarefa/salvar",{projeto_atividade_id:t.projeto_atividade_id,descricao:t.tarefa_atual.descricao,id:t.tarefa_atual.id},function(e){alert_saved(t.tarefa_atual.descricao.substring(0,30)+" alterado com sucesso"),t.carregar_tarefas(function(){t.calcular_percentual()}),t.limpar_selecao_tarefa()})},this.render_tarefas=function(){var e=function(e){var a=$.Tabela_Padrao_Next.create_row(t.tab_tarefas);a.attr("data-id",e.id);var i=$.Tabela_Padrao_Next.getColumn(a,"descricao"),o=$.Tabela_Padrao_Next.getColumn(a,"realizado"),r=$.Tabela_Padrao_Next.getColumn(a,"btn_editar"),s=$.Tabela_Padrao_Next.getColumn(a,"btn_remover");i.addClass("tarefas-row"),o.find("input").removeClass("template_switch").prop("checked",e.realizado).change();var d=o.find("input").prop("checked");i.text(e.descricao),i.attr("data-realizado",d),App.aplicar_checkbox(o),e.pode_marcar?o.find("input").change(function(){d=$(o).find("input").prop("checked"),i.attr("data-realizado",d),WS.post("/tarefa/marcar",{id:e.id,realizado:d,atividade_projeto_id:t.projeto_atividade_id,projeto_apontamento_por:t.projeto_apontamento_por},function(a){t.arr_tarefas.map(function(a){return a.id==e.id&&(a.realizado=d),a}),alert_saved(e.descricao.substring(0,30)+(d?" Realizado":" Não Realizado")),t.carregar_tarefas(function(){t.calcular_percentual()})})}):(o.find("input").unbind("change"),o.find("input").prop("disabled",!0)),e.disabled?(r.addClass("disabled").attr("disabled","disabled"),s.addClass("disabled").attr("disabled","disabled")):(r.click(function(){e.row=$.Tabela_Padrao_Next.Rows.getIndex(a),function(e){t.selecionar_tarefa(e)}(e)}),s.click(function(){$(this);var a=new Validation;a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja remover a tarefa?")),alert_modal("Atenção",a,"Remover",function(){WS.post("tarefa/excluir/",{id:e.id},function(){alert_saved(e.descricao.substring(0,30)+" excluido com sucesso"),t.carregar_tarefas(function(){t.calcular_percentual()}),set_focus(t.edt_nova_tarefa)})},!0)})),$.Tabela_Padrao_Next.RenderRow(t.tab_tarefas,a)};t.arr_tarefas.map(function(a){e(a)})},this.btn_cancelar_edicao_tarefa.click(function(){t.limpar_selecao_tarefa()}),this.btn_editar_tarefa.click(function(){t.atualizar_tarefa()}),this.limpar_tarefa=function(){$.Tabela_Padrao_Next.clear(t.tab_tarefas)},this.limpar_custos=function(){t.tab_custo_listagem.find("tbody tr:not([template-row])").remove()},this.btn_recarregar_tarefa.unbind("click").click(function(){t.carregar_tarefas(function(){t.calcular_percentual()})}),this.menu_referencias.unbind("click").click(function(){t.menu_referencias.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(t.div_componente_referencias[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"projeto_atividade",id:t.projeto_atividade_id,documentoPastaId:t.documento_pasta_id}),t.div_componente_referencias[0]))}),this.setTaskDisable=function(e){e?(t.btn_incluir_tarefa.addClass("disabled").attr("disabled","disabled"),t.tabela_tarefa_config.disabled=!0,t.edt_nova_tarefa.addClass("disabled").attr("disabled","disabled"),$(t.tab_tarefas.tabela).find(".sortable").sortable("disable")):($(t.tab_tarefas.tabela).find(".sortable").sortable("enable"),t.btn_incluir_tarefa.removeClass("disabled").removeAttr("disabled"),t.tabela_tarefa_config.disabled=!1,t.edt_nova_tarefa.removeClass("disabled").removeAttr("disabled"))},this.carregar_tarefas=function(e){WS.get("tarefa/listar/",{projeto_atividade_id:t.projeto_atividade_id},function(a){a.length>0?t.edt_porcentagem.addClass("disabled").attr("disabled","disabled").blur():t.edt_porcentagem.removeClass("disabled").removeAttr("disabled").blur(),t.limpar_tarefa();var i=t.arr_executores.filter(function(e){return e.id==App.sessao.dados.usuario_id}).length>0;t.arr_tarefas=a.map(function(e){return e.pode_marcar=t.projeto_apontamento_por==APONTAMENTO_POR.QUALQUER||t.projeto_apontamento_por==APONTAMENTO_POR.EXECUTOR&&i||App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto,e.disabled=t.tipo_formulario==FORMULARIO.VISUALIZAR||t.tipo_formulario==FORMULARIO.EXCLUIR||t.tabela_tarefa_config.disabled,e}),t.render_tarefas(),void 0!==e&&null!=e&&e()})},this.render_input_peso_atividade=function(e=0){t.utiliza_peso_atividades&&t.div_porcentagem_peso_atividade.removeClass("hidden"),t.input_peso_atividade=t.dx_peso_atividade.dxNumberBox({value:e,min:0,max:100,showSpinButtons:!0,disabled:!App.sessao.dados.admin&&!t.permissoes_projeto.gerente_projeto&&!t.permissoes_projeto.permissao_atividade}).dxValidator({validationRules:[{type:"custom",validationCallback(e){let a=e.value;if(a&&!Number.isInteger(a)){let e=a.toString().split(".");if(0!=+e[1]&&5!=+e[1])return!1}return!0},message:"Permitido somente valores inteiros ou decimais exatos (exemplo: 1.5, 2.5, 4.5)"}]}).dxNumberBox("instance")},this.lbl_tab_predecessora.unbind("click").click(function(){t.lbl_tab_predecessora.hasClass("active")||t.dataGrid.getController("editing").getChanges().length||t.listar_atividades_predecessoras()}),this.chk_cancelada.unbind("change"),this.chk_cancelada.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e)}),this.lbl_tab_movimentacao_financeira.off("click").on("click",function(e){App.sessao.dados.admin||t.permissoes_projeto.permissao_financeiro?t.renderizarComponenteMovimentacaoFinanceira():e.stopPropagation()})}});