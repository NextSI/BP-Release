define([],function(){return function(a){"use strict";var t=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Atividades",this.edt_numero=this.dialog.find(".edt_numero"),this.edt_objetivo=this.dialog.find(".edt_objetivo"),this.edt_data_inicio=this.dialog.find(".edt_data_inicio"),this.edt_data_fim=this.dialog.find(".edt_data_fim"),this.edt_progresso=this.dialog.find(".edt_progresso"),this.edt_situacao=this.dialog.find(".edt_situacao"),this.grid_pdca_atividades=this.dialog.find(".grid_pdca_atividades"),this.pdca={},this.arr_usuarios=[],this.arr_atividades=[],this.msg_observacao_atividade="",this.datagrid=null,this.pdca_atividade_id=null,this.old_data_pdca_atividade=null,this.permite_edicao_pos_acao=!1,this.filtros_row={pdca_atividade_id:0},this.param_filterRow=!1,this.show=function(a,e){t.pdca=a,void 0===e&&(e=!1),t.param_filterRow=e,!0===e&&t.pdca.dados_atividade.pdca_atividade_id>0&&(t.filtros_row.pdca_atividade_id=t.pdca.dados_atividade.pdca_atividade_id),t.montar_cabecalho(),t.listar()},this.listar=function(){var a=function(){WS.get("pdca_atividade/listar/",{pdca_id:t.pdca.pdca_id},function(a){t.arr_atividades=a,t.listar_equipe_pdca()})};setTimeout(function(){t.datagrid&&t.datagrid.getController("editing").getChanges().length?alert_modal("Aviso","Você possui alterações no grid. Deseja atualizar mesmo assim?","Sim",function(){a()},!0,"Cancelar",null,function(){}):a()})},this.montar_cabecalho=function(){WS.get("pdca/objeto/",{pdca_id:t.pdca.pdca_id},function(a){App.titulo_aba(t.html_id,"Atividades "+a.numero),$(t.edt_numero).prop("innerHTML",a.numero),$(t.edt_objetivo).prop("innerHTML",a.objetivo),$(t.edt_data_inicio).prop("innerHTML",a.data_inicio.format_date(!1)),$(t.edt_data_fim).prop("innerHTML",a.data_fim.format_date(!1)),$(t.edt_progresso).prop("innerHTML",a.progresso+"%"),$(t.edt_situacao).prop("innerHTML",a.situacao)})},this.listar_equipe_pdca=function(){WS.get("pdca/listar_equipe/",{pdca_id:t.pdca.pdca_id,apenas_gerente_equipe:!0},function(a){t.arr_usuarios=a,t.monta_grid()})},this.monta_grid=function(){var a=document.createElement("div");a.className="div_listagem_pdca_atividades",a.style="min-width: 100%;",t.grid_pdca_atividades.find(".div_listagem_pdca_atividades").remove(),t.grid_pdca_atividades[0].appendChild(a),t.grid_pdca_atividades.find(".div_listagem_pdca_atividades").css("height","calc(100vh - 140px)"),t.datagrid=t.grid_pdca_atividades.find(".div_listagem_pdca_atividades").dxDataGrid({dataSource:t.arr_atividades,keyExpr:"pdca_atividade_id",allowColumnResizing:!0,columnResizingMode:"widget",allowColumnReordering:!0,hoverStateEnabled:!0,wordWrapEnabled:!1,focusedRowEnabled:!1,editing:{mode:"batch",useIcons:!0,allowAdding:t.verifica_permissao(0,!0),allowUpdating:t.verifica_permissao(0,!1,!1)},loadPanel:{enabled:!0},scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},export:{enabled:!0,fileName:"PDCA #"+t.pdca.pdca_id.toString()+" - "+t.title,allowExportSelectedData:!0},filterRow:{visible:!0,applyFilter:"auto"},filterPanel:{visible:!0},noDataText:App.lang.dxDataGrid.noDataText,wordWrapEnabled:!0,rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},filterValue:t.filtros_row.pdca_atividade_id?["pdca_atividade_id","=",t.filtros_row.pdca_atividade_id]:null,onInitialized:()=>{t.filtros_row.pdca_atividade_id=null},onInitNewRow:function(a){a.data={situacao:PDCA_ATIVIDADE_SITUACAO.ABERTO,data_inicio:new Date,data_fim:new Date,quem:App.sessao.dados.admin?"":App.sessao.dados.usuario_id},a.component.columnOption("situacao","allowEditing",!0),a.component.columnOption("pdca_atividade_id","allowEditing",!1)},onEditCanceled:function(a){t.datagrid.option("editing.mode","batch")},onRowValidating:function(a){if("popup"==t.datagrid.option("editing.mode")){var e=[];e.push({data:{situacao:null!=a.newData.situacao&&""!=a.newData.situacao?a.newData.situacao:a.oldData.situacao,ordem:null!=a.newData.ordem&&""!=a.newData.ordem?a.newData.ordem:a.oldData.ordem,que:null!=a.newData.que&&""!=a.newData.que?a.newData.que:a.oldData.que,porque:null!=a.newData.porque&&""!=a.newData.porque?a.newData.porque:a.oldData.porque,quem:null!=a.newData.quem&&""!=a.newData.quem?a.newData.quem:a.oldData.quem,onde:null!=a.newData.onde&&""!=a.newData.onde?a.newData.onde:a.oldData.onde,data_inicio:null!=a.newData.data_inicio&&""!=a.newData.data_inicio?a.newData.data_inicio:a.oldData.data_inicio,data_fim:null!=a.newData.data_fim&&""!=a.newData.data_fim?a.newData.data_fim:a.oldData.data_fim,data_conclusao:null!=a.newData.data_conclusao&&""!=a.newData.data_conclusao?a.newData.data_conclusao:a.oldData.data_conclusao,como:null!=a.newData.como&&""!=a.newData.como?a.newData.como:a.oldData.como,quanto:null!=a.newData.quanto&&""!=a.newData.quanto?a.newData.quanto:a.oldData.quanto,conclusao:null!=a.newData.conclusao&&""!=a.newData.conclusao?a.newData.conclusao:a.oldData.conclusao},type:void 0!==a.oldData.pdca_atividade_id&&null!=a.oldData.pdca_atividade_id&&""!=a.oldData.pdca_atividade_id?"update":"insert",key:a.oldData.pdca_atividade_id,oldData:a.oldData}),t.atualiza_atividades_pdca(e)}},onCellPrepared:function(a){if("data"===a.rowType&&"edit"===a.column.command){var e=a.cellElement.find(".dx-link");t.verifica_permissao(a.row.data.quem,!1,!0)||e.filter(".dx-link-edit").remove()}},onEditingStart:function(a){a.component.columnOption("pdca_atividade_id","allowEditing",!1),t.pdca.situacao_id==PDCA_SITUACAO.CONCLUIDO?a.cancel=!0:a.cancel=!t.verifica_permissao(a.data.quem,!1,!0)},onEditorPreparing:function(a){var t=["que","porque","onde","como"].find(function(t){return t===a.dataField});"dataRow"==a.parentType&&t?a.editorName="dxTextArea":"dataRow"==a.parentType&&"ordem"==a.dataField&&(a.editorOptions.maxLength=10)},onEditorPrepared:function(a){if("dataRow"===a.parentType)switch("data_inicio"===a.dataField||"data_fim"===a.dataField||"data_conclusao"===a.dataField?a.editorElement.find("input").last().mask("99/99/9999"):"conclusao"==a.dataField&&a.editorElement.find("input").last().mask("999"),a.dataField){case"data_conclusao":$(a.editorElement).dxDateBox("instance").on("valueChanged",function(e){var i=a.row.rowIndex;if(""!==e.value&&null!==e.value){let a=new Date;dateDiff(a,e.value,!1,!0)>0?DevExpress.ui.dialog.alert("A data de conclusão não pode ser maior que a data atual","Atenção").done(function(){t.datagrid.cellValue(i,"data_conclusao",null)}):(t.datagrid.cellValue(i,"situacao","4"),t.datagrid.cellValue(i,"data_conclusao",e.value),t.datagrid.cellValue(i,"conclusao","100"))}else{var d=new Date(t.datagrid.cellValue(i,"data_fim")).toISOString().split("T")[0],o=(new Date).toISOString().split("T")[0];t.datagrid.cellValue(i,"data_conclusao",""),d<o?t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ATRASADO.toString()):(t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()),t.datagrid.cellValue(i,"conclusao","0"))}});break;case"conclusao":$(a.editorElement).dxTextBox("instance").on("valueChanged",function(e){var i=a.row.rowIndex;parseInt(e.value)>100||parseInt(e.value)<0?(DevExpress.ui.dialog.alert("Preencha a coluna Conclusão com valores entre 0 e 100","Atenção"),t.datagrid.cellValue(i,"conclusao","0")):(100==parseInt(e.value)?(t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.CONCLUIDO.toString()),t.datagrid.cellValue(i,"data_conclusao",new Date)):(new Date(t.datagrid.cellValue(i,"data_fim")).toISOString().split("T")[0]<(new Date).toISOString().split("T")[0]?t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ATRASADO.toString()):t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()),t.datagrid.cellValue(i,"data_conclusao",null)),t.datagrid.cellValue(i,"conclusao",e.value))});break;case"data_fim":$(a.editorElement).dxDateBox("instance").on("valueChanged",function(e){var i=a.row.rowIndex,d=t.datagrid.cellValue(i,"data_inicio");new Date(e.value)<new Date(d)&&DevExpress.ui.dialog.alert("Data Fim não pode ser menor que Data Início","Atenção").done(function(){t.datagrid.cellValue(i,"data_fim",new Date(d))});var o=t.datagrid.cellValue(i,"situacao"),n=o!=PDCA_ATIVIDADE_SITUACAO.CONCLUIDO&&(o==PDCA_ATIVIDADE_SITUACAO.ABERTO||o==PDCA_ATIVIDADE_SITUACAO.ATRASADO);new Date(e.value)>new Date&&n?t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()):0==dateDiff(e.value,new Date)&&n?t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()):new Date(e.value)<new Date&&n&&t.datagrid.cellValue(i,"situacao",PDCA_ATIVIDADE_SITUACAO.ATRASADO.toString()),t.datagrid.cellValue(i,"data_fim",e.value)});break;case"data_inicio":$(a.editorElement).dxDateBox("instance").on("valueChanged",function(e){var i=a.row.rowIndex,d=t.datagrid.cellValue(i,"data_fim");new Date(e.value)>new Date(d)&&(DevExpress.ui.dialog.alert("Data Início não pode ser maior que Data Fim","Atenção"),t.datagrid.cellValue(i,"data_inicio",d))});break;case"situacao":$(a.editorElement).dxSelectBox("instance").on("valueChanged",function(e){var i=a.row.rowIndex,d=t.datagrid.cellValue(i,"situacao"),o=t.datagrid.cellValue(i,"data_fim"),n=t.datagrid.cellValue(i,"data_conclusao"),l=t.datagrid.cellValue(i,"conclusao");if(d!=PDCA_ATIVIDADE_SITUACAO.ATRASADO&&e.value==PDCA_ATIVIDADE_SITUACAO.ATRASADO){var c=!1;dateDiff(o,new Date)<0&&null==n&&parseInt(l)<100&&(c=!0),!1===c&&DevExpress.ui.dialog.alert("Esta atividade não pode ser marcada como atrasada. Verifique os itens abaixo: <br /><br /> - Se a data fim está com valor menor que a data atual. <br /> - Se a data de conclusão não está preenchida e/ou se a porcentagem (%) de conclusão está menor que 100%.","Atenção").done(function(){t.datagrid.cellValue(i,"situacao",d)})}e.value==PDCA_ATIVIDADE_SITUACAO.CONCLUIDO?(t.datagrid.cellValue(i,"conclusao","100"),t.datagrid.cellValue(i,"data_conclusao",new Date)):e.value==PDCA_ATIVIDADE_SITUACAO.ABERTO&&(d==PDCA_ATIVIDADE_SITUACAO.CONCLUIDO?(t.datagrid.cellValue(i,"data_conclusao",null),t.datagrid.cellValue(i,"conclusao","0")):d==PDCA_ATIVIDADE_SITUACAO.ATRASADO&&t.datagrid.cellValue(i,"data_fim",new Date)),t.datagrid.cellValue(i,"situacao",e.value)})}},onRowPrepared:function(a){"data"==a.rowType&&(a.data.situacao==PDCA_ATIVIDADE_SITUACAO.ATRASADO?a.rowElement.find("td").css("background","#ffcdd2"):a.data.situacao==PDCA_ATIVIDADE_SITUACAO.CONCLUIDO&&a.rowElement.find("td").css("background","#dcedc8"))},onToolbarPreparing:function(a){var e=a.toolbarOptions.items;$.each(e,function(a,e){"saveButton"===e.name&&(e.options.onClick=function(a){var e=t.datagrid.getController("editing").getChanges();t.atualiza_atividades_pdca(e)}),"addRowButton"===e.name&&t.pdca.situacao_id==PDCA_SITUACAO.CONCLUIDO&&(e.options.disabled=!0)})},onContentReady:function(a){if(0==t.dialog.find(".btn_refresh").length){var e=$("<div style='margin-left: 5px;'>").addClass("btn_refresh").dxButton({hint:"Atualizar",icon:"refresh",onClick:function(){t.listar()}}),i=a.element.find(".dx-toolbar-after");$(i.get(0)).prepend(e)}a.component.columnOption("pdca_atividade_id","allowEditing",!1)},stateStoring:{enabled:!0,type:"custom",customLoad:function(){if(!1===t.param_filterRow)return App.get_parametro_usuario("pdca_listagem_atividades_"+t.pdca.pdca_id)},customSave:function(a){!1===t.param_filterRow&&App.set_parametro_usuario("pdca_listagem_atividades_"+t.pdca.pdca_id,a)}},columns:[{caption:"#",dataField:"pdca_atividade_id",dataType:"number",width:50,fixed:!0,fixedPosition:"left"},{caption:"Situação",alignment:"center",dataField:"situacao",width:90,lookup:{dataSource:[{id:5,descricao:"Aberto"},{id:1,descricao:"Atrasado"},{id:2,descricao:"Stand By"},{id:3,descricao:"Cancelado"},{id:4,descricao:"Concluído"}],valueExpr:"id",displayExpr:"descricao"}},{caption:"PDCA",alignment:"center",width:60,columns:[{caption:"5W2H",width:60,dataField:"ordem",alignment:"center",dataType:"number"}]},{caption:"Plan (Planejamento)",alignment:"center",columns:[{dataField:"que",caption:"What (O Quê ?)"},{dataField:"porque",caption:"Why (Por Quê ?)"},{dataField:"quem",lookup:{dataSource:{store:{type:"array",data:t.arr_usuarios}},valueExpr:"usuario_id",displayExpr:"nome"},caption:"Who (Quem ?)",width:140,validationRules:[{type:"required"}]},{dataField:"onde",caption:"Where (Onde ?)"}]},{caption:"Do (Fazer)",alignment:"center",columns:[{caption:"When (Quando ?)",alignment:"center",columns:[{dataField:"data_inicio",caption:"Data Início",dataType:"date",format:"dd/MM/yyyy",width:130},{dataField:"data_fim",caption:"Data Fim",dataType:"date",format:"dd/MM/yyyy",width:130,cellTemplate:function(a,e){t.verifica_permissao(e.data.quem,!1,!0)?$("<span/>").css("text-decoration","underline").css({"text-decoration":"underline",cursor:"pointer"}).text(new Date(e.data.data_fim).toISOString().format_date(!1)).on("dxclick",function(){View.load("pdca/historico",function(a,i){i.show(e.data.pdca_atividade_id,t.pdca.pdca_id)})}).appendTo(a):$("<span/>").text(new Date(e.data.data_fim).toISOString().format_date(!1)).appendTo(a)}},{dataField:"data_conclusao",caption:"Conclusão",dataType:"date",format:"dd/MM/yyyy",width:130}]},{dataField:"como",caption:"How (Como ?)"},{dataField:"quanto",caption:"How Much (Quanto ?)",dataType:"number",format:{type:"fixedPoint",precision:2},alignment:"left"}]},{caption:"Check (Resultado)",columns:[{dataField:"conclusao",caption:"%",width:80,alignment:"center",customizeText:function(a){var t=a.value||"0";return void 0===a.value||void 0===a.target||"filterPanel"!=a.target&&"row"!=a.target||null===a.value||a.value.indexOf("%")>0&&(t=a.value.replace("%","")),t+"%"}}]},{type:"buttons",width:130,buttons:[{hint:"Pós-Ação",icon:"fa fa-cogs",cssClass:"icon_black",visible:function(a){return t.permite_edicao_pos_acao=t.verifica_permissao(a.row.data.quem,!1,!0),t.verifica_permissao(a.row.data.quem,!1,!0)&&void 0!==a.row.data.pdca_atividade_id},onClick:function(a){View.load("pdca/pos_acao",function(e,i){i.show(t.pdca,a.row.data,t.permite_edicao_pos_acao)},View.ABA.NAO)}},{hint:"Observações",icon:"fa fa-comment",cssClass:"icon_black",onClick:function(a){View.load("pdca/observacao_atividade",function(e,i){var d="";void 0!==a.row.data.observacao?d=a.row.data.observacao:""!=t.msg_observacao_atividade&&(d=t.msg_observacao_atividade),i.show(a.row.data,t.pdca.pdca_id,d),i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==t.html_id&&(t.msg_observacao_atividade=get_tinymce(i.edt_observacao),t.listar())})}})},visible:function(a){return t.verifica_permissao(a.row.data.quem,!1,!0)&&void 0!==a.row.data.pdca_atividade_id}},{hint:"Editar (Popup)",icon:"fa fa-pencil-alt",cssClass:"icon_black",onClick:function(a){var e=function(a){t.datagrid.option("editing.mode","popup"),t.datagrid.editRow(a.row.rowIndex)};Array.isArray(t.datagrid.getController("editing")._changes)&&0!==t.datagrid.getController("editing")._changes.length?alert_modal("Aviso","Você realizou alterações que serão perdidas. Deseja continuar?","Sim",function(){e(a)},!0,"Cancelar",null,function(){}):e(a)},visible:function(a){return t.verifica_permissao(a.row.data.quem,!1,!0)}},{hint:"Remover",icon:"fa fa-trash",cssClass:"icon_black",onClick:function(a){t.datagrid.deleteRow(a.row.rowIndex)},visible:function(a){return t.verifica_permissao(a.row.data.quem,!0)}}]}]}).dxDataGrid("instance")},this.verifica_permissao=function(a,e,i){if(App.sessao.dados.admin)return!0;void 0===a&&(a=0),void 0===e&&(e=!1),void 0===i&&(i=!1);var d=!1;return t.arr_usuarios.length>0&&$(t.arr_usuarios).each(function(t,o){if(App.sessao.dados.usuario_id==o.usuario_id){var n="S"==o.gerente||!1===e&&(!0===i&&+a>0&&"S"==o.equipe&&App.sessao.dados.usuario_id==a||!1===i&&"S"==o.equipe);d=n}}),d},this.atualiza_atividades_pdca=function(a){WS.post("pdca_atividade/salvar/",{pdca_atividade:CircularJSON.stringify(a),pdca_id:t.pdca.pdca_id},function(a){if(void 0!==a){switch(t.pdca.progresso=a.progresso,t.pdca.situacao_id=a.situacao,parseInt(t.pdca.situacao_id)){case PDCA_SITUACAO.NAO_INICIADO:t.pdca.situacao="Não Iniciado";break;case PDCA_SITUACAO.EM_ANDAMENTO:t.pdca.situacao="Em Andamento";break;case PDCA_SITUACAO.CONCLUIDO:t.pdca.situacao="Concluído"}t.montar_cabecalho(),t.datagrid.saveEditData(),t.datagrid.option("editing.mode","batch"),t.listar()}})}}});