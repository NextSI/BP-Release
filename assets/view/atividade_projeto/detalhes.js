define(["react","react-dom","./../componentes_react/InformativoPrazo","./../atividade_projeto/ListarAtividadeProjeto"],function(e,a,o,i){return function(o){"use strict";var t=this;this.html_id=o,this.dialog=$("#"+this.html_id),this.title=null,this.onclose=null,this.onsave=null,this.ListarAtividadeProjeto=e.createElement(i,null,null),this.popup=this.dialog.find(".popup"),this.dx_listagem_atividades_predecessoras=this.dialog.find(".dx_listagem_atividades_predecessoras"),this.aba_formulario=this.dialog.find(".aba_formulario"),this.aba_financeiro=this.dialog.find(".aba_financeiro"),this.aba_executores=this.dialog.find(".aba_executores"),this.aba_atividades_predecessoras=this.dialog.find(".aba_atividades_predecessoras"),this.aba_apontamentos=this.dialog.find(".aba_apontamentos"),this.aba_custos=this.dialog.find(".aba_custos"),this.aba_tarefas=this.dialog.find(".aba_tarefas"),this.lbl_tab_predecessora=this.dialog.find(".lbl_tab_predecessora"),this.aba_referencias=this.dialog.find(".aba_referencias"),this.div_componente_referencias=this.dialog.find(".div_componente_referencias"),this.aba_movimentacao_financeira=this.dialog.find(".aba_movimentacao_financeira"),this.menu_formulario=this.dialog.find(".menu_formulario"),this.menu_financeiro=this.dialog.find(".menu_financeiro"),this.menu_apontamentos=this.dialog.find(".menu_apontamentos"),this.menu_atividade_prdecessoras=this.dialog.find(".menu_atividade_prdecessoras"),this.menu_executores=this.dialog.find(".menu_executores"),this.menu_custos=this.dialog.find(".menu_custos"),this.menu_tarefas=this.dialog.find(".menu_tarefas"),this.menu_referencias=this.dialog.find(".menu_referencias"),this.menu_movimentacao_financeira=this.dialog.find(".menu_movimentacao_financeira"),this.div_projeto=this.dialog.find(".div_projeto"),this.div_lbl_total_executores=this.dialog.find(".div_lbl_total_executores"),this.lbl_projeto_codigo=this.dialog.find(".lbl_projeto_codigo"),this.lbl_projeto_nome=this.dialog.find(".lbl_projeto_nome"),this.lbl_cliente_nome=this.dialog.find(".lbl_cliente_nome"),this.lbl_valor_total=this.dialog.find(".lbl_valor_total"),this.lbl_horas_previstas_total=this.dialog.find(".lbl_horas_previstas_total"),this.lbl_horas_previstas_saldo_total=this.dialog.find(".lbl_horas_previstas_saldo_total"),this.lbl_tab_movimentacao_financeira=this.dialog.find(".lbl_tab_movimentacao_financeira"),this.edt_codigo_projeto=this.dialog.find(".edt_codigo_projeto"),this.edt_porcentagem=this.dialog.find(".edt_porcentagem"),this.edt_data_solicitacao_projeto=this.dialog.find(".edt_data_solicitacao_projeto"),this.cbo_tipo_previsao_inicio=this.dialog.find(".cbo_tipo_previsao_inicio"),this.edt_previsao_inicio=this.dialog.find(".edt_previsao_inicio"),this.edt_inicio_projeto=this.dialog.find(".edt_inicio_projeto"),this.edt_prazo_projeto=this.dialog.find(".edt_prazo_projeto"),this.edt_conclusao_projeto=this.dialog.find(".edt_conclusao_projeto"),this.edt_nome_atividade=this.dialog.find(".edt_nome_atividade"),this.edt_valor_hora_atividade=this.dialog.find(".edt_valor_hora_atividade"),this.edt_prazo_dias=this.dialog.find(".edt_prazo_dias"),this.cbo_assunto_projeto=this.dialog.find(".cbo_assunto_projeto"),this.lbl_status=this.dialog.find(".lbl_status"),this.cbo_consultor_projeto=this.dialog.find(".cbo_consultor_projeto"),this.cbo_responsavel_projeto=this.dialog.find(".cbo_responsavel_projeto"),this.cbo_atividade_sinteticas=this.dialog.find(".cbo_atividade_sinteticas"),this.cbo_valor_previsto=this.dialog.find(".cbo_valor_previsto"),this.cbo_item=this.dialog.find(".cbo_item"),this.div_recursos=this.dialog.find(".div_recursos"),this.div_valor_hora=this.dialog.find(".div_valor_hora"),this.div_valor_total=this.dialog.find(".div_valor_total"),this.div_datas=this.dialog.find(".div_datas"),this.div_conclusao=this.dialog.find(".div_conclusao"),this.div_check_email=this.dialog.find(".div_check_email"),this.div_alert_apontamentos=this.dialog.find(".div_alert_apontamentos"),this.div_classificacao=this.dialog.find(".div_classificacao"),this.txt_atividades=this.dialog.find(".txt_atividades"),this.lbl_atividade_count=this.dialog.find(".lbl_atividade_count"),this.txt_observacoes=this.dialog.find(".txt_observacoes"),this.total_geral_horas=this.dialog.find(".total_geral_horas"),this.chk_notificar_envolvidos_email=this.dialog.find(".chk_notificar_envolvidos_email"),this.chk_marco=this.dialog.find(".chk_marco"),this.chk_cancelada=this.dialog.find(".chk_cancelada"),this.chk_tipo_cancelamento_ignorar_prev_real=this.dialog.find(".chk_tipo_cancelamento_ignorar_prev_real"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_novo_assunto=this.dialog.find(".btn_novo_assunto"),this.btn_visualizar_assunto=this.dialog.find(".btn_visualizar_assunto"),this.btn_apontamento=this.dialog.find(".btn_apontamento"),this.btn_refresh_apontamentos=this.dialog.find(".btn_refresh_apontamentos"),this.btn_incluir_item=this.dialog.find(".btn_incluir_item"),this.btn_incluir_tarefa=this.dialog.find(".btn_incluir_tarefa"),this.btn_cancelar_edicao_tarefa=this.dialog.find(".btn_cancelar_edicao_tarefa"),this.btn_editar_tarefa=this.dialog.find(".btn_editar_tarefa"),this.btn_recarregar_tarefa=this.dialog.find(".btn_recarregar_tarefa"),this.edt_nova_tarefa=this.dialog.find(".edt_nova_tarefa"),this.edt_tarefa_data_conclusao=this.dialog.find(".edt_tarefa_data_conclusao"),this.tab_custo_listagem=this.dialog.find(".tab_custo_listagem"),this.tab_tarefas=this.dialog.find('[data-table-name="tarefas"]').Tabela_Padrao_Next(),this.tab_apontamentos=this.dialog.find(".tab_apontamentos"),this.dx_selecao_executores=this.dialog.find(".dx_selecao_executores"),this.cbo_classificacao=this.dialog.find(".cbo_classificacao"),this.listagem_executores=this.dialog.find(".listagem_executores"),this.menu_mobile=this.dialog.find(".menu-mobile"),this.floating=this.dialog.find(".floating-menu"),this.collapse_accordion=this.dialog.find("#accordion"),this.chk_exibir_prazo_agenda=this.dialog.find(".chk_exibir_prazo_agenda"),this.div_exibir_prazo_agenda=this.dialog.find(".div_exibir_prazo_agenda"),this.div_porcentagem_peso_atividade=this.dialog.find(".div_porcentagem_peso_atividade"),this.dx_peso_atividade=this.dialog.find(".dx_peso_atividade"),this.div_horas_previstas=this.dialog.find(".div_horas_previstas"),this.div_componente_movimentacao_financeira=this.dialog.find(".div_componente_movimentacao_financeira"),this.divs_informativo_prazo=[],this.cliente_id=null,this.projeto_id=null,this.projeto_nome=null,this.projeto_codigo=null,this.projeto_atividade_id=null,this.template="N",this.equipe=new Array,this.arr_atividades_predecessoras=[],this.email_consultor=null,this.email_responsavel=null,this.assunto=null,this.atividade=null,this.tipo_previsao_inicio=null,this.previsao_inicio=null,this.prazo=null,this.conclusao=null,this.inicio=null,this.aba=null,this.atividade_sintetica_pai=null,this.arr_executores=[],this.arr_grupo_executores=[],this.grupo_usuarios_equipe=[],this.todos_executores=[],this.cliente_nome=null,this.projeto_atividade_classificacoes=!1,this.planejamento_datas=!1,this.documento_pasta_id=null,this.bloquear_codigo=!1,this.tabela_custos=[],this.tipo_formulario=FORMULARIO.NOVO,this.tarefa_atual=null,this.projeto_calendario_trabalho_id=null,this.permissoes_projeto=null,this.sugerir_data_prazo=!1,this.status_projeto=null,this.permitir_apontamento_projeto_concluido=null,this.projeto_apontamento_por=null,this.instanceMovimentacaoFinanceira=null,this.sortable_config={placeholder:"ui-state-highlight",revert:!0,axis:"y",cursorAt:{top:5,left:0},helper:function(e,a){var o=$(a).find(".descricao").text(),i="true"===$(a).find(".descricao").attr("data-realizado");return $('<section class="tarefas-row-helper"><article class="tarefas-row" data-realizado="'+i+'"><i class="fa '+(i?"fa-check-square":"fa-square")+' fa-fw"></i>&nbsp;&nbsp;'+o+"</article></section>")},stop:function(e,a){var o=[];$(a.item).parent().find("tr:not([template-row])").each(function(e,a){o.push({id:$(a).attr("data-id"),ordem:e})}),WS.post({route:"tarefa/alterar_ordem/",data:{ordenacao:JSON.stringify(o)},func_response:function(e){t.carregar_tarefas()},func_fail:function(){}})}},this.arr_tarefas=[],this.tabela_tarefa_config={disabled:!1},this.possui_executor_previsao_inicio=!1,this.datasource_movimentacao_financeira=[],this.input_peso_atividade=null,this.utiliza_peso_atividades=!1,this.executoresDropDownBoxRef=null,this.horas_previstas=null,this.show=function(e,a,o,i,r,s,d,_,n,l,c,p,u,v,m=!1){if("object"==typeof e&&null!=e){var h=clone_obj(e);e=null!=h.projeto_id&&""!=h.projeto_id?h.projeto_id:null,a=null!=h.projeto_atividade_id&&""!=h.projeto_atividade_id?h.projeto_atividade_id:null,o=null!=h.tipo&&""!=h.tipo?h.tipo:FORMULARIO.NOVO,i=null!=h.template&&""!=h.template?h.template:null,r=null!=h.equipe&&""!=h.equipe?h.equipe:null,s=null!=h.nome&&""!=h.nome?h.nome:null,d=null!=h.aba&&""!=h.aba?h.aba:null,_=null!=h.atividade_sintetica_pai&&""!=h.atividade_sintetica_pai?h.atividade_sintetica_pai:null,n=null!=h.grupo_usuarios_equipe&&""!=h.grupo_usuarios_equipe?h.grupo_usuarios_equipe:null,l=null!=h.sugere_codigo&&""!=h.sugere_codigo?h.sugere_codigo:null,c=null!=h.cliente_nome&&""!=h.cliente_nome?h.cliente_nome:null,p=null!=h.permitir_apontamento_projeto_concluido&&""!=h.permitir_apontamento_projeto_concluido?h.permitir_apontamento_projeto_concluido:null,u=null!=h.status_projeto&&""!=h.status_projeto?h.status_projeto:null,v=null!=h.projeto_apontamento_por&&""!=h.projeto_apontamento_por.toString()?h.projeto_apontamento_por.toString():null,m=void 0!==h.utiliza_peso_atividades&&h.utiliza_peso_atividades}t.projeto_id=e,t.tipo_formulario=o,t.aba=d,t.atividade_sintetica_pai=_,t.template=i,t.equipe=r,t.nome=s,t.permitir_apontamento_projeto_concluido=p,t.status_projeto=u,t.grupo_usuarios_equipe=n,t.sugere_codigo=l,t.cliente_nome=c,t.projeto_atividade_classificacoes="true"==App.sessao.dados.parametro_projeto.projeto_atividade_classificacoes,t.projeto_apontamento_por=v,t.utiliza_peso_atividades=m,t.btn_confirmar.hide(),t.btn_excluir.hide(),t.menu_custos.addClass("hidden"),t.menu_financeiro.addClass("hidden"),t.menu_movimentacao_financeira.addClass("hidden"),t.div_lbl_total_executores.addClass("hidden"),t.btn_apontamento.addClass("hidden");var f=function(e,o){switch(t.tipo_formulario=e,t.cliente_nome=o,t.edt_valor_hora_atividade.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),t.collapse_accordion.attr("id","accordion"+t.html_id),t.collapse_accordion.find("[href='#list-chamados2']").attr("href","#list-chamados2"+t.html_id).attr("data-parent","#accordion"+t.html_id).attr("aria-controls","list-chamados2"+t.html_id),t.collapse_accordion.find("#list-chamados2").attr("id","list-chamados2"+t.html_id).attr("aria-labelledby","list-chamados2"+t.html_id),$(t.tab_tarefas.tabela).find(".sortable").sortable(t.sortable_config),t.aba_formulario.attr("id","aba_formulario"+t.html_id),t.aba_financeiro.attr("id","aba_financeiro"+t.html_id),t.aba_executores.attr("id","aba_executores"+t.html_id),t.aba_atividades_predecessoras.attr("id","aba_atividades_predecessoras"+t.html_id),t.aba_apontamentos.attr("id","aba_apontamentos"+t.html_id),t.aba_custos.attr("id","aba_custos"+t.html_id),t.aba_tarefas.attr("id","aba_tarefas"+t.html_id),t.aba_referencias.attr("id","aba_referencias"+t.html_id),t.aba_movimentacao_financeira.attr("id","aba_movimentacao_financeira"+t.html_id),t.menu_formulario.attr("href","#"+t.aba_formulario.attr("id")),t.menu_financeiro.attr("href","#"+t.aba_financeiro.attr("id")),t.menu_atividade_prdecessoras.attr("href","#"+t.aba_atividades_predecessoras.attr("id")),t.txt_atividades.attr("id","txt_atividades"+t.html_id),t.menu_executores.attr("href","#"+t.aba_executores.attr("id")),t.menu_apontamentos.attr("href","#"+t.aba_apontamentos.attr("id")),t.menu_custos.attr("href","#"+t.aba_custos.attr("id")),t.menu_tarefas.attr("href","#"+t.aba_tarefas.attr("id")),t.menu_referencias.attr("href","#"+t.aba_referencias.attr("id")),t.menu_movimentacao_financeira.attr("href","#"+t.aba_movimentacao_financeira.attr("id")),set_datepicker(t.edt_data_solicitacao_projeto),set_datepicker(t.edt_previsao_inicio),set_datepicker(t.edt_inicio_projeto),set_datepicker(t.edt_prazo_projeto),set_datepicker(t.edt_conclusao_projeto),set_datepicker(t.edt_tarefa_data_conclusao),"S"==t.template&&(t.div_conclusao.hide(),t.div_datas.hide(),t.btn_apontamento.addClass("hidden"),t.permissoes_projeto={gerente_projeto:!0,permissao_atividade:!0,permissao_recursos:!0,permissao_financeiro:!0,permissao_datas:!0}),t.tipo_formulario!==FORMULARIO.EDITAR&&t.tipo_formulario!==FORMULARIO.NOVO||(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_recursos)&&t.render_dx_selecao_executores(),e){case FORMULARIO.NOVO:t.title=t.projeto_codigo+" - Nova Atividade",App.titulo_aba(t.html_id,t.title),t.btn_apontamento.addClass("hidden"),t.collapse_accordion.addClass("hidden"),t.menu_mobile.addClass("hidden"),t.btn_confirmar.show(),t.btn_excluir.hide(),t.div_check_email.removeClass("hidden"),t.menu_atividade_prdecessoras.addClass("hidden"),t.menu_apontamentos.addClass("hidden"),t.menu_financeiro.addClass("hidden"),t.menu_movimentacao_financeira.addClass("hidden"),t.menu_custos.addClass("hidden"),t.menu_tarefas.addClass("hidden"),t.menu_referencias.addClass("hidden"),t.div_lbl_total_executores.addClass("hidden"),1==t.sugere_codigo&&WS.get("atividade_projeto/get_next_codigo/",{projeto_id:t.projeto_id},function(e){t.edt_codigo_projeto.val(e)}),t.menu_executores.addClass("hidden"),t.btn_confirmar.addClass("list-group-item-warning"),t.bloqueia_codigo(),t.chk_exibir_prazo_agenda.prop("checked",!0),t.chk_exibir_prazo_agenda.removeClass("template_switch"),App.aplicar_checkbox(t.div_exibir_prazo_agenda),t.permissoes_usuario(!1,FORMULARIO.NOVO);break;case FORMULARIO.EDITAR:App.titulo_aba(t.html_id,t.nome.substring(0,10)),t.btn_confirmar.show(),t.btn_excluir.hide(),t.permite_alterar(!1),t.permissoes_usuario(!1,FORMULARIO.EDITAR),t.div_check_email.removeClass("hidden"),t.bloqueia_codigo();break;case FORMULARIO.VISUALIZAR:App.titulo_aba(t.html_id,t.nome.substring(0,10)),t.btn_confirmar.hide(),t.btn_excluir.hide(),t.permite_alterar(!1),t.permissoes_usuario(!0,FORMULARIO.VISUALIZAR);break;case FORMULARIO.EXCLUIR:t.btn_confirmar.hide(),t.btn_excluir.show().unbind("click").click(function(){WS.post("atividade_projeto/excluir",{atividade_projeto_id:t.projeto_atividade_id},function(e){alert_saved("Atividade excluida com sucesso"),t.unload()},[t.btn_excluir])}),t.permite_alterar(!1),t.permissoes_usuario(!0,FORMULARIO.EXCLUIR)}void 0!==a&&a?(t.projeto_atividade_id=a,t.preencher(),t.title="Atividade - "+t.nome):(set_tinymce(t.txt_atividades,""),t.div_projeto.hide(),t.listar_assunto(),t.listar_responsavel(),t.render_input_peso_atividade()),t.listar_atividade_sinteticas(t.atividade_sintetica_pai),1==t.projeto_atividade_classificacoes?(t.div_classificacao.removeClass("hidden"),e==FORMULARIO.NOVO&&t.listar_classificacao()):t.div_classificacao.addClass("hidden"),set_focus(t.edt_codigo_projeto)},b=function(e){for(var a={gerente_projeto:!1,permissao_atividade:!1,permissao_recursos:!1,permissao_financeiro:!1,permissao_datas:!1},o=object_to_array(e),i=0;i<o.length;i++)if(o[i].usuario_id==App.sessao.dados.usuario_id){a.gerente_projeto="S"==o[i].gerente_projeto||1==o[i].gerente_projeto,a.permissao_atividade="S"==o[i].planejamento_atividade||1==o[i].planejamento_atividade,a.permissao_recursos="S"==o[i].planejamento_recursos||1==o[i].planejamento_recursos,a.permissao_financeiro="S"==o[i].planejamento_financeiro||1==o[i].planejamento_financeiro,a.permissao_datas="S"==o[i].planejamento_datas||1==o[i].planejamento_datas,t.permissoes_projeto=a;break}null==t.permissoes_projeto&&(t.permissoes_projeto=a)};parseInt(a,10)>0?WS.get("atividade_projeto/objeto/",{atividade_projeto_id:a},function(e){t.projeto_id=e.projeto_id,t.nome=e.atividade_simplificada.substring(0,10),t.projeto_calendario_trabalho_id=e.projeto_calendario_trabalho_id,b(e.equipe_projeto),f(o,e.cliente_nome)}):parseInt(e,10)>0?WS.get("projeto/objeto/",{projeto_id:e},function(e){t.projeto_codigo=e.codigo,t.projeto_calendario_trabalho_id=e.calendario_trabalho_id,b(e.equipe_toda),f(o,e.cliente_nome)}):f(o,response.cliente_nome)},this.cbo_valor_previsto.on("change",function(e){var a=$(e.target).val();if(a==TIPO_FINANCEIRO.HORA_TECNICO){var o=new Validation;o.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja aplicar valor hora por técnico nos executores desta atividade?")),alert_modal("Validação",o,"Sim",function(){$.each(t.arr_executores,function(e,a){$.each(t.equipe,function(o,i){a.id==i.usuario_id&&(t.arr_executores[e].valor_hora=t.equipe[o].valor_projeto)})}),t.render_executores()},!0,"Não"),t.div_valor_hora.addClass("hidden")}else a==TIPO_FINANCEIRO.HORA_MANUAL?($.each(t.arr_executores,function(e,a){t.arr_executores[e].valor_hora=0}),t.div_valor_hora.addClass("hidden"),t.render_executores()):($.each(t.arr_executores,function(e,a){t.arr_executores[e].valor_hora=t.edt_valor_hora_atividade.maskMoney("unmasked")[0]}),t.render_executores(),t.div_valor_hora.removeClass("hidden"))}),this.edt_valor_hora_atividade.keyup(function(e){if(t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_ATIVIDADE){$(".edt_valor_hora").val($(e.target).val());var a=$(".listagem_executores li:not(.template_row)");$.each(a,function(e,a){var o=$(a).find(".div_horas_alocadas").children().dxTextBox("instance").option("value"),i=$(a).find(".edt_valor_hora"),r=$(a).find(".edt_valor_total");t.custo_total(o,i,r)})}}),this.permissoes_usuario=function(e,a){a!==FORMULARIO.NOVO&&a!==FORMULARIO.EDITAR||(t.btn_confirmar.unbind("click").click(function(){t.salvar_atividade(!0)}),t.status_projeto==PROJETO_STATUS.CONCLUIDO&&"S"!=t.permitir_apontamento_projeto_concluido||t.btn_apontamento.removeClass("hidden"),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto)&&(t.chk_cancelada.prop("disabled",e),t.chk_tipo_cancelamento_ignorar_prev_real.prop("disabled",e)),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_atividade)&&(t.cbo_assunto_projeto.prop("disabled",e),t.txt_observacoes.prop("disabled",e),t.cbo_classificacao.prop("disabled",e),t.edt_codigo_projeto.prop("readonly",e),t.edt_porcentagem.prop("readonly",e),t.btn_novo_assunto.prop("disabled",e),t.btn_visualizar_assunto.prop("disabled",e),t.btn_confirmar.removeClass("hidden"),t.edt_nome_atividade.prop("disabled",e),t.cbo_atividade_sinteticas.prop("disabled",e),t.setTaskDisable(!1)),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_recursos)&&(t.cbo_responsavel_projeto.prop("disabled",e),t.cbo_consultor_projeto.prop("disabled",e),t.executoresDropDownBoxRef&&t.executoresDropDownBoxRef.option("disabled",e),t.chk_exibir_prazo_agenda.prop("disabled",e)),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_datas)&&(t.edt_data_solicitacao_projeto.prop("readonly",e),t.cbo_tipo_previsao_inicio.prop("disabled",e).selectpicker("refresh"),t.edt_previsao_inicio.prop("readonly",e),t.edt_inicio_projeto.prop("readonly",e),t.edt_prazo_projeto.prop("readonly",e),t.edt_conclusao_projeto.prop("readonly",e),t.edt_prazo_dias.prop("disabled",e),t.renderizarComponenteHorasPrevistas(e)))},this.bloqueia_codigo=function(e){WS.get("projeto/objeto/",{projeto_id:t.projeto_id},function(e){t.bloquear_codigo=e.bloquear_codigo,t.documento_pasta_id=e.documento_pasta_id,t.projeto_codigo=e.codigo,1==t.bloquear_codigo||"S"==t.bloquear_codigo?t.edt_codigo_projeto.prop("disabled",!0):t.edt_codigo_projeto.prop("disabled",!1)})},this.listar_atividade_sinteticas=function(e){t.cbo_atividade_sinteticas.find("option").remove(),add_option(t.cbo_atividade_sinteticas,"","Nenhuma"),WS.get("atividade_sintetica_projeto/listar/",{projeto_id:t.projeto_id},function(a){for(var o=function(e,i,r){add_option(t.cbo_atividade_sinteticas,e.atividade_sintetica_id,i.repeat(r)+e.nome);for(var s=[],d=0;d<a.length;d++)(_=a[d]).projeto_atividade_sintetica_pai_id==e.atividade_sintetica_id&&s.push(_);for(d=0;d<s.length;d++){var _=s[d];o(_,i,r+1)}},i=0;i<a.length;i++){var r=a[i];r.projeto_atividade_sintetica_pai_id||o(r,"&mdash;",0)}t.cbo_atividade_sinteticas.selectpicker("refresh"),e&&t.cbo_atividade_sinteticas.val(e).trigger("change")})},this.listar_assunto=function(e){t.cbo_assunto_projeto.find("option").remove(),add_option(t.cbo_assunto_projeto,"","Nenhum"),WS.get("assunto_projeto/listar/",null,function(a){for(var o=0;o<a.length;o++){var i=a[o];add_option(t.cbo_assunto_projeto,i.assunto_projeto_id,i.descricao)}e&&t.cbo_assunto_projeto.val(e).trigger("change"),t.cbo_assunto_projeto.selectpicker("refresh")},null,null,null,null,null,t.html_id)},this.listar_classificacao=function(e){t.cbo_classificacao.find("option").remove(),add_option(t.cbo_classificacao,"","- Selecione -"),WS.get("projeto_atividade_classificacao/listar/",null,function(a){for(var o=0;o<a.length;o++){var i=a[o];add_option(t.cbo_classificacao,i.projeto_atividade_classificacao_id,i.nome)}e&&t.cbo_classificacao.val(e).trigger("change"),t.cbo_classificacao.selectpicker("refresh")},null,null,null,null,null,t.html_id)},this.custo_total=function(e,a,o){const i=e?e.split(":"):["0","00"];var r=i[0],s=i[1],d=60*parseInt(r,10)+parseInt(s,10),_=a.maskMoney("unmasked")[0],n=d*(parseFloat(_)/60);o.addClass("edt_executores_valor_total").attr("elem_key",md5(Math.random()+new Date)),o.maskMoney("mask",parseFloat(n)),o.trigger("change"),t.soma_total()},this.soma_total=function(){if(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_financeiro){var e="00:00",a=0;$.each(t.arr_executores,function(o,i){"N"==i.excluido&&(a+=i.valor_previsto,e=somar_horas(e,i.horas_previstas))}),t.div_lbl_total_executores.removeClass("hidden"),t.lbl_horas_previstas_total.html("Total horas alocadas <br />"+e),t.lbl_horas_previstas_saldo_total.html("Saldo horas não alocadas <br />"+subtrair_horas(t.horas_previstas,e)),t.lbl_valor_total.html("Valor total <br />"+a.format_number(2,!0))}},this.renderizarComponenteMovimentacaoFinanceira=function(){var e={projetoId:t.projeto_id,atividadeProjetoId:t.projeto_atividade_id,dataSource:t.datasource_movimentacao_financeira,instanceMovimentacaoFinanceira:function(e){t.instanceMovimentacaoFinanceira=e}};ReactDOM.render(React.createElement(window.components.MovimentacaoFinanceira.default,e),t.div_componente_movimentacao_financeira[0])},this.renderizarComponenteHorasPrevistas=function(e){ReactDOM.unmountComponentAtNode(t.div_horas_previstas[0]);var a={valor:t.horas_previstas,readOnly:e,aoAlterar:e=>{t.horas_previstas=e}};ReactDOM.render(React.createElement(window.components.TextBoxHora.default,a),t.div_horas_previstas[0])},this.render_executores=function(e){var a=t.listagem_executores.find(".template_row"),o=function(e,a){e.previsao_inicio&&e.horas_previstas&&e.previsao_inicio.length>0&&e.horas_previstas.length>0&&WS.get("/atividade_projeto/calcular_prazo_previsto/",{calendario_trabalho_id:t.projeto_calendario_trabalho_id,previsao_inicio:e.previsao_inicio,horas_previstas:e.horas_previstas,horas_dedicadas:e.horas_dedicadas},function(o){set_datepicker(a,o.substring(0,10)),e.prazo_previsto=o})},i=function(e,i){null!=i.horas_previstas&&""!=i.horas_previstas&&(i.horas_previstas=format_time(i.horas_previstas)),"00:00"!=i.horas_previstas&&"000:00"!=i.horas_previstas||(i.horas_previstas=null),i.horas_dedicadas&&(null!==i.horas_dedicadas&&""!==i.horas_dedicadas&&(i.horas_dedicadas=format_time(i.horas_dedicadas).substring(1)),"00:00"!=i.horas_dedicadas&&"000:00"!=i.horas_dedicadas||(i.horas_dedicadas=null));var r=a.clone();r.removeAttr("template-row"),r.css("display",""),r.removeClass("template_row"),r.addClass("new_row");var s=$(r.find(".table_agenda_evento")),d=$(s.find(".btn_incluir_evento_agenda"));d.unbind("click"),d.click(function(){View.load("agenda/agenda_evento",function(e,a){var o=new Object;o.projeto_id=t.projeto_id,o.projeto_nome=t.projeto_nome,o.projeto_atividade_id=t.projeto_atividade_id,o.cliente_id=t.cliente_id,o.cliente_nome=t.cliente_nome,o.previsao_inicio=i.previsao_inicio,o.horas_previstas=i.horas_previstas;var r={evento_id:null,usuario_id:i.id,dia:getDateNow(!0),usuario_nome:"",obj_dados_projeto:o,agenda_ativo_id:null,calendario_trabalho_id:i.calendario_trabalho_id};a.onsave=function(){t.listar_agenda_evento(s,{projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id,usuario_id:i.id}),t.atualizar_data_prazo()},a.show(r)})}),(h=$(r.find("[template-button='btn_agenda_recorrente']"))).unbind("click"),h.click(function(){if(s.hasClass("hidden")){var e={projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id,usuario_id:i.id};t.atualizar_data_prazo(),t.listar_agenda_evento(s,e),s.removeClass("hidden")}else s.find("tr:gt(1)").remove(),s.addClass("hidden")}),$(r.find("[template-field='nome']")).text(i.nome);var _=$(r.find("[template-field='tipo']"));"usuario"==i.tipo?(_.addClass("label-info"),_.attr("title","Usuário"),_.attr("data-original-title","Usuário"),_.text("U")):"grupo_usuarios"==i.tipo&&(_.addClass("label-warning"),_.attr("title","Grupo de Usuários"),_.attr("data-original-title","Grupo de Usuários"),_.text("GU"));var n=$(r.find(".edt_valor_total")),l=$(r.find("[template-field='edt_valor_hora']")),c=$(r.find("[template-field='edt_previsao_inicio_executor']")),p=$(r.find("[template-field='div_horas_alocadas']")),u=$(r.find("[template-field='edt_horas_dedicadas']")),v=$(r.find("[template-field='edt_prazo_previsto_executor']")),m=$(r.find("[template-button='btn_usuario_remover']")),h=$(r.find("[template-button='btn_agenda_recorrente']")),f=$(r.find(".th_valor_hora")),b=$(r.find(".th_valor_total")),g=i.horas_previstas,j=!0;b.addClass("hidden"),f.addClass("hidden"),m.addClass("hidden"),h.addClass("hidden"),u.prop("disabled",!0),c.attr("type","date"),set_datepicker(c),v.attr("type","date"),set_datepicker(v),v.attr("readonly",!0),c.attr("readonly",!0);var x=()=>{for(var e=0,a=0;a<t.arr_executores.length;a++)"N"==(o=t.arr_executores[a]).excluido&&(e=somar_horas(o.horas_previstas,e));for(a=0;a<t.arr_grupo_executores.length;a++){var o;"N"==(o=t.arr_grupo_executores[a]).excluido&&(e=somar_horas(o.horas_previstas,e))}format_time(e)>format_time(t.horas_previstas)&&(t.permissoes_projeto.permissao_atividade||App.sessao.dados.admin)&&alertaPopUp("Atenção","O total de horas dos executores está maior que as horas previstas da atividade.<br/>Deseja atribuir "+format_time(e)+" à hora prevista da atividade ?","Sim",function(){t.horas_previstas=format_time(e),t.renderizarComponenteHorasPrevistas()},"Não",function(){})};if(App.sessao.dados.admin?!0===App.sessao.dados.admin&&(b.removeClass("hidden"),f.removeClass("hidden"),j=!1,u.prop("disabled",!1),m.removeClass("hidden"),"usuario"==i.tipo&&h.removeClass("hidden"),c.removeAttr("readonly"),n.unbind("change"),n.change(function(){$(r.find(".edt_valor_total")).prop("disabled",!0),n.val(this.value),i.valor_previsto=$(this).maskMoney("unmasked")[0]}),l.unbind("change"),l.change(function(){$(r.find("[template-field='edt_valor_hora']")).val(this.value),t.custo_total(g,l,n),i.valor_hora=$(this).maskMoney("unmasked")[0]}),n.trigger("change"),m.unbind("click"),m.click(function(){r.remove(),"usuario"==i.tipo?t.arr_executores[e].excluido="S":"grupo_usuarios"==i.tipo&&(t.arr_grupo_executores[e].excluido="S"),t.soma_total(),t.sugerir_previsao_inicio_atividade()}),l.prop("disabled",!0),"grupo_usuarios"==i.tipo&&(f.remove(),b.remove())):(t.permissoes_projeto.permissao_financeiro&&(b.removeClass("hidden"),f.removeClass("hidden"),n.unbind("change"),n.change(function(){$(r.find(".edt_valor_total")).prop("disabled",!0),n.val(this.value),i.valor_previsto=$(this).maskMoney("unmasked")[0]}),l.unbind("change"),l.change(function(){$(r.find("[template-field='edt_valor_hora']")).val(this.value),t.custo_total(g,l,n),i.valor_hora=$(this).maskMoney("unmasked")[0]}),n.trigger("change")),t.permissoes_projeto.permissao_recursos&&(j=!1,u.prop("disabled",!1),m.removeClass("hidden"),m.unbind("click"),m.click(function(){r.remove(),"usuario"==i.tipo?t.arr_executores[e].excluido="S":"grupo_usuarios"==i.tipo&&(t.arr_grupo_executores[e].excluido="S"),t.soma_total(),t.sugerir_previsao_inicio_atividade()})),t.permissoes_projeto.permissao_datas&&("usuario"==i.tipo&&h.removeClass("hidden"),c.removeAttr("readonly"))),c.on("change",function(){""==get_datepicker(c)||null==get_datepicker(c)?t.possui_executor_previsao_inicio=!1:t.possui_executor_previsao_inicio=!0,i.previsao_inicio=get_datepicker(c),t.sugerir_previsao_inicio_atividade(),o(i,v)}),u.on("keyup",$.debounce(950,function(){const e=$(this).val();if(5==e.length){if(!function(e,a=6){var o=new Validation,i=e.split(":"),t=i[1];return i.length,t>59||e.length>0&&e.length!=a?(o.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Valor de horas inválido")),alert_modal("Validação",o),!1):!(e>"838:59"&&(o.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"O valor de horas deve ser menor que 838:59")),alert_modal("Validação",o),1))}(e,5))return;i.horas_dedicadas=e,o(i,v)}})),null!=i.previsao_inicio?(t.possui_executor_previsao_inicio=!0,set_datepicker(c,i.previsao_inicio),t.edt_previsao_inicio.prop("readonly",!0)):(t.possui_executor_previsao_inicio=!1,t.edt_previsao_inicio.prop("readonly",!1)),null!=get_datepicker(t.edt_inicio_projeto)&&""!=get_datepicker(t.edt_inicio_projeto)&&t.edt_previsao_inicio.prop("readonly",!0),l.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),n.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),u.mask("00:00"),t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_ATIVIDADE){var k=t.edt_valor_hora_atividade.maskMoney("unmasked")[0];l.maskMoney("mask",k).trigger("change")}else t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_MANUAL?(l.prop("disabled",!1),l.maskMoney("mask",parseFloat(i.valor_hora)).trigger("change")):null!=i.valor_hora&&l.maskMoney("mask",parseFloat(i.valor_hora)).trigger("change");null!==i.horas_dedicadas&&""!==i.horas_dedicadas&&u.val(i.horas_dedicadas).trigger("change"),e!=t.arr_executores.length&&"usuario"==i.tipo?t.arr_executores[e]=i:e!=t.arr_grupo_executores.length&&"grupo_usuarios"==i.tipo?t.arr_grupo_executores[e]=i:"usuario"==i.tipo?t.arr_executores.push(i):"grupo_usuarios"==i.tipo&&t.arr_grupo_executores.push(i),"grupo_usuarios"==i.tipo&&(u.parent().parent().remove(),u.remove()),function(e,a,r,s,d){ReactDOM.unmountComponentAtNode(p[0]);var _={valor:e,readOnly:a,aoAlterar:e=>{t.custo_total(e,r,s),i.horas_previstas=e,t.soma_total(),o(i,d)},fnOnFocusOut:x};ReactDOM.render(React.createElement(window.components.TextBoxHora.default,_),p[0])}(g,j,l,n,v),r.appendTo(t.listagem_executores)};e?"usuario"==e.tipo?"N"==e.excluido&&i(t.arr_executores.length,e):"grupo_usuarios"==e.tipo&&"N"==e.excluido&&i(t.arr_grupo_executores.length,e):(t.listagem_executores.find(".new_row").remove(),$(t.arr_executores).each(function(e,a){a.excluido="N",i(e,a)}),$(t.arr_grupo_executores).each(function(e,a){a.excluido="N",i(e,a)}))},this.sugerir_previsao_inicio_atividade=function(){var e=null;$(t.arr_executores).each(function(a,o){null!=o.previsao_inicio&&""!=o.previsao_inicio&&"S"!=o.excluido&&(o.previsao_inicio<e||null==e)&&(e=o.previsao_inicio)}),$(t.arr_grupo_executores).each(function(a,o){null!=o.previsao_inicio&&""!=o.previsao_inicio&&"S"!=o.excluido&&(o.previsao_inicio<e||null==e)&&(e=o.previsao_inicio)}),null!=e||null!=get_datepicker(t.edt_inicio_projeto)&&""!=get_datepicker(t.edt_inicio_projeto)?setTimeout(function(){set_datepicker(t.edt_previsao_inicio,e),t.edt_previsao_inicio.prop("readonly",!0),t.possui_executor_previsao_inicio=!0},600):(t.edt_previsao_inicio.prop("readonly",!1),t.possui_executor_previsao_inicio=!1)},this.listar_agenda_evento=function(e,a){var o=e.find("tbody"),i=o.find("tr:first");e.find("tr:gt(1)").remove(),WS.get("agenda_evento/get_agenda_evento_by_projeto_executor/",a,function(r){$(r).each(function(r,s){!function(r){var s=i.clone();s.removeAttr("template-row"),s.css("display",""),$(s.find("[template-field='dia']")).text(r.dia?r.dia.format_date():""),$(s.find("[template-field='hora_inicio']")).text(r.hora_inicio?r.hora_inicio.substr(0,5):""),$(s.find("[template-field='hora_fim']")).text(r.hora_fim?r.hora_fim.substr(0,5):""),$(s.find("[template-field='tipo_agenda']")).text(r.agenda_tipo_nome?r.agenda_tipo_nome:""),$(s.find("[template-field='local']")).text(r.agenda_local_nome?r.agenda_local_nome:"");var d=$(s.find(".btn_editar"));d.unbind("click"),d.click(function(){View.load("agenda/agenda_evento",function(o,i){var s=new Object;i.onsave=function(){t.listar_agenda_evento(e,a),t.atualizar_data_prazo()},i.show(r.agenda_evento_id,null,null,s)})}),s.appendTo(o)}(s)})})},this.listar_responsavel=function(e){if(t.cbo_responsavel_projeto.find("option").remove(),add_option(t.cbo_responsavel_projeto,"","Nenhum"),null!=t.equipe&&"undefined"!=t.equipe){for(var a in t.equipe)if("clean"!=a){var o=t.equipe[a];add_option(t.cbo_responsavel_projeto,o.usuario_id,o.nome)}e&&t.cbo_responsavel_projeto.val(e).trigger("change")}t.cbo_responsavel_projeto.selectpicker("refresh")},this.close=function(){void 0!==t.onclose&&t.onclose&&t.onclose()},this.unload=function(){for(var e=0;e<t.divs_informativo_prazo.length;e++)t.divs_informativo_prazo[e].props.desativarRefreshAutomatico();t.close(),View.unload(this.html_id)},this.permite_alterar=function(e){t.txt_atividades.prop("disabled",!e),t.txt_observacoes.prop("disabled",!e),t.edt_codigo_projeto.prop("readonly",!e),t.edt_porcentagem.prop("readonly",!e),t.cbo_classificacao.prop("disabled",!e),t.edt_nome_atividade.prop("disabled",!e),t.cbo_atividade_sinteticas.prop("disabled",!e),t.btn_novo_assunto.prop("disabled",!e),t.btn_visualizar_assunto.prop("disabled",!e),t.edt_data_solicitacao_projeto.prop("readonly",!e),t.cbo_tipo_previsao_inicio.prop("disabled",!e).selectpicker("refresh"),t.edt_previsao_inicio.prop("readonly",!e),t.edt_inicio_projeto.prop("readonly",!e),t.edt_prazo_projeto.prop("readonly",!e),t.edt_conclusao_projeto.prop("readonly",!e),t.renderizarComponenteHorasPrevistas(!e),t.edt_prazo_dias.prop("disabled",!e),t.cbo_assunto_projeto.prop("disabled",!e),t.cbo_consultor_projeto.prop("disabled",!e),t.cbo_responsavel_projeto.prop("disabled",!e),t.chk_cancelada.prop("disabled",!e),t.chk_tipo_cancelamento_ignorar_prev_real.prop("disabled",!e),t.executoresDropDownBoxRef&&t.executoresDropDownBoxRef.option("disabled",!e),t.chk_exibir_prazo_agenda.prop("disabled",!e),t.tabela_tarefa_config.disabled=!e,t.setTaskDisable(!0)},this.preencher=function(){t.limpar_tarefa(),t.limpar_custos(),WS.get("atividade_projeto/objeto/",{atividade_projeto_id:t.projeto_atividade_id},function(e){t.datasource_movimentacao_financeira=e.movimentacao_financeira,t.todos_executores=e.todos_executores,t.arr_executores=e.usuarios_executores,t.arr_grupo_executores=e.grupo_usuarios_executores,t.arr_atividades_predecessoras=e.arr_atividades_predecessoras,t.listar_atividades_predecessoras(),1==t.projeto_atividade_classificacoes&&t.listar_classificacao(e.classificacao_projeto_atividade_id),t.projeto_id=e.projeto_id,t.projeto_nome=e.projeto_nome,t.cliente_id=e.cliente_id,t.cliente_nome=e.cliente_nome,t.email_consultor=e.email_consultor,t.email_responsavel=e.email_responsavel,t.assunto=e.assunto,t.atividade=e.atividade,t.tipo_previsao_inicio=e.tipo_previsao_inicio,t.previsao_inicio=e.previsao_inicio,t.prazo=e.prazo,t.conclusao=e.conclusao,t.tabela_custos=e.tabela_custos,t.carregar_tarefas(),t.tabela_custos.map(function(e,a){e.disabled=t.tipo_formulario==FORMULARIO.VISUALIZAR||t.tipo_formulario==FORMULARIO.EXCLUIR,t.add_custo(e)}),e.prazo_dias>0&&t.edt_prazo_dias.val(e.prazo_dias),t.cliente_id<1&&t.btn_apontamento.addClass("hidden"),t.div_projeto.show(),t.lbl_projeto_codigo.text(e.projeto_codigo),t.lbl_projeto_nome.text(e.projeto_nome),t.lbl_cliente_nome.text(e.cliente_nome);var a=function(){View.load("atividade_projeto/listar",function(a,o){o.show(e.projeto_id,e.template,e.cliente_nome)},View.ABA.MULTIPLAS,null,null,{projetoId:e.projeto_id})};t.lbl_projeto_codigo.click(a),t.lbl_projeto_nome.click(a),t.horas_previstas=e.horas_previstas,t.renderizarComponenteHorasPrevistas(),t.edt_codigo_projeto.val(e.codigo),t.edt_nome_atividade.val(e.atividade_simplificada);var o=!1;null!==t.permissoes_projeto&&(o=App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_atividade),set_tinymce(t.txt_atividades,e.atividade,!o),t.listar_assunto(e.assunto_projetos_id),t.listar_responsavel(e.responsavel_id),t.listar_apontamentos(),t.listar_atividade_sinteticas(e.projeto_atividade_sintetica_pai_id),setTimeout(function(){t.cbo_tipo_previsao_inicio.val(e.tipo_previsao_inicio).trigger("change").selectpicker("refresh"),set_datepicker(t.edt_previsao_inicio,e.previsao_inicio),set_datepicker(t.edt_inicio_projeto,e.inicio),t.edt_previsao_inicio.attr("value",e.previsao_inicio),t.edt_previsao_inicio.change(),void 0!==e.data_prazo&&null!=e.data_prazo?(set_datepicker(t.edt_prazo_projeto,e.data_prazo),t.sugerir_data_prazo=!0):set_datepicker(t.edt_prazo_projeto,e.prazo),""!=e.prazo&&null!=e.prazo&&(t.edt_prazo_dias.unbind("change"),t.edt_prazo_dias.change(function(){if($(this).val()>0){var e=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());e&&set_datepicker(t.edt_prazo_projeto,e.format_date(!0))}else set_datepicker(t.edt_prazo_projeto,get_datepicker(t.edt_previsao_inicio))}),t.edt_previsao_inicio.unbind("blur"),t.edt_previsao_inicio.blur(function(e){setTimeout(function(){(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_datas)&&t.edt_prazo_dias.attr("disabled",!1);var e=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());e&&set_datepicker(t.edt_prazo_projeto,e.format_date(!0))},150)})),set_datepicker(t.edt_conclusao_projeto,e.conclusao),set_datepicker(t.edt_data_solicitacao_projeto,e.data_solicitacao),set_span_status_projeto(t.lbl_status,e.status),clearTimeout(this)},150),t.txt_observacoes.val(e.observacoes),t.horas_previstas=e.horas_previstas,t.renderizarComponenteHorasPrevistas(),t.edt_porcentagem.val(e.porcentagem),App.sessao.dados.admin||t.permissoes_projeto.permissao_financeiro?(e.tipo_valor_hora==TIPO_FINANCEIRO.HORA_ATIVIDADE?(t.edt_valor_hora_atividade.maskMoney("mask",parseFloat(e.valor_hora)),t.cbo_valor_previsto.selectpicker("val",e.tipo_valor_hora).trigger("refresh"),t.div_valor_hora.removeClass("hidden")):e.tipo_valor_hora==TIPO_FINANCEIRO.HORA_MANUAL&&t.cbo_valor_previsto.selectpicker("val",e.tipo_valor_hora).trigger("refresh"),t.menu_custos.removeClass("hidden"),t.menu_financeiro.removeClass("hidden"),t.menu_movimentacao_financeira.removeClass("hidden"),t.tab_custo_listagem.find(".btn_incluir_item").prop("disabled",!1),t.div_lbl_total_executores.removeClass("hidden")):(t.menu_custos.addClass("hidden"),t.menu_financeiro.addClass("hidden"),t.menu_movimentacao_financeira.addClass("hidden"),t.tab_custo_listagem.find(".btn_incluir_item").prop("disabled",!0),t.div_lbl_total_executores.addClass("hidden")),t.render_executores(),t.cbo_valor_previsto.val()!=TIPO_FINANCEIRO.HORA_MANUAL&&t.dialog.find("[template-field='edt_valor_hora']").prop("disabled",!0),t.chk_exibir_prazo_agenda.prop("checked",e.exibir_prazo_agenda),t.chk_exibir_prazo_agenda.removeClass("template_switch"),App.aplicar_checkbox(t.div_exibir_prazo_agenda),t.chk_notificar_envolvidos_email.prop("checked",e.notificar_envolvidos_email).change(),t.chk_marco.prop("checked",e.marco).change(),t.chk_cancelada.prop("checked",e.cancelada).change(),t.chk_tipo_cancelamento_ignorar_prev_real.prop("checked",e.tipo_cancelamento_ignorar_prev_real).change(),t.render_input_peso_atividade(e.porcentagem_peso)})},this.listar_apontamentos=function(){var e=t.tab_apontamentos.find("tbody").find("tr:first");WS.get("apontamento_projeto/listar/",{tipo_listagem:3,projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id},function(a){var o="000:00";t.tab_apontamentos.find(".rows").remove(),$(a).each(function(a,i){null!=i.total_horas&&(o=somar_horas(subtrair_horas(i.total_horas,i.horas_traslado),o)),function(a){var o=e.clone();o.removeAttr("template-row"),o.css("display",""),o.addClass("rows"),$(o.find("[template-field='dia']")).text(a.dia?a.dia.format_date():"");var i=$(o.find("[template-field='atividade']")),r=null;$(a.atividade).each(function(e,a){r=null==r?a.descricao:r+" / "+a.descricao}),i.text(r),"N"==t.meus_apontamentos?($(o.find("[template-field='executor']")).text(a.usuario_nome),$(".th_executor").removeClass("hidden")):($(o.find("[template-field='executor']")).addClass("hidden"),$(".th_executor").addClass("hidden"));var s=$(o.find("[template-field='total_horas']")),d=$(o.find("[template-field='cliente']")),_=$(o.find("[template-field='projeto']"));null==a.total_horas?(d.text("-"),_.text("-"),o.addClass("bg-danger"),o.find("td").addClass("bg-danger"),s.append('<span class="label label-danger"> Pendente </span>')):(d.text(a.cliente_nome),_.text(a.projeto_nome),s.text(null!=a.total_horas?subtrair_horas(a.total_horas,a.horas_traslado):""));var n=$(o.find(".btn_visualizar"));n.unbind("click"),n.click(function(){View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=t.listar,o.show(a.id,FORMULARIO.VISUALIZAR)},View.ABA.MULTIPLAS)});var l=$(o.find(".btn_editar")),c=function(){View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=t.listar,o.show(a.id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS)};l.unbind("click"),l.click(c),o.dblclick(c);var p=$(o.find(".btn_excluir"));p.unbind("click"),p.click(function(){View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=t.listar,o.show(a.id,FORMULARIO.EXCLUIR)},View.ABA.MULTIPLAS)});var u=$(o.find(".btn_gerar_os"));null==a.total_horas&&u.prop("disabled",!0),u.unbind("click"),u.click(function(){App.obter_token_publico(function(e){App.download(WS_URI+"apontamento_projeto/gerar_os/?&empresa_filial_id="+App.temp.empresa+"&apontamento_id="+a.id+"&token_publico="+e)})}),o.appendTo(t.tab_apontamentos)}(i)}),$(t.tab_apontamentos.find("[template-field='total_geral_horas']")).text(format_time(o)),t.total_geral_horas.text(o&&"000:00"!=o?format_time(o):"000:00")},null,null,null,null,null,t.html_id)},this.listar_atividades_predecessoras=function(){t.dataGrid=dx_Listagem_Padrao({div_html:t.dx_listagem_atividades_predecessoras,coluna_chave:"id",colunas:dx_Atividade_Projeto_Colunas(t),toolbar:[dx_Atividade_Projeto_Btn_Novo(t,a)],datasource:t.arr_atividades_predecessoras,nome:this.title,nome_parametro_usuario:"listagem_atividade_analitica_predecessora",editing_mode:dx_Atividade_Projeto_Editing_Mode(),on_row_prepared:function(e){"data"===e.rowType&&setTimeout(function(){var a=t.dataGrid.getCellElement(e.rowIndex,"status");a.text().trim().length&&a.html('<span class="label '+str_cor_status(str_identifica_status(e.data.inicio,e.data.prazo,e.data.conclusao,void 0,e.data.cancelada))+'">'+a.text().trim()+"</span>")})},on_editing_start:function(e){"tipo"!==e.column.dataField&&(e.cancel=!0)},on_editor_preparing:dx_Atividade_Projeto_On_Editor_Preparing(t)})},this.salvar_atividade=function(e,a){for(var o=0,i="",r=0;r<t.arr_executores.length;r++)"N"==(s=t.arr_executores[r]).excluido&&(o=parseFloat(s.valor_previsto+o).toFixed(2));for(r=0;r<t.arr_grupo_executores.length;r++){var s;"N"==(s=t.arr_grupo_executores[r]).excluido&&(o=parseFloat(s.valor_previsto+o).toFixed(2))}for(r=0;r<t.dataGrid.getController("editing").getChanges().length;r++){var d=t.dataGrid.getController("editing").getChanges()[r];const e=d.data||d.key;e.tipo||(i+="<li>"+(e.atividade_simplificada||e.atividade_simplificada)+"</li>")}""!=i?alert_modal(App.lang.modal_validacao.validacao,"Informe um tipo de Atividade predecessora para a(s) atividade(s) abaixo: <br/>"+i):function(e,a){if(!t.input_peso_atividade.option("isValid"))return window.alertaPopUp("Validação","Ajuste o valor da <strong>Porcentagem de Peso da Atividade</strong> antes de salvar as alterações."),!1;WS.post("atividade_projeto/salvar",{projeto_id:t.projeto_id,atividade_projeto_id:t.projeto_atividade_id,codigo:t.edt_codigo_projeto.val(),atividade:get_tinymce(t.txt_atividades),nome_atividade:t.edt_nome_atividade.val(),assunto_projetos_id:t.cbo_assunto_projeto.val(),consultor_id:t.cbo_consultor_projeto.val(),responsavel_id:t.cbo_responsavel_projeto.val(),tipo_previsao_inicio:t.cbo_tipo_previsao_inicio.val(),previsao_inicio:get_datepicker(t.edt_previsao_inicio),inicio:get_datepicker(t.edt_inicio_projeto),prazo:get_datepicker(t.edt_prazo_projeto),conclusao:get_datepicker(t.edt_conclusao_projeto),observacoes:t.txt_observacoes.val(),data_solicitacao:get_datepicker(t.edt_data_solicitacao_projeto),porcentagem:parseInt(t.edt_porcentagem.val(),10)>100?100:t.edt_porcentagem.val(),arr_atividades_predecessoras:t.dataGrid.getController("editing").getChanges().length?CircularJSON.stringify(t.dataGrid.getController("editing").getChanges()):null,notificar_envolvidos_email:t.chk_notificar_envolvidos_email.prop("checked"),projeto_atividade_sintetica_pai_id:t.cbo_atividade_sinteticas.val(),arr_executores:JSON.stringify(t.arr_executores),arr_grupo_executores:JSON.stringify(t.arr_grupo_executores),classificacao_projeto_atividade_id:t.cbo_classificacao.val(),valor_hora:t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_ATIVIDADE?parseFloat($(t.edt_valor_hora_atividade).maskMoney("unmasked")[0]):0,horas_previstas:t.horas_previstas,valor_previsto:o,exibir_prazo_agenda:t.chk_exibir_prazo_agenda.prop("checked"),tipo_valor_hora:t.cbo_valor_previsto.val(),prazo_dias:t.edt_prazo_dias.val()||0,tabela_custos:JSON.stringify(t.getItems()),marco:t.chk_marco.prop("checked"),cancelada:t.chk_cancelada.prop("checked"),tipo_cancelamento_ignorar_prev_real:t.chk_tipo_cancelamento_ignorar_prev_real.prop("checked"),projeto_calendario_trabalho_id:t.projeto_calendario_trabalho_id,porcentagem_peso:t.input_peso_atividade.instance().option("value"),arr_movimentacao_financeira:t.instanceMovimentacaoFinanceira&&t.instanceMovimentacaoFinanceira.getController("editing").getChanges()?CircularJSON.stringify(t.instanceMovimentacaoFinanceira.getController("editing").getChanges()):null},function(o){alert_saved("Atividade salva com sucesso"),t.projeto_atividade_id>0&&1==e?t.unload():(t.menu_executores.removeClass("hidden"),t.btn_confirmar.removeClass("list-group-item-warning"),t.btn_apontamento.removeClass("hidden"),t.collapse_accordion.removeClass("hidden"),t.menu_mobile.removeClass("hidden"),t.div_check_email.removeClass("hidden"),t.menu_atividade_prdecessoras.removeClass("hidden"),t.menu_apontamentos.removeClass("hidden"),t.menu_tarefas.removeClass("hidden"),t.menu_referencias.removeClass("hidden"),(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_financeiro)&&(t.permissoes_projeto.permissao_financeiro&&(t.menu_financeiro.removeClass("hidden"),t.menu_movimentacao_financeira.removeClass("hidden")),t.div_lbl_total_executores.removeClass("hidden")),t.projeto_atividade_id=o.id,t.preencher()),t.projeto_atividade_id=o.id,t.tipo_formulario=FORMULARIO.EDITAR,a&&null!=a&&a()},[t.btn_confirmar,t.btn_cancelar])}(e,a)},this.btn_novo_assunto.unbind("click"),this.btn_novo_assunto.click(function(){View.load("assunto_projeto/detalhes",function(e,a){a.onclose=function(){t.listar_assunto(a.assunto_projeto_id)},a.show(null,FORMULARIO.NOVO)})}),this.btn_visualizar_assunto.unbind("click"),this.btn_visualizar_assunto.click(function(){t.cbo_assunto_projeto.val()>0&&View.load("assunto_projeto/detalhes",function(e,a){a.show(t.cbo_assunto_projeto.val(),FORMULARIO.VISUALIZAR)})}),this.btn_refresh_apontamentos.unbind("click"),this.btn_refresh_apontamentos.click(function(){t.listar_apontamentos()}),this.cbo_tipo_previsao_inicio.unbind("change").change(function(){switch(parseInt(t.cbo_tipo_previsao_inicio.val(),10)){case TIPO_PREVISAO_INICIO.DEVE_INICIAR_EM:t.possui_executor_previsao_inicio||t.edt_previsao_inicio.prop("readonly",!1),t.edt_prazo_dias.prop("readonly",!1),t.edt_prazo_projeto.prop("readonly",!1);break;default:if(t.tipo_previsao_inicio==TIPO_PREVISAO_INICIO.O_MAIS_BREVE_POSSIVEL){var e=get_datepicker(t.edt_previsao_inicio),a=get_datepicker(t.edt_prazo_projeto);null!=e&&""!=e&&null!=t.previsao_inicio&&""!=t.previsao_inicio&&e!=t.previsao_inicio?set_datepicker(t.edt_previsao_inicio,t.previsao_inicio):set_datepicker(t.edt_previsao_inicio,""),null!=a&&""!=a&&null!=t.prazo&&""!=t.prazo&&a!=t.prazo&&set_datepicker(t.edt_prazo_projeto,t.prazo)}t.edt_previsao_inicio.prop("readonly",!0),t.edt_prazo_dias.prop("readonly",!0),t.edt_prazo_projeto.prop("readonly",!0)}}),this.edt_inicio_projeto.unbind("change"),this.edt_inicio_projeto.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e),t.sugerir_previsao_inicio_atividade()}),this.edt_prazo_projeto.unbind("change"),this.edt_prazo_projeto.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e)}),this.edt_conclusao_projeto.unbind("change"),this.edt_conclusao_projeto.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e)}),this.edt_conclusao_projeto.unbind("blur"),this.edt_conclusao_projeto.blur(function(){if(""!=t.edt_conclusao_projeto.val()&&null!=t.edt_conclusao_projeto.val()&&"100"!=t.edt_porcentagem.val()){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Você está informando que a atividade está concluída.<br>Deseja alterar o "% Conclusão" para 100%?')),alert_modal("Validação",e,"Sim",function(){t.edt_porcentagem.val("100")},!0,"Não")}}),this.edt_porcentagem.unbind("blur"),this.edt_porcentagem.blur(function(){if("100"==t.edt_porcentagem.val()){if(null==t.edt_conclusao_projeto.val()||""==t.edt_conclusao_projeto.val().trim()){var e=new Date;e=e.getFullYear().toString()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2),set_datepicker(t.edt_conclusao_projeto,e)}}else t.edt_conclusao_projeto.val("")}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){t.unload()}),this.btn_apontamento.unbind("click"),this.btn_apontamento.click(function(){t.status_projeto==PROJETO_STATUS.CONCLUIDO&&"S"!=t.permitir_apontamento_projeto_concluido||t.salvar_atividade(!1,function(){View.load("apontamento_projeto/detalhes",function(e,a){var o={projeto_id:t.projeto_id,cliente_id:t.cliente_id,cliente_nome:t.cliente_nome,projeto_atividade_id:t.projeto_atividade_id,projeto_nome:t.lbl_projeto_nome.text()};a.show(o),a.onclose=function(){t.listar_apontamentos()}},View.ABA.MULTIPLAS)})}),$(document).scroll(function(){t.floating.css("top",$(this).scrollTop())}),this.atualizar_data_prazo=function(){t.sugerir_data_prazo&&WS.get("agenda_evento/get_last_evento_agenda/",{id:t.projeto_atividade_id},function(e){var a=e[0].dia;t.edt_prazo_projeto.val(a)})},this.edt_previsao_inicio.unbind("blur").blur(function(e){if(null!=this.value&&""!=this.value)if(App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto||t.permissoes_projeto.permissao_datas){if(t.edt_prazo_dias.attr("disabled",!1),""!==t.edt_prazo_dias.val()){var a=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());a&&set_datepicker(t.edt_prazo_projeto,a.format_date(!0))}}else t.edt_prazo_dias.attr("disabled",!0)}),this.edt_prazo_dias.unbind("change").change(function(e){if(""!==t.edt_prazo_dias.val()){var a=fn_dias_uteis(t.projeto_calendario_trabalho_id,get_datepicker(t.edt_previsao_inicio),t.edt_prazo_dias.val());a&&(set_datepicker(t.edt_prazo_projeto,a.format_date(!0)),t.edt_prazo_projeto.attr("disabled",!0))}else t.edt_prazo_projeto.attr("disabled",!1)}),this.edt_prazo_dias.unbind("keypress").keypress(function(e){(this.value.length>=6||null!=e.key.match(/[^\d]/g)&&e.key.match(/[^\d]/g).length>0)&&e.preventDefault()}),this.add_custo=function(e){t.render_items(e)},this.btn_incluir_item.unbind("click").click(function(){t.add_custo({item_id:null,custo_unitario_orcado:0,custo_unitario_real:0,venda_unitaria:0,total_custo_orcado:0,total_custo_real:0,total_venda:0,quantidade:0,disabled:t.tipo_formulario==FORMULARIO.VISUALIZAR||t.tipo_formulario==FORMULARIO.EXCLUIR})}),this.listar_item=function(e,a,o){var i={item_descricao:a.parent().find(".edt_combobox").val(),limite:0,filtrar_por_codigo_ou_nome:!0,modulo_projeto:!0};WS.get("itens/listar/",i,function(e){limpar_combobox(a),e.map(function(e,o){var i=[];i["Código"]=null==e.codigo||""==e.codigo?" ":e.codigo,i["Descrição"]=e.descricao,add_option_combobox(a,o,e.item_id,i,null,null,"col2")})}),e(!0)},this.getItems=function(){var e=[];return t.tab_custo_listagem.find("tr.row_item:not([template-row])").map(function(a,o){var i=$(o).find('[template-field="cbo_item"]'),t=$(o).find('[template-field="edt_quantidade"]'),r=$(o).find('[template-field="edt_custo_unitario_orcado"]'),s=$(o).find('[template-field="edt_custo_unitario_real"]'),d=$(o).find('[template-field="edt_venda_unitaria"]'),_=$(o).find('[template-field="edt_vencimento_pagamento"]'),n=$(o).find('[template-field="realizado"]'),l=$(o).find('[template-field="edt_total_custo_orcado"]'),c=$(o).find('[template-field="edt_total_custo_real"]'),p=$(o).find('[template-field="edt_total_venda"]'),u={item_id:+$(i).next().find("input").attr("selected-value")||null,quantidade:+t.val().replace(".","").replace(",",".")||0,custo_unitario_orcado:+r.val().replace(".","").replace(",",".")||0,custo_unitario_real:+s.val().replace(".","").replace(",",".")||0,venda_unitaria:+d.val().replace(".","").replace(",",".")||0,vencimento_pagamento:_.val()||null,realizado:n.prop("checked"),total_custo_orcado:+l.val().replace(".","").replace(",",".")||0,total_custo_real:+c.val().replace(".","").replace(",",".")||0,total_venda:+p.val().replace(".","").replace(",",".")||0};e.push(u)}),e},this.calcular_percentual=function(){var e=t.arr_tarefas.length,a=100*t.arr_tarefas.reduce(function(e,a){return a.realizado?e+1:e},0)/e;t.edt_porcentagem.val(a.toFixed(2)),t.arr_tarefas.length>0?t.edt_porcentagem.addClass("disabled").attr("disabled","disabled").blur():t.edt_porcentagem.removeClass("disabled").removeAttr("disabled").blur(),t.edt_conclusao_projeto.change()},this.render_items=function(e){var a=t.tab_custo_listagem.find("[template-row]").clone();a.attr("style",""),a.removeAttr("template-row"),a.addClass("row_item"),a.find('[template-field="realizado"]').removeClass("template_switch"),App.aplicar_checkbox(a);var o=a.find('[template-field="cbo_item"]');create_combobox(o,t.listar_item,"col2"),set_value_combobox(o,e.item_id,e.item_descricao);var i=a.find('[template-field="edt_quantidade"]'),r=a.find('[template-field="edt_custo_unitario_orcado"]'),s=a.find('[template-field="edt_total_custo_orcado"]'),d=a.find('[template-field="edt_custo_unitario_real"]'),_=a.find('[template-field="edt_total_custo_real"]'),n=a.find('[template-field="edt_venda_unitaria"]'),l=a.find('[template-field="edt_total_venda"]'),c=a.find('[template-field="realizado"]'),p=a.find('[template-field="edt_vencimento_pagamento"]'),u=a.find(".btn_deletar_item");r.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),s.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),_.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),d.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),n.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),l.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),void 0!==e.disabled&&e.disabled&&(o.parent().find("button").addClass("disabled").attr("disabled","disabled"),o.parent().find("input").addClass("disabled").attr("disabled","disabled"),r.addClass("disabled").attr("disabled","disabled"),d.addClass("disabled").attr("disabled","disabled"),n.addClass("disabled").attr("disabled","disabled"),p.addClass("disabled").attr("disabled","disabled"),i.addClass("disabled").attr("disabled","disabled"),c.addClass("disabled").attr("disabled","disabled"),u.addClass("hidden"));var v=$.debounce(300,function(){var e=((parseFloat(i.val().replace(",","."))||0)*(+r.val().replace(".","").replace(",",".")||0)).toFixed(2);s.val(e).maskMoney("mask")}),m=$.debounce(300,function(){var e=((parseFloat(i.val().replace(",","."))||0)*(+d.val().replace(".","").replace(",",".")||0)).toFixed(2);_.val(e).maskMoney("mask")}),h=$.debounce(300,function(){var e=((parseFloat(i.val().replace(",","."))||0)*(+n.val().replace(".","").replace(",",".")||0)).toFixed(2);l.val(e).maskMoney("mask")});i.unbind("keyup").keyup(v).keyup(m).keyup(h),r.unbind("keyup").keyup(v),d.unbind("keyup").keyup(m),n.unbind("keyup").keyup(h),u.unbind("click").click(function(){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja remover o item?")),alert_modal("Atenção",e,"Remover",function(){a.remove()},!0)}),r.val(e.custo_unitario_orcado).maskMoney("mask"),d.val(e.custo_unitario_real).maskMoney("mask"),n.val(e.venda_unitaria).maskMoney("mask"),i.val(parseFloat(e.quantidade).toFixed(2)).maskMoney("mask"),s.val(parseFloat(e.total_custo_orcado).toFixed(2)).maskMoney("mask"),_.val(parseFloat(e.total_custo_real).toFixed(2)).maskMoney("mask"),l.val(parseFloat(e.total_venda).toFixed(2)).maskMoney("mask"),p.val(e.vencimento_pagamento),c.prop("checked","S"===e.realizado).change(),a.appendTo(t.tab_custo_listagem)},this.add_tarefa=function(e){WS.post("/tarefa/salvar",{projeto_atividade_id:t.projeto_atividade_id,descricao:e.descricao,data_conclusao:e.data_conclusao},function(a){alert_saved(e.descricao.substring(0,30)+" salvo com sucesso"),t.carregar_tarefas(function(){t.calcular_percentual()})})},this.btn_incluir_tarefa.unbind("click").click(function(){""!=t.edt_nova_tarefa.val().trim()&&t.edt_nova_tarefa.val().length>0&&(t.add_tarefa({descricao:t.edt_nova_tarefa.val(),realizado:!1,data_conclusao:get_datepicker(t.edt_tarefa_data_conclusao),disabled:t.tabela_tarefa_config.disabled}),t.edt_nova_tarefa.val(""),set_datepicker(t.edt_tarefa_data_conclusao,""))}),this.edt_nova_tarefa.unbind("keyup").keyup(function(e){e.which==KEYPRESS_PADRAO.ENTER&&(""!=t.edt_nova_tarefa.val().trim()&&t.edt_nova_tarefa.val().length>0&&(null!=t.tarefa_atual?t.atualizar_tarefa():t.add_tarefa({descricao:t.edt_nova_tarefa.val(),realizado:!1,data_conclusao:get_datepicker(t.edt_tarefa_data_conclusao),disabled:t.tabela_tarefa_config.disabled})),t.edt_nova_tarefa.val(""))}),this.selecionar_tarefa=function(e,a){t.edt_nova_tarefa.val(e.descricao).focus(),set_datepicker(t.edt_tarefa_data_conclusao,e.data_conclusao),t.btn_incluir_tarefa.addClass("hidden"),t.btn_cancelar_edicao_tarefa.removeClass("hidden"),t.btn_editar_tarefa.removeClass("hidden"),t.tarefa_atual=e,set_focus(t.edt_nova_tarefa)},this.limpar_selecao_tarefa=function(){t.edt_nova_tarefa.val(""),set_datepicker(t.edt_tarefa_data_conclusao,""),t.btn_incluir_tarefa.removeClass("hidden"),t.btn_cancelar_edicao_tarefa.addClass("hidden"),t.btn_editar_tarefa.addClass("hidden"),t.tarefa_atual=null,set_focus(t.edt_nova_tarefa)},this.atualizar_tarefa=function(){var e=t.edt_nova_tarefa.val();t.tarefa_atual.descricao=e;var a=get_datepicker(t.edt_tarefa_data_conclusao);t.tarefa_atual.data_conclusao=a,WS.post("/tarefa/salvar",{projeto_atividade_id:t.projeto_atividade_id,descricao:t.tarefa_atual.descricao,data_conclusao:t.tarefa_atual.data_conclusao,id:t.tarefa_atual.id},function(e){alert_saved(t.tarefa_atual.descricao.substring(0,30)+" alterado com sucesso"),t.carregar_tarefas(function(){t.calcular_percentual()}),t.limpar_selecao_tarefa()})},this.render_tarefas=function(){var e=function(e){var a=$.Tabela_Padrao_Next.create_row(t.tab_tarefas);a.attr("data-id",e.id);var o=$.Tabela_Padrao_Next.getColumn(a,"descricao"),i=$.Tabela_Padrao_Next.getColumn(a,"realizado"),r=$.Tabela_Padrao_Next.getColumn(a,"data_conclusao"),s=$.Tabela_Padrao_Next.getColumn(a,"btn_editar"),d=$.Tabela_Padrao_Next.getColumn(a,"btn_remover");o.addClass("tarefas-row"),i.find("input").removeClass("template_switch").prop("checked",e.realizado).change();var _=i.find("input").prop("checked");o.text(e.descricao),o.attr("data-realizado",_),r.text(e.data_conclusao?e.data_conclusao.format_date():""),App.aplicar_checkbox(i),e.pode_marcar?i.find("input").change(function(){_=$(i).find("input").prop("checked"),o.attr("data-realizado",_),WS.post("/tarefa/marcar",{id:e.id,realizado:_,atividade_projeto_id:t.projeto_atividade_id,projeto_apontamento_por:t.projeto_apontamento_por},function(a){t.arr_tarefas.map(function(a){return a.id==e.id&&(a.realizado=_),a}),alert_saved(e.descricao.substring(0,30)+(_?" Realizado":" Não Realizado")),t.carregar_tarefas(function(){t.calcular_percentual()})})}):(i.find("input").unbind("change"),i.find("input").prop("disabled",!0)),e.disabled?(s.addClass("disabled").attr("disabled","disabled"),d.addClass("disabled").attr("disabled","disabled")):(s.click(function(){e.row=$.Tabela_Padrao_Next.Rows.getIndex(a),function(e){t.selecionar_tarefa(e)}(e)}),d.click(function(){$(this);var a=new Validation;a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja remover a tarefa?")),alert_modal("Atenção",a,"Remover",function(){WS.post("tarefa/excluir/",{id:e.id},function(){alert_saved(e.descricao.substring(0,30)+" excluido com sucesso"),t.carregar_tarefas(function(){t.calcular_percentual()}),set_focus(t.edt_nova_tarefa)})},!0)})),$.Tabela_Padrao_Next.RenderRow(t.tab_tarefas,a)};t.arr_tarefas.map(function(a){e(a)})},this.btn_cancelar_edicao_tarefa.click(function(){t.limpar_selecao_tarefa()}),this.btn_editar_tarefa.click(function(){t.atualizar_tarefa()}),this.limpar_tarefa=function(){$.Tabela_Padrao_Next.clear(t.tab_tarefas)},this.limpar_custos=function(){t.tab_custo_listagem.find("tbody tr:not([template-row])").remove()},this.btn_recarregar_tarefa.unbind("click").click(function(){t.carregar_tarefas(function(){t.calcular_percentual()})}),this.menu_referencias.unbind("click").click(function(){t.menu_referencias.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(t.div_componente_referencias[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"projeto_atividade",id:t.projeto_atividade_id,documentoPastaId:t.documento_pasta_id}),t.div_componente_referencias[0]))}),this.setTaskDisable=function(e){e?(t.btn_incluir_tarefa.addClass("disabled").attr("disabled","disabled"),t.tabela_tarefa_config.disabled=!0,t.edt_nova_tarefa.addClass("disabled").attr("disabled","disabled"),t.edt_tarefa_data_conclusao.addClass("disabled").attr("disabled","disabled"),$(t.tab_tarefas.tabela).find(".sortable").sortable("disable")):($(t.tab_tarefas.tabela).find(".sortable").sortable("enable"),t.btn_incluir_tarefa.removeClass("disabled").removeAttr("disabled"),t.tabela_tarefa_config.disabled=!1,t.edt_nova_tarefa.removeClass("disabled").removeAttr("disabled"),t.edt_tarefa_data_conclusao.removeClass("disabled").removeAttr("disabled"))},this.carregar_tarefas=function(e){WS.get("tarefa/listar/",{projeto_atividade_id:t.projeto_atividade_id},function(a){a.length>0?t.edt_porcentagem.addClass("disabled").attr("disabled","disabled").blur():t.edt_porcentagem.removeClass("disabled").removeAttr("disabled").blur(),t.limpar_tarefa();var o=t.arr_executores.filter(function(e){return e.id==App.sessao.dados.usuario_id}).length>0;t.arr_tarefas=a.map(function(e){return e.pode_marcar=t.projeto_apontamento_por==APONTAMENTO_POR.QUALQUER||t.projeto_apontamento_por==APONTAMENTO_POR.EXECUTOR&&o||App.sessao.dados.admin||t.permissoes_projeto.gerente_projeto,e.disabled=t.tipo_formulario==FORMULARIO.VISUALIZAR||t.tipo_formulario==FORMULARIO.EXCLUIR||t.tabela_tarefa_config.disabled,e}),t.render_tarefas(),void 0!==e&&null!=e&&e()})},this.render_input_peso_atividade=function(e=0){t.utiliza_peso_atividades&&t.div_porcentagem_peso_atividade.removeClass("hidden"),t.input_peso_atividade=t.dx_peso_atividade.dxNumberBox({value:e,min:0,max:100,showSpinButtons:!0,disabled:!App.sessao.dados.admin&&!t.permissoes_projeto.gerente_projeto&&!t.permissoes_projeto.permissao_atividade}).dxNumberBox("instance")},this.render_dx_selecao_executores=function(){ReactDOM.render(React.createElement(window.components.SelecaoProjetoAtividadeExecutor.default,{projeto_id:t.projeto_id,aoIniciarComponente:e=>{e.dropDownBoxRef.current&&(t.executoresDropDownBoxRef=e.dropDownBoxRef.current.instance)},aoConfirmarSelecao:(e,a)=>{let o=e.getSelectedRowKeys(),i=e.getSelectedRowsData();if(o.length)e:for(let e=0;e<o.length;e++){let r=o[e],s=i.filter(e=>e.chave==r)[0];if("usuario"==s.tipo_executor){if(t.arr_executores.filter(e=>e.id==s.usuario_id&&"N"==e.excluido).length)continue e}else if("grupo_usuarios"==s.tipo_executor&&t.arr_grupo_executores.filter(e=>e.id==s.grupo_usuarios_id&&"N"==e.excluido).length)continue e;let d={id:Number(s.usuario_id)>0?s.usuario_id:s.grupo_usuarios_id,nome:s.nome,tipo:s.tipo_executor,valor_hora:t.cbo_valor_previsto.val()==TIPO_FINANCEIRO.HORA_MANUAL?0:s.valor_projeto,previsao_inicio:null,horas_previstas:null,valor_previsto:null,excluido:"N"};t.render_executores(d),a.close()}}}),t.dx_selecao_executores[0])},this.lbl_tab_predecessora.unbind("click").click(function(){t.lbl_tab_predecessora.hasClass("active")||t.dataGrid.getController("editing").getChanges().length||t.listar_atividades_predecessoras()}),this.chk_cancelada.unbind("change"),this.chk_cancelada.change(function(){var e=str_identifica_status(get_datepicker(t.edt_inicio_projeto),get_datepicker(t.edt_prazo_projeto),get_datepicker(t.edt_conclusao_projeto),void 0,t.chk_cancelada.prop("checked"));set_span_status_projeto(t.lbl_status,e)}),this.lbl_tab_movimentacao_financeira.off("click").on("click",function(e){App.sessao.dados.admin||t.permissoes_projeto.permissao_financeiro?t.renderizarComponenteMovimentacaoFinanceira():e.stopPropagation()})}});