define([],function(){return function(t){"use strict";var a=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.title="Apontamento Atividade",this.dx_listagem_apontamentos=this.dialog.find(".dx_listagem_apontamentos"),this.div_dt_ini=this.dialog.find(".div_dt_ini"),this.div_dt_fim=this.dialog.find(".div_dt_fim"),this.dt_ini=null,this.dt_fim=null;var e=App.get_parametro_usuario("listagem_apontamentos");this.tipo_listagem=e&&e.tipo_listagem?e.tipo_listagem:APONTAMENTO_FILTROS.MEUS_APONTAMENTOS,this.clearState=!1,this.show=function(){var t=new Date;t.setDate(1);var e=pad(t.getMonth()+1,2),o=t.getFullYear(),i=new Date(o,e,1),n=new Date(o,e,0);a.dt_ini=o+"-"+e+"-"+pad(i.getDate(),2),a.dt_fim=o+"-"+e+"-"+pad(n.getDate(),2);var l=function(){a.dt_ini&&a.dt_fim&&a.listar()},s=a.div_dt_ini.dxDateBox({type:"date",showClearButton:!0,displayFormat:"dd/MM/yyyy",value:a.dt_ini,width:"100%",onValueChanged:function(t){d.option("min",t.value),a.dt_ini=formatDate(t.value,!0),l()}}).dxDateBox("instance"),d=a.div_dt_fim.dxDateBox({type:"date",showClearButton:!0,displayFormat:"dd/MM/yyyy",value:a.dt_fim,width:"100%",onValueChanged:function(t){s.option("max",t.value),a.dt_fim=formatDate(t.value,!0),l()}}).dxDateBox("instance");setTimeout(function(){s.option("max",a.dt_fim),d.option("min",a.dt_ini)}),a.listar()},this.listar=function(){var t={tipo_listagem:a.tipo_listagem,data_inicio:a.dt_ini,data_fim:a.dt_fim};WS.get("apontamento_projeto/listar/",t,function(t){a.preencher(t)})},this.preencher=function(t){var e=document.createElement("div");e.className="div_listagem_apontamentos",e.style="min-width: 100%;",a.dx_listagem_apontamentos.find(".div_listagem_apontamentos").remove(),a.dx_listagem_apontamentos[0].appendChild(e);var o=detectmob()?"select":"dragAndDrop",i=get_icon_class();a.dx_listagem_apontamentos.find(".div_listagem_apontamentos").css("height","calc(100vh - 82px)"),a.dx_listagem_apontamentos.find(".div_listagem_apontamentos").dxDataGrid({dataSource:t,showBorders:!0,columnResizingMode:"widget",rowAlternationEnabled:!1,grouping:{autoExpandAll:!0},searchPanel:{visible:!detectmob(),width:200,placeholder:"Pesquisa geral"},paging:{pageSize:20},pager:{showPageSizeSelector:!0,allowedPageSizes:[20,50,100],showInfo:!0},allowColumnReordering:!0,allowColumnResizing:!0,columnChooser:{enabled:!0,allowSearch:!0,mode:o},columnFixing:{enabled:!0},stateStoring:{enabled:!0,type:"custom",customLoad:function(){return App.get_parametro_usuario("listagem_apontamentos")},customSave:function(t){App.set_parametro_usuario("listagem_apontamentos",t)}},selection:{mode:"multiple"},export:{enabled:!0,fileName:"Relatório de apontamentos "+agora(),allowExportSelectedData:!0},filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},filterPanel:{visible:!0},sorting:{mode:"multiple"},groupPanel:{visible:!0},onToolbarPreparing:function(t){var e=[{widget:"dxButton",options:{icon:"fa fa-plus",hint:"Novo apontamento",text:"Novo apontamento",onClick:function(){View.load("apontamento_projeto/detalhes",function(t,e){e.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},e.show(null,FORMULARIO.NOVO)},View.ABA.MULTIPLAS)}},location:"after",name:"BtnNovoApontamento",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-plus",hint:"Novo apontamento múltiplo",text:"Novo apontamento múltiplo",onClick:function(){View.load("apontamento_projeto/multiplo_detalhes",function(t,e){e.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},e.show(null,FORMULARIO.NOVO)},View.ABA.MULTIPLAS)}},location:"after",name:"BtnNovoApontamentoMultiplo",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fas fa-external-link-alt",hint:"Apontamento Simples",text:"Apontamento Simples",onClick:function(){View.loadReact(window.views.apontamento_simples.Listagem.default,{},t=>{},View.ABA.SIM)}},location:"after",name:"BtnApontamentoSimples",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-sync",hint:"Recarregar listagem de apontamentos",text:"Recarregar listagem de apontamentos",onClick:function(){a.listar()}},showText:"inMenu",location:"after",name:"BtnRefresh",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fas fa-expand-alt",hint:"Expandir apontamentos",text:"Expandir apontamentos",onClick:function(){a.dx_listagem_apontamentos.find(".div_listagem_apontamentos").dxDataGrid("instance").expandAll()}},showText:"inMenu",location:"after",name:"BtnExpand",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fas fa-compress-alt",hint:"Recolher apontamentos",text:"Recolher apontamentos",onClick:function(){a.dx_listagem_apontamentos.find(".div_listagem_apontamentos").dxDataGrid("instance").collapseAll()}},showText:"inMenu",location:"after",name:"BtnCollapse",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-cog",hint:"Configurar preferências",text:"Configurar preferências",onClick:function(){View.load("apontamento_projeto/configuracoes",function(t,e){e.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},e.show()})},visible:App.verifica_permissao(App.sessao.dados.empresa_filial_id,"admin_apontamento_atividade")||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"config_modulo_projetos")},showText:"inMenu",location:"after",name:"BtnConfiguracoes",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-user",hint:"Listar meus apontamentos",text:"Listar meus apontamentos",onClick:function(){a.tipo_listagem=APONTAMENTO_FILTROS.MEUS_APONTAMENTOS,App.set_parametro_usuario("listagem_apontamentos",{tipo_listagem:a.tipo_listagem}),a.listar()},onInitialized:function(t){+a.tipo_listagem==APONTAMENTO_FILTROS.MEUS_APONTAMENTOS&&t.component.element().addClass("dx-state-active")}},showText:"inMenu",location:"after",name:"BtnMeusApontamentos",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-users",hint:"Listar apontamentos de usuários supervisionados",text:"Listar apontamentos de usuários supervisionados",onClick:function(){a.tipo_listagem=APONTAMENTO_FILTROS.SUPERVISIONADOS,App.set_parametro_usuario("listagem_apontamentos",{tipo_listagem:a.tipo_listagem}),a.listar()},onInitialized:function(t){+a.tipo_listagem==APONTAMENTO_FILTROS.SUPERVISIONADOS&&t.component.element().addClass("dx-state-active")},visible:"S"==App.sessao.dados.supervisor_projeto},showText:"inMenu",location:"after",name:"BtnSupervisionados",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-users",hint:"Listar apontamentos de todos usuários",text:"Listar apontamentos de todos usuários",onClick:function(){a.tipo_listagem=APONTAMENTO_FILTROS.TODOS,App.set_parametro_usuario("listagem_apontamentos",{tipo_listagem:a.tipo_listagem}),a.listar()},onInitialized:function(t){+a.tipo_listagem==APONTAMENTO_FILTROS.TODOS&&t.component.element().addClass("dx-state-active")},visible:App.verifica_permissao(App.sessao.dados.empresa_filial_id,"admin_apontamento_atividade")},showText:"inMenu",location:"after",name:"BtnTodos",locateInMenu:"auto"}];t.toolbarOptions.items=add_botao_dx_toolbar(e,t.toolbarOptions.items)},columns:[{dataField:"id",caption:"#",dataType:"number",width:50},{dataField:"dia",dataType:"date",format:"dd/MM/yyyy",groupIndex:0,sortOrder:"desc"},{dataField:"cliente_nome",caption:"Cliente"},{dataField:"projeto_nome",caption:"Projeto"},{dataField:"atividade_descricao",caption:"Descrição",calculateCellValue:function(t){var a="";if(void 0!==t.atividade)for(var e=0;e<t.atividade.length;e++){var o=t.atividade[e];a+=a?" / "+o.descricao:o.descricao}return a}},{dataField:"nome_atividade",caption:"Atividade",calculateCellValue:function(t){var a="";if(void 0!==t.atividade)for(var e=0;e<t.atividade.length;e++){var o=t.atividade[e];a+=a?" / "+o.atividade_simplificada:o.atividade_simplificada}return a}},{dataField:"usuario_nome",caption:"Executor"},{dataField:"hora_inicial",calculateCellValue:function(t){return t.hora_inicial?t.hora_inicial.substring(0,5):"00:00"},width:100},{dataField:"hora_final",calculateCellValue:function(t){return t.hora_final?t.hora_final.substring(0,5):"00:00"},width:100},{dataField:"intervalo_inicial",calculateCellValue:function(t){return t.intervalo_inicial?t.intervalo_inicial.substring(0,5):"00:00"},width:100},{dataField:"intervalo_final",calculateCellValue:function(t){return t.intervalo_final?t.intervalo_final.substring(0,5):"00:00"},width:100},{dataField:"horas_traslado",calculateCellValue:function(t){return t.horas_traslado?t.horas_traslado.substring(0,5):"00:00"},width:100},{dataField:"subtotal",calculateCellValue:function(t){var a=subtrair_horas(t.total_horas,t.horas_traslado);return a?a.substring(0,5):"00:00"},width:100},{dataField:"total_horas",calculateCellValue:function(t){return t.total_horas?t.total_horas.substring(0,5):"00:00"},width:100},{dataField:"chamado_id",caption:"Nº Chamado",dataType:"number",width:120},{dataField:"chamado_entidade_nome",caption:"Chamado Entidade",dataType:"string",width:180},{type:"buttons",buttons:[{hint:"Visualizar apontamento",icon:"fa fa-eye",cssClass:i,onClick:function(t){View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},o.show(t.row.data.id,FORMULARIO.VISUALIZAR)},View.ABA.MULTIPLAS),t.event.preventDefault()}},{hint:"Editar apontamento",icon:"fa fa-pencil-alt",cssClass:i,onClick:function(t){View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},o.show(t.row.data.id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS),t.event.preventDefault()}},{hint:"Relatório de ordem de serviço",icon:"fa fa-file-pdf",cssClass:i,visible:function(t){return t.row.data.total_horas},onClick:function(t){App.obter_token_publico(function(a){App.download(WS_URI+"apontamento_projeto/gerar_os/?&empresa_filial_id="+App.temp.empresa+"&apontamento_id="+t.row.data.id+"&token_publico="+a)}),t.event.preventDefault()}},{hint:"Excluir apontamento",icon:"fa fa-trash",cssClass:i,onClick:function(t){View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},o.show(t.row.data.id,FORMULARIO.EXCLUIR)},View.ABA.MULTIPLAS),t.event.preventDefault()}}]}],onRowClick:function(t){var e=t.component;function o(){e.clickCount=1,e.clickKey=t.key,e.clickDate=new Date}e.clickCount&&1==e.clickCount&&e.clickKey==t.key?e.clickKey==t.key&&(new Date-e.clickDate<=300?(e.clickCount=0,e.clickKey=0,e.clickDate=null,View.load("apontamento_projeto/detalhes",function(e,o){o.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},o.show(t.data.id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS),t.event.preventDefault()):o()):o()},onRowPrepared:function(t){"data"==t.rowType&&(t.data.hora_final||t.rowElement.find("td").addClass("bg-warning"))},onContentReady:function(t){add_filtro_cor_tema(t),a.clearState&&(a.dx_listagem_apontamentos.find(".div_listagem_apontamentos").dxDataGrid("instance").state({}),a.clearState=!1)},summary:{groupItems:[{name:"subtotal",showInColumn:"subtotal",summaryType:"custom",showInGroupFooter:!1,alignByColumn:!0},{name:"total_horas",showInColumn:"total_horas",summaryType:"custom",showInGroupFooter:!1,alignByColumn:!0}],calculateCustomSummary:function(t){"subtotal"===t.name?("start"===t.summaryProcess&&(t.totalValue="00:00"),"calculate"===t.summaryProcess&&(t.totalValue=somar_horas(t.totalValue,subtrair_horas(t.value.total_horas,t.value.horas_traslado)),t.totalValue=t.totalValue.substr(0,t.totalValue.length-3))):"total_horas"===t.name&&("start"===t.summaryProcess&&(t.totalValue="00:00"),"calculate"===t.summaryProcess&&(t.totalValue=somar_horas(t.totalValue,t.value.total_horas),t.totalValue=t.totalValue.substr(0,t.totalValue.length-3)))}},onContextMenuPreparing:function(t){"header"==t.target&&Array.isArray(t.items)&&t.items.push({text:"Restaurar estado das colunas",visible:!0,beginGroup:!0,onItemClick:function(t){DevExpress.ui.dialog.confirm("Os filtros, ordenações, agrupamentos, posição, tamanho, e visibilidade das colunas desta listagem serão restauradas ao estado padrão. <b>Deseja continuar?</b>","Restaurar estado das colunas").done(function(t){t&&(a.clearState=!0,a.listar())})}})}}).dxDataGrid("instance")},this.unload=function(){View.unload(this.html_id)}}});