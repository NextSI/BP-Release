define([],function(){return function(i){"use strict";var t=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Job Scheduler",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_novo=this.dialog.find(".btn_novo"),this.btn_limpar_semaforo=this.dialog.find(".btn_limpar_semaforo"),this.btn_listar=this.dialog.find(".btn_listar"),this.show=function(){t.listar()},this.listar=function(){t.btn_limpar_semaforo.hide();var i=t.tab_listagem.find("tbody"),a=i.find("tr:first");t.tab_listagem.find("tr:gt(1)").remove(),WS.get("job_scheduler/listar/",null,function(e){var l=!1;$(e.lista).each(function(e,n){1==n.situacao&&(l=!0),function(e){var l=a.clone();l.removeAttr("template-row"),l.css("display",""),$(l.find("[template-field='script']")).text(e.script),$(l.find("[template-field='ativo']")).html(str_yes_no(e.ativo)),$(l.find("[template-field='minuto']")).text(e.minuto),$(l.find("[template-field='hora']")).text(e.hora),$(l.find("[template-field='dia']")).text(e.dia),$(l.find("[template-field='mes']")).text(e.mes),$(l.find("[template-field='dia_semana']")).text(e.dia_semana),$(l.find("[template-field='ultima_execucao']")).text(e.ultima_execucao?e.ultima_execucao.format_date_time():"");var n=$(l.find("[template-field='situacao']"));e.situacao==JOB_SCHEDULER_SITUACAO.AGUARDANDO?n.addClass("label-default"):e.situacao==JOB_SCHEDULER_SITUACAO.EM_EXECUCAO&&n.addClass("label-warning"),1==e.ativo||e.situacao==JOB_SCHEDULER_SITUACAO.EM_EXECUCAO?n.text(str_job_scheduler_situacao(e.situacao)):n.hide();var o=$(l.find(".btn_visualizar"));o.unbind("click"),o.click(function(){View.load("job_scheduler/detalhes",function(i,t){t.show(e.id,FORMULARIO.VISUALIZAR)})});var s=$(l.find(".btn_executar"));e.situacao==JOB_SCHEDULER_SITUACAO.AGUARDANDO&&1==e.ativo?s.click(function(){WS.post("job_scheduler/executar/",{job_scheduler_id:e.id},function(i){t.listar(),alert_modal("Validação",nl2br(i.log_ultima_execucao))},[s]),setTimeout(t.listar,1e3)}):s.addClass("disabled");var d=$(l.find(".btn_editar")),c=function(){View.load("job_scheduler/detalhes",function(i,a){a.onclose=t.listar,a.show(e.id,FORMULARIO.EDITAR)})};d.unbind("click"),d.click(c),l.dblclick(c);var r=$(l.find(".btn_excluir"));r.unbind("click"),r.click(function(){View.load("job_scheduler/detalhes",function(i,a){a.onclose=t.listar,a.show(e.id,FORMULARIO.EXCLUIR)})}),l.appendTo(i)}(n)}),e.semaforo&&""!=e.semaforo.trim()||l?t.btn_limpar_semaforo.show():t.btn_limpar_semaforo.hide()},[t.btn_limpar_semaforo,t.btn_listar])},this.btn_novo.unbind("click"),this.btn_novo.click(function(){View.load("job_scheduler/detalhes",function(i,a){a.onclose=t.listar,a.show(null,FORMULARIO.NOVO)})}),this.btn_limpar_semaforo.unbind("click"),this.btn_limpar_semaforo.click(function(){WS.post("job_scheduler/limpar_semaforo/",null,function(i){t.listar()},[t.btn_limpar_semaforo])}),this.btn_listar.unbind("click"),this.btn_listar.click(function(){t.listar()}),this.unload=function(){clearInterval(t.listar),View.unload(this.html_id)},this.show()}});