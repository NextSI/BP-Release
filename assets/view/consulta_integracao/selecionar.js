define([],function(){return function(a){"use strict";var t=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.onselect=null,this.onclose=null,this.modal_title=this.dialog.find(".modal_title"),this.table_generic=this.dialog.find(".table_generic"),this.div_parametros=this.dialog.find(".div_parametros"),this.modal_selecionar=this.dialog.find(".modal_selecionar"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.div_load=this.dialog.find(".div_load"),this.result=null,this.consulta_id=null,this.existe_callback=!1,this.notclose=!1,this.parametros=[],this.limite=0,this.is_sqlserver=!1,this.paginacao=!1,this.sql_campo="",this.show=function(a,i,e,l,o){t.consulta_id=a,t.sql_campo=o,t.is_sqlserver="MySQL"!=l,WS.get("consulta_integracao/objeto/",{consulta_id:t.consulta_id},function(a){t.paginacao="N"!=a.paginacao,e&&(t.notclose=e),i?(t.onselect=i,t.existe_callback=!0,t.listar_parametros()):t.paginacao&&t.listar(0)}),show_modal(t.modal.attr("id"))},this.listar_parametros=function(){t.div_parametros.find(".params").remove();var a=t.div_parametros.find('[template-row="parametros"]');WS.get("parametro_consulta_integracao/listar/",{consulta_id:t.consulta_id},function(i){t.parametros=i,$(t.parametros).each(function(i,e){!function(i,e){var l=a.clone();l.removeAttr("template-row"),l.css("display",""),l.addClass("params"),$(l.find("[template-field='nome']")).text(e.nome);var o=$(l.find("[template-field='valor']"));o.unbind("keyup"),o.keyup($.debounce(500,function(){t.table_generic.find("tr").remove(),t.parametros[i].valor=o.val(),t.listar(0)})),l.appendTo(t.div_parametros),0==i&&set_focus(o)}(i,e)}),(t.paginacao||0==t.parametros.length)&&t.listar(0)})},this.close=function(){close_modal(t.modal.attr("id")),void 0!==t.onclose&&t.onclose&&t.onclose()},this.unload=function(){t.close(),View.unload(this.html_id)},this.listar=function(a){var i={consulta_id:t.consulta_id,salvar:!1,limite:a,paginacao:t.paginacao,sql_campo:JSON.stringify(t.sql_campo)};t.existe_callback&&(i.parametros=JSON.stringify(t.parametros),i.save_params=!1),WS.post("consulta_integracao/executar_consulta",i,function(a){t.result=a,a&&(t.render_lista(),t.modal_title.text(t.result.cabecalho.nome))},null,null,null,!1,null,t.html_id)},this.render_lista=function(){t.table_generic.find(".tr_head").remove();var a=$("<tr>");if($(t.result.colunas).each(function(t,i){var e=$('<th class=" tr_head text-center">');e.text(i.titulo.toUpperCase()),e.appendTo(a)}),t.existe_callback){var i=$('<th class="tr_head text-center">');i.html("&nbsp;"),i.appendTo(a)}a.appendTo(t.table_generic.find("thead")),$(t.result.registros).each(function(a,i){var e=$("<tr>");if($(t.result.colunas).each(function(a,t){var l=$('<td class="text-center">');l.text(null!=i[t.nome]?i[t.nome]:""),l.appendTo(e)}),t.existe_callback){var l=$("<td>"),o=$('<div class="btn-group pull-right">'),n=$('<span class="glyphicon glyphicon-ok">'),s=$('<button type="button" class="btn_selecionar btn btn-primary">'),c=function(){t.onselect(i),t.notclose||t.unload()};s.unbind("click"),s.click(c),n.appendTo(s),s.text("Selecionar"),s.appendTo(o),o.appendTo(l),l.appendTo(e),e.dblclick(c)}e.appendTo(t.table_generic.find("tbody"))}),t.div_load.addClass("hidden")},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){t.unload()}),this.modal_selecionar.unbind("scroll"),this.modal_selecionar.scroll(function(){t.paginacao&&t.modal_selecionar.scrollTop()+t.modal_selecionar.height()==t.modal_selecionar.get(0).scrollHeight&&(t.div_load.removeClass("hidden"),t.limite=t.limite+50,t.listar(t.limite))})}});