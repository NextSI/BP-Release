define(["react","react-dom","./../atividade_projeto/ListarAtividadeProjeto"],function(i,a,e){return function(t){"use strict";var o=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onsave=null,this.ListarAtividadeProjeto=i.createElement(e,null,null),this.edt_nome=this.dialog.find(".edt_nome"),this.edt_codigo=this.dialog.find(".edt_codigo"),this.cbo_atividade_sinteticas=this.dialog.find(".cbo_atividade_sinteticas"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.div_excluir_filhas=this.dialog.find(".div_excluir_filhas"),this.chk_excluir_filhas=this.dialog.find(".chk_excluir_filhas"),this.div_marco=this.dialog.find(".div_marco"),this.chk_marco=this.dialog.find(".chk_marco"),this.div_atividade_sinteticas=this.dialog.find(".div_atividade_sinteticas"),this.label_atividade_sintetica=this.dialog.find(".label_atividade_sintetica"),this.cbo_tipo_previsao_inicio=this.dialog.find(".cbo_tipo_previsao_inicio"),this.edt_previsao_inicio=this.dialog.find(".edt_previsao_inicio"),this.edt_prazo_dias=this.dialog.find(".edt_prazo_dias"),this.edt_prazo_projeto=this.dialog.find(".edt_prazo_projeto"),this.lbl_tab_predecessora=this.dialog.find(".lbl_tab_predecessora"),this.popup=this.dialog.find(".popup"),this.dx_listagem_atividades_predecessoras=this.dialog.find(".dx_listagem_atividades_predecessoras"),this.arr_atividades_predecessoras=[],this.atividade_sintetica_id=null,this.projeto_id=null,this.dataGrid=null,this.permissoes_projeto={},this.tipo_previsao_inicio=0,this.previsao_inicio=null,this.prazo_dias=0,this.data_prazo=null,this.show=function(i,a,e){if("object"==typeof i&&null!=i){var t=clone_obj(i);i=null!=t.atividade_sintetica_id&&""!=t.atividade_sintetica_id?t.atividade_sintetica_id:null,a=null!=t.tipo&&""!=t.tipo?t.tipo:FORMULARIO.NOVO,e=null!=t.projeto_id&&""!=t.projeto_id?t.projeto_id:null,o.permissoes_projeto.gerente_projeto=t.gerente_projeto,o.permissoes_projeto.planejamento_datas=t.planejamento_datas}switch(o.projeto_id=e,a){case FORMULARIO.NOVO:o.btn_salvar.show(),o.btn_excluir.hide(),o.permite_alterar(!0),o.listar_atividade_sinteticas(!0);break;case FORMULARIO.EDITAR:o.btn_salvar.show(),o.btn_excluir.hide(),o.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:o.btn_salvar.hide(),o.btn_excluir.hide(),o.permite_alterar(!1),o.cbo_atividade_sinteticas.prop("disabled",!0);break;case FORMULARIO.EXCLUIR:o.btn_salvar.hide(),o.btn_excluir.show(),o.permite_alterar(!1),o.div_marco.addClass("hidden"),o.div_excluir_filhas.removeClass("hidden"),o.label_atividade_sintetica.text("Mover para atividade:")}o.tipo=a,void 0!==i&&i?(o.atividade_sintetica_id=i,o.preencher()):o.listar_atividades_predecessoras();var d=!0;(App.sessao.dados.admin||o.permissoes_projeto.gerente_projeto||o.permissoes_projeto.permissao_datas)&&(d=!1),setTimeout(function(){o.cbo_tipo_previsao_inicio.val(o.tipo_previsao_inicio).trigger("change").selectpicker("refresh"),set_datepicker(o.edt_previsao_inicio,o.previsao_inicio),o.edt_prazo_dias.val(o.prazo_dias),void 0!==o.data_prazo&&null!=o.data_prazo&&(set_datepicker(o.edt_prazo_projeto,o.data_prazo),o.sugerir_data_prazo=!0),o.edt_prazo_dias.unbind("change"),o.edt_prazo_dias.change(function(){if($(this).val()>0){var i=fn_dias_uteis(o.projeto_calendario_trabalho_id,get_datepicker(o.edt_previsao_inicio),o.edt_prazo_dias.val());i&&set_datepicker(o.edt_prazo_projeto,i.format_date(!0))}else set_datepicker(o.edt_prazo_projeto,get_datepicker(o.edt_previsao_inicio))}),o.edt_previsao_inicio.unbind("blur"),o.edt_previsao_inicio.blur(function(i){setTimeout(function(){(App.sessao.dados.admin||o.permissoes_projeto.gerente_projeto||o.permissoes_projeto.permissao_datas)&&o.edt_prazo_dias.attr("disabled",!1);var i=fn_dias_uteis(o.projeto_calendario_trabalho_id,get_datepicker(o.edt_previsao_inicio),o.edt_prazo_dias.val());i&&set_datepicker(o.edt_prazo_projeto,i.format_date(!0))},150)}),clearTimeout(this)},150),o.cbo_tipo_previsao_inicio.prop("disabled",d).selectpicker("refresh"),o.edt_previsao_inicio.prop("readonly",d),o.edt_prazo_dias.prop("disabled",d),o.edt_prazo_projeto.prop("readonly",d),show_modal(o.modal.attr("id")),set_focus(o.edt_nome)},this.listar_atividade_sinteticas=function(i,a){o.cbo_atividade_sinteticas.find("option").remove(),add_option(o.cbo_atividade_sinteticas,"","Nenhuma"),WS.get("atividade_sintetica_projeto/listar/",{projeto_id:o.projeto_id},function(e){for(var t=function(a,d,_){(o.atividade_sintetica_id!=a.atividade_sintetica_id&&0==i||1==i)&&add_option(o.cbo_atividade_sinteticas,a.atividade_sintetica_id,d.repeat(_)+a.nome);for(var s=[],r=0;r<e.length;r++)(n=e[r]).projeto_atividade_sintetica_pai_id==a.atividade_sintetica_id&&s.push(n);for(r=0;r<s.length;r++){var n=s[r];o.atividade_sintetica_id!=a.atividade_sintetica_id&&t(n,d,_+1)}},d=0;d<e.length;d++){var _=e[d];_.projeto_atividade_sintetica_pai_id||t(_,"&mdash;",0)}o.cbo_atividade_sinteticas.selectpicker("refresh"),a&&o.cbo_atividade_sinteticas.val(a).trigger("change")},[o.btn_salvar,o.btn_cancelar])},this.close=function(){close_modal(o.modal.attr("id")),void 0!==o.onclose&&o.onclose&&o.onclose()},this.unload=function(){o.close(),View.unload(this.html_id)},this.permite_alterar=function(i){o.edt_codigo.prop("readonly",!i),o.edt_nome.prop("readonly",!i)},this.preencher=function(){WS.get("atividade_sintetica_projeto/objeto/",{atividade_sintetica_projeto_id:o.atividade_sintetica_id},function(i){o.edt_nome.val(i.nome),o.edt_codigo.val(i.codigo),o.chk_marco.prop("checked",i.marco).change(),o.tipo_previsao_inicio=i.tipo_previsao_inicio,o.previsao_inicio=i.previsao_inicio,o.prazo_dias=i.prazo_dias,o.data_prazo=i.data_prazo,o.listar_atividade_sinteticas(!1,i.projeto_atividade_sintetica_pai_id),o.arr_atividades_predecessoras=i.arr_atividades_predecessoras,o.listar_atividades_predecessoras()})},this.listar_atividades_predecessoras=function(){o.dataGrid=dx_Listagem_Padrao({div_html:o.dx_listagem_atividades_predecessoras,coluna_chave:"id",colunas:dx_Atividade_Projeto_Colunas(o),toolbar:[dx_Atividade_Projeto_Btn_Novo(o,a)],datasource:o.arr_atividades_predecessoras,nome:this.title,nome_parametro_usuario:"listagem_atividade_sintetica_predecessora",editing_mode:dx_Atividade_Projeto_Editing_Mode(),on_row_prepared:function(i){"data"===i.rowType&&setTimeout(function(){var a=o.dataGrid.getCellElement(i.rowIndex,"status");a.text().trim().length&&a.html('<span class="label '+str_cor_status(str_identifica_status(i.data.inicio,i.data.prazo,i.data.conclusao))+'">'+a.text().trim()+"</span>")})},on_editing_start:function(i){"tipo"!==i.column.dataField&&(i.cancel=!0)},on_editor_preparing:dx_Atividade_Projeto_On_Editor_Preparing(o)})},this.btn_cancelar.unbind("click").click(function(){o.unload()}),this.btn_salvar.unbind("click").click(function(){for(var i="",a=0;a<o.dataGrid.getController("editing").getChanges().length;a++){var e=o.dataGrid.getController("editing").getChanges()[a];const t=e.data||e.key;t.tipo||(i+="<li>"+(t.atividade_simplificada||t.atividade_simplificada)+"</li>")}""!=i?alert_modal(App.lang.modal_validacao.validacao,"Informe um tipo de Atividade predecessora para a(s) atividade(s) abaixo: <br/>"+i):WS.post("atividade_sintetica_projeto/salvar",{atividade_sintetica_id:o.atividade_sintetica_id,nome:o.edt_nome.val(),projeto_id:o.projeto_id,projeto_atividade_sintetica_pai_id:o.cbo_atividade_sinteticas.val(),codigo:o.edt_codigo.val(),marco:o.chk_marco.prop("checked"),tipo_previsao_inicio:o.cbo_tipo_previsao_inicio.val(),previsao_inicio:get_datepicker(o.edt_previsao_inicio),prazo_dias:o.edt_prazo_dias.val()||0,prazo:get_datepicker(o.edt_prazo_projeto),arr_atividades_predecessoras:o.dataGrid.getController("editing").getChanges().length?CircularJSON.stringify(o.dataGrid.getController("editing").getChanges()):null},function(i){o.atividade_sintetica_id=i.id,alert_saved("Atividade salva com sucesso"),o.unload()})}),this.btn_excluir.unbind("click").click(function(){WS.post("atividade_sintetica_projeto/excluir",{atividade_sintetica_id:o.atividade_sintetica_id,projeto_atividade_sintetica_pai_id:o.cbo_atividade_sinteticas.val(),excluir_filhas:o.chk_excluir_filhas.prop("checked")},function(i){o.atividade_sintetica_id=i.id,alert_saved("Atividade exclu√≠da com sucesso"),o.onsave(!1)}),o.unload()}),this.cbo_tipo_previsao_inicio.unbind("change").change(function(){switch(parseInt(o.cbo_tipo_previsao_inicio.val(),10)){case TIPO_PREVISAO_INICIO.DEVE_INICIAR_EM:o.possui_executor_previsao_inicio||o.edt_previsao_inicio.prop("readonly",!1),o.edt_prazo_dias.prop("readonly",!1),o.edt_prazo_projeto.prop("readonly",!1);break;default:if(o.tipo_previsao_inicio==TIPO_PREVISAO_INICIO.O_MAIS_BREVE_POSSIVEL){var i=get_datepicker(o.edt_previsao_inicio),a=get_datepicker(o.edt_prazo_projeto);null!=i&&""!=i&&null!=o.previsao_inicio&&""!=o.previsao_inicio&&i!=o.previsao_inicio?set_datepicker(o.edt_previsao_inicio,o.previsao_inicio):set_datepicker(o.edt_previsao_inicio,""),null!=a&&""!=a&&null!=o.prazo&&""!=o.prazo&&a!=o.prazo&&set_datepicker(o.edt_prazo_projeto,o.prazo)}o.edt_previsao_inicio.prop("readonly",!0),o.edt_prazo_dias.prop("readonly",!0),o.edt_prazo_projeto.prop("readonly",!0)}}),this.chk_excluir_filhas.unbind("change").change(function(){o.chk_excluir_filhas.prop("checked")?o.div_atividade_sinteticas.addClass("hidden"):o.div_atividade_sinteticas.removeClass("hidden")}),this.lbl_tab_predecessora.unbind("click").click(function(){o.lbl_tab_predecessora.hasClass("active")||o.dataGrid.getController("editing").getChanges().length||o.listar_atividades_predecessoras()})}});