define([],function(){return function(a){"use strict";var o=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title="Histórico Documentos - D4Sign",this.onclose=null,this.onsave=null,this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.btn_solicitar_assinaturas=this.dialog.find(".btn_solicitar_assinaturas"),this.treelist_historico_documento_d4sign=this.dialog.find(".treelist_historico_documento_d4sign"),this.div_job_scheduler_ativo=this.dialog.find(".div_job_scheduler_ativo"),this.btn_job_scheduler=this.dialog.find(".btn_job_scheduler"),this.documento_revisao_id=null,this.usuario_permissao_escrita=null,this.grupo_usuario_permissao_escrita=null,this.job_scheduler_ativo=!1,this.existe_reprocessamento_pendente=!1,this.mensagem_padrao_d4sign=null,this.solicitacao_id=null,this.show=function(a,i,t,e){o.documento_revisao_id=a,o.mensagem_padrao_d4sign=t||null,o.solicitacao_id=e||null,null!==i&&"object"==typeof i&&(o.usuario_permissao_escrita=i.usuario_permissao_escrita||"S",o.grupo_usuario_permissao_escrita=i.grupo_usuario_permissao_escrita||"S"),o.listar(),show_modal(o.modal.attr("id"))},this.listar=function(){WS.get("documento_revisao_assinatura/listar_eventos_por_revisao/",{documento_revisao_id:o.documento_revisao_id,plataforma:"d4sign"},function(a){o.job_scheduler_ativo=!0===a.job_scheduler_ativo,o.montaTreeList(a.listagem)})},this.exibir_div_job_scheduler_ativo=(()=>{!1===o.job_scheduler_ativo&&!0===o.existe_reprocessamento_pendente?o.div_job_scheduler_ativo.show():o.div_job_scheduler_ativo.hide()}),this.onTreeContextMenuPreparing=(a=>{a.row&&"data"===a.row.rowType&&(a.items=[{text:"Download",visible:"A"!==a.row.data.situacao&&parseInt(a.row.data.signed_document_tamanho,10)>0,onItemClick:()=>o.download(a)},{text:"Reprocessar download do documento assinado",visible:"A"!==a.row.data.situacao&&!a.row.data.reprocessar_download,onItemClick:()=>o.reprocessar_download(a)},{text:"Cancelar reprocessamento de download",visible:"A"!==a.row.data.situacao&&a.row.data.reprocessar_download,onItemClick:()=>o.reprocessar_download(a,!0)}])}),this.download=(a=>{const i=a.row.data.documento_revisao_assinatura_id;App.obter_token_publico(a=>{App.download(WS_URI+"documento/download/?documento_revisao_id="+o.documento_revisao_id+"&documento_revisao_assinatura_id="+i+"&token_publico="+a)})}),this.reprocessar_download=((a,i=!1)=>{const t=a.row.data.documento_revisao_assinatura_id;WS.post("documento_revisao_assinatura/reprocessar_download/",{documento_revisao_id:o.documento_revisao_id,documento_revisao_assinatura_id:t,plataforma:"d4sign",cancelar:i},a=>{o.job_scheduler_ativo=!0===a.job_scheduler_ativo,o.montaTreeList(a.listagem)})}),this.montaTreeList=function(a){o.existe_reprocessamento_pendente=!1;for(let i=0;i<a.length;i++){const t=a[i];if("A"!==t.situacao&&!0===t.reprocessar_download){o.existe_reprocessamento_pendente=!0;break}}o.exibir_div_job_scheduler_ativo(),o.treelist_historico_documento_d4sign.dxTreeList({dataSource:a,showBorders:!0,keyExpr:"id",parentIdExpr:"pai_id",editing:{useIcons:!0},rowAlternationEnabled:!1,onRowPrepared:function(a){"data"===a.rowType&&"C"===a.data.situacao&&a.rowElement.find("td").css("background","#ffcdd2")},onContextMenuPreparing:o.onTreeContextMenuPreparing,columns:[{dataField:"solicitante_nome",caption:"Solicitante"},{dataField:"data_envio",caption:"Data de Envio",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{dataField:"situacao",caption:"Situação",alignment:"center",cellTemplate:function(a,o){var i="",t="";switch(o.data.situacao){case"A":t="Aguardando",i="label label-warning";break;case"F":t="Finalizado",i="label label-success";break;case"C":t="Cancelado",i="label label-danger"}$("<span class='"+i+"'>"+t+"</span>").appendTo(a)}},{dataField:"nome_arquivo",caption:"Nome do Arquivo"},{dataField:"nome_completo",caption:"Signatário"},{dataField:"event_occurred_at",caption:"Data Assinatura",width:130,dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{type:"buttons",buttons:[{hint:"Download",icon:"fa fa-download",visible:function(a){return 0===a.row.level&&"A"!==a.row.data.situacao&&parseInt(a.row.data.signed_document_tamanho,10)>0},onClick:o.download},{hint:!1===o.job_scheduler_ativo?"Configuração Pendente":"Reprocessando Download",visible:function(a){return 0===a.row.level&&"A"!==a.row.data.situacao&&!0===a.row.data.reprocessar_download},template:function(){return!1===o.job_scheduler_ativo?$('<i class="fas fa-exclamation-triangle text-warning"></i>'):$('<i class="fas fa-cog fa-spin text-info"></i>')}},{hint:"Cancelar Assinatura",icon:"fa fa-thumbs-down",cssClass:"icon_red",visible:function(a){return 0===a.row.level&&("S"===o.usuario_permissao_escrita||"S"===o.grupo_usuario_permissao_escrita)&&"F"!==a.row.data.situacao&&"C"!==a.row.data.situacao},onClick:function(a){o.cancelar_documento_assinado(a.row.data.d4sign_document_key)}}]}],showRowLines:!0})},this.cancelar_documento_assinado=function(a){alert_modal("Aviso","Deseja cancelar esta solicitação de assinatura?","Sim",function(){WS.get("d4sign/cancelar_assinatura/",{d4sign_document_key:a},function(a){alert_modal("Atenção","Solicitação de cancelamento enviado com sucesso! <br><br> A situação será atualizada automaticamente após o D4Sing confirmar o cancelamento.","OK")})},!0,"Não")},this.close=function(){close_modal(o.modal.attr("id")),void 0!==o.onclose&&o.onclose&&o.onclose()},this.unload=function(){o.close(),View.unload(this.html_id)},this.btn_refresh.unbind("click"),this.btn_refresh.click(function(){o.listar()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){o.unload()}),this.btn_solicitar_assinaturas.unbind("click"),this.btn_solicitar_assinaturas.click(function(){View.load("d4sign/configurar_signatarios",function(a,i){i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==o.html_id&&o.listar()})},i.show(o.documento_revisao_id,!0,null,null,o.solicitacao_id,o.mensagem_padrao_d4sign)},View.ABA.MULTIPLAS)}),this.btn_job_scheduler.on("click",()=>{View.load("job_scheduler/listar",a=>{},View.ABA.SIM)})}});