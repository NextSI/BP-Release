define(["react","react-dom","./../componentes_react/CboUsuarios"],function(e,i,o){return function(a){"use strict";var t=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onconfirm=null,this.edt_codigo=this.dialog.find(".edt_codigo"),this.edt_objetivo=this.dialog.find(".edt_objetivo"),this.edt_inicio=this.dialog.find(".edt_inicio"),this.edt_fim=this.dialog.find(".edt_fim"),this.cbo_status=this.dialog.find(".cbo_status"),this.div_status=this.dialog.find(".div_status"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.tab_equipe=this.dialog.find(".tab_equipe"),this.div_componente_usuario=this.dialog.find(".div_componente_usuario"),this.div_selecao_categoria=this.dialog.find(".div_selecao_categoria"),this.lbl_tab_equipe=this.dialog.find(".lbl_tab_equipe"),this.lbl_tab_anexos=this.dialog.find(".lbl_tab_anexos"),this.tbl_listagem_draft=this.dialog.find("#tbl_listagem_draft > tbody"),this.div_files_upload_draft=this.dialog.find("#div_files_upload_draft"),this.lbl_choose_file=this.dialog.find("#lbl_choose_file"),this.painel_anexos=this.dialog.find(".painel_anexos"),this.pdca=null,this.equipe={usuarios:[],grupo_usuarios:[]},this.categoria_pdca_id=null,this.dadosReferencia={referencia_tabela:null,referencia_id:null},this.cboEquipe=e.createElement(o,null,null),this.show=function(e,i,o={referencia_tabela:null,referencia_id:null}){switch(t.renderiza_componentes(),t.initUpload(),t.edt_objetivo.attr("id","edt_objetivo"+t.html_id),void 0!==e&&null!=e?(t.pdca=e,t.preencher()):t.renderiza_selecao_categoria(),null!==o&&"object"==typeof o&&(t.dadosReferencia.referencia_tabela=o.referencia_tabela||null,t.dadosReferencia.referencia_id=o.referencia_id||null),i){case FORMULARIO.NOVO:t.btn_confirmar.show(),t.btn_excluir.hide(),t.div_status.addClass("hidden"),t.permite_alterar(!0),t.lbl_tab_anexos.hide(),t.sugere_codigo(),set_datepicker(t.edt_inicio),set_datepicker(t.edt_fim),set_tinymce(t.edt_objetivo),App.sessao.dados.tipo==USUARIO_TIPO.ANALISTA&&(t.equipe.usuarios.push({usuario_id:App.sessao.dados.usuario_id,nome:App.sessao.dados.nome,tipo:App.sessao.dados.tipo,gerente:!1,equipe:!1,acompanhamento:!1}),t.render_equipe()),t.title="Novo PDCA";break;case FORMULARIO.EDITAR:t.btn_excluir.hide(),t.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:t.btn_confirmar.hide(),t.btn_excluir.hide(),t.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:t.btn_confirmar.hide(),t.btn_excluir.show(),t.permite_alterar(!1)}},this.sugere_codigo=function(){WS.get("pdca/get_next_codigo/",null,function(e){e&&(t.edt_codigo.val(e).change(),t.edt_codigo.tooltip({title:"Sugerido automaticamente",placement:"right"}),t.edt_codigo.tooltip("toggle"))})},this.permite_alterar=function(e){t.edt_codigo.prop("readonly",!e),t.edt_objetivo.prop("readonly",!e),t.edt_inicio.prop("readonly",!e),t.edt_fim.prop("readonly",!e),t.cbo_status.prop("disabled",!e),t.valor=e},this.renderiza_componentes=function(){i.render(t.cboEquipe,t.div_componente_usuario[0]),t.cboEquipe.props.setObjParam({Clientes:!1,EmpresaId:App.temp.empresa,ExibirGrupos:!0,EquipeInterna:!0,Modulo:MODULOS.PDCA}),t.cboEquipe.props.setFunctionSelect(t.seleciona_membro_equipe)},this.seleciona_membro_equipe=function(){var e=!1;if($(t.equipe).each(function(i,o){"usuarios"==t.cboEquipe.props.UsuarioSelecionado.tipo?$(o.usuarios).each(function(i,o){if(o.usuario_id==t.cboEquipe.props.UsuarioSelecionado.id)return e=!0,!1}):"grupo_usuarios"==t.cboEquipe.props.UsuarioSelecionado.tipo&&$(o.grupo_usuarios).each(function(i,o){if(o.grupo_usuarios_id==t.cboEquipe.props.UsuarioSelecionado.id)return e=!0,!1})}),!e){switch(t.cboEquipe.props.UsuarioSelecionado.tipo){case"usuarios":t.equipe.usuarios.push({usuario_id:t.cboEquipe.props.UsuarioSelecionado.id,nome:t.cboEquipe.props.UsuarioSelecionado.nome,tipo:t.cboEquipe.props.UsuarioSelecionado.tipo,gerente:!1,equipe:!1,acompanhamento:!1});break;case"grupo_usuarios":t.equipe.grupo_usuarios.push({grupo_usuarios_id:t.cboEquipe.props.UsuarioSelecionado.id,nome:t.cboEquipe.props.UsuarioSelecionado.nome,tipo:t.cboEquipe.props.UsuarioSelecionado.tipo,gerente:!1,equipe:!1,acompanhamento:!1})}t.render_equipe()}t.cboEquipe.props.setUsuario({usuario_id:null,usuario_nome:""})},this.render_equipe=function(){var e=t.tab_equipe.find("tbody"),i=e.find("tr:first"),o=function(o,a,n){var d=i.clone(),r=$(d.find("[template-field='tipo']")),s=$(d.find(".btn_usuario_remover")),c=$(d.find("[template-field='nome']")),u=$(d.find(".chk_gerente")),l=$(d.find(".chk_equipe")),p=$(d.find(".chk_acompanhamento")),_=$(d.find(".div_esconder"));d.removeAttr("template-row"),d.css("display",""),a?(r.addClass("label-warning"),r.attr("title","Grupo de Usuários"),r.attr("data-original-title","Grupo de Usuários"),r.text("GU")):"usuario_cliente"==o.tipo||o.tipo==USUARIO_TIPO.CLIENTE?(r.addClass("label-info"),r.attr("title","Usuário Cliente"),r.attr("data-original-title","Usuário Cliente"),r.text("C")):(r.addClass("label-info"),r.attr("title","Usuário"),r.attr("data-original-title","Usuário"),r.text("U")),r.tooltip(),c.text(o.nome),u.attr("type","checkbox"),u.addClass("checkbox_bootstrap_toggle"),l.attr("type","checkbox"),l.addClass("checkbox_bootstrap_toggle"),p.attr("type","checkbox"),p.addClass("checkbox_bootstrap_toggle"),1==o.gerente?(u.prop("checked",!0),p.parent().parent().parent().addClass("hidden"),l.parent().parent().parent().addClass("hidden"),d.addClass("bg-info"),d.find("td").addClass("bg-info"),t.lbl_tab_equipe.show()):(p.parent().parent().parent().removeClass("hidden"),l.parent().parent().parent().removeClass("hidden"),d.removeClass("bg-info"),d.find("td").removeClass("bg-info")),1==o.equipe&&l.prop("checked",!0),1==o.acompanhamento&&p.prop("checked",!0),$(p).prop("disabled",!t.valor),$(l).prop("disabled",!t.valor),$(u).prop("disabled",!t.valor),$(s).prop("disabled",!t.valor),t.valor||$(s).addClass("hidden"),l.parent().unbind("click").click(function(e){var i=a?t.equipe.grupo_usuarios[n]:t.equipe.usuarios[n];i.equipe=!$(this).find(".chk_equipe").prop("checked"),i.acompanhamento=!1,p.prop("checked",!1).change()}),p.parent().unbind("click").click(function(e){var i=a?t.equipe.grupo_usuarios[n]:t.equipe.usuarios[n];i.acompanhamento=!$(this).find(".chk_acompanhamento").prop("checked"),i.equipe=!1,l.prop("checked",!1).change()}),u.unbind("change"),u.change(function(){var e=a?t.equipe.grupo_usuarios[n]:t.equipe.usuarios[n];$(this).prop("checked")?(d.addClass("bg-info"),d.find("td").addClass("bg-info"),_.addClass("hidden")):(d.removeClass("bg-info"),d.find("td").removeClass("bg-info"),_.removeClass("hidden")),l.prop("checked",!1).change(),p.prop("checked",!1).change(),e.gerente=$(this).prop("checked"),e.acompanhamento=!1,e.equipe=!1}),s.unbind("click"),s.click(function(){a?alert_modal(t.title.text(),"Deseja remover o Grupo de Usuários?","Remover",function(){$(t.equipe.grupo_usuarios).each(function(e,i){i.grupo_usuarios_id==o.grupo_usuarios_id&&(d.remove(),t.equipe.grupo_usuarios.splice(e,1),t.render_equipe())})},!0):alert_modal(t.title.text(),"Deseja remover o Usuário?","Remover",function(){$(t.equipe.usuarios).each(function(e,i){i.usuario_id==o.usuario_id&&(d.remove(),t.equipe.usuarios.splice(e,1),t.render_equipe())})},!0)}),d.appendTo(e)};t.tab_equipe.find("tr:gt(1)").remove(),$(t.equipe.usuarios).each(function(e,i){o(i,!1,e)}),$(t.equipe.grupo_usuarios).each(function(e,i){o(i,!0,e)}),App.aplicar_checkbox(e)},this.preencher=function(){WS.get("pdca/objeto/",{pdca_id:t.pdca.pdca_id},function(e){App.titulo_aba(t.html_id,"PDCA "+e.numero),t.edt_codigo.val(e.numero),set_tinymce(t.edt_objetivo,e.objetivo),set_datepicker(t.edt_inicio,e.data_inicio),set_datepicker(t.edt_fim,e.data_fim),t.cbo_status.val(e.situacao),t.equipe.usuarios=e.equipe,t.equipe.grupo_usuarios=e.grupo_usuarios_equipe,t.categoria_pdca_id=e.categoria_pdca_id,t.render_equipe(),t.listaDocumentos(),t.renderiza_selecao_categoria()})},this.initUpload=function(){var e=$('<input type="file">');e[0].addEventListener("change",t.selecionouArquivo,!1),t.lbl_choose_file.click(function(){e.click()})},this.selecionouArquivo=function(e){var i=e.target.files;i&&(t.upload_files=i,t.uploadFile())},this.uploadFile=function(e){var i=new FormData;$.each(t.upload_files,function(e,o){i.append(e,o)}),WS.post("pdca_documento/salvar",{pdca_id:t.pdca.pdca_id,mobile:App.is_nativo()?"S":"N",data:t.upload_files},function(e){t.listaDocumentos()},null,null,!0)},this.removerArquivo=function(e){WS.post("pdca_documento/excluir",{pdca_documento_id:e.pdca_documento_id},function(e){t.listaDocumentos()})},this.listaDocumentos=function(){WS.get("pdca_documento/listar/",{pdca_id:t.pdca.pdca_id},function(e){t.tbl_listagem_draft.find(".rows").remove(),$.each(e,function(e,i){!function(e,i){var o=t.tbl_listagem_draft.find("tr:first").clone();o.addClass("rows").attr("indice",e).removeAttr("template-row").css("display","");var a=$(o.find("[template-field='file']"));a.text(i.nome),a.click(function(){App.obter_token_publico(function(e){App.download(WS_URI+"documento/download/?documento_revisao_id="+i.documento_revisao_id+"&token_publico="+e)})}),$(o.find("[template-field='size']")).text(i.tamanho+" kb");var n=o.find("[template-button='remove']");n.attr("template-ref",i.id),n.click(function(){alert_modal("Atenção","Deseja remover o arquivo "+i.nome+"?","Remover",function(){t.removerArquivo(i)},!0)}),o.appendTo(tbl_listagem_draft)}(e,i)})})},this.renderiza_selecao_categoria=function(){i.render(e.createElement(window.components.SelecaoCategoriaPDCA.default,{selecionado:t.categoria_pdca_id,columns:[{dataField:"nome",caption:"Nome",dataType:"string"}],aoAlterar:e=>{t.categoria_pdca_id=e}}),t.div_selecao_categoria[0])},this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("pdca/excluir",{pdca_id:t.pdca.pdca_id},function(e){alert_saved(e.objetivo+" excluido com sucesso"),t.unload()},[t.btn_excluir])}),this.btn_confirmar.unbind("click"),this.btn_confirmar.click(function(){WS.post("pdca/salvar",{pdca_id:null===t.pdca?0:t.pdca.pdca_id,numero:t.edt_codigo.val(),objetivo:get_tinymce(t.edt_objetivo),data_inicio:get_datepicker(t.edt_inicio),data_fim:get_datepicker(t.edt_fim),situacao:t.cbo_status.val(),equipe:JSON.stringify(t.equipe.usuarios),grupo_usuarios_equipe:JSON.stringify(t.equipe.grupo_usuarios),categoria_pdca_id:t.categoria_pdca_id,referencia_tabela:t.dadosReferencia.referencia_tabela,referencia_id:t.dadosReferencia.referencia_id},function(e){alert_saved("Registro "+(null===t.pdca_id?"inserido":"alterado")+" com sucesso!"),t.unload()},[t.btn_cancelar])}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){t.unload()}),this.close=function(){close_modal(t.modal.attr("id")),void 0!==t.onclose&&t.onclose&&t.onclose()},this.unload=function(){t.close(),View.unload(this.html_id)}}});