define(["react","react-dom","./../componentes_react/CboUsuarios"],function(a,i,o){return function(t){"use strict";var e=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.title="Possibilidades",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_novo=this.dialog.find(".btn_novo"),this.btn_nova_carta=this.dialog.find(".btn_nova_carta"),this.btn_listar=this.dialog.find(".btn_listar"),this.cbo_filtro_cliente=this.dialog.find(".cbo_filtro_cliente"),this.div_cbo_usuarios=this.dialog.find(".div_cbo_usuarios"),this.select_area_foco=this.dialog.find(".select_area_foco"),this.btn_pesquisa_registros=this.dialog.find(".btn_pesquisa_registros"),this.edt_filtro_autor=this.dialog.find(".edt_filtro_autor"),this.filtro_ordenacao=this.dialog.find(".filtro_ordenacao"),this.btn_limpar_filtros=this.dialog.find(".btn_limpar_filtros"),this.btn_info=this.dialog.find(".btn_info"),this.nova_possibilidade=this.dialog.find(".tab_listagem tfoot .nova-possibilidade"),this.totalizadores=this.dialog.find(".tab_listagem tfoot .totalizadores"),this.info_novo_registro=this.dialog.find(".info_novo_registro"),this.classificacao=this.dialog.find("#classificacao"),this.mensagem=this.dialog.find(".mensagem"),this.cboUsuarios=a.createElement(o,null,null),this.div_componente_usuario=this.dialog.find(".div_componente_usuario"),this.registrando=!1,this.area_foco_id=0,this.supervisionado_id=0,this.grupo_usuarios_id=0,e.info_novo_registro.css("display","none"),this.show=function(){(App.sessao.dados.admin||"S"==App.sessao.dados.supervisor_inovacao)&&e.div_cbo_usuarios.removeClass("hidden"),i.render(e.cboUsuarios,e.div_componente_usuario[0]),e.cboUsuarios.props.setObjParam({LabelCampo:"Filtrar por autor",ExibirApenasSupervisionados:!0,ExibirGrupos:!0}),e.cboUsuarios.props.setUsuario({usuario_id:App.sessao.dados.usuario_id,usuario_nome:App.sessao.dados.usuario_nome}),e.cboUsuarios.props.setFunctionSelect(e.evt_selecao_usuario),e.listar(null,!0)},this.evt_selecao_usuario=function(){"usuarios"==e.cboUsuarios.props.UsuarioSelecionado.tipo?(e.supervisionado_id=e.cboUsuarios.props.UsuarioSelecionado.id,e.grupo_usuarios_id=0,e.listar()):"grupo_usuarios"==e.cboUsuarios.props.UsuarioSelecionado.tipo&&(e.grupo_usuarios_id=e.cboUsuarios.props.UsuarioSelecionado.id,e.supervisionado_id=0,e.listar())},this.listar=function(a,i,o,t){e.tab_listagem.find("tbody").find("tr:not([template-row])").remove(),WS.get("possibilidades/listar/",{area_foco_id:a,ordena_um_nove:i,ordena_possibilidade:o,ordena_impacto:t,busca_autor:e.edt_filtro_autor.val(),supervisionado_id:e.supervisionado_id,grupo_usuarios_id:e.grupo_usuarios_id},function(a){e.totalizadores.html(a.length+" possibilidade(s)"),$(a).each(function(a,i){e.add_row(i,a+1)}),e.linha_auxiliar()})},this.linha_auxiliar=function(){var a=e.tab_listagem.find("tbody"),i=a.find("tr:first").clone();i.removeAttr("template-row"),i.css("display","");var o=$(i.find("[template-field='numero']")),t=($(i.find("[template-field='possibilidade'] span")),$(i.find("[template-field='autor'] span")),$(i.find("[template-field='classificacao'] span")),$(i.find("[template-field='possibilidade'] input")));t.prop("maxlength",100),$(i.find("[template-field='autor'] input")),$(i.find("[template-field='classificacao'] select")),$(i.find("td .btn_remove"));var s=$(i.find("[template-field='carta_inovacao'] .btn_carta_inovacao")),d=$(i.find("[template-field='carta_inovacao'] .btn_gerar_chamado"));$(i.find("[template-field='status'] span")),t.removeClass("hidden"),s.addClass("hidden"),d.addClass("hidden"),o.text("-"),i.css("opacity","0.7"),$(i).find("[template-field='possibilidade'] input").unbind("click").click(function(a){$(this).closest("tr").remove(),e.add_new_row()}),i.appendTo(a)},this.add_row=function(a,i){var o=e.tab_listagem.find("tbody"),t=o.find("tr:first").clone();t.removeAttr("template-row"),t.css("display",""),$(t).attr("data-id-possibilidade",a.id);var s=$(t.find("[template-field='numero']")),d=$(t.find("[template-field='possibilidade'] span")),n=$(t.find("[template-field='autor'] span")),l=$(t.find("[template-field='classificacao'] span")),r=$(t.find("[template-field='possibilidade'] input"));r.prop("maxlength",100);var c=$(t.find("[template-field='autor'] input")),_=$(t.find("[template-field='classificacao'] select")),u=$(t.find("td .btn_remove")),f=$(t.find("[template-field='carta_inovacao'] .btn_carta_inovacao")),p=$(t.find("[template-field='status'] span"));p.removeClass(),null==a.situacao?(p.text("Não iniciada"),p.addClass("label label-warning"),$(t).css("background","rgba(177, 171, 0, 0.32)")):a.situacao==CARTA_INOVACAO_SITUACAO.RASCUNHO||-1==a.situacao?(p.text("Rascunho"),p.addClass("label label-warning"),$(t).css("background","rgba(177, 171, 0, 0.32)")):a.situacao==CARTA_INOVACAO_SITUACAO.AGUARDANDO_AVALIACAO?(p.text("Aguardando Avaliação"),p.addClass("label label-default")):a.situacao==CARTA_INOVACAO_SITUACAO.STANDBY?(p.text("Standby"),$(t).css("background","#66909952"),p.addClass("label label-info")):a.situacao==CARTA_INOVACAO_SITUACAO.APROVADA&&"S"==a.chamado_gerado?(p.text("Em Execução"),p.addClass("label label-success"),$(t).css("background","#008a2e52")):a.situacao==CARTA_INOVACAO_SITUACAO.REPROVADA&&(p.text("Reprovada"),p.addClass("label label-danger"),$(t).css("background","#af000052")),f.click(function(i){View.load("possibilidades/carta_inovacao",function(i,o){o.show(a),o.onclose=e.listar;var t={possibilidade_id:a.id,situacao:a.situacao,usuario_id:a.usuario_id,usuario_nome:a.nome,carta_inovacao_id:a.carta_inovacao_id,nome_possibilidade:a.possibilidade};o.listar(t)},View.ABA.MULTIPLAS)});var v=$(t.find("[template-field='carta_inovacao'] .btn_gerar_chamado"));1!=App.sessao.dados.admin&&"S"!=App.sessao.dados.supervisor_inovacao||a.situacao==CARTA_INOVACAO_SITUACAO.APROVADA&&"S"!=a.chamado_gerado&&v.click(function(i){alert_modal("Carta de Inovação",'Tem certeza que deseja Gerar o chamado para esta possibilidade?".',"Sim",function(){WS.post("possibilidades/gerar_chamado/",{responsavel_id:a.usuario_id,titulo:a.possibilidade,carta_inovacao_id:a.carta_inovacao_id},function(a){alert_modal("Carta de inovação","Chamado gerado com sucesso","OK",function(){e.listar(null,!0),alert_saved("Salvo com sucesso!")})})},!0,"Não")}).removeClass("hidden"),a.chamado_id>0&&(v.html("Chamado #"+a.chamado_id).removeClass("hidden"),v.click(function(){View.loadReact(window.views.chamado.Detalhes.default,{chamadoId:a.chamado_id},function(a,i){},View.ABA.MULTIPLAS)}));var m=$(t).attr("data-id-possibilidade");u.css("cursor","pointer"),u.click(function(i){alert_modal("Excluir","Deseja realmente excluir?","Excluir",function(){a.situacao==CARTA_INOVACAO_SITUACAO.APROVADA?alert_modal("Carta de Inovação","Não é possível excluir uma possibilidade com a Carta de Inovação com Execução já iniciada."):e.excluir_registro(m)},!0,"Não",null,function(){})}),r.val(a.possibilidade),c.val(a.autor),_.val(a.classificacao),s.text(i),d.text(a.possibilidade),n.text(a.autor),l.text(a.classificacao),$(t).find("td:not([template-field='numero'], [template-field='autor'], [template-field='btn-remove'], [template-field='carta_inovacao'], [template-field='status']), tr:not([class='novo-registro']), tr:not(.novo-registro td[template-field='possibilidade'])").unbind("click").unbind("focusout").click(e.evento_editar).keyup(function(a){13==a.keyCode&&$(a.target).blur()}).focusout(function(){var i=$(this),o=$(i).find("input"),t=$(i).find("span"),s=$(o).val(),d=$(_).val();if($(o).attr("data-ativado",!1).addClass("hidden"),$(t).text($(i).find("input").val()).removeClass("hidden"),void 0===s&&(s=a.possibilidade),s!=a.possibilidade||d!=a.classificacao){var n=e.select_area_foco.val();null!=d&&""!=d&&e.salvar_dados(m,s,d,n)}else e.registrando=!1,e.info_novo_registro.css("display","none")}),t.appendTo(o)},this.add_new_row=function(){e.registrando=!0,e.info_novo_registro.css("display","block");var a=e.tab_listagem.find("tbody"),i=a.find("tr:first").clone();i.removeAttr("template-row"),i.removeAttr("data-id-possibilidade").removeAttr("data-ativado").removeAttr("template-row").addClass("novo-registro"),i.css("display","");var o=$(i.find("[template-field='numero']")),t=($(i.find("[template-field='possibilidade'] span")),$(i.find("[template-field='autor'] span")),$(i.find("[template-field='classificacao'] span")),$(i.find("[template-field='possibilidade'] input"))),s=$(i.find("[template-field='autor'] input")),d=$(i.find("[template-field='classificacao'] select")),n=($(i.find("[template-field='carta_inovacao'] btn")),$(i.find("td .btn_remove"))),l=$(i.find("td .btn_salvar"));n.css("display","none"),l.css("display","inline-block"),d.prop("disabled",!0),l.unbind("click"),l.css("cursor","pointer"),l.click(function(a){var i;if(-1==e.select_area_foco.val())return(i=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Escolha uma Área de Foco.")),alert_modal("Validação",i),$(a.target).closest("tr").remove(),void e.linha_auxiliar();if(""==t.val())return(i=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Possibilidade não pode estar vazia.")),alert_modal("Validação",i),$(a.target).closest("tr").remove(),void e.linha_auxiliar();var o=$(a.target).parent().closest("tr").find(".edt_possibilidade").val();e.salvar_dados("",o,"",e.select_area_foco.val())}),t.val("").removeClass("hidden").attr("placeholder","Digite a nova possibilidade"),s.val(0).addClass("hidden"),o.text("-"),$(i).find("td:not([template-field='numero'], [template-field='autor']), tr.novo-registro").unbind("keypress").keypress(function(a){if(13==a.keyCode){if(-1==e.select_area_foco.val())return(i=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Escolha uma Área de Foco.")),alert_modal("Validação",i),$(a.target).closest("tr").remove(),void e.linha_auxiliar();var i,o=$(a.target),t=$(a.target).parent().find("span"),s=$(o).val(),n=d.val();if(""==s)return(i=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Campo inválido, digite um valor.")),void alert_modal("Validação",i,"OK",function(){e.registrando=!1,$(a.target).focus()});e.salvar_dados("",s,n,e.select_area_foco.val()),o.attr("data-ativado",!1).addClass("hidden"),t.text($(a.target).val()).removeClass("hidden")}}),i.appendTo(a),t.focus()},$(document).keyup(function(a){27==a.keyCode&&e.registrando&&(e.tab_listagem.find("tbody tr:last").remove(),e.linha_auxiliar(),e.registrando=!1,e.filtro_ordenacao.prop("disabled",!1),e.edt_filtro_autor.prop("disabled",!1),e.select_area_foco.prop("disabled",!1),$(this).prop("disabled",!0),e.info_novo_registro.css("display","none"))}),this.listar_area_foco=function(a){e.select_area_foco.find("option").remove(),add_option(e.select_area_foco,-1,"Todas"),WS.get("area_foco/listar/",null,function(i){for(var o=0;o<i.length;o++){var t=i[o];add_option(e.select_area_foco,t.area_id,t.nome)}a&&e.select_area_foco.val(a).trigger("change"),e.select_area_foco.selectpicker("refresh")})},this.evento_editar=function(a){if(1==e.registrando){var i=new Validation;return i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Termine o registro novo ou cancele-o para continuar!")),void alert_modal("Validação",i)}var o=$(this);o.parents("tbody").find("tr").attr("data-ativado","false").find("input").removeClass("hidden").addClass("hidden"),o.parents("tbody").find("tr").find("span").removeClass("hidden");var t="true"==o.attr("data-ativado");o.attr("data-ativado",t),(t=!t)?($(o).find("input").removeClass("hidden"),$(o).find("span").addClass("hidden"),$(o).find("input").focus()):($(o).find("input").addClass("hidden"),$(o).find("span").removeClass("hidden"))},this.salvar_dados=function(a,i,o,t){WS.post({route:"possibilidades/salvar/",data:{possibilidade_id:a,descricao:i,classificacao:o,id_area_foco:t},type:"POST",func_response:function(a){a&&(e.filtro_ordenacao.prop("disabled",!1),e.edt_filtro_autor.prop("disabled",!1),e.select_area_foco.prop("disabled",!1),alert_saved("Salvo com sucesso!"),t?e.listar(t,!0):e.listar(null,!0),e.update_last_row(a),e.registrando=!1,e.info_novo_registro.css("display","none"))}})},this.update_last_row=function(a){var i=e.tab_listagem.find("tbody tr").last(),o=i.prev().find("td:nth-child(2)").text();0==~~parseInt(o)?(i.find("td:nth-child(2)").text(1),i.removeClass("novo-registro"),i.attr("data-id-possibilidade",a.id)):(i.find("td:nth-child(2)").text(parseInt(o)+1),i.removeClass("novo-registro"),i.attr("data-id-possibilidade",a.id))},this.btn_novo.unbind("click"),this.btn_novo.click(function(){View.load("possibilidades/detalhes",function(a,i){i.onclose=e.listar,i.show(null,FORMULARIO.NOVO)})}),this.btn_nova_carta.unbind("click"),this.btn_nova_carta.click(function(){View.load("possibilidades/carta_inovacao",function(a,i){i.show()},View.ABA.SIM)}),this.btn_limpar_filtros.unbind("click"),this.btn_limpar_filtros.click(function(a){e.select_area_foco.val("-1"),e.select_area_foco.selectpicker("refresh"),e.edt_filtro_autor.val(""),e.filtro_ordenacao.val("-1"),e.filtro_ordenacao.selectpicker("refresh"),e.select_area_foco.html(""),e.supervisionado_id=0,e.grupo_usuarios_id=0,e.cboUsuarios.props.setUsuario({usuario_id:null,usuario_nome:""}),e.listar(),e.listar_area_foco()}),this.btn_pesquisa_registros.unbind("click"),this.btn_pesquisa_registros.click(function(){var a=e.edt_filtro_autor.val(),i=e.select_area_foco.val();WS.get({html_id:e.html_id,route:"possibilidades/listar/",data:{area_foco_id:i,busca_autor:a},func_response:function(a){if(!(a.length>0)){var i=new Validation;return i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Nenhum registro encontrado!")),void alert_modal("Busca por autor",i)}e.tab_listagem.find("tbody").find("tr:not([template-row])").remove(),$(a).each(function(a,i){e.add_row(i,a+1)})}})}),this.filtro_ordenacao.unbind("change"),this.filtro_ordenacao.change(function(){1==e.filtro_ordenacao.val()?e.listar(e.select_area_foco.val(),!0):2==e.filtro_ordenacao.val()?e.listar(e.select_area_foco.val(),!1,!0):3==e.filtro_ordenacao.val()&&e.listar(e.select_area_foco.val(),!1,!1,!0)}),this.btn_info.unbind("click"),this.btn_info.css("cursor","pointer"),this.btn_info.click(function(){e.classificacao.modal("show")}),this.select_area_foco.unbind("change"),this.select_area_foco.change(function(){e.listar(e.select_area_foco.val(),!0)}),this.btn_listar.unbind("click"),this.btn_listar.click(function(){e.listar()}),this.nova_possibilidade.unbind("click"),this.nova_possibilidade.css("cursor","pointer"),this.nova_possibilidade.click(function(a){if(e.select_area_foco.val()<=0){var i=new Validation;return i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Selecione uma Área de Foco para continuar!")),void alert_modal("Validação",i)}e.registrando||($(this).prop("disabled",!0),e.filtro_ordenacao.prop("disabled",!0),e.edt_filtro_autor.prop("disabled",!0),e.select_area_foco.prop("disabled",!0),e.add_new_row())}),this.excluir_registro=function(a){WS.post("possibilidades/excluir/",{possibilidade_id:a},function(a){alert_saved("Registro excluído com sucesso"),e.select_area_foco.val()<=0?e.listar():e.listar(e.select_area_foco.val())})},this.unload=function(){View.unload(this.html_id)},this.nova_possibilidade_area_foco=function(a){e.listar_area_foco(a)},e.listar_area_foco()}});