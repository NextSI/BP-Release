define(["react","react-dom","./../componentes_react/CboClientes","./../atividade_projeto/ListarAtividadeProjeto"],function(a,e,o,t){return function(i){"use strict";var s=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Apontamento Atividade",this.onclose=null,this.tipo=null,$(this.dialog).attr("viewcode",TELAS.APONTAMENTO_PROJETO.codigo),this.cbo_consultor=this.dialog.find(".cbo_consultor"),this.cbo_projeto=this.dialog.find(".cbo_projeto"),this.edt_data=this.dialog.find(".edt_data"),this.edt_hora_inicio=this.dialog.find(".edt_hora_inicio"),this.edt_hora_fim=this.dialog.find(".edt_hora_fim"),this.edt_intervalo_inicio=this.dialog.find(".edt_intervalo_inicio"),this.edt_intervalo_fim=this.dialog.find(".edt_intervalo_fim"),this.edt_traslado=this.dialog.find(".edt_traslado"),this.edt_total=this.dialog.find(".edt_total"),this.edt_total_atividade=this.dialog.find(".edt_total_atividade"),this.edt_subtotal=this.dialog.find(".edt_subtotal"),this.div_todas_atividades=this.dialog.find(".div_todas_atividades"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.floating=this.dialog.find(".floating-menu"),this.div_component_cbo_clientes=this.dialog.find(".div_component_cbo_clientes"),this.dx_check_despesas=this.dialog.find(".dx_check_despesas"),this.dx_despesas_formulario=this.dialog.find(".dx_despesas_formulario"),this.cboClientes=a.createElement(o,{initial_values:{placeholder:"Pesquisar por nome/cnpj"}},null),this.ListarAtividadeProjeto=a.createElement(t,null,null),this.apontamento_id=null,this.projeto_id=null,this.cliente_id=null,this.cliente_nome=null,this.usuario_id=null,this.total_horas_apontamento=null,this.total_horas_atividade=null,this.total_horas_negativo=!1,this.atividade_id=[],this.descricao=[],this.atividade=[],this.horas_atividade=[],this.valor=null,this.anexo_atividade=[],this.filtros=null,this.projeto_nome="",this.arr_atividades=[],this.apontamento_despesa_id=0,this.dx_depesas_valores_formulario_data_source={km_rodado:0,pedagio:0,refeicao:0,outras_despesas:0,descricao:"",observacoes:""},this.qtde_atividades=null,this.atividades=null,this.aux=null,this.atividade=null,this.qtde_atv_filhos=null,this.projeto={},this.data_fechamento=null,this.auto_size=null,this.show=function(a,e,o,t,i,n,d,r){if("object"==typeof a&&null!=a){var _=clone_obj(a);a=null!=_.apontamento_id&&""!=_.apontamento_id?_.apontamento_id:null,e=null!=_.tipo&&""!=_.tipo?_.tipo:FORMULARIO.NOVO,null!=_.dia&&""!=_.dia&&_.dia,t=null!=_.projeto_id&&""!=_.projeto_id?_.projeto_id:null,i=null!=_.cliente_id&&""!=_.cliente_id?_.cliente_id:null,n=null!=_.cliente_nome&&""!=_.cliente_nome?_.cliente_nome:null,d=null!=_.projeto_atividade_id&&""!=_.projeto_atividade_id?_.projeto_atividade_id:null,r=null!=_.projeto_nome&&""!=_.projeto_nome?_.projeto_nome:null}switch(s.dx_check_despesas.dxCheckBox({value:!1,text:"Apontar despesas",onValueChanged:function(a){a.value?s.dx_despesas_formulario.show():s.dx_despesas_formulario.hide()}}),s.edt_hora_inicio.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){s.calcula_horas()}}),s.edt_hora_fim.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){s.calcula_horas()}}),s.edt_intervalo_inicio.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){s.calcula_horas()}}),s.edt_intervalo_fim.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){s.calcula_horas()}}),s.edt_traslado.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){s.calcula_horas()}}),s.edt_total.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){s.calcula_horas()}}),s.dx_despesas_formulario.dxForm(dx_Apontamento_Depesa_Projeto_Valores_Formulario(s.dx_depesas_valores_formulario_data_source)),WS.get("apontamento_projeto/get_parametros/",null,function(a){s.data_fechamento=a.apontamento_data_fechamento}),s.projeto_id=t,s.cliente_id=i,s.cliente_nome=n,s.projeto_nome=r,set_datepicker(s.edt_data),s.edt_total.dxDateBox("instance").option("disabled",!0),s.edt_total_atividade.prop("disabled",!0),s.tipo=e,e){case FORMULARIO.NOVO:s.btn_salvar.show(),s.btn_excluir.hide(),s.permite_alterar(!0),App.titulo_aba(s.html_id,"Novo - Apontamento Atividade");break;case FORMULARIO.EDITAR:s.btn_salvar.show(),s.btn_excluir.hide(),s.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:s.btn_salvar.hide(),s.btn_excluir.hide(),s.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:s.btn_salvar.hide(),s.btn_excluir.show(),s.permite_alterar(!1)}if(void 0!==a&&a)s.apontamento_id=a,s.preencher();else{var l=new Date,p=("0"+l.getDate()).slice(-2),c=("0"+(l.getMonth()+1)).slice(-2),u=l.getFullYear()+"-"+c+"-"+p;setTimeout(function(){set_datepicker(s.edt_data,u)},150),s.listar_consultor(App.sessao.dados.usuario_id),t&&s.preencher_despesas_padrao(),d?s.listar_atividades_projeto(t,function(){s.adiciona_atividade(d)}):s.adiciona_atividade(),s.renderiza_componentes()}create_combobox(s.cbo_projeto,s.listar_filtro_projeto),setTimeout(function(){""!=t&&null!=t&&(s.projeto_id=t,set_value_combobox(s.cbo_projeto,t,r))},150)},this.renderiza_componentes=function(){s.renderiza_combobox_cliente(),s.filtros?s.cboClientes.props.setCliente(s.filtros):s.cliente_id>0&&s.cliente_nome.length>0&&s.cboClientes.props.setCliente({cliente_id:s.cliente_id,cliente_nome:s.cliente_nome}),s.cboClientes.props.setFunctionSelect(s.evt_alterar_cliente)},this.renderiza_combobox_cliente=function(){e.render(s.cboClientes,s.div_component_cbo_clientes[0]),s.cboClientes.props.setConfiguracoes={main_externo:s,exibe_tipo_entidade:!0,placeholder:"Filtro por Cliente",WS_params:{desconsiderar_empresa:!0,desconsiderar_prospect:!0,desconsiderar_fornecedor:!0,cliente_vinculado_projeto:!0,limite:0}}},this.evt_alterar_cliente=function(){s.filtros=spread({},s.filtros,{cliente_id:s.cboClientes.props.ClienteSelecionado.id,cliente_nome:s.cboClientes.props.ClienteSelecionado.nome_fantasia,cliente_tipo:"C"}),s.cliente_id=s.filtros.cliente_id,App.temp.atividade_cliente_nome=s.cboClientes.props.ClienteSelecionado.nome_fantasia,setTimeout(function(){set_value_combobox(s.cbo_projeto,null,"")}),s.projeto_id=null},this.listar_consultor=function(a){s.cbo_consultor.find("option").remove(),add_option(s.cbo_consultor,"","-- Selecione --"),WS.get("usuario/listar/",null,function(e){for(var o=0;o<e.length;o++){var t=e[o];add_option(s.cbo_consultor,t.usuario_id,t.nome)}a&&(s.cbo_consultor.val(a).trigger("change"),s.usuario_id=a),s.cbo_consultor.selectpicker("refresh")})},this.listar_atividades_projeto=function(a,e){WS.get({route:"atividade_projeto/listar/",data:{projeto_id:a},func_response:function(a){a.atividades.push({atividade_simplificada:a.projeto.nome,id:"raiz",projeto_atividade_sintetica_pai_id:null,tipo_atividade:"P",marco:!1,horas_previstas:"000:00"}),s.projeto.data=a,void 0!==e&&e()},html_id:s.html_id})},this.function_select_projeto=function(a,e){var o=new Validation;if("S"!=e&&a.projeto_status_id==PROJETO_STATUS.CONCLUIDO)return setTimeout(function(){set_value_combobox(s.cbo_projeto,null,"")}),s.projeto_id=null,o.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Você não pode realizar apontamentos em projetos concluídos.")),alert_modal("Validação",o),s.edt_traslado.dxDateBox("instance").option("value",null),s.dx_depesas_valores_formulario_data_source.km_rodado=0,s.dx_depesas_valores_formulario_data_source.pedagio=0,s.dx_depesas_valores_formulario_data_source.refeicao=0,s.dx_depesas_valores_formulario_data_source.outras_despesas=0,s.dx_despesas_formulario.dxForm("instance").option("formData",s.dx_depesas_valores_formulario_data_source),!1;s.projeto_id=a.id,s.projeto_permite_alterar_padrao_apontamento=a.permite_alterar_padrao_apontamento,s.projeto_sugerir_despesas_no_apontamento_atividades=a.sugerir_despesas_no_apontamento_atividades,a.id?(a.id>0?"S"!=s.projeto_permite_alterar_padrao_apontamento&&!0!==s.projeto_permite_alterar_padrao_apontamento||!(s.dx_check_despesas.dxCheckBox("instance").option("value")&&(s.dx_depesas_valores_formulario_data_source.km_rodado>0||s.dx_depesas_valores_formulario_data_source.pedagio>0||s.dx_depesas_valores_formulario_data_source.refeicao>0||s.dx_depesas_valores_formulario_data_source.outras_despesas>0)||s.edt_traslado.dxDateBox("instance").option("value"))?s.preencher_despesas_padrao():alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"Deseja substituir as despesas pelas padrões do projeto ?","Sim",function(){s.preencher_despesas_padrao()},!0):(s.edt_traslado.dxDateBox("instance").option("value",null),s.dx_depesas_valores_formulario_data_source.km_rodado=0,s.dx_depesas_valores_formulario_data_source.pedagio=0,s.dx_depesas_valores_formulario_data_source.refeicao=0,s.dx_depesas_valores_formulario_data_source.outras_despesas=0,s.dx_despesas_formulario.dxForm("instance").option("formData",s.dx_depesas_valores_formulario_data_source)),"S"==s.projeto_permite_alterar_padrao_apontamento||!0===s.projeto_permite_alterar_padrao_apontamento?dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(s.dx_despesas_formulario.dxForm("instance"),!1):dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(s.dx_despesas_formulario.dxForm("instance"),!0),"S"==s.projeto_sugerir_despesas_no_apontamento_atividades||!0===s.projeto_sugerir_despesas_no_apontamento_atividades?s.dx_check_despesas.dxCheckBox("instance").option("value",!0):s.dx_check_despesas.dxCheckBox("instance").option("value",!1),s.listar_atividades_projeto(a.id,function(){for(var e=s.dialog.find(".div_atividades"),o=0;o<e.length;o++){var t=e[o];s.ListarAtividadeProjeto.props.setParams({div:$(t).find(".div_componente_atividades"),html_id:s.html_id,div_porcentagem:$(t).find(".porcentagem_atividade"),data:s.projeto.data||[],dialog:s.dialog,parametro_usuario:"apontamento_projeto",dropdown:!0,somente_leitura:!0,atividade_selecionada:a.projeto_atividade_id})}})):s.projeto.data=[]},this.preencher_despesas_padrao=function(){WS.get("projeto/objeto/",{projeto_id:s.projeto_id,usuario_id:s.usuario_id},function(a){s.edt_traslado.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+(a.traslado_padrao?a.traslado_padrao:"00:00"))),s.dx_depesas_valores_formulario_data_source.km_rodado=parseFloat(a.quantidade_km_padrao),s.dx_depesas_valores_formulario_data_source.pedagio=parseFloat(a.valor_pedagio),s.dx_depesas_valores_formulario_data_source.refeicao=a.tipo_valor_padrao_refeicao==TIPO_VALOR_REFEICAO.TECNICO?parseFloat(a.tecnico_valor_refeicao):parseFloat(a.valor_refeicao),s.dx_depesas_valores_formulario_data_source.outras_despesas=parseFloat(a.outras_despesas),s.dx_despesas_formulario.dxForm("instance").option("formData",s.dx_depesas_valores_formulario_data_source),void 0!==s.projeto_permite_alterar_padrao_apontamento&&void 0!==s.projeto_sugerir_despesas_no_apontamento_atividades||(s.projeto_permite_alterar_padrao_apontamento=a.permite_alterar_padrao_apontamento,s.projeto_sugerir_despesas_no_apontamento_atividades=a.sugerir_despesas_no_apontamento_atividades,"S"==s.projeto_permite_alterar_padrao_apontamento||!0===s.projeto_permite_alterar_padrao_apontamento?dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(s.dx_despesas_formulario.dxForm("instance"),!1):dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(s.dx_despesas_formulario.dxForm("instance"),!0),"S"==s.projeto_sugerir_despesas_no_apontamento_atividades||!0===s.projeto_sugerir_despesas_no_apontamento_atividades?s.dx_check_despesas.dxCheckBox("instance").option("value",!0):s.dx_check_despesas.dxCheckBox("instance").option("value",!1))})},this.listar_filtro_projeto=function(a){var e=s.cbo_projeto.parent().find(".edt_combobox");WS.get("projeto/get_projeto/",{projeto_nome:e.val(),cliente_id:s.cliente_id,usuario_id:s.usuario_id,apontamento_projeto:!0,limite:50},function(e){if(limpar_combobox(s.cbo_projeto),e.lista.length){for(var o=0;o<e.lista.length;o++){var t=e.lista[o],i=[],n=$('<span class="label lb_situacao" style="margin: 5px;"></span>');i.Nome=t.nome,t.status==PROJETO_STATUS.CONCLUIDO?(n.addClass("label-success"),n.attr("title","Concluído"),n.text("Concluído")):t.status==PROJETO_STATUS.NAO_INICIADO?(n.addClass("label-warning"),n.attr("title","Não Iniciado"),n.text("Não Iniciado")):t.status==PROJETO_STATUS.ANDAMENTO&&(n.addClass("label-info"),n.attr("title","Andamento"),n.text("Andamento")),add_option_combobox(s.cbo_projeto,o,t.id>0?t.id:null,i,n,JSON.stringify(t))}a(!0)}$(s.cbo_projeto.parent()).find(".ul_row").click(function(){var a=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;s.function_select_projeto(a,e.permitir_apontamento_projeto_concluido)}),s.cbo_projeto.parent().find(".edt_combobox").one("keypress",function(a){if(13==a.keyCode){var o=$(this).attr("dados-adicionais")?JSON.parse($(this).attr("dados-adicionais")):null;s.function_select_projeto(o,e.permitir_apontamento_projeto_concluido)}})}),e.keyup(function(a){$(this).val()||s.function_select_projeto({})})},this.incAnexo=function(a,e,o){var t=a.clone();o=1+o,t.find(".anexo_base_label").text("Anexo #"+o);var i=t.find(".checkbox");i.attr("type","checkbox"),i.bootstrapSwitch(!0),t.addClass("anexo_atividade"),t.removeClass("hidden"),t.appendTo(e),t.find('input[type="file"]').trigger("click")},this.carrega_documentos=function(a,e){var o=$(e).find(".div_anexos_carregados");o.removeClass("hidden");var t=o.find(".anexos");t.find(".line_anexos").remove();var i=$('<div class="row line_anexos">');a>0&&s.apontamento_id>0&&WS.get("documento/get_by_atividade_projeto/",{projeto_atividade_id:a,apontamento_id:s.apontamento_id},function(a){$(a).each(function(a,e){!function(a){var e=$('<div class="input-group">'),o=a.documento_revisao_id;if("application/pdf"==a.mime_type)(s=$("<button>")).addClass("btn btn-default btn-sm"),s.text(FileShortName(a.revisao_nome)),s.unbind("click"),s.click(function(){View.load("central_documentos/visualizar_pdf",function(a,e){e.show(o)})}),(d=$("<a>")).attr("type","button"),d.addClass("btn btn-default btn-sm"),d.attr("title",a.revisao_nome),d.attr("value",a.documento_revisao_id),(n=$("<span>")).addClass("glyphicon glyphicon-download-alt"),d.append(n),e.append(s),e.append(d);else if("image/png"==a.mime_type||"image/bmp"==a.mime_type||"image/jpeg"==a.mime_type||"image/jpg"==a.mime_type||"image/gif"==a.mime_type){var s,n;(s=$("<button>")).addClass("btn btn-default btn-sm"),s.text(FileShortName(a.revisao_nome)),s.unbind("click"),s.click(function(){View.load("central_documentos/visualizar_documento",function(a,e){e.show(o)})}),(d=$("<a>")).attr("type","button"),d.addClass("btn btn-default btn-sm"),d.attr("title",a.revisao_nome),d.attr("value",a.documento_revisao_id),(n=$("<span>")).addClass("glyphicon glyphicon-download-alt"),d.append(n),e.append(s),e.append(d)}else{var d;(d=$("<a>")).attr("type","button"),d.addClass("btn btn-default btn-sm"),d.attr("title",a.revisao_nome),d.text(FileShortName(a.revisao_nome)),d.attr("value",a.documento_revisao_id),e.append(d)}d.click(function(){App.obter_token_publico(function(a){App.download(WS_URI+"documento/download/?documento_revisao_id="+o+"&token_publico="+a)})});var r=$('<div class="col-md-6" style="padding-bottom: 3px;">');r.append(e),i.append(r),t.append(i)}(e)})})},this.adiciona_atividade=function(a,o,t){var i=s.dialog.find("[template-row='atividade']").clone();i.addClass("div_atividades"),i.removeAttr("template-row"),i.css("display","");var n=$(i).find("[template-field='porcentagem_atividade']"),d=$(i).find("[template-field='div_componente_atividades']");e.render(s.ListarAtividadeProjeto,d[0]),s.ListarAtividadeProjeto.props.setParams({div:d,html_id:s.html_id,div_porcentagem:n,data:s.projeto.data||[],dialog:s.dialog,parametro_usuario:"apontamento_projeto",dropdown:!0,somente_leitura:!0,atividade_selecionada:a}),a&&WS.get("atividade_projeto/objeto/",{atividade_projeto_id:a},function(e){s.carrega_documentos(a,i);var o=$(i).find("[template-field='status']"),t=str_identifica_status(e.inicio,e.prazo,e.conclusao);t=str_nome_status(t),o.text("- "+t),r=e.porcentagem,$(n).val(r);var d=$(i).find("[template-field='horas_atividade']"),_="",l="",p="";if(""!=e.horas_previstas&&null!=e.horas_previstas&&(e.horas_previstas=8==e.horas_previstas.length?"0"+e.horas_previstas:e.horas_previstas,_="Horas previstas: "+e.horas_previstas.substring(0,6)),""!=e.horas_previstas&&null!=e.horas_previstas&&(e.horas_previstas=8==e.horas_previstas.length?"0"+e.horas_previstas:e.horas_previstas,_="Horas previstas: "+e.horas_previstas.substring(0,6)),null!=e.horas_trabalhadas&&""!=e.horas_trabalhadas&&(e.horas_trabalhadas=8==e.horas_trabalhadas.length?"0"+e.horas_trabalhadas:e.horas_trabalhadas,l="<br>Horas trabalhadas: "+e.horas_trabalhadas.substring(0,6)),null!=e.saldo&&""!=e.saldo){var c=e.saldo.indexOf("-");e.saldo=c>-1?e.saldo.replace("-","").trim():e.saldo,e.saldo=8==e.saldo.length?-1==c?"0"+e.saldo:"-0"+e.saldo:e.saldo,p="<br>Saldo: "+(-1==e.saldo.indexOf("-")?e.saldo.substring(0,6):e.saldo.substring(0,7))}void 0!==e.tarefas&&e.tarefas.length>0&&n.addClass("disabled").attr("disabled","disabled"),d.html(_+" "+l+" "+p),d.html(_+" "+l+" "+p)});var r=null;s.dialog.find(".edt_descricao").prop("disabled",!s.valor),o&&$(i).find(".edt_descricao").val(o);var _=$(i).find(".div_anexos"),l=$(i).find(".div_anexos_row"),p=$(i).find(".btn_anexo");p.unbind("click"),p.click(function(){var a=null;a=(a=$(i).find(".div_anexos_row")).length-1,s.incAnexo(l,_,a)}),n.addClass("porcentagem_atividade"),n.prop("readonly",!s.valor),n.unbind("change").change(function(){$(this).val($(this).val()>100?100:$(this).val()<0?0:$(this).val())});var c=$(i).find("[template-field='horas']");c.attr("type","text"),c.mask("00:00"),c.addClass("edt_horas"),c.prop("disabled",!s.valor),c.unbind("change").change(function(){s.horas_atividades()}),t&&$(c).val(t),i.appendTo(s.div_todas_atividades)},this.horas_atividades=function(){var a=s.dialog.find(".edt_horas"),e=null;$(a).each(function(a,o){if(null!=o&&"00:00"!=o){var t=o.value.substring(0,2),i=o.value.substring(3,5),s=60*parseInt(t,10)+parseInt(i,10);e+=isNaN(s)?0:s}}),s.total_horas_atividade=e;var o=e,t=Math.floor(o/60);o-=60*t;var i=s.format_hora(t,o);s.edt_total_atividade.val("NaN:NaN"==i?"00:00":i)},this.close=function(){void 0!==s.onclose&&s.onclose&&s.onclose()},this.unload=function(){s.close(),View.unload(this.html_id)},this.calcula_horas=function(){var a=s.edt_hora_inicio.dxDateBox("instance").option("value"),e=s.edt_hora_fim.dxDateBox("instance").option("value"),o=s.edt_intervalo_inicio.dxDateBox("instance").option("value"),t=s.edt_intervalo_fim.dxDateBox("instance").option("value"),i=s.edt_traslado.dxDateBox("instance").option("value")?formatDateTime(s.edt_traslado.dxDateBox("instance").option("value")).substr(-5):"00:00:00",n="00:00:00",d="00:00:00";if(a&&e){if(pad(a.getHours(),2)+":"+pad(a.getMinutes(),2)>pad(e.getHours(),2)+":"+pad(e.getMinutes(),2))return s.edt_hora_inicio.dxDateBox("instance").option("value",null),s.edt_hora_fim.dxDateBox("instance").option("value",null),(r=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,'A "hora inicial" não pode ser maior que a "hora final". Digite novamente.')),void alert_modal("Validação",r);n=subtrair_horas(formatDateTime(e).substr(-5),formatDateTime(a).substr(-5))}if(o&&t){if(o>t)return s.edt_intervalo_inicio.dxDateBox("instance").option("value",null),s.edt_intervalo_fim.dxDateBox("instance").option("value",null),(r=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,'O "intervalo inicial" não pode ser maior que o "intervalo final". Digite novamente.')),void alert_modal("Validação",r);d=subtrair_horas(formatDateTime(t).substr(-5),formatDateTime(o).substr(-5))}var r,_=somar_horas(subtrair_horas(n,d),i);if(a&&e&&o&&t&&"-"===_.substr(0,1))return s.total_horas_negativo=!0,(r=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"O intervalo está maior que o tempo gasto na atividade. Revise os horários.")),void alert_modal("Validação",r);s.total_horas_negativo=!1,s.edt_total.dxDateBox("instance").option("value",_)},this.permite_alterar=function(a){const e=App.sessao.dados.admin||App.verifica_permissao(App.temp.empresa,"admin_apontamento_atividade");s.valor=a,s.edt_data.prop("readonly",!a),s.cbo_consultor.prop("disabled",!(s.tipo==FORMULARIO.NOVO&&e)),s.edt_hora_inicio.dxDateBox("instance").option("disabled",!a),s.edt_hora_fim.dxDateBox("instance").option("disabled",!a),s.edt_intervalo_inicio.dxDateBox("instance").option("disabled",!a),s.edt_intervalo_fim.dxDateBox("instance").option("disabled",!a),s.edt_traslado.dxDateBox("instance").option("disabled",!a),s.edt_total.dxDateBox("instance").option("disabled",!a)},this.preencher=function(){WS.get("apontamento_projeto/objeto/",{apontamento_id:s.apontamento_id},function(a){App.titulo_aba(s.html_id,"#"+a.id+" - Apontamento Atividade"),s.projeto_id=a.projeto_id,s.cliente_id=a.cliente_id,s.usuario_id=a.usuario_id,s.apontamento_despesa_id=a.apontamento_despesa_id,s.projeto_permite_alterar_padrao_apontamento=a.projeto_permite_alterar_padrao_apontamento,s.projeto_sugerir_despesas_no_apontamento_atividades=a.projeto_sugerir_despesas_no_apontamento_atividades,s.filtros=spread({},s.filtros,{cliente_id:a.cliente_id,cliente_nome:a.cliente_nome,cliente_tipo:"C"}),s.renderiza_componentes(),set_datepicker(s.edt_data,a.dia),s.listar_consultor(a.usuario_id),set_value_combobox(s.cbo_projeto,a.projeto_id,a.projeto_nome),a.hora_inicial&&s.edt_hora_inicio.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.hora_inicial)),a.hora_final&&s.edt_hora_fim.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.hora_final)),a.intervalo_inicial&&s.edt_intervalo_inicio.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.intervalo_inicial)),a.intervalo_final&&s.edt_intervalo_fim.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.intervalo_final)),a.horas_traslado&&s.edt_traslado.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.horas_traslado)),s.apontamento_despesa_id>0&&(s.dx_check_despesas.dxCheckBox("instance").option("value",!0),s.dx_depesas_valores_formulario_data_source.km_rodado=parseFloat(a.km_rodado),s.dx_depesas_valores_formulario_data_source.pedagio=parseFloat(a.pedagio),s.dx_depesas_valores_formulario_data_source.refeicao=parseFloat(a.refeicao),s.dx_depesas_valores_formulario_data_source.outras_despesas=parseFloat(a.outras_despesas),s.dx_depesas_valores_formulario_data_source.descricao=a.despesa_descricao,s.dx_depesas_valores_formulario_data_source.observacoes=a.despesa_observacoes,s.dx_despesas_formulario.dxForm("instance").option("formData",s.dx_depesas_valores_formulario_data_source),"N"!=s.projeto_permite_alterar_padrao_apontamento&&!1!==s.projeto_permite_alterar_padrao_apontamento||dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(s.dx_despesas_formulario.dxForm("instance"),!0)),s.listar_atividades_projeto(a.projeto_id,function(){a.atividade!=[]&&$(a.atividade).each(function(a,e){s.adiciona_atividade(e.projeto_atividade_id,e.descricao,e.horas)}),s.horas_atividades()})})},this.format_hora=function(a,e){return a.toString().indexOf("-")>-1?(a=a.toString().replace("-",""),parseInt(a,10)<10&&parseInt(e,10)<10?" -0"+a+":0"+e:parseInt(a,10)<10?" -0"+a+":"+e:parseInt(e,10)<10?a+":0"+e:a+":"+e):parseInt(a,10)<10&&parseInt(e,10)<10?"0"+a+":0"+e:parseInt(a,10)<10?"0"+a+":"+e:parseInt(e,10)<10?a+":0"+e:a+":"+e},this.cbo_consultor.unbind("change"),this.cbo_consultor.change(function(){null!==s.usuario_id&&(s.usuario_id=s.cbo_consultor.val(),s.cliente_id>0&&s.tipo==FORMULARIO.NOVO&&(s.projeto_id=null,set_value_combobox(s.cbo_projeto,null,"")))}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){s.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var a=function(){if(s.total_horas_negativo){var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"O intervalo está maior que o tempo gasto na atividade. Revise os horários.")),void alert_modal("Validação",a)}s.arr_atividades=[];var e=s.dialog.find(".div_atividades");$(e).each(function(a,e){var o={};o.atividade_id=$(e).find(".div_listagem_atividade_projeto").attr("id"),o.descricao=$(e).find("textarea").val(),o.horas_atividade=s.edt_total.dxDateBox("instance").option("value")?s.edt_total.dxDateBox("instance").option("value").substr(0,5):null,o.horas_atividade&&s.edt_traslado.dxDateBox("instance").option("value")&&(o.horas_atividade=subtrair_horas(formatDateTime(o.horas_atividade).substr(-5),formatDateTime(s.edt_traslado.dxDateBox("instance").option("value")).substr(-5))),o.porcentagem_atividade=$(e).find(".porcentagem_atividade").val(),s.arr_atividades[a]=o});var o={apontamento_id:s.apontamento_id,usuario_id:s.cbo_consultor.val(),projeto_id:s.projeto_id,atividade:JSON.stringify(s.arr_atividades),cliente_id:s.cliente_id,dia:get_datepicker(s.edt_data),hora_inicial:s.edt_hora_inicio.dxDateBox("instance").option("value")?formatDateTime(s.edt_hora_inicio.dxDateBox("instance").option("value")).substr(-5):null,hora_final:s.edt_hora_fim.dxDateBox("instance").option("value")?formatDateTime(s.edt_hora_fim.dxDateBox("instance").option("value")).substr(-5):null,intervalo_inicial:s.edt_intervalo_inicio.dxDateBox("instance").option("value")?formatDateTime(s.edt_intervalo_inicio.dxDateBox("instance").option("value")).substr(-5):null,intervalo_final:s.edt_intervalo_fim.dxDateBox("instance").option("value")?formatDateTime(s.edt_intervalo_fim.dxDateBox("instance").option("value")).substr(-5):null,horas_traslado:s.edt_traslado.dxDateBox("instance").option("value")?formatDateTime(s.edt_traslado.dxDateBox("instance").option("value")).substr(-5):null,horas_total:s.edt_total.dxDateBox("instance").option("value")?s.edt_total.dxDateBox("instance").option("value").substr(0,5):null,apontar_despesa:s.dx_check_despesas.dxCheckBox("instance").option("value"),km_rodado:s.dx_depesas_valores_formulario_data_source.km_rodado,pedagio:s.dx_depesas_valores_formulario_data_source.pedagio,refeicao:s.dx_depesas_valores_formulario_data_source.refeicao,outras_despesas:s.dx_depesas_valores_formulario_data_source.outras_despesas,despesa_descricao:s.dx_depesas_valores_formulario_data_source.descricao,despesa_observacoes:s.dx_depesas_valores_formulario_data_source.observacoes};$(e).each(function(a,e){var t=$(e).find(".anexo_atividade").find('input[type="file"]'),i=$(e).find(".div_listagem_atividade_projeto").attr("id");$.each(t,function(a,e){e.files[0]&&(o[i+"_"+a]=e.files[0])})}),WS.post("apontamento_projeto/salvar",o,function(a){s.apontamento_id=a.id,alert_saved("Apontamento salvo com sucesso"),s.unload()},[s.btn_cancelar,s.btn_salvar],null,!0)};get_datepicker(s.edt_data)<=s.data_fechamento&&App.verifica_permissao(App.temp.empresa,"apontamento_projetos_fechado")?alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !','<div class="alert alert-info" style="text-align: center"> <span href="#" class="alert-link"><strong>Você está tentando realizar um apontamento </strong>fechado,<strong> deseja continuar ?  </strong></span></div>','<i class="fa fa-check" aria-hidden="true"></i> Sim',function(){a()},!0,'<i class="fa fa-times" aria-hidden="true"></i> Cancelar'):a()}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("apontamento_projeto/excluir",{apontamento_projeto_id:s.apontamento_id},function(a){alert_saved("Apontamento excluido com sucesso"),s.unload()},[s.btn_cancelar,s.btn_excluir])}),$(document).scroll(function(){s.floating.css("top",$(this).scrollTop())})}});