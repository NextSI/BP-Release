var isMobile=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(isMobile=!0),define(["react","react-dom","./../componentes_react/CboClientes"],function(e,a,o){return function(t){"use strict";var i=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.title="",this.onclose=null,this.onselect=null,this.onsave=null,this.ondelete=null,this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.edt_nome_oportunidade=this.dialog.find(".edt_nome_oportunidade"),this.cbo_contatos=this.dialog.find(".cbo_contatos"),this.cbo_tipo_oportunidade=this.dialog.find(".cbo_tipo_oportunidade"),this.div_dropdown_etiquetas=this.dialog.find(".div_dropdown_etiquetas"),this.cbo_representante=this.dialog.find(".cbo_representante"),this.cbo_representante2=this.dialog.find(".cbo_representante2"),this.cbo_funil=this.dialog.find(".cbo_funil"),this.edt_funil=this.dialog.find(".edt_funil"),this.cbo_etapa=this.dialog.find(".cbo_etapa"),this.edt_data_fechamento=this.dialog.find(".edt_data_fechamento"),this.div_componente_tipo_moeda=this.dialog.find(".div_componente_tipo_moeda"),this.edt_valor_negocio=this.dialog.find(".edt_valor_negocio"),this.cbo_situacao=this.dialog.find(".cbo_situacao"),this.btn_incluir_item=this.dialog.find(".btn_incluir_item"),this.btn_nova_agenda=this.dialog.find(".btn_nova_agenda"),this.btn_novo_status=this.dialog.find(".btn_novo_status"),this.cbo_convidados=this.dialog.find(".cbo_convidados"),this.edt_convidados=null,this.btn_pdf=this.dialog.find(".btn_pdf"),this.btn_gerar_orcamento=this.dialog.find(".btn_gerar_orcamento"),this.cbo_condicao_pagamento=this.dialog.find(".cbo_condicao_pagamento"),this.cbo_transportador=this.dialog.find(".cbo_transportador"),this.edt_condicao_pagamento=null,this.cbo_tabela_preco=this.dialog.find(".cbo_tabela_preco"),this.edt_tabela_preco=null,this.edt_motivo_desconto=this.dialog.find(".edt_motivo_desconto"),this.edt_observacao_condicao_pagamento=this.dialog.find(".edt_observacao_condicao_pagamento"),this.edt_observacao_frete=this.dialog.find(".edt_observacao_frete"),this.edt_observacao_entrega=this.dialog.find(".edt_observacao_entrega"),this.cbo_tipo_frete=this.dialog.find(".cbo_tipo_frete"),this.edt_valor_frete=this.dialog.find(".edt_valor_frete"),this.edt_data_entrega=this.dialog.find(".edt_data_entrega"),this.edt_observacao=this.dialog.find(".edt_observacao"),this.edt_observacao_nf=this.dialog.find(".edt_observacao_nf"),this.edt_validade_orcamento=this.dialog.find(".edt_validade_orcamento"),this.btn_editar_obs=this.dialog.find(".btn_editar_obs"),this.btn_excluir_obs=this.dialog.find(".btn_excluir_obs"),this.div_motivo_desconto=this.dialog.find(".div_motivo_desconto"),this.div_condicao_pagamento=this.dialog.find(".div_condicao_pagamento"),this.div_condicao_pagamento_obs=this.dialog.find(".div_condicao_pagamento_obs"),this.div_frete=this.dialog.find(".div_frete"),this.div_frete_obs=this.dialog.find(".div_frete_obs"),this.div_entrega=this.dialog.find(".div_entrega"),this.div_entrega_obs=this.dialog.find(".div_entrega_obs"),this.div_obs=this.dialog.find(".div_obs"),this.div_validade_orcamento=this.dialog.find(".div_validade_orcamento"),this.div_custo=this.dialog.find(".div_custo"),this.div_percentual_lucro_bruto=this.dialog.find(".div_percentual_lucro_bruto"),this.div_valor_lucro_bruto=this.dialog.find(".div_valor_lucro_bruto"),this.nav_oportunidade=this.dialog.find(".nav_oportunidade"),this.edt_subtotal=this.dialog.find(".edt_subtotal"),this.edt_total_desconto_item=this.dialog.find(".edt_total_desconto_item"),this.div_total_desconto_item=this.dialog.find(".div_total_desconto_item"),this.edt_perc_total_desconto_oportunidade=this.dialog.find(".edt_perc_total_desconto_oportunidade"),this.edt_total_desconto_oportunidade=this.dialog.find(".edt_total_desconto_oportunidade"),this.btn_recarrega_eventos=this.dialog.find(".btn_recarrega_eventos"),this.btn_refresh_status=this.dialog.find(".btn_refresh_status"),this.cbo_origem=this.dialog.find(".cbo_origem"),this.div_origem=this.dialog.find(".div_origem"),this.div_btn_detalhes_entidade=this.dialog.find(".div_btn_detalhes_entidade"),this.btn_detalhes_entidade=this.dialog.find(".btn_detalhes_entidade"),this.btn_historico_entidade=this.dialog.find(".btn_historico_entidade"),this.div_detalhes_entidade=this.dialog.find(".div_detalhes_entidade"),this.div_btn_detalhes_contato=this.dialog.find(".div_btn_detalhes_contato"),this.btn_detalhes_contato=this.dialog.find(".btn_detalhes_contato"),this.div_detalhes_contato=this.dialog.find(".div_detalhes_contato"),this.tipo_entidade=this.dialog.find(".tipo_entidade"),this.codigo_unidade_entidade=this.dialog.find(".codigo_unidade_entidade"),this.cnpj_entidade=this.dialog.find(".cnpj_entidade"),this.email_entidade=this.dialog.find(".email_entidade"),this.telefone1_entidade=this.dialog.find(".telefone1_entidade"),this.telefone2_entidade=this.dialog.find(".telefone2_entidade"),this.telefone3_entidade=this.dialog.find(".telefone3_entidade"),this.telefone4_entidade=this.dialog.find(".telefone4_entidade"),this.cep_entidade=this.dialog.find(".cep_entidade"),this.endereco_entidade=this.dialog.find(".endereco_entidade"),this.div_representante2=this.dialog.find(".div_representante2"),this.edt_total_ipi=this.dialog.find(".edt_total_ipi"),this.div_total_ipi=this.dialog.find(".div_total_ipi"),this.edt_valor_total=this.dialog.find(".edt_valor_total"),this.edt_valor_lucro_bruto_total=this.dialog.find(".edt_valor_lucro_bruto_total"),this.edt_percentual_lucro_bruto_total=this.dialog.find(".edt_percentual_lucro_bruto_total"),this.div_lucro_bruto_total=this.dialog.find(".div_lucro_bruto_total"),this.th_total=this.dialog.find(".th_total"),this.div_panel=this.dialog.find(".div_panel"),this.div_oportunidade=this.dialog.find(".div_oportunidade"),this.div_panel_default=this.dialog.find(".panel-default"),this.btn_oportunidade=this.dialog.find(".btn_oportunidade"),this.tab_listagem=this.dialog.find(".tab_listagem"),this.menu_item=this.dialog.find(".menu_item"),this.aba_itens=this.dialog.find(".aba_itens"),this.menu_agenda=this.dialog.find(".menu_agenda"),this.aba_agenda=this.dialog.find(".aba_agenda"),this.menu_observacoes=this.dialog.find(".menu_observacoes"),this.aba_observacoes=this.dialog.find(".aba_observacoes"),this.menu_convidados=this.dialog.find(".menu_convidados"),this.aba_convidados=this.dialog.find(".aba_convidados"),this.scrollview=this.dialog.find(".scrollview"),this.tab_personalizados=this.dialog.find(".tab_personalizados"),this.menu_historico=this.dialog.find(".menu_historico"),this.aba_historico=this.dialog.find(".aba_historico"),this.menu_personalizado=this.dialog.find(".menu_personalizado"),this.aba_personalizado=this.dialog.find(".aba_personalizado"),this.aba_referencias=this.dialog.find(".aba_referencias"),this.div_componente_referencias=this.dialog.find(".div_componente_referencias"),this.lbl_nome=this.dialog.find(".lbl_nome"),this.form_editor=this.dialog.find(".form-editor"),this.form_grupos=this.dialog.find(".form-grupos"),this.tab_listagem_orcamento=this.dialog.find(".tab_listagem_orcamento"),this.menu_orcamentos=this.dialog.find(".menu_orcamentos"),this.aba_orcamentos=this.dialog.find(".aba_orcamentos"),this.tab_listagem_status=this.dialog.find(".tab_listagem_status"),this.menu_status=this.dialog.find(".menu_status"),this.aba_status=this.dialog.find(".aba_status"),this.btn_nova_mensagem=this.dialog.find(".btn_nova_mensagem"),this.btn_nova_mensagem_refresh=this.dialog.find(".btn_nova_mensagem_refresh"),this.template_grupo=this.dialog.find("[template-grupo]"),this.template_campo=this.dialog.find("[template-campo]"),this.tab_listagem_historico=this.dialog.find(".tab_listagem_historico"),this.div_contato=this.dialog.find(".div_contato"),this.div_contato=this.dialog.find(".div_contato"),this.div_btn_detalhes_contato_editar=this.dialog.find(".div_detalhes_contato_editar"),this.div_btn_detalhes_entidade_editar=this.dialog.find(".div_detalhes_entidade_editar"),this.div_carregar_mais=this.dialog.find(".div_carregar_mais"),this.btn_carregar_mais=this.dialog.find(".btn_carregar_mais"),this.div_component_cbo_clientes=this.dialog.find(".div_component_cbo_clientes"),this.cboClientes=e.createElement(o,{initial_values:{placeholder:"Nome da Entidade"}},null),this.divs_informativo_prazo=[],this.div_group_menu_superior=this.dialog.find(".div_group_menu_superior"),this.oportunidade=null,this.oportunidade_id=null,this.status_id=null,this.entidade_tipo=null,this.entidade_id=null,this.entidade_nome=null,this.entidade_razao_social=null,this.arr_itens=[],this.arr_listar_itens=[],this.arr_agendas=[],this.arr_convidados=[],this.parametros_item=null,this.tem_itens=!1,this.arr_observacoes=null,this.obrigar_regra_tabela_preco="N",this.notificar_regra_tabela_preco="N",this.permitir_tabela_preco_vencida="S",this.contatos_entidade="S",this.utilizar_unidade_medida="N",this.bloquear_unidade_medida="N",this.utilizar_unidade_medida2="N",this.utilizar_unidade_medida2="N",this.utilizar_data_validade_orcamento="N",this.edt_transportador=null,this.entidade_nome=null,this.exibir_carteira_representante="N",this.funil_notificar_outras_entidades="N",this.motivo_perda_negocio=null,this.motivo_perda_negocio=null,this.tipo_representante,this.tipo_representante2,this.oportunidade_origem_id=null,this.exibir_itens_sem_tabela_preco=!1,this.condicao_pagamento_id=null,this.condicao_pagamento_descricao=null,this.funil_vendas_id=null,this.editar_preco=!1,this.editar_desconto=!1,this.nao_permitir_item_repetido=!1,this.representante_usuario_id=null,this.representante_usuario_id2=null,this.campos_personalizados=null,this.exibir_info_lucro="N",this.edt_representante=null,this.edt_representante2=null,this.edt_entidades=null,this.edt_contatos=null,this.parametro_busca_automatica=!0,this.tipo_edt_quantidade="",this.considera_valor_PE=!1,this.tabela_preco_possui_entidade=!1,this.utilizar_codigo_pedido_item="N",this.utilizar_prazo_dias_item="N",this.editar_observacoes_item="N",this.exibir_organizacao_efetivada_oportunidade=!0,this.calcular_desconto_por_percentual=null,this.utilizar_controle_sequencia_orcamento=!1,this.tipo_moeda_id=null,this.tipo_moeda_simbolo=null,this.scroll={historico:{limite:0,incrementar_limite:!1,limite_a_cada:100,controle_ignore_error:!1,ultimo_limite_incrementado:0,bloqueia_limite:!1}},this.arr_dados_itens=[],this.filtros={},this.entidade_objeto={};var n=1,d=2,r="M";this.arr_funil_vendas_colunas=[{coluna_nome:"Itens",visivel:!0},{coluna_nome:"Orçamentos",visivel:!0},{coluna_nome:"Status",visivel:!0},{coluna_nome:"Eventos",visivel:!0},{coluna_nome:"Referências",visivel:!0},{coluna_nome:"Convidados",visivel:!0},{coluna_nome:"Observações",visivel:!0},{coluna_nome:"Histórico",visivel:!0}],this.total_itens=0,this.show=function(e,a,o){i.scrollview.dxScrollView().dxScrollView("instance"),i.scrollview.css("height","calc(100vh - 90px)"),void 0===o?WS.get("oportunidade/objeto/",{oportunidade_id:e},function(e){i.arr_funil_vendas_colunas=e.funil_vendas_colunas,i.etiquetas=e.etiquetas.map(e=>e.etiqueta_id),i.utilizar_itens_orcamento="S"==e.utilizar_itens_orcamento,i.formulario_oportunidade_id=e.formulario_oportunidade_id,i.funil_vendas_nome=e.funil_vendas_nome,i.formulario_nome=e.formulario_nome,i.init(e.id,a,e.funil_vendas_id)}):WS.get("funil_vendas/configuracoes/",{funil_vendas_id:o},function(t){i.arr_funil_vendas_colunas=t.colunas,i.utilizar_itens_orcamento="S"==t.utilizar_itens_orcamento,i.formulario_oportunidade_id=t.formulario_oportunidade_id,i.funil_vendas_nome=t.nome,i.formulario_nome=t.formulario_nome,i.init(e,a,o)}),i.btn_historico_entidade.tooltip({title:"Histórico da entidade",placement:"bottom"})},this.renderiza_componentes=function(){i.renderiza_combobox_cliente(),i.cboClientes.props.setCliente(i.filtros),i.cboClientes.props.setFunctionSelect(i.evt_alterar_cliente)},this.adicionarDadosContato=function(e){i.div_detalhes_contato.find("div:not(.pull-right)").remove(),e&&(i.adicionarEmailContato(e.email),i.adicionarTelefoneContato(e.telefone1),i.adicionarTelefoneContato(e.telefone2),i.adicionarTelefoneContato(e.telefone3),i.adicionarTelefoneContato(e.telefone4));var a=i.div_detalhes_contato.find("div").first();a.detach(),a.appendTo(i.div_detalhes_contato)},this.adicionarEmailContato=function(e){if(!e)return!1;let a=$('<span class="text-muted contato_texto">');a.text(e.toLowerCase());let o=$('<span class="text-muted contato_botoes" style="display: none;">');$('<a style="padding-left: 6px;"><i class="fas fa-envelope"></i></a>').attr("href","javascript:;").on("click",()=>{App.download("mailto:"+e.toLowerCase()),i.salvarHistorico("Ação no E-mail",e.toLowerCase())}).appendTo(o);let t=$('<div class="contato_item col-xs-12 col-sm-12 col-md-12 col-lg-12">').append(a).append(o);i.div_detalhes_contato.append(t)},this.adicionarTelefoneContato=function(e){if(!e)return!1;let a=$('<span class="text-muted contato_texto">');a.text(e);let o=$('<span class="text-muted contato_botoes" style="display: none;">');$('<a style="padding-left: 6px;"><i class="fas fa-phone"></i></a>').attr("href","javascript:;").on("click",()=>{App.download("tel:"+e),i.salvarHistorico("Ação no Telefone",e)}).appendTo(o);const t=e.trim().replace(/\D/g,"");let n="";("("===e.trim().substr(0,1)||"+"!==e.trim().substr(0,1)||t.length<=11)&&(n="55"),$('<a style="padding-left: 6px;"><i class="fab fa-whatsapp"></i></a>').attr("href","https://api.whatsapp.com/send?phone="+n+t).attr("target","_blank").on("click",()=>{i.salvarHistorico("Ação no Whatsapp",e)}).appendTo(o);let d=$('<div class="contato_item col-xs-12 col-sm-12 col-md-12 col-lg-12">').append(a).append(o);i.div_detalhes_contato.append(d)},this.salvarHistorico=function(e,a){var o={oportunidade_id:i.oportunidade_id,acao:OPORTUNIDADE_HISTORICO_ACAO.VISUALIZACAO,coluna:e,valor_anterior:"",valor_novo:a};WS.post("oportunidade_historico/salvar/",o,function(e){})},this.renderiza_combobox_cliente=function(){a.render(i.cboClientes,i.div_component_cbo_clientes[0]),i.cboClientes.props.setConfiguracoes={main_externo:i,exibe_tipo_entidade:!0,placeholder:"Filtro por Cliente",WS_params:{desconsiderar_empresa:!0,desconsiderar_fornecedor:!0,limite:0,cadastra_novo:!0,representante_usuario_id:i.representante_usuario_id,representante_usuario_id2:i.representante_usuario_id2,funil_apenas_carteira_representante:"S"==i.exibir_carteira_representante,funil_notificar_outras_entidades:"S"==i.funil_notificar_outras_entidades,exibir_organizacao_efetivada_oportunidade:i.exibir_organizacao_efetivada_oportunidade,parametro_tela:"oportunidade"}}},this.evt_alterar_cliente=function(){if(i.filtros=spread({},i.filtros,{cliente_id:i.cboClientes.props.ClienteSelecionado.id,cliente_nome:i.cboClientes.props.ClienteSelecionado.nome_fantasia,cliente_tipo:i.cboClientes.props.ClienteSelecionado.tipo,notificar_outras_entidades:i.cboClientes.props.ClienteSelecionado.notificar_outras_entidades,tabela_preco_id:0,tabela_preco_descricao:null,condicao_pagamento_id:0,condicao_pagamento_descricao:null,tabela_preco_dtFinal:null,tabela_preco_dentroPrazo:null}),"S"==i.cboClientes.props.ClienteSelecionado.possui_restricao){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Cliente "'+i.cboClientes.props.ClienteSelecionado.nome_fantasia+'" possuí pendências financeiras.')),alert_modal("Restrição Financeira",e)}i.entidade_id=i.filtros.entidade_id,i.entidade_tipo=i.filtros.entidade_tipo,i.entidade_nome=i.filtros.entidade_nome,i.cbo_contatos.parent().find(".edt_combobox").val(""),i.adicionarDadosContato(),i.div_btn_detalhes_contato_editar.addClass("hidden"),"S"!=i.filtros.notificar_outras_entidades&&"S"!=i.funil_notificar_outras_entidades||WS.get("oportunidade/checa_vinculo_usuario/",{organizacao_id:i.filtros.cliente_id,tipo:i.filtros.cliente_tipo},function(e){if(e.length>0){var a=!0;if($.each(e,function(e,o){o.usuario_id==i.representante_usuario_id&&(a=!1)}),1==a){var o=e.map(function(e){return null!=e.nome?e.nome:""}),t=new Validation;return t.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Cliente ou Organização vinculado a outro(s) representante(s): ["+o.toString()+"].")),alert_modal("Validação",t),i.cboClientes.props.setCliente({cliente_id:null,cliente_nome:""}),i.entidade_id=null,i.entidade_nome=null,i.entidade_tipo=null,i.filtros.cliente_id=null,i.filtros.cliente_nome=null,void(i.filtros.cliente_tipo=null)}}}),WS.get("/oportunidade/dados_padrao_da_entidade/",{entidade_id:i.filtros.cliente_id,tipo_entidade:i.filtros.cliente_tipo},function(e){i.filtros.tabela_preco_id=e.tabela_preco_id,i.filtros.tabela_preco_descricao=e.tabela_preco_nome,i.filtros.tabela_preco_dtFinal=e.tabela_preco_data_final,i.filtros.tabela_preco_dentroPrazo=e.tabela_dentro_prazo,i.filtros.condicao_pagamento_id=e.condicao_pagamento_id,i.filtros.condicao_pagamento_descricao=e.condicao_pagamento_nome,"C"==i.filtros.tipo||i.filtros.tipo,void 0!==i.cboClientes.props.ClienteSelecionado?(i.preencher_info_entidade(i.cboClientes.props.ClienteSelecionado),i.setConfigEditarEntidade(i.cboClientes.props.ClienteSelecionado),i.sugerir_configuracoes_da_entidade(i.filtros.tabela_preco_id,i.filtros.tabela_preco_descricao,i.filtros.condicao_pagamento_id,i.filtros.condicao_pagamento_descricao,i.filtros.tabela_preco_dtFinal,i.filtros.tabela_preco_dentroPrazo)):(i.tipo_entidade.text(""),i.codigo_unidade_entidade.text(""),i.cnpj_entidade.text(""),i.email_entidade.text(""),i.email_entidade.attr("href","javascript:;"),i.telefone1_entidade.text(""),i.telefone1_entidade.attr("href","javascript:;"),i.telefone2_entidade.text(""),i.telefone2_entidade.attr("href","javascript:;"),i.telefone3_entidade.text(""),i.telefone3_entidade.attr("href","javascript:;"),i.telefone4_entidade.text(""),i.telefone4_entidade.attr("href","javascript:;"),i.div_btn_detalhes_entidade_editar.addClass("hidden"))})},this.init=function(e,a,o){i.funil_vendas_id=o,WS.get("itens/get_parametros/",null,function(e){i.parametros_item=e,"N"==i.parametros_item.item_desconto&&i.div_total_desconto_item.addClass("hidden"),"N"==i.parametros_item.imposto_ipi&&i.div_total_ipi.addClass("hidden")}),i.parametro_busca_automatica="N"==App.sessao.dados.busca_automatica,create_combobox(i.cbo_representante,i.listar_representante,null,!1,{pesquisar_enter:i.parametro_busca_automatica,pesquisar_tudo_seta:!1}),create_combobox(i.cbo_representante2,i.listar_representante2,null,!1,{pesquisar_enter:i.parametro_busca_automatica,pesquisar_tudo_seta:!1}),create_combobox(i.cbo_contatos,i.listar_contatos,null,!1,{pesquisar_enter:i.parametro_busca_automatica}),i.listar_tipo_oportunidade(),create_combobox(i.cbo_funil,i.listar_funil,null,!1,{pesquisar_enter:i.parametro_busca_automatica}),i.listar_etapas(),create_combobox(i.cbo_convidados,i.listar_convidados,null,!1,{pesquisar_enter:i.parametro_busca_automatica}),create_combobox(i.cbo_tabela_preco,i.listar_tabela_preco,null,!1,{pesquisar_enter:i.parametro_busca_automatica,pesquisar_tudo_seta:!1}),create_combobox(i.cbo_condicao_pagamento,i.listar_condicao_pagamento,null,!1,{pesquisar_enter:i.parametro_busca_automatica,pesquisar_tudo_seta:!1}),create_combobox(i.cbo_transportador,i.listar_transportador,null,!1,{pesquisar_enter:i.parametro_busca_automatica}),i.btn_novo_contato(),i.btn_novo_funil(),i.tipo=a,i.aba_itens.attr("id","aba_itens"+i.html_id),i.aba_orcamentos.attr("id","aba_orcamentos"+i.html_id),i.aba_status.attr("id","aba_status"+i.html_id),i.aba_agenda.attr("id","aba_agenda"+i.html_id),i.aba_convidados.attr("id","aba_convidados"+i.html_id),i.aba_observacoes.attr("id","aba_observacoes"+i.html_id),i.aba_historico.attr("id","aba_historico"+i.html_id),i.aba_personalizado.attr("id","aba_personalizado"+i.html_id),i.aba_referencias.attr("id","aba_referencias"+i.html_id);var t=null,n=null,d=null,r=null,s=null,_=0,l=null;i.arr_funil_vendas_colunas.forEach(function(e,a){if(1==e.visivel||!0===e.visivel||"S"==e.visivel){t=removerAcentos(e.coluna_nome.toLowerCase().replace(" ","_"));let a=e.coluna_nome;switch(t){case"itens":if(n="menu_item",d=i.aba_itens,!i.utilizar_itens_orcamento)return;break;case"orcamentos":if(n="menu_orcamentos",d=i.aba_orcamentos,!i.utilizar_itens_orcamento)return;break;case"status":n="menu_status",d=i.aba_status;break;case"eventos":n="menu_agenda",d=i.aba_agenda;break;case"convidados":n="menu_convidados",d=i.aba_convidados;break;case"observacoes":n="menu_observacoes",d=i.aba_observacoes;break;case"historico":n="menu_historico",d=i.aba_historico;break;case"referencias":n="menu_referencias",d=i.aba_referencias;break;case"formulario_personalizado":if(n="menu_personalizado",d=i.aba_personalizado,!i.formulario_oportunidade_id)return;a=i.formulario_nome;break;default:n=null,d=null}if(!n||!d)return;_+=1,s=$("<a>").addClass(n).attr("href","#"+d.attr("id")).attr("role","tab").attr("data-toggle","tab").text(a),r=$("<li>").addClass("tab_"+t).append(s),1===_&&(r.addClass("active"),d.addClass("active"),l=n),i.nav_oportunidade.append(r)}}),i.tab_itens=i.dialog.find(".tab_itens"),i.tab_orcamentos=i.dialog.find(".tab_orcamentos"),i.tab_status=i.dialog.find(".tab_status"),i.tab_convidados=i.dialog.find(".tab_convidados"),i.tab_eventos=i.dialog.find(".tab_eventos"),i.tab_historico=i.dialog.find(".tab_historico"),i.tab_observacoes=i.dialog.find(".tab_observacoes"),i.tab_referencias=i.dialog.find(".tab_referencias"),i.menu_referencias=i.dialog.find(".menu_referencias"),i.menu_referencias.unbind("click").click(function(){i.menu_referencias.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(i.div_componente_referencias[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"oportunidade",id:i.oportunidade_id,entidadeId:i.entidade_id,entidadeTipo:i.entidade_tipo}),i.div_componente_referencias[0]))}),set_datepicker(i.edt_data_fechamento),set_datepicker(i.edt_data_entrega),set_datepicker(i.edt_validade_orcamento),i.edt_valor_negocio.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_perc_total_desconto_oportunidade.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:4}),i.edt_total_desconto_oportunidade.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_valor_frete.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2});var c=i.cbo_representante.parent();switch(i.edt_representante=c.find(".edt_combobox"),c=i.cbo_representante2.parent(),i.edt_representante2=c.find(".edt_combobox"),1!=App.sessao.dados.admin&&"S"!=App.sessao.dados.admin&&"S"!=App.sessao.dados.supervisor_atendimento_relacionamento&&i.edt_representante.prop("readonly",!0),c=i.cbo_contatos.parent(),i.edt_contatos=c.find(".edt_combobox"),c=i.cbo_funil.parent(),i.edt_funil=c.find(".edt_combobox"),i.edt_funil.prop("readonly",!0),c=i.cbo_convidados.parent(),i.edt_convidados=c.find(".edt_combobox"),c=i.cbo_tabela_preco.parent(),i.edt_tabela_preco=c.find(".edt_combobox"),c=i.cbo_condicao_pagamento.parent(),i.edt_condicao_pagamento=c.find(".edt_combobox"),c=i.cbo_transportador.parent(),i.edt_transportador=c.find(".edt_combobox"),i.edt_convidados.keypress(function(e){if(13==e.keyCode){var a=i.cbo_convidados.parent(),o=a.find(".ncbo_scroll").find(".row_selected").attr("id_registro");null!=o&&""!=o&&(i.relacionar_convidado(o),a.find(".ncbo_item").removeClass("bg-primary"),a.find(".ncbo_item").removeClass("row_selected"))}}),i.edt_tabela_preco.keypress(function(e){if(13==e.keyCode){if(0==i.edt_tabela_preco.val().length)return;var a=i.cbo_tabela_preco.parent(),o=a.find(".ncbo_scroll").find(".row_selected");if(o.attr("id_registro"),a.find(".ncbo_item").removeClass("bg-primary"),a.find(".ncbo_item").removeClass("row_selected"),"S"==i.notificar_regra_tabela_preco){var t=o.attr("dados-adicionais")?JSON.parse(o.attr("dados-adicionais")):null;if(t){var n=function(){"N"==t.dentro_prazo?alert_modal("2. Data de vigência","A tabela de preços <strong>"+t.descricao+"</strong> desta entidade está fora do prazo.<br><br>Deseja vinculá-la à oportunidade mesmo assim?","Vincular mesmo assim",function(){set_value_combobox(i.cbo_tabela_preco,t.tabela_precos_id,t.descricao),i.entidade_tabela_preco_id=t.tabela_precos_id},!0,"Não vincular",null,function(){set_value_combobox(i.cbo_tabela_preco,null,null)}):(set_value_combobox(i.cbo_tabela_preco,t.tabela_precos_id,t.descricao),i.entidade_tabela_preco_id=t.tabela_precos_id)},d=function(){alert_modal("1. Vínculo com entidade","A tabela de preço <strong>"+t.descricao+"</strong> não possui vínculo com a entidade selecionada. Deseja vinculá-la mesmo assim?","Vincular mesmo assim",function(){n()},!0,"Não vincular",null,function(){set_value_combobox(i.cbo_tabela_preco,null,null)})};"S"==i.notificar_regra_tabela_preco&&(t.entidade_tipo==i.entidade_tipo&&t.entidade_id!=i.entidade_id?d():"O"==i.entidade_tipo&&t.tabela_precos_id!=t.prospect_tabela_preco_id||"C"==i.entidade_tipo&&t.tabela_precos_id!=t.cliente_tabela_preco_id?d():n())}}}}),i.edt_tabela_preco.change(function(){i.tabela_possui_entidade($(this).val())}),$(i.cbo_representante.parent()).find("input").keypress(function(e){if(13==e.keyCode||13==e.tecla_value){var a=$(this);i.representante_usuario_id=a.attr("selected-value")?a.attr("selected-value"):i.representante_usuario_id,i.tipo_representante=a.attr("dados-adicionais")?a.attr("dados-adicionais"):"E",i.cboClientes.props.setConfiguracoes.WS_params.representante_usuario_id=i.representante_usuario_id}}),$(i.cbo_representante2.parent()).find("input").keyup(function(e){if($(this).val()||(set_value_combobox(i.cbo_representante2,"",""),i.representante_usuario_id2=null,i.tipo_representante2=null,i.cboClientes.props.setConfiguracoes.WS_params.representante_usuario_id2=i.representante_usuario_id2),13==e.keyCode||13==e.tecla_value){var a=$(this);i.representante_usuario_id2=a.attr("selected-value"),i.tipo_representante2=a.attr("dados-adicionais"),i.cboClientes.props.setConfiguracoes.WS_params.representante_usuario_id2=i.representante_usuario_id2}}),i.cbo_origem.SelectMultiColumn({route:"oportunidade_origem/listar/",params:null,arr_cols:["Nome"],arr_campos:["nome"],campo_value:"oportunidade_origem_id",text_value:"nome",habilitar_novo:!1,func_by_response:function(e,a){e.elemento=JSON.stringify(e)},OnKeyUp:function(e,a){var o={nome:i.cbo_origem.SelectMultiColumn("EdtVal")};if(i.cbo_origem.SelectMultiColumn("UpdateParams",o),13==e.which){var t=i.cbo_origem.val();t&&(i.oportunidade_origem_id=t)}},OnClickOverRow:function(e,a){a&&(i.oportunidade_origem_id=a)}}),a){case FORMULARIO.NOVO:i.btn_salvar.show(),i.btn_excluir.hide(),App.titulo_aba(i.html_id,"Novo - Oportunidade"),i.permite_alterar(!0),i.representante_usuario_id=App.sessao.dados.usuario_id,i.renderiza_componentes(),"S"==App.sessao.dados.representante&&set_value_combobox(i.cbo_representante,i.representante_usuario_id,App.sessao.dados.nome,App.sessao.dados.tipo_representante),i.btn_salvar.removeClass("btn-primary"),i.btn_salvar.addClass("btn-warning"),i.btn_salvar.text("Salvar e Continuar"),i.btn_salvar.removeClass("pull-right").addClass("pull-left"),i.btn_cancelar.removeClass("pull-right").addClass("pull-left"),i.btn_excluir.removeClass("pull-right").addClass("pull-left"),i.div_panel.css({cursor:"not-allowed",opacity:"0.5"}),i.div_panel_default.css("pointer-events","none"),i.btn_oportunidade.addClass("hidden"),i.div_panel.addClass("hidden-xs hidden-sm"),i.configuracoes_funil_venda(o),View.loadPE("Oportunidade_Detalhes_Novo",i);break;case FORMULARIO.EDITAR:i.btn_salvar.show(),i.btn_excluir.hide(),i.div_oportunidade.addClass("hidden"),i.esconde_mostra_oportunidade();break;case FORMULARIO.VISUALIZAR:i.btn_salvar.hide(),i.btn_excluir.hide(),i.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:i.btn_salvar.hide(),i.btn_excluir.show(),i.permite_alterar(!1);break;case FORMULARIO.CRIAR_UNIDADE:i.btn_salvar.show(),i.btn_excluir.hide(),i.permite_alterar(!0)}if(void 0!==e&&e)i.oportunidade_id=e,"menu_orcamentos"==l?i.listar_orcamentos():"menu_agenda"==l?i.listar_agenda():"menu_historico"==l?(i.tab_listagem_historico.find("tr:gt(1)").remove(),i.limpar_scroll_historico(),i.listar_historico(!0)):"menu_status"==l&&i.listar_status(),i.preencher();else{set_value_combobox(i.cbo_funil,o,i.funil_vendas_nome);var p=new Object;p.funil_vendas_id=get_value_combobox(i.cbo_funil),WS.get("funil_vendas/listar_etapas/",p,function(e){$(e).each(function(e,a){return i.listar_etapas(a.funil_vendas_etapa_id),!1})}),WS.get("tipo_oportunidade/listar/",null,function(e){var a=null;$(e).each(function(e,o){"S"==o.padrao&&(a=o.tipo_oportunidade_id)}),i.listar_tipo_oportunidade(a)}),i.btn_nova_entidade()}},this.configuracoes_funil_venda=function(e,a){if(!e>0)alert_modal("Funil de vendas não informado","Por favor, defina um Funil de Vendas padrão ou selecione um na listagem de oportunidades antes de continuar.","Ok",function(){i.unload()});else{i.btn_incluir_item.prop("disabled",!0);var o={funil_vendas_id:e};WS.get("funil_vendas/objeto/",o,function(e){if(i.tipo==FORMULARIO.NOVO){if(null!=e.nome_oportunidade_padrao&&i.edt_nome_oportunidade.val(e.nome_oportunidade_padrao),null!=e.observacao_padrao&&""!=e.observacao_padrao&&i.edt_observacao.val(e.observacao_padrao),"S"==e.sugerir_data_atual){var o=new Date,t=("0"+o.getDate()).slice(-2),n=("0"+(o.getMonth()+1)).slice(-2),d=o.getFullYear()+"-"+n+"-"+t;set_datepicker(i.edt_data_fechamento,d)}"S"==e.sugerir_situacao_negocio_ganho&&i.cbo_situacao.val("G")}"N"==e.utiliza_contato&&i.div_contato.hide(),"N"==e.utilizar_data_validade_orcamento?i.div_validade_orcamento.hide():i.div_validade_orcamento.show(),"S"==e.utilizar_representante2&&i.div_representante2.removeClass("hidden"),"S"==e.utiliza_origem&&i.div_origem.removeClass("hidden"),"S"!=e.utilizar_motivo_desconto&&!0!==e.utilizar_motivo_desconto||i.div_motivo_desconto.removeClass("hidden"),i.utilizar_controle_sequencia_orcamento="S"==e.utilizar_controle_sequencia_orcamento||!0===e.utilizar_controle_sequencia_orcamento,i.exibir_info_lucro=e.exibir_info_lucro,"S"!=e.exibir_info_lucro&&(i.div_custo.addClass("hidden"),i.div_percentual_lucro_bruto.addClass("hidden"),i.div_valor_lucro_bruto.addClass("hidden")),i.contatos_entidade=e.contatos_entidade,i.obrigar_regra_tabela_preco=e.obrigar_regra_tabela_preco,i.notificar_regra_tabela_preco=e.notificar_regra_tabela_preco,i.permitir_tabela_preco_vencida=e.permitir_tabela_preco_vencida,i.utilizar_unidade_medida=e.utilizar_unidade_medida,i.bloquear_unidade_medida=e.bloquear_unidade_medida,i.utilizar_unidade_medida2=e.utilizar_unidade_medida2,i.bloquear_unidade_medida2=e.bloquear_unidade_medida2,i.exibir_carteira_representante=e.exibir_carteira_representante,i.funil_notificar_outras_entidades=e.notificar_outras_entidades,i.arredondamento_automatico_preco_com_desconto=e.arredondamento_automatico_preco_com_desconto,i.exibir_itens_sem_tabela_preco=e.exibir_itens_sem_tabela_preco,i.condicao_pagamento_id=e.condicao_pagamento_id,i.condicao_pagamento_descricao=e.condicao_pagamento_descricao,i.editar_preco=e.editar_preco,i.editar_desconto=e.editar_desconto,i.nao_permitir_item_repetido=e.nao_permitir_item_repetido,i.utilizar_codigo_pedido_item=e.utilizar_codigo_pedido_item,i.utilizar_prazo_dias_item=e.utilizar_prazo_dias_item,i.editar_observacoes_item=e.editar_observacoes_item,i.exibir_organizacao_efetivada_oportunidade="S"==e.exibir_organizacao_efetivada_oportunidade,a&&a(),i.oportunidade&&"G"==i.oportunidade.situacao||i.btn_incluir_item.prop("disabled",!1),i.renderiza_componentes(),i.btn_nova_entidade(),i.preencher_info_entidade(i.entidade_objeto)})}},this.close=function(){void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){for(var e=0;e<i.divs_informativo_prazo.length;e++)i.divs_informativo_prazo[e].props.desativarRefreshAutomatico();i.close(),View.unload(this.html_id)},this.permite_alterar=function(e){i.edt_nome_oportunidade.prop("disabled",!e);var a={aoAlterar:(e,a)=>{i.tipo_moeda_id=e,i.tipo_moeda_simbolo=a.simbolo,i.alterarTipoMoeda()},selecionado:i.tipo_moeda_id,readOnly:!e};ReactDOM.render(React.createElement(window.components.SelecaoTipoMoeda.default,a),i.div_componente_tipo_moeda[0])},this.preencher=function(){var e=new Object;e.oportunidade_id=i.oportunidade_id,WS.get("oportunidade/objeto/",e,function(e){i.oportunidade=e,"G"==e.situacao&&(i.btn_salvar.prop("disabled",!0),i.btn_gerar_orcamento.prop("disabled",!0)),i.entidade_razao_social=e.entidade_razao_social,i.filtros=spread({},i.filtros,{cliente_id:e.entidade_id,cliente_nome:e.entidade_nome,cliente_tipo:e.entidade_tipo}),App.titulo_aba(i.html_id,e.nome.substring(0,10)+" - Oportunidade #"+e.id+" ");var a={email:e.email,telefone1:e.telefone1,telefone2:e.telefone2,telefone3:e.telefone3,telefone4:e.telefone4};a.email||a.telefone1||a.telefone2||a.telefone3||a.telefone4?i.adicionarDadosContato(a):(i.div_detalhes_contato.hasClass("hidden")||(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato()),i.div_btn_detalhes_contato.tooltip({title:"Este Contato não possui informações (E-Mail e/ou telefone)",placement:"right"}),i.div_btn_detalhes_contato.tooltip()),i.setConfigEditarContatos(spread({},a,{id:e.contato_id})),set_value_combobox(i.cbo_contatos,e.contato_id,e.contato_nome,JSON.stringify(a)),i.entidade_objeto={id:e.entidade_id,tipo:"C"==e.entidade_tipo?"Cliente":"Organização",codigo_entidade:e.codigo_entidade,unidade_entidade:e.unidade_entidade,cnpj:e.cnpj_entidade,email_principal:e.email_entidade,telefone1:e.telefone1_entidade,telefone2:e.telefone2_entidade,telefone3:e.telefone3_entidade,telefone4:e.telefone4_entidade,cep:e.cep_entidade,endereco:e.endereco_entidade,numero:e.numero_entidade,complemento:e.complemento_entidade,bairro:e.bairro_entidade,cidade:e.cidade_entidade,uf_sigla:e.uf_sigla_entidade,entidade_nome:e.entidade_nome},i.setConfigEditarEntidade(spread({},i.entidade_objeto,{tipo:e.entidade_tipo})),i.entidade_tipo=e.entidade_tipo,i.entidade_id=e.entidade_id,i.entidade_nome=e.entidade_nome,i.cbo_origem.SelectMultiColumn("refresh"),i.cbo_origem.SelectMultiColumn("val",e.oportunidade_origem_id),i.oportunidade_origem_id=e.oportunidade_origem_id,i.edt_nome_oportunidade.val(e.nome),i.listar_tipo_oportunidade(e.tipo_oportunidade_id),set_value_combobox(i.cbo_funil,e.funil_vendas_id,e.funil_vendas_nome),i.listar_etapas(e.funil_vendas_etapa_id),set_datepicker(i.edt_data_fechamento,e.data_fechamento),i.tipo_moeda_id=e.tipo_moeda_id,i.tipo_moeda_simbolo=e.tipo_moeda_simbolo,i.alterarTipoMoeda(),i.edt_valor_negocio.maskMoney("mask",parseFloat(e.valor_negocio)),i.edt_perc_total_desconto_oportunidade.maskMoney("mask",parseFloat(e.percentual_desconto)),i.edt_total_desconto_oportunidade.maskMoney("mask",parseFloat(e.valor_desconto)),i.calcular_desconto_por_percentual=e.calcular_desconto_por_percentual,i.configuracoes_funil_venda(e.funil_vendas_id,function(){i.representante_usuario_id=e.representante_usuario_id,i.representante_usuario_id2=e.representante_usuario2_id,i.cbo_situacao.val(e.situacao),i.renderiza_componentes(),set_value_combobox(i.cbo_representante,i.representante_usuario_id,e.representante_nome),set_value_combobox(i.cbo_representante2,i.representante_usuario_id2,e.representante_nome2),set_value_combobox(i.cbo_condicao_pagamento,e.condicao_pagamento_id,e.condicao_pagamento_descricao),set_value_combobox(i.cbo_transportador,e.transportadora_id,e.transportadora_nome),i.edt_motivo_desconto.val(e.motivo_desconto),i.edt_observacao_condicao_pagamento.val(e.observacao_condicao_pagamento),i.cbo_tipo_frete.val(e.tipo_frete),i.cbo_tipo_frete.selectpicker("refresh"),i.edt_valor_frete.maskMoney("mask",parseFloat(e.valor_frete)),i.edt_observacao_frete.val(e.observacao_frete),set_datepicker(i.edt_data_entrega,e.data_entrega),i.edt_observacao_entrega.val(e.observacao_entrega),i.edt_observacao.val(e.observacao),i.edt_observacao_nf.val(e.observacao_nf),set_datepicker(i.edt_validade_orcamento,e.validade_orcamento),set_value_combobox(i.cbo_tabela_preco,e.tabela_preco_id,e.tabela_preco_descricao),i.arr_itens=e.arr_itens,i.render_itens(),i.arr_agendas=e.arr_agendas,i.render_agendas(),i.render_convidados(),i.render_observacoes(),View.loadPE("Oportunidade_Detalhes_Preencher",i)}),i.tipo==FORMULARIO.EDITAR&&i.permite_alterar(!0)}),i.renderDropDownEtiquetas()},this.listar_condicao_pagamento=function(e){var a=new Object;a.descricao=i.edt_condicao_pagamento.val(),a.bloqueado="N",a.entidade_id=i.entidade_id,WS.get("condicao_pagamento/listar/",a,function(a){limpar_combobox(i.cbo_condicao_pagamento),$(a).each(function(e,a){var o=[];o["Descrição"]=a.descricao,add_option_combobox(i.cbo_condicao_pagamento,e,a.condicao_pagamento_id,o)}),e(!0)})},this.listar_transportador=function(e){var a=new Object;a.nome_fantasia=i.edt_transportador.val(),a.classificacao="T",a.limite=0,WS.get("fornecedor/listar/",a,function(a){limpar_combobox(i.cbo_transportador),$(a).each(function(e,a){var o=[];o["Nome Fantasia"]=a.nome_fantasia,add_option_combobox(i.cbo_transportador,e,a.fornecedor_id,o)}),e(!0)})},this.listar_tabela_preco=function(e){var a=new Object;a.descricao=i.edt_tabela_preco.val(),a.entidade_id=i.entidade_id,a.entidade_tipo=i.entidade_tipo,a.funil_vendas_id=get_value_combobox(i.cbo_funil),WS.get("tabela_precos/listar/",a,function(a){null!=a.entidade_nome&&(i.tabela_preco_possui_entidade=!0),limpar_combobox(i.cbo_tabela_preco),$(a).each(function(e,a){var o=[];o["Descrição"]=a.descricao,add_option_combobox(i.cbo_tabela_preco,e,a.tabela_precos_id,o,null,JSON.stringify(a))}),i.cbo_tabela_preco.parent().find(".ul_row").click(function(){if("S"==i.notificar_regra_tabela_preco){var e=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;if(e){var a=function(){"N"==e.dentro_prazo?alert_modal("2. Data de vigência","A tabela de preços <strong>"+e.descricao+"</strong> desta entidade está fora do prazo.<br><br>Deseja vinculá-la à oportunidade mesmo assim?","Vincular mesmo assim",function(){set_value_combobox(i.cbo_tabela_preco,e.tabela_precos_id,e.descricao),i.entidade_tabela_preco_id=e.tabela_precos_id},!0,"Não vincular",null,function(){set_value_combobox(i.cbo_tabela_preco,null,null)}):(set_value_combobox(i.cbo_tabela_preco,e.tabela_precos_id,e.descricao),i.entidade_tabela_preco_id=e.tabela_precos_id)},o=function(){alert_modal("1. Vínculo com entidade","A tabela de preço <strong>"+e.descricao+"</strong> não possui vínculo com a entidade selecionada. Deseja vinculá-la mesmo assim?","Vincular mesmo assim",function(){a()},!0,"Não vincular",null,function(){set_value_combobox(i.cbo_tabela_preco,null,null)})};"S"==i.notificar_regra_tabela_preco&&(e.entidade_tipo==i.entidade_tipo&&e.entidade_id!=i.entidade_id?o():"O"==i.entidade_tipo&&e.tabela_precos_id!=e.prospect_tabela_preco_id||"C"==i.entidade_tipo&&e.tabela_precos_id!=e.cliente_tabela_preco_id?o():a())}}i.tabela_possui_entidade($(this).parent().text().trim())}),e(!0)})},this.listar_representante=function(e){var a=new Object;a.nome_fantasia=i.edt_representante.val(),WS.get("representante/listar/",a,function(a){limpar_combobox(i.cbo_representante),$(a).each(function(e,a){var o=[];o.Nome=a.nome_fantasia,1==App.sessao.dados.admin?add_option_combobox(i.cbo_representante,e,a.usuario_id,o,null,a.tipo_representante):"S"==App.sessao.dados.supervisor_atendimento_relacionamento&&add_option_combobox(i.cbo_representante,e,a.usuario_id,o,null,a.tipo_representante)}),e(!0),$(i.cbo_representante.parent()).find(".ul_row").click(function(){var e=$(this).parent();i.representante_usuario_id=e.attr("id_registro"),i.tipo_representante=e.attr("dados-adicionais")?e.attr("dados-adicionais"):"E",i.cboClientes.props.setConfiguracoes.WS_params.representante_usuario_id=i.representante_usuario_id,setTimeout(function(){i.cbo_representante.parent().find("input").trigger("change")})})})},this.listar_representante2=function(e){var a=new Object;a.nome_fantasia=i.edt_representante2.val(),WS.get("representante/listar/",a,function(a){limpar_combobox(i.cbo_representante2),$(a).each(function(e,a){var o=[];o.Nome=a.nome_fantasia,add_option_combobox(i.cbo_representante2,e,a.usuario_id,o,null,a.tipo_representante)}),e(!0),$(i.cbo_representante2.parent()).find(".ul_row").click(function(){var e=$(this).parent();i.representante_usuario_id2=e.attr("id_registro"),i.tipo_representante2=e.attr("dados-adicionais")?e.attr("dados-adicionais"):"E",i.cboClientes.props.setConfiguracoes.WS_params.representante_usuario_id2=i.representante_usuario_id2})})},this.listar_convidados=function(e){var a=new Object;a.nome=i.edt_convidados.val(),a.considerar_todos=!0,WS.get("supervisor/listar_representantes_supervisionados/",a,function(a){limpar_combobox(i.cbo_convidados),$(a).each(function(e,a){var o=[];o.Nome=a.usuario_nome,add_option_combobox(i.cbo_convidados,e,a.usuario_id,o)}),i.cbo_convidados.parent().find(".ul_row").click(function(){var e=$(this).parent().attr("id_registro");i.relacionar_convidado(e)}),e(!0)})},this.relacionar_convidado=function(e){if(!(e>0)){var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Representante não encontrado")),void alert_modal("Validação",a)}var o={oportunidade_id:i.oportunidade_id,representante_usuario_id:e};WS.post("oportunidade/incluir_convidado/",o,function(e){set_value_combobox(i.cbo_convidados,"",""),i.edt_convidados.val(""),i.edt_convidados.focus(),i.render_convidados()})},this.btn_novo_contato=function(){var e=i.cbo_contatos.parent().find(".btn_novo"),a=i.cbo_contatos.parent();i.edt_contatos=a.find(".edt_combobox"),e.click(function(){if(null==i.filtros.cliente_id){e.addClass("hidden");var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Informe a Entidade")),void alert_modal("Validação",a)}View.load("contato/detalhes",function(e,a){a.onsave=function(e){set_value_combobox(i.cbo_contatos,e.id,e.nome,JSON.stringify(e)),e.email||e.telefone1||e.telefone2||e.telefone3||e.telefone4?(i.adicionarDadosContato(e),i.div_btn_detalhes_contato.tooltip("destroy")):(i.div_detalhes_contato.hasClass("hidden")||(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato()),i.div_btn_detalhes_contato.tooltip({title:"Este Contato não possui informações (E-Mail e/ou telefone)",placement:"right"}),i.div_btn_detalhes_contato.tooltip());var a={id:e.id};i.setConfigEditarContatos(a),i.cbo_contatos.parent().find(".btn_novo").addClass("hidden"),set_focus(i.edt_entidades)},a.show(null,FORMULARIO.NOVO,null,i.edt_contatos.val(),i.entidade_tipo,i.entidade_id)},View.ABA.SIM)})},this.listar_contatos=function(e){var a=new Object;if(a.nome=i.edt_contatos.val(),a.cliente_id=null,a.prospect_id=null,a.limite=0,"N"==i.contatos_entidade)a.cliente_id=null,a.prospect_id=null;else if(null!=i.filtros&&("C"==i.filtros.cliente_tipo?(a.cliente_id=i.filtros.cliente_id,a.prospect_id=null):(a.cliente_id=null,a.prospect_id=i.filtros.cliente_id)),!a.cliente_id&&!a.prospect_id){var o=new Validation;return o.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Escolha uma entidade e tente novamente.")),void alert_modal("Validação",o)}WS.get("contato/listar/",a,function(a){limpar_combobox(i.cbo_contatos),$(a).each(function(e,a){var o=[];o.Nome=a.nome,add_option_combobox(i.cbo_contatos,e,a.contato_id,o,null,JSON.stringify(a))}),a.length>0?e(!0):(e(!1),i.div_detalhes_contato.hasClass("hidden")||(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato())),$(i.cbo_contatos.parent()).find(".ul_row").click(function(){var e=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;e&&(e.email||e.telefone1||e.telefone2||e.telefone3||e.telefone4?(i.adicionarDadosContato(e),i.div_btn_detalhes_contato.tooltip("destroy")):(i.div_detalhes_contato.hasClass("hidden")||(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato()),i.div_btn_detalhes_contato.tooltip({title:"Este Contato não possui informações (E-Mail e/ou telefone)",placement:"right"}),i.div_btn_detalhes_contato.tooltip())),i.setConfigEditarContatos(e)}),$(i.cbo_contatos.parent()).find("input").keypress(function(e){if(13==e.keyCode||13==e.tecla_value){var a=null;""!=$(this).val()&&(a=$(this).attr("dados-adicionais")?JSON.parse($(this).attr("dados-adicionais")):null),a?(a.email||a.telefone1||a.telefone2||a.telefone3||a.telefone4?(i.adicionarDadosContato(a),i.div_btn_detalhes_contato.tooltip("destroy")):(i.div_detalhes_contato.hasClass("hidden")||(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato()),i.div_btn_detalhes_contato.tooltip({title:"Este Contato não possui informações (E-Mail e/ou telefone)",placement:"right"}),i.div_btn_detalhes_contato.tooltip()),i.setConfigEditarContatos(a)):(i.adicionarDadosContato(),i.div_btn_detalhes_contato_editar.addClass("hidden"))}})})},this.preencher_info_entidade=function(e){var a="";if("C"==e.tipo||"Cliente"==e.tipo?(a="Cliente",i.entidade_tipo="C"):"O"!=e.tipo&&"Organização"!=e.tipo||(a="Organização",i.entidade_tipo="O"),i.entidade_id=e.id,i.edt_entidades.attr("selected-value",i.entidade_id),i.entidade_nome=e.entidade_nome?e.entidade_nome:"",e.cnpj||e.email_principal||e.telefone1||e.telefone2||e.telefone3||e.telefone4||e.endereco||e.numero||e.complemento||e.bairro||e.cidade||e.uf_sigla){i.tipo_entidade.text("Tipo: "+(""!=a||null!=a?a:"Não Informado")),void 0!==e.codigo_entidade&&void 0!==e.unidade_entidade?i.codigo_unidade_entidade.text("Código/Unidade: "+e.codigo_entidade+(e.codigo_entidade&&e.unidade_entidade?" - ":"")+e.unidade_entidade):void 0!==e.unidade&&i.codigo_unidade_entidade.text("Código/Unidade: "+e.codigo+(e.codigo&&e.unidade?" - ":"")+e.unidade),i.cnpj_entidade.text("CNPJ/CPF: "+(e.cnpj?e.cnpj:"Não Informado")),e.email_principal?(i.email_entidade.text(e.email_principal),i.email_entidade.attr("href","mailto:"+e.email_principal)):i.email_entidade.hide(),e.telefone1?(i.telefone1_entidade.attr("href","tel:"+e.telefone1),i.telefone1_entidade.text(e.telefone1)):i.telefone1_entidade.hide(),e.telefone2?(i.telefone2_entidade.attr("href","tel:"+e.telefone2),i.telefone2_entidade.text(e.telefone2)):i.telefone2_entidade.hide(),e.telefone3?(i.telefone3_entidade.attr("href","tel:"+e.telefone3),i.telefone3_entidade.text(e.telefone3)):i.telefone3_entidade.hide(),e.telefone4?(i.telefone4_entidade.attr("href","tel:"+e.telefone4),i.telefone4_entidade.text(e.telefone4)):i.telefone4_entidade.hide(),i.cep_entidade.text("CEP: "+(e.cep?e.cep:"Não Informado"));var o="";e.endereco&&""!=e.endereco.trim()&&(o=e.endereco),e.numero&&""!=e.numero.trim()&&(""!=o&&(o+=", "),o+=e.numero),e.complemento&&""!=e.complemento.trim()&&(""!=o&&(o+=", "),o+=e.complemento),e.bairro&&""!=e.bairro.trim()&&(""!=o&&(o+=", "),o+=e.bairro),e.cidade&&""!=e.cidade.trim()&&(""!=o&&(o+=", "),o+=e.cidade),e.uf_sigla&&""!=e.uf_sigla.trim()&&(""!=o&&(o+=", "),o+=e.uf_sigla),""!=o?(i.endereco_entidade.text(o),i.endereco_entidade.show()):i.endereco_entidade.hide(),i.div_btn_detalhes_entidade.tooltip("destroy")}else i.div_detalhes_entidade.hasClass("hidden")||i.div_detalhes_entidade.addClass("hidden"),i.div_btn_detalhes_entidade.tooltip({title:"Esta Entidade não possui informações (CNPJ, endereço, E-Mail e/ou telefone)",placement:"right"}),i.div_btn_detalhes_entidade.tooltip()},this.btn_nova_entidade=function(){var e=i.div_component_cbo_clientes;i.edt_entidades=e.find(".edt_combobox");var a=e.find(".btn_novo");App.verifica_permissao(App.emp,"prospect")?a.unbind("click").click(function(){View.load("prospect/detalhes",function(e,a){a.onsave=function(e){e.tipo="O",i.preencher_info_entidade(e),i.cboClientes.props.setCliente({cliente_id:e.id,cliente_nome:e.nome_fantasia}),i.filtros.cliente_id=e.id,i.filtros.cliente_nome=e.nome_fantasia,i.filtros.cliente_tipo=e.tipo,i.div_btn_detalhes_entidade_editar.removeClass("hidden"),i.div_component_cbo_clientes.find(".btn_novo").addClass("hidden"),WS.get("/oportunidade/dados_padrao_da_entidade/",{entidade_id:i.filtros.cliente_id,tipo_entidade:i.filtros.cliente_tipo},function(e){i.sugerir_configuracoes_da_entidade(e.tabela_preco_id,e.tabela_preco_nome,e.condicao_pagamento_id,e.condicao_pagamento_nome,e.tabela_preco_data_final,e.tabela_dentro_prazo)})},a.show(null,FORMULARIO.NOVO,null,i.div_component_cbo_clientes.find(".edt_combobox").val())},View.ABA.SIM)}):a.parent().addClass("hidden")},this.listar_agenda=function(){i.render_agendas()},this.setConfigEditarContatos=function(e){(App.verifica_permissao(App.temp.empresa,"contatos")||App.sessao.dados.admin)&&(i.div_btn_detalhes_contato_editar.removeClass("hidden"),i.div_btn_detalhes_contato_editar.unbind("click").click(function(a){View.load("contato/detalhes",function(a,o){o.onsave=function(e){set_value_combobox(i.cbo_contatos,e.id,e.nome,JSON.stringify(e)),e.email||e.telefone1||e.telefone2||e.telefone3||e.telefone4?(i.adicionarDadosContato(e),i.div_btn_detalhes_contato.tooltip("destroy")):(i.div_detalhes_contato.hasClass("hidden")||(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato()),i.div_btn_detalhes_contato.tooltip({title:"Este Contato não possui informações (E-Mail e/ou telefone)",placement:"right"}),i.div_btn_detalhes_contato.tooltip()),i.cbo_contatos.parent().find(".btn_novo").addClass("hidden"),set_focus(i.edt_entidades)},o.show(e.id||e.contato_id,FORMULARIO.EDITAR,null,i.edt_contatos.val(),i.entidade_tipo,i.entidade_id)},View.ABA.SIM)}))},this.setConfigEditarEntidade=function(e){("C"==e.tipo&&App.verifica_permissao(App.temp.empresa,"cliente")||App.sessao.dados.admin||"O"==e.tipo&&App.verifica_permissao(App.temp.empresa,"prospect"))&&(i.div_btn_detalhes_entidade_editar.removeClass("hidden"),i.div_btn_detalhes_entidade_editar.unbind("click").click(function(a){"C"==e.tipo?View.load("cliente/detalhes",function(a,o){o.onsave=function(e){i.preencher_info_entidade(e),i.cboClientes.props.setCliente({cliente_id:e.id,cliente_nome:e.nome_fantasia}),i.filtros.cliente_id=e.id,i.filtros.cliente_nome=e.nome_fantasia,i.filtros.cliente_tipo="C",i.edt_entidades.attr("selected-value",i.entidade_id),i.div_component_cbo_clientes.find(".btn_novo").addClass("hidden"),set_focus(i.edt_entidades),WS.get("/oportunidade/dados_padrao_da_entidade/",{entidade_id:i.filtros.cliente_id,tipo_entidade:i.filtros.cliente_tipo},function(e){i.sugerir_configuracoes_da_entidade(e.tabela_preco_id,e.tabela_preco_nome,e.condicao_pagamento_id,e.condicao_pagamento_nome)})},o.show(e.id,FORMULARIO.EDITAR,null,i.filtros.cliente_nome)},View.ABA.SIM,null,null,{clienteId:e.id}):"O"==e.tipo&&View.load("prospect/detalhes",function(e,a){a.onsave=function(e){i.preencher_info_entidade(e),i.cboClientes.props.setCliente({cliente_id:e.id,cliente_nome:e.nome_fantasia}),i.filtros.cliente_id=e.id,i.filtros.cliente_nome=e.nome_fantasia,i.filtros.cliente_tipo="O",i.edt_entidades.attr("selected-value",i.entidade_id),i.div_component_cbo_clientes.find(".btn_novo").addClass("hidden"),set_focus(i.edt_entidades),WS.get("/oportunidade/dados_padrao_da_entidade/",{entidade_id:i.filtros.cliente_id,tipo_entidade:i.filtros.cliente_tipo},function(e){i.sugerir_configuracoes_da_entidade(e.tabela_preco_id,e.tabela_preco_nome,e.condicao_pagamento_id,e.condicao_pagamento_nome)})},a.show(i.filtros.cliente_id,FORMULARIO.EDITAR,null,i.filtros.cliente_nome)},View.ABA.SIM)}))},this.listar_tipo_oportunidade=function(e){i.cbo_tipo_oportunidade.find("option").remove(),WS.get("tipo_oportunidade/listar/",null,function(a){for(var o=0;o<a.length;o++){var t=a[o];add_option(i.cbo_tipo_oportunidade,t.tipo_oportunidade_id,t.descricao)}e&&i.cbo_tipo_oportunidade.val(e).trigger("change"),i.cbo_tipo_oportunidade.selectpicker("refresh")})},this.listar_funil=function(e){var a=new Object;a.nome=i.edt_funil.val(),WS.get("funil_vendas/listar/",a,function(a){limpar_combobox(i.cbo_funil),i.cbo_etapa.val("").change(),$(a).each(function(e,a){var o=[];o["Descrição"]=a.nome,add_option_combobox(i.cbo_funil,e,a.id,o,null,JSON.stringify(a))}),i.cbo_funil.parent().find(".ul_row").click(function(){var e=$(this).parent().attr("id_registro"),a=JSON.parse($(this).parent().attr("dados-adicionais"));e>0&&(set_value_combobox(i.cbo_funil,e,a.nome),i.listar_etapas())}),a.length>0?e(!0):e(!1)})},this.btn_novo_funil=function(){i.cbo_funil.parent().find(".btn_novo").click(function(){View.load("funil_vendas/detalhes",function(e,a){a.onsave=function(e){set_value_combobox(i.cbo_funil,e.id,e.nome),i.cbo_funil.parent().find(".btn_novo").addClass("hidden"),set_focus(i.edt_funil)},a.show(null,FORMULARIO.NOVO,i.edt_funil.val())},View.ABA.MULTIPLAS)})},this.listar_etapas=function(e){var a=new Object;a.funil_vendas_id=get_value_combobox(i.cbo_funil),i.render_formulario(a.funil_vendas_id,i.oportunidade_id),i.cbo_etapa.find("option").remove(),WS.get("funil_vendas/listar_etapas/",a,function(a){for(var o=0;o<a.length;o++){var t=a[o];add_option(i.cbo_etapa,t.funil_vendas_etapa_id,t.nome)}e&&i.cbo_etapa.val(e).trigger("change"),i.cbo_etapa.selectpicker("refresh")})},this.renderDropDownEtiquetas=function(){ReactDOM.unmountComponentAtNode(i.div_dropdown_etiquetas[0]);let e=i.etiquetas?i.etiquetas:[];ReactDOM.render(React.createElement(window.components.DropDownEtiquetas.default,{pai_tabela:"funil_vendas",pai_id:i.funil_vendas_id,selecionados:e,onValueChanged:e=>{i.etiquetas=e},readOnly:!1,stylingMode:"filled",maxDisplayedTags:3,applyValueMode:"useButtons"}),i.div_dropdown_etiquetas[0])},this.render_itens_repetidos=function(e,a,o){if(a.tooltip("destroy"),"S"==i.nao_permitir_item_repetido&&void 0!==i.arr_itens&&i.arr_itens)for(var t=0;t<i.arr_itens.length;t++)e!=t&&i.arr_itens[t].codigo==o&&"N"==i.arr_itens[t].excluido&&(a.tooltip({title:"Este item é repetido",placement:"auto"}),a.tooltip("show"))},this.render_itens=function(){var e=i.tab_listagem.find("tbody"),a=e.find("tr:first"),o=!1;i.oportunidade&&"G"==i.oportunidade.situacao&&i.btn_incluir_item.prop("disabled",!0),i.tab_listagem.find(".rows").remove(),$(i.arr_itens).each(function(t,r){"S"!=r.excluido&&function(t,r){var s=a.clone();if(s.removeAttr("template-row"),s.css("display",""),s.addClass("rows"),App.PE.Oportunidade_render_itens_add_row_antes)try{App.PE.Oportunidade_render_itens_add_row_antes(s,i,t)}catch(e){console.log(e)}"N"==i.parametros_item.item_desconto&&(s.find(".div_perc_desconto").addClass("hidden"),s.find(".div_vlr_desconto_item").addClass("hidden"),s.find(".div_preco_unitario_com_desconto").addClass("hidden")),"N"==i.parametros_item.imposto_ipi&&(s.find(".div_perc_ipi").addClass("hidden"),s.find(".div_valor_ipi").addClass("hidden")),"N"==r.excluido&&(o=!0),"S"==i.bloquear_unidade_medida&&s.find('[template-field="edt_quantidade"]').addClass("disabled").prop("disabled",!0),"S"==i.bloquear_unidade_medida2&&s.find('[template-field="edt_quantidade_unidade_medida2"]').addClass("disabled").prop("disabled",!0),"N"==i.utilizar_unidade_medida&&s.find(".div_unidade_medida").addClass("hidden"),"N"==i.utilizar_unidade_medida2&&s.find(".div_quantidade_unidade_medida2").addClass("hidden"),"N"==i.utilizar_codigo_pedido_item&&s.find(".div_codigo_pedido_item").addClass("hidden"),"N"==i.utilizar_prazo_dias_item&&s.find(".div_prazo_dias").addClass("hidden");var _=$(s.find("[template-field='cbo_item']")),l="col2";i.tabela_preco_possui_entidade&&(l="col3"),create_combobox(_,i.listar_itens,l,!1,{pesquisar_enter:i.parametro_busca_automatica,pesquisar_tudo_seta:!1});var c=$(".div_itens_oportunidade"),p=_.parent().find(".edt_combobox");setTimeout(function(){p.prop("disabled")||(window.scroll(0,p.offset().top-c.offset().top),p.focus())},500);var u=$(s.find(".edt_codigo_item"));u.removeClass("hidden"),void 0!==r.tabela_preco_item_codigo_entidade&&r.tabela_preco_item_codigo_entidade&&""!=r.tabela_preco_item_codigo_entidade.trim()?u.html('<div title="Código do Item">'+r.codigo+'</div><div title="Código da Entidade">'+r.tabela_preco_item_codigo_entidade+"</div>"):u.text(r.codigo),i.render_itens_repetidos(t,u,r.codigo),i.arr_itens[t].oportunidade_item_id=r.oportunidade_item_id,i.arr_itens[t].calcular_preco_por_percentual=r.calcular_preco_por_percentual,s.keydown(function(e){40==e.keyCode&&0==verificar_status_dropdown(_)&&(i.arr_itens.push({oportunidade_item_id:null,excluido:"N",oportunidade_id:null,item_id:null,codigo:"",item_descricao:null,preco:0,quantidade:0,perc_desconto:0,valor_desconto:0,preco_unitario_com_desconto:0,total:0,cst_ipi:null,perc_ipi:0,valor_ipi:0,unidade_medida_id:null,unidade_medida2_id:null,unidade_medida:"",unidade_medida2:"",fator_conversao:0,tipo_conversao:"D",quantidade_unidade_medida2:0,codigo_pedido_item:null,calcular_preco_por_percentual:"S"}),i.render_itens())}),p.keypress(function(e){var a=$(this),o=e.selected_value?e.selected_value:get_value_combobox(_),d=$(s.find("[template-field='cbo_item']"));if(d.parent().find(".edt_combobox").val(this.value),o>0&&(13==e.keyCode||"click"==e.type)){if(i.arr_itens[t].item_id=o,i.arr_itens[t].item_descricao=this.value,App.PE.Oportunidade_adicionar_item)try{App.PE.Oportunidade_adicionar_item(i,r,s,t)}catch(e){console.log(e)}$(i.arr_listar_itens).each(function(e,r){if(r.item_id==o){i.arr_itens[t].item_descricao=r.descricao,i.arr_itens[t].item_observacoes=r.observacoes,i.arr_itens[t].observacoes="",i.arr_itens[t].unidade_medida=r.unidade_medida,i.arr_itens[t].unidade_medida2=r.unidade_medida2,i.arr_itens[t].unidade_medida_id=r.unidade_medida_id,i.arr_itens[t].unidade_medida2_id=r.unidade_medida2_id,i.arr_itens[t].qtde_casas_decimal=r.qtde_casas_decimal>0?r.qtde_casas_decimal:0,i.arr_itens[t].qtde_casas_decimal2=r.qtde_casas_decimal2>0?r.qtde_casas_decimal2:0,i.arr_itens[t].tipo_conversao=r.tipo_conversao,i.arr_itens[t].fator_conversao=r.fator_conversao,i.arr_itens[t].quantidade_unidade_medida2=0,i.arr_itens[t].preco=r.preco>0?r.preco:0,i.arr_itens[t].custo=r.custo>0?r.custo:0,i.arr_itens[t].preco_minimo=r.preco_minimo>0?r.preco_minimo:0,i.arr_itens[t].preco_maximo=r.preco_maximo>0?r.preco_maximo:0,i.arr_itens[t].quantidade_minima=r.quantidade_minima>0?r.quantidade_minima:0,i.arr_itens[t].quantidade_maxima=r.quantidade_maxima>0?r.quantidade_maxima:0,i.arr_itens[t].desconto=r.desconto>0?r.desconto:0,i.arr_itens[t].preco_desconto=r.preco_desconto>0?r.preco_desconto:0,i.arr_itens[t].tabela_preco_id=r.tabela_preco_id,i.arr_itens[t].cor_item_fundo=r.cor_item_fundo?r.cor_item_fundo:"#FFFFFF",i.arr_itens[t].cor_item_fonte=r.cor_item_fonte?r.cor_item_fonte:"#000000",V.text("Qtde "+(r.desc_unidade_medida?"("+r.desc_unidade_medida+")":"")),I.text("Qtde "+(r.desc_unidade_medida2?"("+r.desc_unidade_medida2+")":"")),0==i.arr_itens[t].qtde_casas_decimal?M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}):i.arr_itens[t].qtde_casas_decimal>0&&M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal)}),0==i.arr_itens[t].qtde_casas_decimal2?T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}):i.arr_itens[t].qtde_casas_decimal2>0&&T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal2)}),M.val(parseFloat(0)),T.val(parseFloat(0)),i.arr_itens[t].codigo=r.codigo,void 0!==r.tabela_preco_item_codigo_entidade&&r.tabela_preco_item_codigo_entidade&&""!=r.tabela_preco_item_codigo_entidade.trim()?u.html('<div title="Código do Item">'+r.codigo+'</div><div title="Código da Entidade">'+r.tabela_preco_item_codigo_entidade+"</div>"):u.text(r.codigo),i.render_itens_repetidos(t,u,r.codigo);var _=function(){if(i.arr_itens[t].total=r.preco,i.arr_itens[t].cst_ipi=r.cst_ipi,i.arr_itens[t].perc_ipi=r.perc_ipi,i.arr_itens[t].valor_ipi=0,v.maskMoney("mask",parseFloat(i.arr_itens[t].preco)),0==r.qtde_casas_decimal?M.maskMoney("mask",parseInt(i.arr_itens[t].quantidade,10)):r.qtde_casas_decimal>0&&M.maskMoney("mask",parseFloat(i.arr_itens[t].quantidade)),i.calcular_total_item(r,t,s),"S"==i.exibir_info_lucro){g.maskMoney("mask",parseFloat(i.arr_itens[t].custo));var e=parseFloat(i.arr_itens[t].custo),o=parseFloat(i.arr_itens[t].preco),d=(o-e)/o*100;d<0&&(d=0),h.maskMoney("mask",d),y.maskMoney("mask",parseFloat(o-e))}v.maskMoney("mask",parseFloat(i.arr_itens[t].preco)),F.maskMoney("mask",parseFloat(i.arr_itens[t].preco_unitario_com_desconto)),z.maskMoney("mask",parseFloat(i.arr_itens[t].perc_ipi)),R.maskMoney("mask",parseFloat(i.arr_itens[t].valor_ipi)),E.maskMoney("mask",parseFloat(i.arr_itens[t].total)),S.maskMoney("mask",parseFloat(i.arr_itens[t].perc_desconto)),i.totalizar_itens();var _=i.converter_unidade_medida(n,M.maskMoney("unmasked")[0],i.arr_itens[t].tipo_conversao,i.arr_itens[t].fator_conversao);T.maskMoney("mask",_),i.arr_itens[t].quantidade_unidade_medida2=_,a.css("background",i.arr_itens[t].cor_item_fundo),a.css("color",i.arr_itens[t].cor_item_fonte)};if(get_value_combobox(i.cbo_tabela_preco)>0)if("S"!=i.notificar_regra_tabela_preco||"N"!=i.exibir_itens_sem_tabela_preco||i.arr_itens[t].tabela_preco_id)if("S"!=i.obrigar_regra_tabela_preco||"N"!=i.exibir_itens_sem_tabela_preco||i.arr_itens[t].tabela_preco_id)_();else{var l;(l=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Item não existe na tabela de preço.")),alert_modal("Validação",l,"Ok",function(){i.arr_itens[t].codigo=null,u.text(""),set_value_combobox(d,"",""),V.text("Qtde"),I.text("Qtde"),T.maskMoney("mask",parseFloat(0)),v.maskMoney("mask",0),M.maskMoney("mask",0),S.maskMoney("mask",0),F.maskMoney("mask",0),z.maskMoney("mask",0),R.maskMoney("mask",0),E.maskMoney("mask",0),S.maskMoney("mask",0)})}else(l=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Item não existe na tabela de preço. Deseja realmente incluir?")),alert_modal("Validação",l,"Sim",function(){_()},!0,"Não",null,function(){i.arr_itens[t].codigo=null,u.text(""),set_value_combobox(d,"",""),V.text("Qtde"),I.text("Qtde"),T.maskMoney("mask",parseFloat(0)),v.maskMoney("mask",0),M.maskMoney("mask",0),S.maskMoney("mask",0),F.maskMoney("mask",0),z.maskMoney("mask",0),R.maskMoney("mask",0),E.maskMoney("mask",0),S.maskMoney("mask",0)});else _()}});var l=$(".div_itens_oportunidade");setTimeout(function(){window.scroll(0,a.offset().top-l.offset().top)},500)}}),p.val(r.item_descricao);var m=r.cor_item_fundo?r.cor_item_fundo:"#FFFFFF",f=r.cor_item_fonte?r.cor_item_fonte:"#000000";p.css("background",m),p.css("color",f);var b=_.parent().find(".btn_novo");"N"==i.parametros_item.somente_consulta_item&&App.verifica_permissao(App.emp,"item")?b.unbind("click").click(function(){View.load("itens/detalhes",function(e,a){a.onsave=function(e){var a={oportunidade_item_id:null,excluido:"N",oportunidade_id:i.oportunidade_id,item_id:e.id,codigo:e.codigo,descricao:e.descricao,preco:e.preco>0?e.preco:0,quantidade:0,perc_desconto:0,valor_desconto:0,preco_unitario_com_desconto:0,total:0,cst_ipi:e.cst_ipi,perc_ipi:e.perc_ipi,valor_ipi:0,unidade_medida_id:e.unidade_medida_id,unidade_medida2_id:e.unidade_medida2_id,unidade_medida:e.unidade_medida,unidade_medida2:e.unidade_medida2,fator_conversao:e.fator_conversao,tipo_conversao:e.tipo_conversao,quantidade_unidade_medida2:0,codigo_pedido_item:e.codigo_pedido_item,qtde_casas_decimal:e.qtde_casas_decimal>0?e.qtde_casas_decimal:0,qtde_casas_decimal2:e.qtde_casas_decimal2>0?e.qtde_casas_decimal2:0,calcular_preco_por_percentual:"S"};i.arr_listar_itens.push(a),p.val(e.descricao),set_value_combobox(_,e.id,e.descricao),b.addClass("hidden"),p.trigger({type:"keypress",keyCode:13,selected_value:e.id}),void 0!==e.tabela_preco_item_codigo_entidade&&e.tabela_preco_item_codigo_entidade&&""!=e.tabela_preco_item_codigo_entidade.trim()?u.html('<div title="Código do Item">'+e.codigo+'</div><div title="Código da Entidade">'+e.tabela_preco_item_codigo_entidade+"</div>"):u.text(e.codigo)},a.show(null,FORMULARIO.NOVO,p.val())},View.ABA.SIM)}):b.parent().addClass("hidden");var v=$(s.find("[template-field='edt_preco']"));if("S"==i.exibir_info_lucro){var h=$(s.find("[template-field='edt_percentual_lucro_bruto']"));h.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),h.maskMoney("mask",100*parseFloat((r.preco-r.custo)/r.preco));var g=$(s.find("[template-field='edt_custo']"));g.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),g.maskMoney("mask",parseFloat(r.custo));var k=parseFloat(r.quantidade),x=parseFloat(r.preco),C=k*parseFloat(r.custo),w=k*x,y=$(s.find("[template-field='edt_valor_lucro_bruto']"));y.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),y.maskMoney("mask",parseFloat(w-C))}v.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),v.keyup($.debounce(100,function(e){if(i.considera_valor_PE||(i.arr_itens[t].preco=v.maskMoney("unmasked")[0]),"S"==i.exibir_info_lucro){var a=parseFloat(i.arr_itens[t].custo),o=parseFloat(i.arr_itens[t].preco),n=parseFloat(i.arr_itens[t].quantidade),d=(o-a)/o*100;d<0&&(d=0),h.maskMoney("mask",d);var _=n*a,l=n*o;y.maskMoney("mask",parseFloat(l-_))}i.calcular_total_item(r,t,s)})),v.maskMoney("mask",parseFloat(r.preco)),v.unbind("change"),v.change(function(){i.validar_item(i.arr_itens[t],v,"edt_preco")});var M=$(s.find("[template-field='edt_quantidade']")),O=!1;0==r.qtde_casas_decimal?".00"==r.quantidade.toString().substring(Number(r.quantidade).toFixed(2).length-3,Number(r.quantidade).toFixed(2).length)?(M.maskMoney({thousands:".",decimal:"",allowZero:!0,suffix:"",precision:0}),O=!0):M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}):r.qtde_casas_decimal>0&&M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(r.qtde_casas_decimal)}),M.off("focus keyup").on("focus keyup",function(e){setTimeout(function(){i.calcular_total_item(r,t,s);var e=i.converter_unidade_medida(n,M.maskMoney("unmasked")[0],i.arr_itens[t].tipo_conversao,i.arr_itens[t].fator_conversao);T.maskMoney("mask",e),i.arr_itens[t].quantidade_unidade_medida2=T.maskMoney("unmasked")[0]})}),O?M.val(parseInt(r.quantidade)):M.maskMoney("mask",parseFloat(r.quantidade)),M.unbind("change").change(function(){setTimeout(function(){if("S"==i.exibir_info_lucro){var e=parseFloat(i.arr_itens[t].custo),a=parseFloat(i.arr_itens[t].preco),o=parseFloat(i.arr_itens[t].quantidade),n=o*e,d=o*a;y.maskMoney("mask",parseFloat(d-n))}i.validar_item(i.arr_itens[t],M,"edt_quantidade")})}),M.unbind("focus").focus(function(){setTimeout(function(){T.prop("disabled",!0),i.arr_itens[t].qtde_casas_decimal>0?(M.val().indexOf(",")>0&&M.val(M.val().substring(0,Number(M.val().indexOf(","))+Number(i.arr_itens[t].qtde_casas_decimal)+1)),M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal)})):0==i.arr_itens[t].qtde_casas_decimal&&(M.val().indexOf(",")>0&&M.val(M.val().substring(0,M.val().indexOf(","))),M.maskMoney({thousands:".",decimal:"",allowZero:!0,suffix:"",precision:0})),Number(i.arr_itens[t].qtde_casas_decimal2)<=2?T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}):T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal2)})})}),M.unbind("blur").blur(function(e){setTimeout(function(){"N"==i.bloquear_unidade_medida2&&T.prop("disabled",!1),L()})});var S=$(s.find("[template-field='edt_perc_desconto']"));S.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:4}),S.maskMoney("mask",parseFloat(r.perc_desconto)),S.keyup($.debounce(100,function(e){i.arr_itens[t].calcular_preco_por_percentual="S",i.calcular_total_item(r,t,s)}));var A=$(s.find("[template-field='edt_vlr_desconto_item']"));A.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),A.maskMoney("mask",parseFloat(r.valor_desconto)),A.keyup($.debounce(100,function(e){i.arr_itens[t].calcular_preco_por_percentual="N",i.calcular_total_item(r,t,s)}));var q=$(s.find("[template-field='edt_vlr_desconto_oportunidade_item_rateio']"));q.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),q.maskMoney("mask",parseFloat(r.valor_desconto_oportunidade_rateio)),q.unbind("change").change(function(){i.calcular_total_item(r,t,s)}),i.edt_perc_total_desconto_oportunidade.keyup($.debounce(100,function(e){i.calcular_desconto_por_percentual=!0,i.calcular_desconto_oportunidade_item_rateio()})),i.edt_total_desconto_oportunidade.keyup($.debounce(100,function(e){i.calcular_desconto_por_percentual=!1,i.calcular_desconto_oportunidade_item_rateio()})),S.unbind("change").change(function(){i.validar_item(i.arr_itens[t],S,"edt_perc_desconto")});var F=$(s.find("[template-field='edt_preco_unitario_com_desconto']"));F.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),F.maskMoney("mask",parseFloat(r.preco_unitario_com_desconto));var N=$(s.find("[template-field='edt_prazo_dias']"));N.val(r.prazo_dias),N.keyup(function(){i.arr_itens[t].prazo_dias=N.val()});var z=$(s.find("[template-field='edt_perc_ipi']"));z.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),z.prop("disabled",!0),z.maskMoney("mask",parseFloat(r.perc_ipi));var R=$(s.find("[template-field='edt_valor_ipi']"));R.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),R.prop("disabled",!0),R.maskMoney("mask",parseFloat(r.valor_ipi));var E=$(s.find("[template-field='edt_total']"));E.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),E.prop("disabled",!0),E.maskMoney("mask",parseFloat(r.total));var V=$(s.find("[template-field='edt_unidade_medida']"));V.text("Qtde "+(r.desc_unidade_medida?"("+r.desc_unidade_medida+")":""));var I=$(s.find("[template-field='edt_unidade_medida2']"));I.text("Qtde "+(r.desc_unidade_medida2?"("+r.desc_unidade_medida2+")":""));var D=$(s.find("[template-field='edt_codigo_pedido_item']"));D.val(r.codigo_pedido_item),D.keyup(function(){i.arr_itens[t].codigo_pedido_item=D.val()});var T=$(s.find("[template-field='edt_quantidade_unidade_medida2']"));function L(){var e=M.val(),a=T.val();i.arr_itens[t].qtde_casas_decimal>0?M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal)}):0==i.arr_itens[t].qtde_casas_decimal&&(M.maskMoney({thousands:".",decimal:"",allowZero:!0,suffix:"",precision:0}),",00"==e.substring(e.length-3,e.length)&&M.val(parseInt(e.replace(".","")))),i.arr_itens[t].qtde_casas_decimal2>0?T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal2)}):0==i.arr_itens[t].qtde_casas_decimal2&&(T.maskMoney({thousands:".",decimal:"",allowZero:!0,suffix:"",precision:0}),",00"==a.substring(a.length-3,a.length)&&T.val(parseInt(a.replace(".",""))))}O=!1,0==r.qtde_casas_decimal2?".00"==r.quantidade_unidade_medida2.toString().substring(Number(r.quantidade_unidade_medida2).toFixed(2).length-3,Number(r.quantidade_unidade_medida2).toFixed(2).length)?(T.maskMoney({thousands:".",decimal:"",allowZero:!0,suffix:"",precision:0}),O=!0):T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}):r.qtde_casas_decimal2>0&&T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(r.qtde_casas_decimal2)}),O?T.val(parseInt(r.quantidade_unidade_medida2)):T.maskMoney("mask",parseFloat(r.quantidade_unidade_medida2)),T.off("focus keyup").on("focus keyup",function(e){setTimeout(function(){i.arr_itens[t].quantidade_unidade_medida2=T.maskMoney("unmasked")[0];var e=i.converter_unidade_medida(d,T.maskMoney("unmasked")[0],i.arr_itens[t].tipo_conversao,i.arr_itens[t].fator_conversao);e!=M.maskMoney("unmasked")[0]&&M.maskMoney("mask",e),i.arr_itens[t].quantidade=e,i.calcular_total_item(r,t,s)})}),T.unbind("change").change(function(){setTimeout(function(){i.validar_item(i.arr_itens[t],T,"edt_quantidade_unidade_medida2")})}),T.unbind("focus").focus(function(){setTimeout(function(){M.prop("disabled",!0),i.arr_itens[t].qtde_casas_decimal2>0?(T.val().indexOf(",")>0&&T.val(T.val().substring(0,Number(T.val().indexOf(","))+Number(i.arr_itens[t].qtde_casas_decimal2)+1)),T.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal2)})):0==i.arr_itens[t].qtde_casas_decimal2&&(T.val().indexOf(",")>0&&T.val(T.val().substring(0,T.val().indexOf(","))),T.maskMoney({thousands:".",decimal:"",allowZero:!0,suffix:"",precision:0})),Number(i.arr_itens[t].qtde_casas_decimal)<=2?M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}):M.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:Number(i.arr_itens[t].qtde_casas_decimal)})})}),T.unbind("blur").blur(function(e){setTimeout(function(){"N"==i.bloquear_unidade_medida&&M.prop("disabled",!1),L()})});var j=$(s.find(".btn_detalhes_item"));"S"==i.editar_observacoes_item&&(j.show(),j.unbind("click"),j.click(function(){View.load("oportunidade/item_observacoes",function(e,a){a.show(i.arr_itens[t],i.arr_itens[t].observacoes?i.arr_itens[t].observacoes:nl2br(i.arr_itens[t].item_observacoes))},View.ABA.MULTIPLAS)}));var W=$(s.find(".btn_deletar_item"));if(W.unbind("click"),i.oportunidade&&"G"==i.oportunidade.situacao?W.prop("disabled",!0):W.click(function(){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja Remover?")),alert_modal("Atenção",e,"Remover",function(){if(App.PE.Oportunidade_remover_item)try{App.PE.Oportunidade_remover_item(i,r,s,t)}catch(e){console.log(e)}i.arr_itens[t].excluido="S",i.render_itens(),i.totalizar_itens()},!0)}),i.oportunidade&&"G"==i.oportunidade.situacao&&s.find("input,.btn_combobox").prop("disabled",!0),0==i.editar_preco&&(v.prop("disabled",!0),z.prop("disabled",!0),R.prop("disabled",!0)),0==i.editar_desconto&&(S.prop("disabled",!0),A.prop("disabled",!0),i.edt_perc_total_desconto_oportunidade.prop("disabled",!0),i.edt_total_desconto_oportunidade.prop("disabled",!0)),s.appendTo(e),App.PE.Oportunidade_render_itens_add_row_depois)try{App.PE.Oportunidade_render_itens_add_row_depois(s,i,t)}catch(e){console.log(e)}}(t,r)}),i.tem_itens=o,i.totalizar_itens(),i.edt_valor_negocio.prop("disabled",o),i.edt_tabela_preco.prop("disabled",o),i.cbo_tabela_preco.parent().find("button").prop("disabled",o),i.cbo_tipo_oportunidade.prop("disabled",o),App.aplicar_mascaras(e)},this.calcular_total_item=function(e,a,o){var t=$(o.find("[template-field='edt_preco']")),n=$(o.find("[template-field='edt_quantidade']")),d=$(o.find("[template-field='edt_perc_desconto']")),r=$(o.find("[template-field='edt_vlr_desconto_item']")),s=$(o.find("[template-field='edt_vlr_desconto_oportunidade_item_rateio']")),_=$(o.find("[template-field='edt_valor_ipi']")),l=$(o.find("[template-field='edt_preco_unitario_com_desconto']")),c=$(o.find("[template-field='edt_total']"));i.arr_itens[a].preco=t.maskMoney("unmasked")[0],i.arr_itens[a].quantidade=n.maskMoney("unmasked")[0],i.arr_itens[a].perc_desconto=d.maskMoney("unmasked")[0],i.arr_itens[a].valor_desconto=r.maskMoney("unmasked")[0],i.arr_itens[a].valor_desconto_oportunidade_rateio=s.maskMoney("unmasked")[0],i.arr_itens[a].perc_ipi=e.perc_ipi;var p=i.arr_itens[a].preco*i.arr_itens[a].quantidade;"S"==i.arr_itens[a].calcular_preco_por_percentual?i.arr_itens[a].valor_desconto=i.arr_itens[a].preco*i.arr_itens[a].perc_desconto/100:i.arr_itens[a].perc_desconto=i.arr_itens[a].valor_desconto/i.arr_itens[a].preco*100;var u=p/i.arr_itens[a].quantidade-i.arr_itens[a].valor_desconto;isNaN(u)&&(u=0);var m=(u="S"==i.arredondamento_automatico_preco_com_desconto?u.toFixed(2):formataCasasDecimaisSemTruncar(u,u.countDecimals()))*i.arr_itens[a].quantidade;i.arr_itens[a].valor_ipi=i.arr_itens[a].perc_ipi?parseFloat(i.arr_itens[a].perc_ipi)*parseFloat(m)/100:0,i.arr_itens[a].total=m-i.arr_itens[a].valor_desconto_oportunidade_rateio+i.arr_itens[a].valor_ipi,i.arr_itens[a].preco_unitario_com_desconto=u,_.maskMoney("mask",parseFloat(i.arr_itens[a].valor_ipi)),d.maskMoney("mask",parseFloat(i.arr_itens[a].perc_desconto)),r.maskMoney("mask",parseFloat(i.arr_itens[a].valor_desconto)),c.maskMoney("mask",parseFloat(i.arr_itens[a].total)),l.maskMoney("mask",parseFloat(i.arr_itens[a].preco_unitario_com_desconto)),i.totalizar_itens(),i.calcular_desconto_oportunidade_item_rateio()},this.calcular_desconto_oportunidade_item_rateio=function(){var e=i.tab_listagem.find(".itens_oportunidade.rows"),a=i.edt_subtotal.maskMoney("unmasked")[0],o=i.edt_total_desconto_item.maskMoney("unmasked")[0],t=i.edt_perc_total_desconto_oportunidade.maskMoney("unmasked")[0],n=i.edt_total_desconto_oportunidade.maskMoney("unmasked")[0];i.calcular_desconto_por_percentual?(n=(a-o)*t/100,i.edt_total_desconto_oportunidade.maskMoney("mask",n).trigger("change")):(t=n/(a-o)*100,i.edt_perc_total_desconto_oportunidade.maskMoney("mask",t).trigger("change"));for(var d=0;d<e.length;d++){var r=e[d],s=$(r).find(".quantidade_item").maskMoney("unmasked")[0],_=($(r).find(".preco_unitario").maskMoney("unmasked")[0]-$(r).find(".vlr_desconto_item").maskMoney("unmasked")[0])*s/(a-o)*100*n/100,l=$(r).find(".vlr_desconto_oportunidade_item_rateio");isNaN(_)||l.maskMoney("unmasked")[0]==parseFloat(_.toFixed(2))||(l.maskMoney("mask",parseFloat(_)),l.trigger("change"))}},this.totalizar_itens=function(){var e=0,a=0,o=0,t=0,n=0,d=0;$(i.arr_itens).each(function(d,r){if("N"==r.excluido){e+=parseFloat(r.preco)*parseFloat(r.quantidade);var s=parseFloat(r.preco)*parseFloat(r.quantidade);a+=s*parseFloat(r.perc_desconto)/100,o=parseFloat(o)+parseFloat(r.valor_ipi),t=parseFloat(t)+parseFloat(r.total),"S"==i.exibir_info_lucro&&(n+=parseFloat(r.preco*r.quantidade)-parseFloat(r.custo*r.quantidade))}}),t=isNaN(t)?0:t,i.total_itens=t,"S"==i.exibir_info_lucro&&(n=isNaN(n)?0:n,d=isNaN(d)?0:d,d=n/t*100);let r=i.edt_valor_frete.maskMoney("unmasked")[0];!isNaN(r)&&r>0&&(t=parseFloat(t)+parseFloat(r)),i.arr_itens.length>0&&t>0&&i.edt_valor_negocio.maskMoney("mask",t),d=isNaN(d)?0:d,i.edt_subtotal.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_subtotal.maskMoney("mask",parseFloat(e)),i.edt_total_desconto_item.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_total_desconto_item.maskMoney("mask",parseFloat(a)),i.edt_total_ipi.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_total_ipi.maskMoney("mask",parseFloat(o)),i.edt_valor_total.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_valor_total.maskMoney("mask",parseFloat(t)),"S"==i.exibir_info_lucro&&(i.div_lucro_bruto_total.removeClass("hidden"),i.edt_valor_lucro_bruto_total.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_valor_lucro_bruto_total.maskMoney("mask",parseFloat(n)),i.edt_percentual_lucro_bruto_total.maskMoney({thousands:".",decimal:",",allowZero:!0,suffix:"",precision:2}),i.edt_percentual_lucro_bruto_total.maskMoney("mask",parseFloat(d)))},this.listar_itens=function(e,a,o){var t=a.parent(),n={item_descricao:t.find(".edt_combobox").val(),tipo_oportunidade_id:i.cbo_tipo_oportunidade.val(),limite:0,filtrar_por_codigo_ou_nome:!0,tabela_preco_id:get_value_combobox(i.cbo_tabela_preco),funil_vendas_id:get_value_combobox(i.cbo_funil),modulo_crm:!0,listar_apenas_itens_tabela_preco:"N"==i.exibir_itens_sem_tabela_preco&&"N"==i.notificar_regra_tabela_preco};WS.get("itens/listar/",n,function(o){limpar_combobox(a),i.arr_listar_itens=o,i.arr_dados_itens=[];var n="col2",d=[];$(o).each(function(e,o){i.arr_dados_itens[e]=o,d["Código"]=null==o.codigo||""==o.codigo?" ":o.codigo,void 0!==o.tabela_preco_entidade_id&&o.tabela_preco_entidade_id&&""!=o.tabela_preco_entidade_id.trim()&&(d["Cód.Entidade"]=null==o.tabela_preco_item_codigo_entidade||""==o.tabela_preco_item_codigo_entidade?" ":o.tabela_preco_item_codigo_entidade,n="col3"),d["Descrição"]=o.descricao,d["Cor do item"]={cell_name:o.cor_item_nome,color_background:o.cor_item_fundo,color_text:o.cor_item_fonte},add_option_combobox(a,e,o.item_id,d,null,null,n)});var r=$(t.find(".header_col"));if(r[0]){r[0].style.width="97px","col3"==n?(r[1].style.width="97px",r[2].style.width=""):r[1].style.width="";var s=$(t.find(".ul_row"));$(s).each(function(e,a){(a=$(a)).find("li")[0].style.width="97px","col3"==n?(a.find("li")[1].style.width="97px",a.find("li")[2].style.width=""):a.find("li")[1].style.width=""})}r.removeClass("hidden-xs hidden-sm"),$(t.find(".detalhe_col")).removeClass("hidden-xs hidden-sm"),t.find(".ul_row").click(function(){var e=$(this).parent().attr("id_registro"),a=$(this).parent().parent().parent().parent().parent().parent(),o=($(this).parent(),a.find("input"));o.attr("selected-value",e),o.trigger({type:"keypress",keyCode:13,selected_value:e})}),o.length>0?e(!0):e(!1)})},this.render_agendas=function(){var e=i.dialog.find(".div_body"),a=e.find(".template-ul");WS.get("oportunidade_agenda/listar/",{oportunidade_id:i.oportunidade_id},function(o){i.arr_agendas=o,e.find(".row_ul").remove(),$(i.arr_agendas).each(function(o,t){!function(o,t){var n=a.clone();n.removeClass("template-ul"),n.addClass("row_ul"),n.css("display","");var d=$(n.find(".carrega_img"));null!=t.foto_id?d.attr("src",WS_URI+"documento/midia/?documento_id="+t.foto_id+"&token_midia="+App.sessao.token_midia):d.attr("src","assets/img/imagem_usuario_padrao.svg"),$(n.find(".nome_usuario")).text(t.responsavel_nome),$(n.find("[template-field='solicitante']")).text("Solicitante: "+t.insert_usuario_nome),$(n.find(".insert_hora")).text("Aberto em: "+t.insert_hora.format_date());var r=$(n.find(".data_hora"));null!=t.data&&null!=t.hora?r.text("Agendado para: "+t.data.format_date()+" "+t.hora+" - "+t.duracao):r.text("Agendado para: "+t.data.format_date()),$(n.find(".tipo_agenda")).text(t.tipo_agenda_oportunidade_descricao),$(n.find(".descricao")).text(t.descricao),$(n.find(".observacao")).text(t.observacoes);var s=$(n.find(".chk_realizado")),_=function(){var e=s.find(".span_realizado"),a=s.find(".span_texto");"S"==t.atividade_realizada?(e.removeClass("glyphicon-pushpin"),s.removeClass("btn-warning"),e.addClass("glyphicon-thumbs-up"),s.addClass("btn-success"),a.text("Realizado")):(e.removeClass("glyphicon-thumbs-up"),s.removeClass("btn-success"),e.addClass("glyphicon-pushpin"),s.addClass("btn-warning"),a.text("Planejado"))};_(),s.unbind("click"),s.click(function(){"S"==t.atividade_realizada?t.atividade_realizada="N":t.atividade_realizada="S",_(),WS.post("oportunidade_agenda/atualizar_situacao",{oportunidade_agenda_id:t.oportunidade_agenda_id,atividade_realizada:t.atividade_realizada},function(e){})});var l=$(n.find(".btn_editar"));l.unbind("click"),l.click(function(){View.load("oportunidade/atividade",function(e,a){a.onclose=i.render_agendas,a.show(t.oportunidade_agenda_id,FORMULARIO.EDITAR,t.representante_usuario_id,t.oportunidade_id)})});var c=$(n.find(".data_previsao")),p=DiferencaDatasDias(t.data);c.text(p.day_text),c.addClass("label-"+p.span);var u=$(n.find(".btn_excluir_agenda"));u.unbind("click"),u.click(function(){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja Remover?")),alert_modal("Atenção",e,"Remover",function(){WS.post("oportunidade_agenda/excluir",{oportunidade_agenda_id:t.oportunidade_agenda_id},function(e){alert_saved(e.descricao+" excluído com sucesso"),i.render_agendas()})},!0)}),n.appendTo(e)}(0,t)})})},this.render_convidados=function(){var e=i.dialog.find(".div_convidados"),a=e.find(".template-ul");WS.get("oportunidade/listar_convidados/",{oportunidade_id:i.oportunidade_id},function(o){e.find(".row_ul").remove(),i.arr_convidados=o,$(i.arr_convidados).each(function(o,t){!function(o,t){var n=a.clone();n.removeClass("template-ul"),n.addClass("row_ul"),n.css("display",""),"S"==t.excluido&&$(n).addClass("hidden");var d=$(n.find(".carrega_img"));null!=t.logo_id?d.attr("src",WS_URI+"documento/midia/?documento_id="+t.logo_id+"&token_midia="+App.sessao.token_midia):d.attr("src","assets/img/imagem_usuario_padrao.svg"),$(n.find(".descricao")).text(t.nome);var r=$(n.find(".btn_visualizar"));r.unbind("click"),r.click(function(){View.load("representante/detalhes",function(e,a){a.show(t.representante_id,FORMULARIO.VISUALIZAR)},View.ABA.MULTIPLAS)});var s=$(n.find(".btn_excluir_agenda"));s.unbind("click"),s.click(function(){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja Remover?")),alert_modal("Atenção",e,"Remover",function(){WS.post("oportunidade/excluir_convidado/",{oportunidade_id:i.oportunidade_id,representante_usuario_id:t.representante_usuario_id},function(e){i.render_convidados()})},!0)}),n.appendTo(e)}(0,t)})})},this.listar_orcamentos=function(){var e=i.tab_listagem_orcamento.find("tbody"),a=e.find("tr:first");i.tab_listagem_orcamento.find("tr:gt(1)").remove();var o={oportunidade_id:i.oportunidade_id};WS.get("oportunidade_orcamento/listar/",o,function(o){$(o).each(function(o,t){!function(o,t){var n=a.clone();n.removeAttr("template-row"),n.css("display",""),$(n.find("[template-field='oportunidade_orcamento_id']")).text("#"+(1==i.utilizar_controle_sequencia_orcamento?o.sequencia:o.oportunidade_orcamento_id)),$(n.find("[template-field='insert_hora']")).text(o.insert_hora.format_date_time()),$(n.find("[template-field='total']")).text(o.valor_total>0?o.valor_total.format_number(2,!0):"0,00");var d=$(n.find(".lb_situacao"));0==o.situacao?(d.removeClass("label-warning"),d.addClass("label-warning"),d.text("Aguardando Aprovação")):1==o.situacao?(d.removeClass("label-warning"),d.addClass("label-success"),d.text("Aprovado")):2==o.situacao?(d.removeClass("label-warning"),d.addClass("label-danger"),d.text("Reprovado")):4==o.situacao?(d.removeClass("label-warning"),d.addClass("label-default"),d.text("Orçamento Aprovado e Aguardando Envio de E-mail")):(d.removeClass("label-warning"),d.addClass("label-info"),d.text("Em Análise"));var r=$(n.find(".btn_enviar_email"));r.unbind("click"),r.click(function(){View.load("oportunidade/email_orcamento",function(e,a){a.onsave=i.listar_orcamentos,a.show(FORMULARIO.EDITAR,i.oportunidade_id,get_value_combobox(i.cbo_contatos),o.oportunidade_orcamento_id,i.entidade_nome,i.entidade_razao_social,get_value_combobox(i.cbo_funil),o.situacao)},View.ABA.MULTIPLAS)});var s=$(n.find(".btn_imprimir_orcamento"));s.unbind("click"),s.click(function(){var e=1;App.temp.empresa&&(e=App.temp.empresa);var a=function(e,a){App.obter_token_publico(function(o){App.download(WS_URI+"oportunidade/gerar_pdf/?empresa_id="+e+"&oportunidade_orcamento_id="+a+"&token_publico="+o)})};if(App.PE.Oportunidade_download_orcamento_antes)try{App.PE.Oportunidade_download_orcamento_antes(i,e,o.oportunidade_orcamento_id,a)}catch(e){console.log(e)}else a(e,o.oportunidade_orcamento_id)}),"S"===o.exibir_botao_download_orcamento_pdf?s.show():s.hide();var _=$(n.find(".btn_gerar_word"));_.unbind("click"),_.click(function(){View.loadReact(window.views.orcamento_template_word.OrcamentoTemplateWordListagem.default,{oportunidadeOrcamentoId:o.oportunidade_orcamento_id,exibirDownloadDOCX:o.exibir_botao_download_orcamento_template_docx,exibirDownloadPDF:o.exibir_botao_download_orcamento_template_pdf},function(e){},View.ABA.SIM)}),"S"===o.exibir_botao_download_orcamento_template_docx||"S"===o.exibir_botao_download_orcamento_template_pdf?_.show():_.hide();var l=$(n.find(".btn_aprovar"));l.unbind("click"),l.click(function(){var e={oportunidade_orcamento_id:o.oportunidade_orcamento_id,situacao:ORCAMENTO_FILTROS.APROVADO};WS.post("oportunidade_orcamento/alterar_situacao",e,function(e){alert_saved("Orçamento #"+(!0===i.utilizar_controle_sequencia_orcamento?e.sequencia:e.id)+" aprovado com sucesso"),i.listar_orcamentos()},[l])});var c=$(n.find(".btn_reprovar"));if(c.unbind("click"),c.click(function(){View.load("orcamento/justificativa",function(e,a){a.onsave=function(e){var a={oportunidade_orcamento_id:o.oportunidade_orcamento_id,situacao:ORCAMENTO_FILTROS.REPROVADO,justificativa:e};WS.post("oportunidade_orcamento/alterar_situacao",a,function(e){alert_saved("Orçamento #"+(!0===i.utilizar_controle_sequencia_orcamento?e.sequencia:e.id)+" reprovado com sucesso"),i.listar_orcamentos()},[c])},a.show(i.oportunidade_orcamento_id,FORMULARIO.NOVO)})}),0==t&&(r.removeClass("hidden"),c.removeClass("hidden"),l.removeClass("hidden")),1!=App.sessao.dados.admin&&"S"!=App.sessao.dados.admin&&"S"!=App.sessao.dados.supervisor_atendimento_relacionamento&&(c.addClass("hidden"),l.addClass("hidden")),null!=o.data_aprovacao&&""!=o.data_aprovacao&&"null"!=o.data_aprovacao){$(n.find(".lb_nome_usuario")).text(o.usuario_aprovacao_nome),$(n.find(".lb_data")).text(o.data_aprovacao.format_date_time());var p=$(n.find(".lb_sem_email"));"N"==o.possui_email&&p.text("Orçamento sem envio de E-Mail")}var u=$(n.find(".lb_justificativa"));null!=o.justificativa_aprovacao&&o.situacao==ORCAMENTO_FILTROS.REPROVADO&&u.text(o.justificativa_aprovacao),1==App.sessao.dados.admin||"S"==App.sessao.dados.admin||"S"==App.sessao.dados.supervisor_atendimento_relacionamento||0!=o.situacao&&2!=o.situacao||r.addClass("hidden"),"N"==o.possui_email&&r.addClass("hidden"),n.appendTo(e)}(t,o)})})},this.alterarTipoMoeda=function(){i.alterarTextoLabel(i.dialog.find(".div_vlr_desconto_item").find("label")),i.alterarTextoLabel(i.dialog.find(".div_preco_unitario").find("label")),i.alterarTextoLabel(i.dialog.find(".div_preco_unitario_com_desconto").find("label")),i.alterarTextoLabel(i.dialog.find(".div_vlr_desconto_oportunidade").find("label")),i.alterarTextoLabel(i.dialog.find(".div_valor_ipi").find("label")),i.alterarTextoLabel(i.dialog.find(".div_total").find("label")),i.alterarTextoLabel(i.dialog.find(".div_custo").find("label")),i.alterarTextoLabel(i.dialog.find(".div_valor_lucro_bruto").find("label")),i.alterarTextoLabel(i.dialog.find(".div_total_desconto_oportunidade").find("label")),i.alterarTextoLabel(i.dialog.find(".div_lucro_bruto_total").find("label")),i.alterarTextoLabel($(i.dialog.find(".edt_valor_total").parents()[1]).find("label")),i.alterarTextoLabel($(i.dialog.find(".edt_subtotal").parents()[1]).find("label"))},this.alterarTextoLabel=function(e){var a=$(e[0]).text().split(" ");a.pop(),a.push(i.tipo_moeda_simbolo),e.text(a.join(" "))},this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){WS.get("oportunidade/verificar_oportunidade_solicitacao/",{oportunidade_id:i.oportunidade_id},function(e){e.retorno||"N"!=e.vinculo_obrigatorio?i.salvar_oportunidade("N",null):alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"A oportunidade precisa de um processo com a etapa "+e.nome_etapa+" aprovada<br />Está oportunidade não possui, deseja continuar mesmo assim ?","Sim",function(){i.salvar_oportunidade("N",null)},!0,"Cancelar")})}),this.btn_oportunidade.unbind("click"),this.btn_oportunidade.click(function(){i.esconde_mostra_oportunidade()}),this.esconde_mostra_oportunidade=function(){i.div_oportunidade.hasClass("hidden")?(i.div_oportunidade.removeClass("hidden"),i.btn_oportunidade.text("Ocultar detalhes"),i.div_panel.removeClass("col-md-12").removeClass("col-lg-12").addClass("col-md-9").addClass("col-md-9")):(i.div_oportunidade.addClass("hidden"),i.btn_oportunidade.text("Mais detalhes"),i.div_panel.removeClass("col-md-9").removeClass("col-lg-9").addClass("col-md-12").addClass("col-md-12"))},this.salvar_oportunidade=function(e,a,o,t){var n="",d="";"C"==i.entidade_tipo?n=i.entidade_id:"O"==i.entidade_tipo&&(d=i.entidade_id);var r=!1,s=null,_=null,l=null;null!=a&&(r=a.enviar_email,s=a,_=a.documentos,l=a.enviar_email_caixa_saida);var c=1;if(App.temp.empresa&&(c=App.temp.empresa),i.considera_valor_PE)for(var p=0;p<i.arr_itens.length;p++)void 0!==i.arr_itens[p].total_atualizado&&(i.arr_itens[p].total=i.arr_itens[p].total_atualizado);if(i.campos_personalizados&&i.oportunidade_id&&(!i.validar_campos_obrigatorios()||!i.validar_data_form()))return!1;var u={empresa_id:c,oportunidade_id:i.oportunidade_id,status_id:i.status_id,contato_id:get_value_combobox(i.cbo_contatos),cliente_id:n,prospect_id:d,nome_oportunidade:i.edt_nome_oportunidade.val(),tipo_oportunidade_id:i.cbo_tipo_oportunidade.val(),funil_id:get_value_combobox(i.cbo_funil),etapa_id:i.cbo_etapa.val(),dt_fechamento:get_datepicker(i.edt_data_fechamento),valor_negocio:i.edt_valor_negocio.maskMoney("unmasked")[0],etiquetas:i.etiquetas,situacao:i.tipo==FORMULARIO.NOVO?"A":i.cbo_situacao.val(),arr_itens:JSON.stringify(i.arr_itens),representante_usuario_id:i.representante_usuario_id,percentual_desconto:i.edt_perc_total_desconto_oportunidade.maskMoney("unmasked")[0],calcular_desconto_por_percentual:i.calcular_desconto_por_percentual,valor_desconto:i.edt_total_desconto_oportunidade.maskMoney("unmasked")[0],arr_agendas:JSON.stringify(i.arr_agendas),gerar_versao:e,condicao_pagamento_id:get_value_combobox(i.cbo_condicao_pagamento),motivo_desconto:i.edt_motivo_desconto.val(),observacao_condicao_pagamento:i.edt_observacao_condicao_pagamento.val(),tipo_frete:i.cbo_tipo_frete.val(),valor_frete:i.edt_valor_frete.maskMoney("unmasked")[0],observacao_frete:i.edt_observacao_frete.val(),data_entrega:get_datepicker(i.edt_data_entrega),observacao_entrega:i.edt_observacao_entrega.val(),observacao:i.edt_observacao.val(),observacao_nf:i.edt_observacao_nf.val(),validade_orcamento:get_datepicker(i.edt_validade_orcamento),enviar_email:r,corpo_email:JSON.stringify(s),documentos_email:_,tabela_preco_id:get_value_combobox(i.cbo_tabela_preco),transportadora_id:get_value_combobox(i.cbo_transportador),representante_usuario2_id:i.representante_usuario_id2,enviar_email_caixa_saida:l,oportunidade_origem_id:i.oportunidade_origem_id,tipo_moeda_id:i.tipo_moeda_id,campos_personalizados:JSON.stringify(i.campos_personalizados)};i.campos_personalizados&&$(i.campos_personalizados.grupos).each(function(e,a){$(a.elementos).each(function(e,a){a.tipo==ELEMENTO_TIPO.ANEXO&&a.anexo?u[a.elem_key]=a.anexo:a.tipo==ELEMENTO_TIPO.TABELA&&a.valor&&$(a).each(function(e,a){a.valor&&$(a.valor).each(function(e,a){u[a.elem_key+"_linha_"+a.linha]=a.anexo})})})}),$(i.arr_itens).each(function(e,a){0==parseInt(a.qtde_casas_decimal)&&(a.quantidade=parseInt(a.quantidade)),0==parseInt(a.qtde_casas_decimal2)&&(a.quantidade_unidade_medida2=parseInt(a.quantidade_unidade_medida2))}),WS.post("oportunidade/salvar",u,function(a){if(i.oportunidade_id=a.id,i.status_id=a.status_id,i.arr_itens=a.arr_itens,i.entidade_nome=a.entidade_nome,i.entidade_razao_social=a.entidade_razao_social,i.oportunidade=a,"S"==e)i.btn_salvar.removeClass("btn-warning"),i.btn_salvar.addClass("btn-primary"),i.tipo=FORMULARIO.EDITAR,App.titulo_aba(i.html_id,a.nome.substring(0,10)+" - Oportunidade"),i.menu_orcamentos.tab("show"),alert_saved("Orçamento gerado com sucesso."),o&&View.unload(o);else if(i.tipo==FORMULARIO.NOVO){i.btn_salvar.removeClass("btn-warning"),i.btn_salvar.addClass("btn-primary"),alert_saved(a.nome+" salvo com sucesso."),i.btn_salvar.text("Salvar"),i.div_panel.css({cursor:"default",opacity:""}),i.div_panel_default.css("pointer-events","all"),i.div_panel.removeClass("hidden-xs hidden-sm"),$(window).width()<=992?i.div_oportunidade.removeClass("hidden"):i.div_oportunidade.addClass("hidden"),i.esconde_mostra_oportunidade(),i.btn_oportunidade.removeClass("hidden"),i.btn_salvar.removeClass("pull-left").addClass("pull-right"),i.btn_cancelar.removeClass("pull-left").addClass("pull-right"),i.btn_excluir.removeClass("pull-left").addClass("pull-right"),i.tipo=FORMULARIO.EDITAR,App.titulo_aba(i.html_id,a.nome.substring(0,10)+" - Oportunidade"),View.loadPE("Oportunidade_Detalhes_Preencher",i);let e=new Object;e.funil_vendas_id=get_value_combobox(i.cbo_funil),i.render_formulario(e.funil_vendas_id,a.id)}else void 0===t&&(alert_saved(a.nome+" salvo com sucesso."),i.unload());void 0!==t&&t()},[i.btn_salvar,i.btn_cancelar,i.btn_gerar_orcamento],null,!0)},this.render_observacoes=function(){var e=i.dialog.find(".div_body_observacoes"),a=e.find(".template-ul");WS.get("oportunidade_observacoes/listar/",{oportunidade_id:i.oportunidade_id},function(o){i.arr_observacoes=o,e.find(".row_ul").remove(),$(i.arr_observacoes).each(function(o,t){!function(o,t){var n=a.clone();n.removeClass("template-ul"),n.addClass("row_ul"),n.css("display",""),$(n.find(".nome_usuario")).text(t.nome),$(n.find(".data_hora")).text(t.insert_hora.format_date_time()),$(n.find(".mensagem")).html(t.observacao).find("img").css("max-width","100%");var d=$(n.find(".carrega_img"));null!=t.foto_id?d.attr("src",WS_URI+"documento/midia/?documento_id="+t.foto_id+"&token_midia="+App.sessao.token_midia):d.attr("src","assets/img/imagem_usuario_padrao.svg");var r=$(n.find(".btn_editar_obs")),s=function(){View.load("oportunidade/nova_mensagem",function(e,a){a.onclose=i.render_observacoes,a.show(FORMULARIO.EDITAR,t.oportunidade_id,t.oportunidade_observacoes_id,t.observacao)})};r.unbind("click"),r.click(s),n.dblclick(s);var _=$(n.find(".btn_excluir_obs"));_.unbind("click"),_.click(function(){View.load("oportunidade/nova_mensagem",function(e,a){a.onclose=i.render_observacoes,a.show(FORMULARIO.EXCLUIR,t.oportunidade_id,t.oportunidade_observacoes_id,t.observacao)})}),n.appendTo(e)}(0,t)})})},this.tabela_possui_entidade=function(e){var a=new Object;a.descricao=void 0===e?i.edt_tabela_preco.val():e,a.entidade_id=i.entidade_id,a.entidade_tipo=i.entidade_tipo,a.funil_vendas_id=i.funil_vendas_id,""!==a.descricao?WS.get("tabela_precos/listar/",a,function(e){e.length>0&&null!=e[0].entidade_nome&&void 0!==e[0].entidade_nome&&(i.tabela_preco_possui_entidade=!0)}):i.tabela_preco_possui_entidade=!1},this.render_formulario=function(e,a){WS.get("formulario_oportunidade/get_formulario/",{funil_vendas_id:e,oportunidade_id:a},function(e){e?(i.campos_personalizados=e,i.menu_personalizado.removeClass("hidden"),i.menu_personalizado.html(e.nome),i.campos_personalizados.registros&&$.each(i.campos_personalizados.registros,function(e,a){"campo_anexo"==e?a&&$.each(a,function(e,a){if(a){var o=a.split(";"),t=parseInt(o[0]),n=o[1];$.each(i.campos_personalizados.grupos,function(a,o){$.each(o.elementos,function(a,o){e==o.id_elemento&&(o.valor=t,o.documento_revisao=new Object,o.documento_revisao.nome_arquivo=n,o.documento_revisao.mime_type=extensao_to_mimetype(n.substring(n.lastIndexOf(".")+1,n.length)))})})}}):"selecao_documento"==e?$.each(a,function(e,a){$.each(i.campos_personalizados.grupos,function(o,t){$.each(t.elementos,function(o,t){e==t.id_elemento&&(t.valor=a)})})}):"campo_tabela"==e&&$.each(a,function(e,a){if("string"==typeof a)try{a=JSON.parse(a.replace(/(\"{2})(\w.+?)\"{2}/gm,'"$2"').replace(/(\r\n|\n|\r)/gm," "))}catch(e){console.warn(a,a.replace(/(\"{2})(\w.+?)\"{2}/gm,'"$2"').replace(/(\r\n|\n|\r)/gm," "))}a&&$.each(i.campos_personalizados.grupos,function(o,t){$.each(t.elementos,function(o,t){e==t.id_elemento&&(t.tamanho_render=a.tamanho_render,t.valor=a.valor,void 0!==t.valor&&$.each(t.valor,function(e,a){if(null!=a.revisao){var o=a.revisao.split(";"),t=parseInt(o[0]),i=o[1];a.valor=t,a.documento_revisao=new Object,a.documento_revisao.nome_arquivo=i,a.documento_revisao.mime_type=extensao_to_mimetype(i.substring(i.lastIndexOf(".")+1,i.length))}}))})})})}),require(["./assets/view/formulario/util"],function(a){(new a).render_previsao(i,i.template_campo,i.template_grupo,i.campos_personalizados),e.registros&&$.each(e.registros,function(a,o){"campo_geral"==a?Object.keys(e.registros.campo_geral).map(function(a,o){i.aba_personalizado.find("[id_elemento="+a+"]").val(e.registros.campo_geral[a]),i.aba_personalizado.find("[id_elemento="+a+"]").change(),i.aba_personalizado.find("[id_elemento="+a+"]").blur()}):"campo_decimal"==a?Object.keys(e.registros.campo_decimal).map(function(a,o){e.registros.campo_decimal[a]&&(i.aba_personalizado.find("[id_elemento="+a+"]").val(e.registros.campo_decimal[a].replace(".",",")),i.aba_personalizado.find("[id_elemento="+a+"]").change(),i.aba_personalizado.find("[id_elemento="+a+"]").blur())}):"lista_opcoes"==a?Object.keys(e.registros.lista_opcoes).map(function(a,o){var t=i.aba_personalizado.find("[id_elemento="+a+"]").find("option"),n=e.registros.lista_opcoes[a];null!=n&&(n=n.split(";"));var d=0;t&&n&&$.each(t,function(e,a){$.each(n,function(e,o){a.value==o&&(a.selected=!0,$(a).change(),$(a).blur(),d=$(a).index(),$(a).parent().parent().find("[data-original-index='"+d+"']").addClass("selected"))})})}):"radio"==a?Object.keys(e.registros.radio).map(function(a,o){var t=i.aba_personalizado.find("[id_elemento="+a+"]");t.parent().find("input[value='"+e.registros.radio[a]+"']").prop("checked",!0),t.parent().find("input[value='"+e.registros.radio[a]+"']").change()}):"checkbox"==a?Object.keys(e.registros.checkbox).map(function(a,o){var t=e.registros.checkbox[a];null!=t&&(t=t.split(";"));var n=i.aba_personalizado.find("[id_elemento="+a+"]");t&&$.each(t,function(e,a){n.parent().find("input[value='"+a+"']").prop("checked",!0),n.parent().find("input[value='"+a+"']").change()})}):"'caixa_verificacao'"==a?$.each(e.registros.caixa_verificacao,function(e,a){"S"==a&&i.aba_personalizado.find("[id_elemento="+e+"]").prop("checked",!0)}):"editor_texto"==a?setTimeout(function(){Object.keys(e.registros.editor_texto).map(function(a,o){tinyMCE.get(i.aba_personalizado.find("[id_elemento="+a+"]").attr("id")).setContent(e.registros.editor_texto[a])})},500):"campo_integracao"==a&&Object.keys(e.registros.campo_integracao).map(function(a,o){i.aba_personalizado.find("[id_elemento="+a+"]").find(".dx-dropdownbox").dxDropDownBox("instance").option("value",e.registros.campo_integracao[a])})})})):i.menu_personalizado.addClass("hidden")})},this.validar_data_form=function(){var e=new Date,a=("0"+e.getDate()).slice(-2),o=("0"+(e.getMonth()+1)).slice(-2),t=e.getFullYear()+"-"+o+"-"+a,n="";return i.form_editor.find('[type="date"]').each(function(e,a){var o=$(a);void 0===(o.attr("disabled")||o.attr("readonly"))&&"none"!=$(a).css("display")&&""!=a.value&&null!=a.value&&("S"==o.attr("data_retroativa")&&(get_datepicker(o)<t?(o.tooltip({title:"Data Inválida",placement:"auto"}),o.tooltip("show"),n+=$(a).attr("id_elemento")+"<br />"):o.tooltip("destroy")),"S"==o.attr("data_retroativa_igual")&&(get_datepicker(o)<=t?(o.tooltip({title:"Data Inválida",placement:"auto"}),o.tooltip("show"),n+=$(a).attr("id_elemento")+"<br />"):o.tooltip("destroy")))}),""==n||(alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Data Inválida !'," Data informada fora do período válido, informe corretamente para os campos abaixo: <br /><br /> "+n),!1)},this.alerta_campo_obrigatorio=function(e,a){e.tooltip({title:"Campo obrigatorio",placement:void 0!==a?a:"auto"}),e.tooltip("show")},this.validar_campos_obrigatorios=function(){var e="";return i.form_editor.find("[required]").not(".selectpicker").each(function(a,o){var t=$(o);"text"==t.attr("type")&&void 0===t.attr("maskmoney")?void 0===t.attr("readonly")&&"none"!=$(o).css("display")||$(o).hasClass("input_consulta_integracao")?void 0!==t.attr("maskmoney")?""!=o.value.trim()&&0!=t.maskMoney("unmasked")[0]||(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(t)):""==o.value.trim()&&(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(t)):t.tooltip("destroy"):void 0===t.attr("disabled")&&"none"!=$(o).css("display")?void 0!==t.attr("maskmoney")?""===o.value.trim()&&(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(t)):"date"==t.attr("type")&&void 0===t.attr("disabled")&&void 0===t.attr("readonly")?""==o.value.trim()&&(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(t)):""==o.value.trim()&&"date"!=t.attr("type")&&(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(t)):t.tooltip("destroy")}),i.form_editor.find(".vld_lista_check").each(function(a,o){var t=$(o);if(!t[0].children[0].disabled&&"none"!==t[0].children[0].style.display){var n=t.find("input:checked"),d=t.parent().find(".lbl_nome");n&&0!=n.length?d.tooltip("destroy"):(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(d))}}),i.form_editor.find(".vld_lista_radio").each(function(a,o){var t=$(o);if(!t[0].children[0].disabled&&"none"!==t[0].children[0].style.display){var n=t.find("input:checked"),d=t.parent().find(".lbl_nome");n&&0!=n.length?d.tooltip("destroy"):(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(d))}}),i.form_editor.find("select.selectpicker[required]").each(function(a,o){var t=$(o);if(!t[0].disabled&&"none"!==t[0].style.display){var n=t.val(),d=t.parent().find(".lbl_nome");n&&0!=n.length?d.tooltip("destroy"):(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(d))}}),i.form_editor.find(".div_input_arquivo [required]").each(function(a,o){let t=$(o),n=t.parent().find(".lbl_nome");""==t.val().trim()&&void 0===t.parent().find("button").attr("disabled")&&(e+=$(o).attr("id_elemento")+"<br />",i.alerta_campo_obrigatorio(n))}),$("<div>").dxButton({onClick:function(a){for(var o=0;o<a.validationGroup.validators.length;o++){var t=a.validationGroup.validators[o];t.option("adapter").editor.option("readOnly")&&t.option("validationRules",[])}if(!a.validationGroup.validate().isValid){let a=$(t._$element.parent()).attr("id_elemento");e+=a+"<br />"}}}).click(),""==e||(alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Campos Obrigatórios !'," Por gentileza, preencha os campos abaixo: <br /><br /> "+e),!1)},this.listar_status=function(){var e=i.tab_listagem_status.find("tbody"),a=e.find("tr:first"),o={oportunidade_id:i.oportunidade_id};WS.get("oportunidade_status/listar/",o,function(o){i.tab_listagem_status.find("tr:gt(1)").remove(),$(o).each(function(o,t){!function(o,t){var n=a.clone();n.removeAttr("template-row"),n.css("display",""),$(n.find("[template-field='status']")).append('<span class="badge" style="padding-right: 10px; background:'+o.status_cor+'">'+o.status_nome+"</span>"),$(n.find("[template-field='data_inclusao']")).text(o.insert_hora.format_date()),$(n.find("[template-field='data_fechamento']")).text(o.data_fechamento.format_date());var d=$(n.find(".btn_excluir_status"));d.unbind("click"),d.click(function(){var e=new Validation;e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Deseja Remover?")),alert_modal("Atenção",e,"Remover",function(){var e={oportunidade_status_id:o.oportunidade_status_id};WS.post("oportunidade_status/excluir",e,function(e){alert_saved("Status excluído com sucesso"),i.listar_status()},[d])},!0)}),n.appendTo(e)}(t)})})},this.listar_historico=function(e){var a={oportunidade_id:i.oportunidade_id,limite:i.scroll.historico.limite,motivo_perda_negocio:i.motivo_perda_negocio};void 0!==e&&"boolean"==typeof e||(e=!1),i.scroll.historico.bloqueia_limite||WS.get({route:"oportunidade_historico/listar/",type:"GET",data:a,func_response:function(a){i.div_carregar_mais.removeClass("hidden"),i.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.carregar_mais_registros),i.btn_carregar_mais.find("span.icn_carregar_mais").remove(),i.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-arrow-down"></span>'),a&&(e&&(i.scroll.historico.limite=i.scroll.historico.limite+i.scroll.historico.limite_a_cada),0==a.length&&(i.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.todos_carregados),i.btn_carregar_mais.find("span.icn_carregar_mais").remove(),i.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-check"></span>'),i.scroll.historico.bloqueia_limite=!0),i.render_historico(a))},html_id:i.html_id})},this.render_historico=function(e){var a=i.tab_listagem_historico.find("tbody"),o=a.find("tr:first");$(e).each(function(e,t){!function(e,t){var i=o.clone();i.removeAttr("template-row"),i.css("display","");var n=$(i.find("[template-field='acao']"));switch(e.acao_id){case"1":n.addClass("label-success"),n.text("Inclusão");break;case"2":n.addClass("label-warning"),n.text("Alteração");break;case"3":n.addClass("label-danger"),n.text("Exclusão")}$(i.find("[template-field='coluna']")).text(e.coluna),$(i.find("[template-field='valor_anterior']")).text(e.valor_anterior),$(i.find("[template-field='valor_novo']")).text(e.valor_novo),$(i.find("[template-field='insert_hora']")).text(e.insert_hora.format_date_time()),$(i.find("[template-field='usuario_insert']")).text(e.usuario_insert),i.appendTo(a)}(t)})},this.validar_item=function(e,a,o){if(a.tooltip("destroy"),("S"==i.obrigar_regra_tabela_preco||"S"==i.notificar_regra_tabela_preco)&&"N"==e.excluido&&("edt_preco"==o&&parseFloat(e.preco_minimo)>0&&parseFloat(e.preco_minimo)>parseFloat(e.preco)&&(setTimeout(function(){a.tooltip({title:"Preço mínimo sugerido: "+e.preco_minimo.format_number(2,!0),placement:"auto"}),a.tooltip("show")},1e3),"edt_preco"==o&&"S"==i.obrigar_regra_tabela_preco&&a.trigger({type:"keyup",keyCode:13})),"edt_preco"==o&&parseFloat(e.preco_maximo)>0&&parseFloat(e.preco_maximo)<parseFloat(e.preco)&&(setTimeout(function(){a.tooltip({title:"Preço máximo sugerido: "+e.preco_maximo.format_number(2,!0),placement:"auto"}),a.tooltip("show")},1e3),"edt_preco"==o&&"S"==i.obrigar_regra_tabela_preco&&a.trigger({type:"keyup",keyCode:13})),"edt_quantidade"==o&&parseFloat(e.quantidade_minima)>0&&parseFloat(e.quantidade_minima)>parseFloat(e.quantidade)&&(setTimeout(function(){a.tooltip({title:"Quantidade mínima sugerida: "+e.quantidade_minima.format_number(2,!0),placement:"auto"}),a.tooltip("show")},1e3),"edt_quantidade"!=o&&"edt_quantidade_unidade_medida2"!=o||"S"==i.obrigar_regra_tabela_preco&&a.trigger({type:"keyup",keyCode:13})),"edt_quantidade"==o&&parseFloat(e.quantidade_maxima)>0&&parseFloat(e.quantidade_maxima)<parseFloat(e.quantidade)&&(setTimeout(function(){a.tooltip({title:"Quantidade máxima sugerida: "+e.quantidade_maxima.format_number(2,!0),placement:"auto"}),a.tooltip("show")},1e3),"edt_quantidade"!=o&&"edt_quantidade_unidade_medida2"!=o||"S"==i.obrigar_regra_tabela_preco&&a.trigger({type:"keyup",keyCode:13})),"edt_perc_desconto"==o&&parseFloat(e.perc_desconto)>0)){parseFloat(e.desconto)>0&&parseFloat(e.perc_desconto)>parseFloat(e.desconto)&&setTimeout(function(){a.tooltip({title:"Desconto máximo sugerido: "+e.desconto.format_number(2,!0)+"%"}),a.tooltip("show")},1e3);var t=parseFloat(e.quantidade)*parseFloat(e.preco),n=parseFloat(t)*parseFloat(e.perc_desconto)/100,d=parseFloat(t)-parseFloat(n),r=parseFloat(d)/parseFloat(e.quantidade);parseFloat(e.preco_desconto)>0?r<parseFloat(e.preco_desconto)&&setTimeout(function(){a.tooltip({title:"Preço c/ desconto mínimo sugerido: "+i.tipo_moeda_simbolo+e.preco_desconto.format_number(2,!0)}),a.tooltip("show")},1e3):parseFloat(e.preco_minimo)>parseFloat(r)&&setTimeout(function(){a.tooltip({title:"Preço c/ desconto mínimo sugerido: "+i.tipo_moeda_simbolo+e.preco_minimo.format_number(2,!0)}),a.tooltip("show")},1e3),"S"==i.obrigar_regra_tabela_preco&&a.trigger({type:"keyup",keyCode:13})}},this.converter_unidade_medida=function(e,a,o,t){return a=parseFloat(a),null==(t=parseFloat(t))||0==t?0:o==r?e==n?a*t:a/t:e==n?a/t:a*t},this.sugerir_configuracoes_da_entidade=function(e,a,o,t,n,d){null!=o&&""!=o?set_value_combobox(i.cbo_condicao_pagamento,o,t):null!=i.condicao_pagamento_id&&""!=i.condicao_pagamento_id?set_value_combobox(i.cbo_condicao_pagamento,i.condicao_pagamento_id,i.condicao_pagamento_descricao):set_value_combobox(i.cbo_condicao_pagamento,"",""),i.tem_itens||(i.btn_incluir_item.prop("disabled",!0),e>0?"S"==i.notificar_regra_tabela_preco&&"N"==d?alert_modal("Atenção","A tabela de preços <strong>"+a+"</strong> desta entidade está fora do prazo.<br><br>Deseja vinculá-la à oportunidade mesmo assim?","Vincular mesmo assim",function(){set_value_combobox(i.cbo_tabela_preco,e,a),i.entidade_tabela_preco_id=e},!0,"Não vincular",null,function(){set_value_combobox(i.cbo_tabela_preco,"","")}):"N"==i.notificar_regra_tabela_preco&&"N"==i.permitir_tabela_preco_vencida&&null!==n&&"N"==d?set_value_combobox(i.cbo_tabela_preco,"",""):(set_value_combobox(i.cbo_tabela_preco,e,a),i.entidade_tabela_preco_id=e):set_value_combobox(i.cbo_tabela_preco,"",""),i.btn_incluir_item.prop("disabled",!1))},this.btn_detalhes_entidade.unbind("click"),this.btn_detalhes_entidade.click(function(){i.div_detalhes_entidade.hasClass("hidden")?i.div_detalhes_entidade.removeClass("hidden"):i.div_detalhes_entidade.addClass("hidden")}),this.btn_historico_entidade.unbind("click"),this.btn_historico_entidade.click(function(){i.entidade_id&&View.load("entidade_historico/listar",function(e,a){a.show(i.entidade_id,i.entidade_tipo)},View.ABA.MULTIPLAS)}),this.btn_detalhes_contato.unbind("click"),this.btn_detalhes_contato.click(function(){i.div_detalhes_contato.hasClass("hidden")?i.div_detalhes_contato.removeClass("hidden"):(i.div_detalhes_contato.addClass("hidden"),i.adicionarDadosContato())}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),this.btn_incluir_item.unbind("click"),this.btn_incluir_item.click(function(){var e="";i.arr_itens.length>0?$(i.arr_itens).each(function(a,o){"N"==o.excluido&&null!=o.codigo_pedido_item&&""!=o.codigo_pedido_item&&(e=o.codigo_pedido_item)}):e=null;var a={oportunidade_item_id:null,excluido:"N",oportunidade_id:null,codigo:"",item_id:null,item_descricao:null,preco:0,quantidade:0,perc_desconto:0,valor_desconto:0,preco_unitario_com_desconto:0,total:0,cst_ipi:null,perc_ipi:0,valor_ipi:0,unidade_medida_id:null,unidade_medida2_id:null,unidade_medida:"",unidade_medida2:"",fator_conversao:0,tipo_conversao:"D",quantidade_unidade_medida2:0,codigo_pedido_item:e,calcular_preco_por_percentual:"S"};i.arr_itens.push(a),i.render_itens(),setTimeout(function(){window.scrollTo(0,window.scrollY+174)},300)}),this.btn_nova_agenda.unbind("click"),this.btn_nova_agenda.click(function(){View.load("oportunidade/atividade",function(e,a){a.onclose=i.render_agendas;const o=App.sessao.dados.usuario_id==i.representante_usuario_id2?i.representante_usuario_id2:i.representante_usuario_id;a.show(null,FORMULARIO.NOVO,o,i.oportunidade_id,i.edt_nome_oportunidade.val())})}),this.btn_recarrega_eventos.unbind("click"),this.btn_recarrega_eventos.click(function(){i.listar_agenda()}),this.btn_gerar_orcamento.unbind("click"),this.btn_gerar_orcamento.click(function(){i.salvar_oportunidade("N",null,null,function(){if(null==i.oportunidade_id||""==i.oportunidade_id){var e=new Validation;return e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por favor, salvar a oportunidade.")),void alert_modal("Validação",e)}View.load("oportunidade/email_orcamento",function(e,a){a.onsave=function(e,a){i.salvar_oportunidade("S",e,a)},a.show(FORMULARIO.NOVO,i.oportunidade_id,get_value_combobox(i.cbo_contatos),null,i.entidade_nome,i.entidade_razao_social,get_value_combobox(i.cbo_funil),0)},View.ABA.MULTIPLAS)})}),i.nav_oportunidade.on("shown.bs.tab",function(e){if(null==i.oportunidade_id||""==i.oportunidade_id){if("menu_item"!=e.target.className&&"menu_status"!=e.target.className){i.menu_item.tab("show");var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por favor, salvar oportunidade antes de prosseguir.")),void alert_modal("Validação",a)}}else"menu_orcamentos"==e.target.className&&i.listar_orcamentos(),"menu_agenda"==e.target.className&&i.listar_agenda(),"menu_historico"==e.target.className&&(i.tab_listagem_historico.find("tr:gt(1)").remove(),i.limpar_scroll_historico(),i.listar_historico(!0)),"menu_status"==e.target.className&&i.listar_status()}),this.btn_nova_mensagem.unbind("click"),this.btn_nova_mensagem.click(function(){View.load("oportunidade/nova_mensagem",function(e,a){a.onclose=i.render_observacoes,a.show(FORMULARIO.NOVO,i.oportunidade_id)})}),this.btn_nova_mensagem_refresh.unbind("click"),this.btn_nova_mensagem_refresh.click(function(){i.render_observacoes()}),this.btn_novo_status.unbind("click"),this.btn_novo_status.click(function(){if(null==i.oportunidade_id||""==i.oportunidade_id){var e=new Validation;return e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por favor, salvar oportunidade antes de prosseguir.")),void alert_modal("Validação",e)}View.load("oportunidade/status",function(e,a){a.onclose=i.listar_status,a.show(i.oportunidade_id,null,FORMULARIO.NOVO)})}),this.limpar_scroll_historico=function(){i.scroll.historico.limite=0,i.scroll.historico.bloqueia_limite=!1},this.btn_refresh_status.unbind("click"),this.btn_refresh_status.click(function(){i.listar_status()}),this.btn_carregar_mais.unbind("click").click(function(){i.scroll.historico.bloqueia_limite||(i.listar_historico(!0),i.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.aguarde),i.btn_carregar_mais.find("span.icn_carregar_mais").remove(),i.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-spinner fa-spin">'))}),this.calcular_valor_negocio_frete=function(){let e=i.edt_valor_frete.maskMoney("unmasked")[0];if(i.edt_valor_negocio.prop("disabled")&&i.arr_itens.length>0){let a=parseFloat(i.total_itens)+parseFloat(e);i.edt_valor_negocio.maskMoney("mask",a)}},this.edt_valor_frete.on("keyup",$.debounce(900,i.calcular_valor_negocio_frete))}});