define([],function(){return function(a){"use strict";var e=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Atividades",this.edt_numero=this.dialog.find(".edt_numero"),this.edt_objetivo=this.dialog.find(".edt_objetivo"),this.edt_data_inicio=this.dialog.find(".edt_data_inicio"),this.edt_data_fim=this.dialog.find(".edt_data_fim"),this.edt_progresso=this.dialog.find(".edt_progresso"),this.edt_situacao=this.dialog.find(".edt_situacao"),this.grid_pdca_atividades=this.dialog.find(".grid_pdca_atividades"),this.pdca={},this.arr_usuarios=[],this.arr_atividades=[],this.msg_observacao_atividade="",this.datagrid=null,this.pdca_atividade_id=null,this.old_data_pdca_atividade=null,this.permite_edicao_pos_acao=!1,this.filtros_row={pdca_atividade_id:0},this.param_filterRow=!1,this.dadosReferencia={referencia_tabela:null,referencia_id:null},this.show=function(a,i=!1,t={referencia_tabela:null,referencia_id:null}){e.pdca=a,void 0===i&&(i=!1),e.param_filterRow=i,!0===i&&e.pdca.dados_atividade.pdca_atividade_id>0&&(e.filtros_row.pdca_atividade_id=e.pdca.dados_atividade.pdca_atividade_id),null!==t&&"object"==typeof t&&(e.dadosReferencia.referencia_tabela=t.referencia_tabela||null,e.dadosReferencia.referencia_id=t.referencia_id||null),e.montar_cabecalho(),e.listar()},this.listar=function(){var a=function(){WS.get("pdca_atividade/listar/",{pdca_id:e.pdca.pdca_id},function(a){e.arr_atividades=a,e.listar_equipe_pdca()})};setTimeout(function(){e.datagrid&&e.datagrid.getController("editing").getChanges().length?alert_modal("Aviso","Você possui alterações no grid. Deseja atualizar mesmo assim?","Sim",function(){a()},!0,"Cancelar",null,function(){}):a()})},this.montar_cabecalho=function(){WS.get("pdca/objeto/",{pdca_id:e.pdca.pdca_id},function(a){App.titulo_aba(e.html_id,"Atividades "+a.numero),$(e.edt_numero).prop("innerHTML",a.numero),$(e.edt_objetivo).prop("innerHTML",a.objetivo),$(e.edt_data_inicio).prop("innerHTML",a.data_inicio.format_date(!1)),$(e.edt_data_fim).prop("innerHTML",a.data_fim.format_date(!1)),$(e.edt_progresso).prop("innerHTML",a.progresso+"%"),$(e.edt_situacao).prop("innerHTML",a.situacao)})},this.listar_equipe_pdca=function(){WS.get("pdca/listar_equipe/",{pdca_id:e.pdca.pdca_id,apenas_gerente_equipe:!0},function(a){e.arr_usuarios=a,e.monta_grid()})},this.monta_grid=function(){var a=document.createElement("div");a.className="div_listagem_pdca_atividades",a.style="min-width: 100%;",e.grid_pdca_atividades.find(".div_listagem_pdca_atividades").remove(),e.grid_pdca_atividades[0].appendChild(a),e.grid_pdca_atividades.find(".div_listagem_pdca_atividades").css("height","calc(100vh - 140px)"),e.datagrid=e.grid_pdca_atividades.find(".div_listagem_pdca_atividades").dxDataGrid({dataSource:e.arr_atividades,keyExpr:"pdca_atividade_id",allowColumnResizing:!0,columnResizingMode:"widget",allowColumnReordering:!0,hoverStateEnabled:!0,wordWrapEnabled:!1,focusedRowEnabled:!1,editing:{mode:"batch",useIcons:!0,allowAdding:e.verifica_permissao(0,!0),allowUpdating:e.verifica_permissao(0,!1,!1)},loadPanel:{enabled:!0},scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},export:{enabled:!0,fileName:"PDCA #"+e.pdca.pdca_id.toString()+" - "+e.title,allowExportSelectedData:!0},filterRow:{visible:!0,applyFilter:"auto"},filterPanel:{visible:!0},noDataText:App.lang.dxDataGrid.noDataText,wordWrapEnabled:!0,rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},filterValue:e.filtros_row.pdca_atividade_id?["pdca_atividade_id","=",e.filtros_row.pdca_atividade_id]:null,onInitialized:()=>{e.filtros_row.pdca_atividade_id=null},onInitNewRow:function(a){a.data={situacao:PDCA_ATIVIDADE_SITUACAO.ABERTO,data_inicio:new Date,data_fim:new Date,quem:App.sessao.dados.admin?"":App.sessao.dados.usuario_id},a.component.columnOption("situacao","allowEditing",!0),a.component.columnOption("pdca_atividade_id","allowEditing",!1)},onEditCanceled:function(a){e.datagrid.option("editing.mode","batch")},onRowValidating:function(a){if("popup"==e.datagrid.option("editing.mode")){var i=[];i.push({data:{situacao:null!=a.newData.situacao&&""!=a.newData.situacao?a.newData.situacao:a.oldData.situacao,ordem:null!=a.newData.ordem&&""!=a.newData.ordem?a.newData.ordem:a.oldData.ordem,que:null!=a.newData.que&&""!=a.newData.que?a.newData.que:a.oldData.que,porque:null!=a.newData.porque&&""!=a.newData.porque?a.newData.porque:a.oldData.porque,quem:null!=a.newData.quem&&""!=a.newData.quem?a.newData.quem:a.oldData.quem,onde:null!=a.newData.onde&&""!=a.newData.onde?a.newData.onde:a.oldData.onde,data_inicio:null!=a.newData.data_inicio&&""!=a.newData.data_inicio?a.newData.data_inicio:a.oldData.data_inicio,data_fim:null!=a.newData.data_fim&&""!=a.newData.data_fim?a.newData.data_fim:a.oldData.data_fim,data_conclusao:null!=a.newData.data_conclusao&&""!=a.newData.data_conclusao?a.newData.data_conclusao:a.oldData.data_conclusao,como:null!=a.newData.como&&""!=a.newData.como?a.newData.como:a.oldData.como,quanto:null!=a.newData.quanto&&""!=a.newData.quanto?a.newData.quanto:a.oldData.quanto,conclusao:null!=a.newData.conclusao&&""!=a.newData.conclusao?a.newData.conclusao:a.oldData.conclusao},type:void 0!==a.oldData.pdca_atividade_id&&null!=a.oldData.pdca_atividade_id&&""!=a.oldData.pdca_atividade_id?"update":"insert",key:a.oldData.pdca_atividade_id,oldData:a.oldData}),e.atualiza_atividades_pdca(i)}},onCellPrepared:function(a){if("data"===a.rowType&&"edit"===a.column.command){var i=a.cellElement.find(".dx-link");e.verifica_permissao(a.row.data.quem,!1,!0)||i.filter(".dx-link-edit").remove()}},onEditingStart:function(a){a.component.columnOption("pdca_atividade_id","allowEditing",!1),e.pdca.situacao_id==PDCA_SITUACAO.CONCLUIDO?a.cancel=!0:a.cancel=!e.verifica_permissao(a.data.quem,!1,!0)},onEditorPreparing:function(a){var e=["que","porque","onde","como"].find(function(e){return e===a.dataField});"dataRow"==a.parentType&&e?a.editorName="dxTextArea":"dataRow"==a.parentType&&"ordem"==a.dataField&&(a.editorOptions.maxLength=10)},onEditorPrepared:function(a){if("dataRow"===a.parentType)switch("data_inicio"===a.dataField||"data_fim"===a.dataField||"data_conclusao"===a.dataField?a.editorElement.find("input").last().mask("99/99/9999"):"conclusao"==a.dataField&&a.editorElement.find("input").last().mask("999"),a.dataField){case"data_conclusao":$(a.editorElement).dxDateBox("instance").on("valueChanged",function(i){var t=a.row.rowIndex;if(""!==i.value&&null!==i.value){let a=new Date;dateDiff(a,i.value,!1,!0)>0?DevExpress.ui.dialog.alert("A data de conclusão não pode ser maior que a data atual","Atenção").done(function(){e.datagrid.cellValue(t,"data_conclusao",null)}):(e.datagrid.cellValue(t,"situacao","4"),e.datagrid.cellValue(t,"data_conclusao",i.value),e.datagrid.cellValue(t,"conclusao","100"))}else{var d=new Date(e.datagrid.cellValue(t,"data_fim")).toISOString().split("T")[0],o=(new Date).toISOString().split("T")[0];e.datagrid.cellValue(t,"data_conclusao",""),d<o?e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ATRASADO.toString()):(e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()),e.datagrid.cellValue(t,"conclusao","0"))}});break;case"conclusao":$(a.editorElement).dxTextBox("instance").on("valueChanged",function(i){var t=a.row.rowIndex;parseInt(i.value)>100||parseInt(i.value)<0?(DevExpress.ui.dialog.alert("Preencha a coluna Conclusão com valores entre 0 e 100","Atenção"),e.datagrid.cellValue(t,"conclusao","0")):(100==parseInt(i.value)?(e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.CONCLUIDO.toString()),e.datagrid.cellValue(t,"data_conclusao",new Date)):(new Date(e.datagrid.cellValue(t,"data_fim")).toISOString().split("T")[0]<(new Date).toISOString().split("T")[0]?e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ATRASADO.toString()):e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()),e.datagrid.cellValue(t,"data_conclusao",null)),e.datagrid.cellValue(t,"conclusao",i.value))});break;case"data_fim":$(a.editorElement).dxDateBox("instance").on("valueChanged",function(i){var t=a.row.rowIndex,d=e.datagrid.cellValue(t,"data_inicio");new Date(i.value)<new Date(d)&&DevExpress.ui.dialog.alert("Data Fim não pode ser menor que Data Início","Atenção").done(function(){e.datagrid.cellValue(t,"data_fim",new Date(d))});var o=e.datagrid.cellValue(t,"situacao"),n=o!=PDCA_ATIVIDADE_SITUACAO.CONCLUIDO&&(o==PDCA_ATIVIDADE_SITUACAO.ABERTO||o==PDCA_ATIVIDADE_SITUACAO.ATRASADO);new Date(i.value)>new Date&&n?e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()):0==dateDiff(i.value,new Date)&&n?e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ABERTO.toString()):new Date(i.value)<new Date&&n&&e.datagrid.cellValue(t,"situacao",PDCA_ATIVIDADE_SITUACAO.ATRASADO.toString()),e.datagrid.cellValue(t,"data_fim",i.value)});break;case"data_inicio":$(a.editorElement).dxDateBox("instance").on("valueChanged",function(i){var t=a.row.rowIndex,d=e.datagrid.cellValue(t,"data_fim");new Date(i.value)>new Date(d)&&(DevExpress.ui.dialog.alert("Data Início não pode ser maior que Data Fim","Atenção"),e.datagrid.cellValue(t,"data_inicio",d))});break;case"situacao":$(a.editorElement).dxSelectBox("instance").on("valueChanged",function(i){var t=a.row.rowIndex,d=e.datagrid.cellValue(t,"situacao"),o=e.datagrid.cellValue(t,"data_fim"),n=e.datagrid.cellValue(t,"data_conclusao"),l=e.datagrid.cellValue(t,"conclusao");if(d!=PDCA_ATIVIDADE_SITUACAO.ATRASADO&&i.value==PDCA_ATIVIDADE_SITUACAO.ATRASADO){var c=!1;dateDiff(o,new Date)<0&&null==n&&parseInt(l)<100&&(c=!0),!1===c&&DevExpress.ui.dialog.alert("Esta atividade não pode ser marcada como atrasada. Verifique os itens abaixo: <br /><br /> - Se a data fim está com valor menor que a data atual. <br /> - Se a data de conclusão não está preenchida e/ou se a porcentagem (%) de conclusão está menor que 100%.","Atenção").done(function(){e.datagrid.cellValue(t,"situacao",d)})}i.value==PDCA_ATIVIDADE_SITUACAO.CONCLUIDO?(e.datagrid.cellValue(t,"conclusao","100"),e.datagrid.cellValue(t,"data_conclusao",new Date)):i.value==PDCA_ATIVIDADE_SITUACAO.ABERTO&&(d==PDCA_ATIVIDADE_SITUACAO.CONCLUIDO?(e.datagrid.cellValue(t,"data_conclusao",null),e.datagrid.cellValue(t,"conclusao","0")):d==PDCA_ATIVIDADE_SITUACAO.ATRASADO&&e.datagrid.cellValue(t,"data_fim",new Date)),e.datagrid.cellValue(t,"situacao",i.value)})}},onRowPrepared:function(a){"data"==a.rowType&&(a.data.situacao==PDCA_ATIVIDADE_SITUACAO.ATRASADO?a.rowElement.find("td").css("background","#ffcdd2"):a.data.situacao==PDCA_ATIVIDADE_SITUACAO.CONCLUIDO&&a.rowElement.find("td").css("background","#dcedc8"))},onToolbarPreparing:function(a){var i=a.toolbarOptions.items;$.each(i,function(a,i){"saveButton"===i.name&&(i.options.onClick=function(a){var i=e.datagrid.getController("editing").getChanges();e.atualiza_atividades_pdca(i)}),"addRowButton"===i.name&&e.pdca.situacao_id==PDCA_SITUACAO.CONCLUIDO&&(i.options.disabled=!0)})},onContentReady:function(a){if(0==e.dialog.find(".btn_refresh").length){var i=$("<div style='margin-left: 5px;'>").addClass("btn_refresh").dxButton({hint:"Atualizar",icon:"refresh",onClick:function(){e.listar()}}),t=a.element.find(".dx-toolbar-after");$(t.get(0)).prepend(i)}a.component.columnOption("pdca_atividade_id","allowEditing",!1)},stateStoring:{enabled:!0,type:"custom",customLoad:function(){if(!1===e.param_filterRow)return App.get_parametro_usuario("pdca_listagem_atividades_"+e.pdca.pdca_id)},customSave:function(a){!1===e.param_filterRow&&App.set_parametro_usuario("pdca_listagem_atividades_"+e.pdca.pdca_id,a)}},columns:[{caption:"#",dataField:"pdca_atividade_id",dataType:"number",width:50,fixed:!0,fixedPosition:"left"},{caption:"Situação",alignment:"center",dataField:"situacao",width:90,lookup:{dataSource:[{id:5,descricao:"Aberto"},{id:1,descricao:"Atrasado"},{id:2,descricao:"Stand By"},{id:3,descricao:"Cancelado"},{id:4,descricao:"Concluído"}],valueExpr:"id",displayExpr:"descricao"}},{caption:"PDCA",alignment:"center",width:60,columns:[{caption:"5W2H",width:60,dataField:"ordem",alignment:"center",dataType:"number"}]},{caption:"Plan (Planejamento)",alignment:"center",columns:[{dataField:"que",caption:"What (O Quê ?)"},{dataField:"porque",caption:"Why (Por Quê ?)"},{dataField:"quem",lookup:{dataSource:{store:{type:"array",data:e.arr_usuarios}},valueExpr:"usuario_id",displayExpr:"nome"},caption:"Who (Quem ?)",width:140,validationRules:[{type:"required"}]},{dataField:"onde",caption:"Where (Onde ?)"}]},{caption:"Do (Fazer)",alignment:"center",columns:[{caption:"When (Quando ?)",alignment:"center",columns:[{dataField:"data_inicio",caption:"Data Início",dataType:"date",format:"dd/MM/yyyy",width:130},{dataField:"data_fim",caption:"Data Fim",dataType:"date",format:"dd/MM/yyyy",width:130,cellTemplate:function(a,i){e.verifica_permissao(i.data.quem,!1,!0)?$("<span/>").css("text-decoration","underline").css({"text-decoration":"underline",cursor:"pointer"}).text(new Date(i.data.data_fim).toISOString().format_date(!1)).on("dxclick",function(){View.load("pdca/historico",function(a,t){t.show(i.data.pdca_atividade_id,e.pdca.pdca_id)})}).appendTo(a):$("<span/>").text(new Date(i.data.data_fim).toISOString().format_date(!1)).appendTo(a)}},{dataField:"data_conclusao",caption:"Conclusão",dataType:"date",format:"dd/MM/yyyy",width:130}]},{dataField:"como",caption:"How (Como ?)"},{dataField:"quanto",caption:"How Much (Quanto ?)",dataType:"number",format:{type:"fixedPoint",precision:2},alignment:"left"}]},{caption:"Check (Resultado)",columns:[{dataField:"conclusao",caption:"%",width:80,alignment:"center",customizeText:function(a){var e=a.value||"0";return void 0===a.value||void 0===a.target||"filterPanel"!=a.target&&"row"!=a.target||null===a.value||a.value.indexOf("%")>0&&(e=a.value.replace("%","")),e+"%"}}]},{type:"buttons",width:130,buttons:[{hint:"Pós-Ação",icon:"fa fa-cogs",cssClass:"icon_black",visible:function(a){return e.permite_edicao_pos_acao=e.verifica_permissao(a.row.data.quem,!1,!0),e.verifica_permissao(a.row.data.quem,!1,!0)&&void 0!==a.row.data.pdca_atividade_id},onClick:function(a){View.load("pdca/pos_acao",function(i,t){t.show(e.pdca,a.row.data,e.permite_edicao_pos_acao)},View.ABA.NAO)}},{hint:"Observações",icon:"fa fa-comment",cssClass:"icon_black",onClick:function(a){View.load("pdca/observacao_atividade",function(i,t){var d="";void 0!==a.row.data.observacao?d=a.row.data.observacao:""!=e.msg_observacao_atividade&&(d=e.msg_observacao_atividade),t.show(a.row.data,e.pdca.pdca_id,d),t.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==e.html_id&&(e.msg_observacao_atividade=get_tinymce(t.edt_observacao),e.listar())})}})},visible:function(a){return e.verifica_permissao(a.row.data.quem,!1,!0)&&void 0!==a.row.data.pdca_atividade_id}},{hint:"Editar (Popup)",icon:"fa fa-pencil-alt",cssClass:"icon_black",onClick:function(a){var i=function(a){e.datagrid.option("editing.mode","popup"),e.datagrid.editRow(a.row.rowIndex)};Array.isArray(e.datagrid.getController("editing")._changes)&&0!==e.datagrid.getController("editing")._changes.length?alert_modal("Aviso","Você realizou alterações que serão perdidas. Deseja continuar?","Sim",function(){i(a)},!0,"Cancelar",null,function(){}):i(a)},visible:function(a){return e.verifica_permissao(a.row.data.quem,!1,!0)}},{hint:"Remover",icon:"fa fa-trash",cssClass:"icon_black",onClick:function(a){e.datagrid.deleteRow(a.row.rowIndex)},visible:function(a){return e.verifica_permissao(a.row.data.quem,!0)}}]}]}).dxDataGrid("instance")},this.verifica_permissao=function(a,i,t){if(App.sessao.dados.admin)return!0;void 0===a&&(a=0),void 0===i&&(i=!1),void 0===t&&(t=!1);var d=!1;return e.arr_usuarios.length>0&&$(e.arr_usuarios).each(function(e,o){if(App.sessao.dados.usuario_id==o.usuario_id){var n="S"==o.gerente||!1===i&&(!0===t&&+a>0&&"S"==o.equipe&&App.sessao.dados.usuario_id==a||!1===t&&"S"==o.equipe);d=n}}),d},this.atualiza_atividades_pdca=function(a){WS.post("pdca_atividade/salvar/",{pdca_atividade:CircularJSON.stringify(a),pdca_id:e.pdca.pdca_id,referencia_tabela:e.dadosReferencia.referencia_tabela,referencia_id:e.dadosReferencia.referencia_id},function(a){if(void 0!==a){switch(e.pdca.progresso=a.progresso,e.pdca.situacao_id=a.situacao,parseInt(e.pdca.situacao_id)){case PDCA_SITUACAO.NAO_INICIADO:e.pdca.situacao="Não Iniciado";break;case PDCA_SITUACAO.EM_ANDAMENTO:e.pdca.situacao="Em Andamento";break;case PDCA_SITUACAO.CONCLUIDO:e.pdca.situacao="Concluído"}e.montar_cabecalho(),e.datagrid.saveEditData(),e.datagrid.option("editing.mode","batch"),e.listar()}})}}});