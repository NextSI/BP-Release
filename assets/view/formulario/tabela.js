define([],function(){return function(e){"use strict";var a=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.popup=null,this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onsave=null,this.onremove=null,this.edt_nome=this.dialog.find(".edt_nome"),this.edt_tamanho=this.dialog.find(".edt_tamanho"),this.edt_tipo_linha=this.dialog.find(".edt_tipo_linha"),this.edt_id_elemento=this.dialog.find(".edt_id_elemento"),this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_add_campo=this.dialog.find(".btn_add_campo"),this.btn_remover=this.dialog.find(".btn_remover"),this.chk_exibir_impressao=this.dialog.find(".chk_exibir_impressao"),this.tabela={nome:null,tipo:ELEMENTO_TIPO.TABELA,tamanho:5,tipo_linha:FORMULARIO_TABELA_TIPO_LINHA.EXATO,colunas:12,obrigatorio:!1,campos:[],id_elemento:null},this.arr_grupos=null,this.tipo_formulario=null,this.evento_iniciar_construtor=null;var t=function(e){if(void 0!==a.tabela.campos&&a.tabela.campos){for(var t=-1,o=0;o<a.tabela.campos.length;o++)a.tabela.campos[o].elem_key==e.elem_key&&(t=o);t<0?a.tabela.campos.push(e):a.tabela.campos[t]=e}a.render_lista()},o=function(e){if(void 0!==a.tabela.campos&&a.tabela.campos){for(var t=-1,o=0;o<a.tabela.campos.length;o++)a.tabela.campos[o].elem_key==e.elem_key&&(t=o);t>=0&&a.tabela.campos.splice(t,1)}a.render_lista()};this.show=function(e,t,o,i,n){switch(a.tipo=t,a.arr_grupos=o,a.tipo_formulario=i,a.evento_iniciar_construtor=n,void 0!==e&&e&&(this.tabela=e),t){case FORMULARIO.NOVO:a.btn_remover.hide(),a.permite_alterar(!0),a.chk_exibir_impressao.prop("checked",!0),a.permite=!0;break;case FORMULARIO.EDITAR:a.btn_remover.show(),a.permite_alterar(!0),a.permite=!0;break;case FORMULARIO.VISUALIZAR:a.btn_remover.hide(),a.permite_alterar(!1),a.permite=!1;break;case FORMULARIO.EXCLUIR:a.btn_remover.show(),a.permite_alterar(!1),a.permite=!1}alertaPopUp({titulo:"Tabela "+(a.tabela&&a.tabela.nome?a.tabela.nome:"nova"),conteudo:(e,t)=>{setTimeout(()=>{a.popup=t,a.dialog.css("padding","0px"),e.replaceWith(a.dialog),a.dialog.closest(".dx-popup-content").css("padding","0px"),a.preencher(),set_focus(a.edt_nome)})},botaoConfirmarTexto:a.permite?"Ok":null,botaoConfirmarFuncao:a.salvar,botaoCancelarTexto:"Cancelar",botaoCancelarFuncao:a.unload,largura:"calc(100% - 20px)",larguraMinima:"400px",larguraMaxima:"800px"})},this.close=function(){close_modal(a.modal.attr("id")),void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(a.html_id)},this.permite_alterar=function(e){a.edt_id_elemento.prop("disabled",!e||a.tipo==FORMULARIO.EDITAR&&a.tabela.id_elemento)},this.preencher=function(){a.edt_nome.val(a.tabela.nome),a.edt_tamanho.val(a.tabela.tamanho),void 0!==a.tabela.tipo_linha?a.edt_tipo_linha.val(a.tabela.tipo_linha):Number(a.tabela.tamanho)>0?a.edt_tipo_linha.val(FORMULARIO_TABELA_TIPO_LINHA.EXATO):a.edt_tipo_linha.val(FORMULARIO_TABELA_TIPO_LINHA.MINIMO),a.edt_id_elemento.val(a.tabela.id_elemento),a.chk_exibir_impressao.prop("checked",void 0===a.tabela.exibir_impressao||a.tabela.exibir_impressao).change(),a.render_lista()},this.render_lista=function(){var e=a.tab_listagem.find("tbody"),i=e.find("tr:first");a.tab_listagem.find("tr:gt(1)").remove(),$(a.tabela.campos).each(function(n,l){!function(n){var l=i.clone();l.removeAttr("template-row"),l.css("display","");var r=l.find(".btn_tab_up_campo");r.unbind("click"),r.click(function(){var e=-1;if($(a.tabela.campos).each(function(a,t){t==n&&(e=a)}),e>0){var t=e-1,o=a.tabela.campos[e],i=a.tabela.campos[t];a.tabela.campos[t]=o,a.tabela.campos[e]=i,a.render_lista()}});var d=l.find(".btn_tab_down_campo");d.unbind("click"),d.click(function(){var e=-1;if($(a.tabela.campos).each(function(a,t){t==n&&(e=a)}),e+1<a.tabela.campos.length){var t=e+1,o=a.tabela.campos[e],i=a.tabela.campos[t];a.tabela.campos[t]=o,a.tabela.campos[e]=i,a.render_lista()}});var _=l.find(".lbl_nome"),s=l.find(".lbl_tipo"),m=l.find(".lbl_id"),E=l.find(".lbl_obrigatorio"),c=l.find(".lbl_possui_evento");_.text(n.nome);var p=str_elemento_tipo(n.tipo);n.tipo!=ELEMENTO_TIPO.TEXTO&&n.tipo!=ELEMENTO_TIPO.DECIMAL&&n.tipo!=ELEMENTO_TIPO.MASCARA||(p+=" ("+(n.tipo==ELEMENTO_TIPO.DECIMAL?n.decimais:n.tamanho)+")"),s.text(p),s.text(p),n.id_elemento?m.text("ID: "+n.id_elemento):(m.text("Informe o ID"),m.toggleClass("label-default label-danger")),E.hide(),n.obrigatorio&&"true"===n.obrigatorio.toString()&&E.show(),c.hide(),(n.evento_alterar&&n.evento_alterar.trim()||n.evento_clicar&&n.evento_clicar.trim()||n.evento_limpar&&n.evento_limpar.trim()||n.evento_selecionar&&n.evento_selecionar.trim())&&c.show();var T=$(l.find(".btn_editar")),I=function(){View.load("formulario/campo",function(e,i){i.onsave=t,i.onremove=o,i.show(n,FORMULARIO.EDITAR,!0,a.tabela,a.arr_grupos,a.evento_iniciar_construtor)})};T.unbind("click"),T.click(I),l.dblclick(I),l.appendTo(e)}(l)})},this.salvar=function(){var e=new Validation;if(""==a.edt_id_elemento.val().trim()||null==a.edt_id_elemento.val())e.add(new ValidationMessage(Validation.CODES.ERR,"Informe um ID para a tabela"));else{var t=a.edt_id_elemento.val().substr(0,1);"_"==t&&e.add(new ValidationMessage(Validation.CODES.ERR,"O nome do campo não pode começar com um underline.")),isNaN(t)||e.add(new ValidationMessage(Validation.CODES.ERR,"O nome do campo não pode começar com um número."));for(var o=["ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","COLUMNS","CONSTRAINT","CONVERT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","ELSE","ENCLOSED","ESCAPED","EXISTS","EXPLAIN","FALSE","FIELDS","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","GRANT","GROUP","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERVAL","INTO","IS","JOIN","KEY","KEYS","KILL","LEADING","LEFT","LIKE","LIMIT","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOW_PRIORITY","MATCH","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","NATURAL","NOT","NO_WRITE_TO_BINLOG","NULL","NUMERIC","ON","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUTER","OUTFILE","PRECISION","PRIMARY","PRIVILEGES","PROCEDURE","PURGE","READ","REAL","REFERENCES","REGEXP","RENAME","REPLACE","REQUIRE","RESTRICT","REVOKE","RIGHT","RLIKE","SECOND_MICROSECOND","SELECT","SEPARATOR","SET","SHOW","SMALLINT","SONAME","SPATIAL","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STRAIGHT_JOIN","TABLE","TABLES","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRUE","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHERE","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL","main","obj_solicitacao","ID","parametros"],i=0;i<o.length;i++){var n=o[i];a.edt_id_elemento.val().toUpperCase()==n.toUpperCase()&&e.add(new ValidationMessage(Validation.CODES.ERR,"O nome da tabela não pode ser "+n+" pois a mesma é uma palavra reservada"))}for(i=0;i<a.arr_grupos.length;i++)for(var l=a.arr_grupos[i],r=0;r<l.elementos.length;r++){var d=l.elementos[r];void 0!==d.id_elemento&&d.id_elemento&&a.edt_id_elemento.val().toLowerCase()==d.id_elemento.toLowerCase()&&a.tabela.elem_key!=d.elem_key&&(d.tipo==ELEMENTO_TIPO.TABELA?e.add(new ValidationMessage(Validation.CODES.ERR,"O id informado já está sendo utilizado pela tabela: "+d.nome)):e.add(new ValidationMessage(Validation.CODES.ERR,"O id informado já está sendo utilizado pelo campo: "+d.nome)))}}a.edt_tipo_linha.val()!=FORMULARIO_TABELA_TIPO_LINHA.EXATO||0!=a.edt_tamanho.val()&&null!=a.edt_tamanho.val()&&""!=a.edt_tamanho.val().trim()||e.add(new ValidationMessage(Validation.CODES.ERR,'Quando o tipo de linha está configurado como "Exato", a quantidade de linhas precisa ser maior ou igual a 1 (um).')),e.is_valid()?(void 0===a.tabela.elem_key&&(a.tabela.elem_key=String((new Date).getTime())+String(Math.round(1e4*Math.random()))+String((new Date).getTime())+String(Math.round(1e4*Math.random()))),a.tabela.nome=a.edt_nome.val(),a.tabela.tamanho=a.edt_tamanho.val(),a.tabela.tipo_linha=a.edt_tipo_linha.val(),a.tabela.id_elemento=a.edt_id_elemento.val(),a.tabela.exibir_impressao=a.chk_exibir_impressao.prop("checked"),void 0!==a.onsave&&a.onsave&&a.onsave(a.tabela,a.evento_iniciar_construtor),a.unload()):alertaPopUp("Validação",e)},this.btn_add_campo.unbind("click"),this.btn_add_campo.click(function(){View.load("formulario/campo",function(e,o){o.onsave=t,o.show(null,FORMULARIO.NOVO,!0,a.edt_id_elemento.val(),a.arr_grupos,a.evento_iniciar_construtor)})}),this.edt_nome.unbind("keyup").keyup(function(){if(!a.edt_id_elemento.prop("disabled")){var e=removerAcentos(a.edt_nome.val().replaceAll(" ","_")).replaceAll(/\W/g,"").toLowerCase().substr(0,20),t=e.substr(0,1);""==t||isNaN(t)||(e="t"+e),a.edt_id_elemento.val(e)}}),this.edt_id_elemento.unbind("keypress").bind("keypress",function(e){if(!new RegExp("^[_0-9a-zA-Z\b]+$").test(e.key))return e.preventDefault(),!1}),this.edt_id_elemento.unbind("blur").bind("blur",function(){var e=removerAcentos(a.edt_id_elemento.val()).replaceAll(/\W/g,"").toLowerCase().substr(0,20);a.edt_id_elemento.val(e)}),this.btn_remover.unbind("click"),this.btn_remover.click(function(){alertaPopUp(a.title.text(),"Deseja remover a tabela?","Remover",function(){void 0!==a.onremove&&a.onremove&&a.onremove(a.tabela),a.unload(),a.popup.hide()},"Cancelar")})}});