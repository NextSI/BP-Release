define([],function(){return function(e){"use strict";var a=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.title="Funil de Venda",this.tipo=null,this.onclose=null,this.edt_nome=this.dialog.find(".edt_nome"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_incluir_etapa=this.dialog.find(".btn_incluir_etapa"),this.tab_listagem_etapas=this.dialog.find(".tab_listagem_etapas"),this.chk_padrao=this.dialog.find(".chk_padrao"),this.chk_redimensionar_etapas=this.dialog.find(".chk_redimensionar_etapas"),this.chk_gerar_evento=this.dialog.find(".chk_gerar_evento"),this.chk_aprovacao_supervisor=this.dialog.find(".chk_aprovacao_supervisor"),this.chk_utiliza_contato=this.dialog.find(".chk_utiliza_contato"),this.div_parametros_evento=this.dialog.find(".div_parametros_evento"),this.edt_descricao=this.dialog.find(".edt_descricao"),this.edt_dias_apos=this.dialog.find(".edt_dias_apos"),this.cbo_evento_tipo=this.dialog.find(".cbo_evento_tipo"),this.edt_hora_inicial=this.dialog.find(".edt_hora_inicial"),this.edt_hora_final=this.dialog.find(".edt_hora_final"),this.edt_mensagem_padrao=this.dialog.find(".edt_mensagem_padrao"),this.edt_nome_oportunidade_padrao=this.dialog.find(".edt_nome_oportunidade_padrao"),this.edt_observacao_padrao=this.dialog.find(".edt_observacao_padrao"),this.chk_sugerir_data_atual=this.dialog.find(".chk_sugerir_data_atual"),this.chk_sugerir_situacao_negocio_ganho=this.dialog.find(".chk_sugerir_situacao_negocio_ganho"),this.chk_obrigar_regra_tabela_preco=this.dialog.find(".chk_obrigar_regra_tabela_preco"),this.chk_notificar_regra_tabela_preco=this.dialog.find(".chk_notificar_regra_tabela_preco"),this.chk_imprimir_impostos_orcamento=this.dialog.find(".chk_imprimir_impostos_orcamento"),this.chk_aprovacao_representante_envia_email=this.dialog.find(".chk_aprovacao_representante_envia_email"),this.chk_listar_contatos_entidade=this.dialog.find(".chk_listar_contatos_entidade"),this.chk_utilizar_unidade_medida=this.dialog.find(".chk_utilizar_unidade_medida"),this.chk_bloquear_unidade_medida=this.dialog.find(".chk_bloquear_unidade_medida"),this.chk_utilizar_unidade_medida2=this.dialog.find(".chk_utilizar_unidade_medida2"),this.chk_bloquear_unidade_medida2=this.dialog.find(".chk_bloquear_unidade_medida2"),this.chk_utilizar_representante2=this.dialog.find(".chk_utilizar_representante2"),this.chk_utilizar_itens_orcamento=this.dialog.find(".chk_utilizar_itens_orcamento"),this.chk_editar_observacoes_item=this.dialog.find(".chk_editar_observacoes_item"),this.chk_exibir_carteira_representante=this.dialog.find(".chk_exibir_carteira_representante"),this.chk_notificar_outras_entidades=this.dialog.find(".chk_notificar_outras_entidades"),this.chk_imprimir_foto_item_orcamento=this.dialog.find(".chk_imprimir_foto_item_orcamento"),this.chk_exibir_itens_sem_tabela_preco=this.dialog.find(".chk_exibir_itens_sem_tabela_preco"),this.chk_utiliza_origem=this.dialog.find(".chk_utiliza_origem"),this.chk_sugerir_condicao_pagamento=this.dialog.find(".chk_sugerir_condicao_pagamento"),this.chk_nao_permitir_item_repetido=this.dialog.find(".chk_nao_permitir_item_repetido"),this.chk_imprimir_observacoes_item=this.dialog.find(".chk_imprimir_observacoes_item"),this.chk_escolha_empresa_ganho_perda=this.dialog.find(".chk_escolha_empresa_ganho_perda"),this.chk_exibir_data_abertura_oportunidade=this.dialog.find(".chk_exibir_data_abertura_oportunidade"),this.chk_efetivar_organizacao_oportunidade_ganha=this.dialog.find(".chk_efetivar_organizacao_oportunidade_ganha"),this.chk_exibir_organizacao_efetivada_oportunidade=this.dialog.find(".chk_exibir_organizacao_efetivada_oportunidade"),this.chk_exibir_organizacao_efetivada_filtro=this.dialog.find(".chk_exibir_organizacao_efetivada_filtro"),this.chk_exibir_razao_social_entidade=this.dialog.find(".chk_exibir_razao_social_entidade"),this.chk_considera_situacao_de_referencias=this.dialog.find(".chk_considera_situacao_de_referencias"),this.chk_exibir_info_lucro=this.dialog.find(".chk_exibir_info_lucro"),this.div_exibir_itens_sem_tabela_preco=this.dialog.find(".div_exibir_itens_sem_tabela_preco"),this.cbo_condicao_pagamento=this.dialog.find(".cbo_condicao_pagamento"),this.div_condicao_pagamento=this.dialog.find(".div_condicao_pagamento"),this.chk_utilizar_tabela_preco_cliente=this.dialog.find(".chk_utilizar_tabela_preco_cliente"),this.cbo_representante=this.dialog.find(".cbo_representante"),this.edt_representante=null,this.tab_listagem_representante=this.dialog.find(".tab_listagem_representante"),this.lbl_tab_personalizados=this.dialog.find(".lbl_tab_personalizados"),this.lbl_tab_processo_automacao=this.dialog.find(".lbl_tab_processo_automacao"),this.chk_representante_especifico_acessar_funil=this.dialog.find(".chk_representante_especifico_acessar_funil"),this.div_representante=this.dialog.find(".div_representante"),this.div_exibir_notificar_entidades=this.dialog.find(".div_exibir_notificar_entidades"),this.div_representante=this.dialog.find(".div_representante"),this.chk_utilizar_codigo_pedido_item=this.dialog.find(".chk_utilizar_codigo_pedido_item"),this.chk_utilizar_prazo_dias_item=this.dialog.find(".chk_utilizar_prazo_dias_item"),this.chk_utilizar_data_validade_orcamento=this.dialog.find(".chk_utilizar_data_validade_orcamento"),this.chk_permitir_tabela_preco_vencida=this.dialog.find(".chk_permitir_tabela_preco_vencida"),this.chk_arredondamento_automatico_preco_com_desconto=this.dialog.find(".chk_arredondamento_automatico_preco_com_desconto"),this.cbo_vincular_form=this.dialog.find(".cbo_vincular_form"),this.chk_utilizar_motivo_desconto=this.dialog.find(".chk_utilizar_motivo_desconto"),this.chk_utilizar_controle_sequencia_orcamento=this.dialog.find(".chk_utilizar_controle_sequencia_orcamento"),this.cbo_processo=this.dialog.find(".cbo_processo"),this.div_vinculo_atividade_processo_funil=this.dialog.find(".div_vinculo_atividade_processo_funil"),this.tabela_vinculo_processo_funil=this.dialog.find(".tabela_vinculo_processo_funil"),this.btn_alterar_imagem=this.dialog.find(".btn_alterar_imagem"),this.grid_ordenacao=this.dialog.find("#grid_ordenacao"),a.modal_funil_geral_tab=this.dialog.find("#modal_funil_geral_tab"),a.modal_funil_config_tab=this.dialog.find("#modal_funil_config_tab"),a.modal_funil_representantes_tab=this.dialog.find("#modal_funil_representantes_tab"),a.modal_funil_mensagem_email_tab=this.dialog.find("#modal_funil_mensagem_email_tab"),a.modal_personalizados_tab=this.dialog.find("#modal_personalizados_tab"),a.modal_processo_automacao_tab=this.dialog.find("#modal_processo_automacao_tab"),a.modal_funil_geral=this.dialog.find("#modal_funil_geral"),a.modal_funil_config=this.dialog.find("#modal_funil_config"),a.modal_funil_representantes=this.dialog.find("#modal_funil_representantes"),a.modal_funil_mensagem_email=this.dialog.find("#modal_funil_mensagem_email"),a.modal_personalizados=this.dialog.find("#modal_personalizados"),a.modal_processo_automacao=this.dialog.find("#modal_processo_automacao"),this.funil_vendas_id=null,this.arr_etapas=[],this.arr_etapas_filter=[],this.edt_condicao_pagamento=null,this.imagem_id=null,this.arr_representante=[],this.arr_representante_filtrados=[],this.arr_listagem_representante=[],this.formulario_id=null,this.formulario_alterado_id=null,this.tipo_formulario=1,this.funil_vendas_etapa_processo=null,this.dados_vinculo_atividade_processo_funil=[],this.aux_dados_vinculo_atividade_processo_funil=[],this.itens_array=[],this.tem_permissao={},this.arr_ordenacao_colunas=[{coluna_nome:"Itens",visivel:!0},{coluna_nome:"Orçamentos",visivel:!0},{coluna_nome:"Status",visivel:!0},{coluna_nome:"Eventos",visivel:!0},{coluna_nome:"Convidados",visivel:!0},{coluna_nome:"Observações",visivel:!0},{coluna_nome:"Histórico",visivel:!0},{coluna_nome:"Referências",visivel:!0},{coluna_nome:"Formulário Personalizado",visivel:!0}],this.show=function(i,o,t){if(a.chk_sugerir_data_atual.removeClass("template_switch"),a.chk_sugerir_situacao_negocio_ganho.removeClass("template_switch"),a.chk_obrigar_regra_tabela_preco.removeClass("template_switch"),a.chk_notificar_regra_tabela_preco.removeClass("template_switch"),a.chk_imprimir_impostos_orcamento.removeClass("template_switch"),a.chk_aprovacao_representante_envia_email.removeClass("template_switch"),a.chk_utilizar_motivo_desconto.removeClass("template_switch"),a.chk_utilizar_controle_sequencia_orcamento.removeClass("template_switch"),a.chk_listar_contatos_entidade.removeClass("template_switch"),a.chk_utilizar_unidade_medida.removeClass("template_switch"),a.chk_utilizar_unidade_medida2.removeClass("template_switch"),a.chk_utilizar_representante2.removeClass("template_switch"),a.chk_utilizar_itens_orcamento.removeClass("template_switch"),a.chk_editar_observacoes_item.removeClass("template_switch"),a.chk_exibir_carteira_representante.removeClass("template_switch"),a.chk_imprimir_foto_item_orcamento.removeClass("template_switch"),a.chk_exibir_itens_sem_tabela_preco.removeClass("template_switch"),a.chk_utiliza_origem.removeClass("template_switch"),a.chk_exibir_itens_sem_tabela_preco.removeClass("template_switch"),a.div_exibir_itens_sem_tabela_preco.removeClass("template_switch"),a.chk_sugerir_condicao_pagamento.removeClass("template_switch"),a.chk_escolha_empresa_ganho_perda.removeClass("template_switch"),a.chk_exibir_data_abertura_oportunidade.removeClass("template_switch"),a.chk_efetivar_organizacao_oportunidade_ganha.removeClass("template_switch"),a.chk_exibir_organizacao_efetivada_oportunidade.removeClass("template_switch"),a.chk_exibir_organizacao_efetivada_filtro.removeClass("template_switch"),a.chk_exibir_razao_social_entidade.removeClass("template_switch"),a.chk_considera_situacao_de_referencias.removeClass("template_switch"),a.chk_exibir_info_lucro.removeClass("template_switch"),a.chk_padrao.removeClass("template_switch"),a.chk_redimensionar_etapas.removeClass("template_switch"),a.chk_gerar_evento.removeClass("template_switch"),a.chk_aprovacao_supervisor.removeClass("template_switch"),a.chk_utiliza_contato.removeClass("template_switch"),a.chk_imprimir_observacoes_item.removeClass("template_switch"),a.chk_nao_permitir_item_repetido.removeClass("template_switch"),a.chk_utilizar_tabela_preco_cliente.removeClass("template_switch"),a.chk_representante_especifico_acessar_funil.removeClass("template_switch"),a.chk_bloquear_unidade_medida.removeClass("template_switch"),a.chk_bloquear_unidade_medida2.removeClass("template_switch"),a.chk_notificar_outras_entidades.removeClass("template_switch"),a.chk_utilizar_codigo_pedido_item.removeClass("template_switch"),a.chk_utilizar_prazo_dias_item.removeClass("template_switch"),a.chk_utilizar_data_validade_orcamento.removeClass("template_switch"),a.chk_permitir_tabela_preco_vencida.removeClass("template_switch"),a.chk_arredondamento_automatico_preco_com_desconto.removeClass("template_switch"),a.edt_mensagem_padrao.attr("id","edt_mensagem_padrao"+a.html_id),a.modal_funil_geral.attr("id","modal_funil_geral_"+e),a.modal_funil_config.attr("id","modal_funil_config_"+e),a.modal_funil_representantes.attr("id","modal_funil_representantes_"+e),a.modal_funil_mensagem_email.attr("id","modal_funil_mensagem_email_"+e),a.modal_personalizados.attr("id","modal_personalizados_"+e),a.modal_processo_automacao.attr("id","modal_processo_automacao_"+e),a.modal_funil_geral_tab.attr("href","#"+a.modal_funil_geral.attr("id")),a.modal_funil_config_tab.attr("href","#"+a.modal_funil_config.attr("id")),a.modal_funil_representantes_tab.attr("href","#"+a.modal_funil_representantes.attr("id")),a.modal_funil_mensagem_email_tab.attr("href","#"+a.modal_funil_mensagem_email.attr("id")),a.modal_personalizados_tab.attr("href","#"+a.modal_personalizados.attr("id")),a.modal_processo_automacao_tab.attr("href","#"+a.modal_processo_automacao.attr("id")),null==a.edt_representante){create_combobox(a.cbo_representante,a.render_representantes);var _=a.cbo_representante.parent();a.edt_representante=_.find(".edt_combobox"),a.edt_representante.keypress(function(e){if(e.keyCode==KEYPRESS_PADRAO.ENTER){var i=a.cbo_representante.parent().find(".ncbo_scroll").find(".row_selected").attr("id_registro");a.relacionar_representante_existente(i)}})}switch(create_combobox(a.cbo_condicao_pagamento,a.listar_condicao_pagamento),_=a.cbo_condicao_pagamento.parent(),a.edt_condicao_pagamento=_.find(".edt_combobox"),o){case FORMULARIO.NOVO:a.btn_salvar.show(),a.btn_excluir.hide(),a.permite_alterar(!0),a.chk_utiliza_contato.prop("checked",!0).change(),a.chk_redimensionar_etapas.prop("checked",!0).change(),a.chk_arredondamento_automatico_preco_com_desconto.prop("checked",!0).change();break;case FORMULARIO.EDITAR:a.btn_salvar.show(),a.btn_excluir.hide(),a.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:a.btn_salvar.hide(),a.btn_excluir.hide(),a.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:a.btn_salvar.hide(),a.btn_excluir.show(),a.permite_alterar(!1)}a.tem_permissao.formulario=checa_permissao("formulario"),a.tem_permissao.gestao_processo=checa_permissao("gestao_processos"),a.tem_permissao.relatorio_atividade_processo=checa_permissao("relatorio_atividade_processo"),a.tipo=o,(a.tem_permissao.formulario.length>0||App.sessao.dados.admin)&&a.lbl_tab_personalizados.removeClass("hidden"),(a.tem_permissao.gestao_processo.length>0&&a.tem_permissao.relatorio_atividade_processo.length>0||App.sessao.dados.admin)&&a.lbl_tab_processo_automacao.removeClass("hidden"),void 0!==i&&i?(a.title=t,a.funil_vendas_id=i,a.preencher()):(set_tinymce(a.edt_mensagem_padrao,""),a.listar_eventos(),(a.tem_permissao.formulario.length>0||App.sessao.dados.admin)&&a.render_formulario(),(a.tem_permissao.gestao_processo.length>0&&a.tem_permissao.relatorio_atividade_processo.length>0||App.sessao.dados.admin)&&a.listar_processos(),void 0!==t&&"undefined"!=t&&null!=t&&(a.edt_nome.val(t),set_focus(a.edt_nome))),a.get_colunas_ordem(),set_focus(a.edt_nome)},this.monta_grid=function(){a.funil_vendas_etapa_processo=a.tabela_vinculo_processo_funil.dxDataGrid({dataSource:new DevExpress.data.DataSource.default({load:function(){var e=$.Deferred();return WS.get("funil_vendas/listar_etapas/",{funil_vendas_id:a.funil_vendas_id},function(a){e.resolve(a)}),e.promise()}}),rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0,hoverStateEnabled:!0,noDataText:App.lang.dxDataGrid.noDataText,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},editing:{useIcons:!0},wordWrapEnabled:!0,allowColumnResizing:!1,columnAutoWidth:!0,filterRow:{visible:!1},loadPanel:{enabled:!1},columns:[{caption:"Ao iniciar a atividade do processo",allowSorting:!1,cellTemplate:function(e,i){var o=$("<div>div>"),t=[];$.each(a.aux_dados_vinculo_atividade_processo_funil,function(e,a){i.data.funil_vendas_etapa_id==a.funil_vendas_etapa_id&&t.push(a.processo_atividade_id)});for(var _=0;_<t.length;_++)for(var r=t[_],n=0;n<a.itens_array.length;n++)r==a.itens_array[n].id&&(a.itens_array[n].disabled=!0,a.itens_array[n].visible=!1);o.dxTagBox({items:a.itens_array,valueExpr:"id",displayExpr:"descricao",showDropDownButton:!0,acceptCustomValue:!0,value:t,hideSelectedItems:!0,showClearButton:!0,itemTemplate:function(e,a,i){i.append($("<span>").text(e.descricao))},onFocusOut:function(e){$(e.element).dxTagBox("option","values",a.itens_array),$(e.element).dxTagBox("instance").repaint()},onSelectionChanged:function(e){for(var i=e.addedItems,o=e.removedItems,t=0;t<a.itens_array.length;t++){for(var _=a.itens_array[t],r=0;r<i.length;r++){var n=i[r];_.id==n.id&&(a.itens_array[t].disabled=!0,a.itens_array[t].visible=!1)}for(var c=0;c<o.length;c++)n=o[c],_.id==n.id&&(a.itens_array[t].disabled=!1,a.itens_array[t].visible=!0)}}}),$(o).appendTo(e)}},{caption:"Mover oportunidade do funil para a etapa",dataField:"nome",allowSorting:!1,cellTemplate:function(e,a){var i=$("<div><span class='label label-primary'>"+a.row.data.ordem+"</span> "+a.row.data.nome+"</div>");$(i).appendTo(e)}}]})},this.listar_processos=function(e){WS.get("processo/listar/",null,function(i){add_option(a.cbo_processo,"","Nenhum"),$(i).each(function(i,o){add_option(a.cbo_processo,o.processo_id,o.nome),e&&(a.cbo_processo.val(e).trigger("change"),a.div_vinculo_atividade_processo_funil.removeClass("hidden")),a.cbo_processo.selectpicker("refresh")}),a.popula_tag_boxes()})},this.popula_tag_boxes=function(){a.itens_array=[],WS.get("processo/listar_atividades/",{processo_id:a.processo_id},function(e){a.itens_array=e,a.monta_grid()})},this.close=function(){void 0!==a.onclose&&a.onclose&&a.onclose()},this.listar_eventos=function(e){a.cbo_evento_tipo.find("option").remove(),add_option(a.cbo_evento_tipo,"","Selecione"),WS.get("tipo_agenda_oportunidade/listar/",null,function(i){for(var o=0;o<i.length;o++){var t=i[o];add_option(a.cbo_evento_tipo,t.tipo_agenda_oportunidade_id,t.descricao)}e&&a.cbo_evento_tipo.val(e).trigger("change"),a.cbo_evento_tipo.selectpicker("refresh")})},this.unload=function(){a.close(),View.unload(this.html_id)},this.permite_alterar=function(e){a.edt_nome.prop("readonly",!e),a.btn_incluir_etapa.prop("disabled",!e),a.tab_listagem_etapas.prop("disabled",!e),a.chk_representante_especifico_acessar_funil.prop("disabled",!e)},this.preencher=function(){WS.get("funil_vendas/objeto/",{funil_vendas_id:a.funil_vendas_id},function(e){a.imagem_id=e.imagem_id,a.processo_id=e.processo_id,a.listar_processos(e.processo_id),a.aux_dados_vinculo_atividade_processo_funil=e.dados_vinculo_processo_funil,set_tinymce(a.edt_mensagem_padrao,e.mensagem_email),a.edt_nome.val(e.nome),"S"==e.padrao?a.chk_padrao.prop("checked",!0).change():a.chk_padrao.prop("checked",!1).change(),"S"==e.redimensionar_etapas||1==e.redimensionar_etapas?a.chk_redimensionar_etapas.prop("checked",!0).change():a.chk_redimensionar_etapas.prop("checked",!1).change(),a.chk_gerar_evento.prop("checked","N"!=e.gerar_evento_apos_orcamento).change(),a.chk_aprovacao_supervisor.prop("checked","N"!=e.aprovacao_supervisor).change(),a.chk_utiliza_contato.prop("checked","N"!=e.utiliza_contato).change(),a.edt_nome_oportunidade_padrao.val(e.nome_oportunidade_padrao),a.edt_observacao_padrao.val(e.observacao_padrao),a.chk_sugerir_data_atual.prop("checked","N"!=e.sugerir_data_atual).change(),a.chk_sugerir_situacao_negocio_ganho.prop("checked","N"!=e.sugerir_situacao_negocio_ganho).change(),a.chk_exibir_itens_sem_tabela_preco.prop("checked","N"!=e.exibir_itens_sem_tabela_preco).change(),a.chk_obrigar_regra_tabela_preco.prop("checked","N"!=e.obrigar_regra_tabela_preco).change(),a.chk_notificar_regra_tabela_preco.prop("checked","N"!=e.notificar_regra_tabela_preco).change(),a.chk_imprimir_impostos_orcamento.prop("checked","N"!=e.imprimir_impostos_orcamento).change(),a.chk_aprovacao_representante_envia_email.prop("checked","N"!=e.aprovacao_representante_envia_email).change(),a.chk_utilizar_motivo_desconto.prop("checked","S"==e.utilizar_motivo_desconto||!0===e.utilizar_motivo_desconto).change(),a.chk_utilizar_controle_sequencia_orcamento.prop("checked","S"==e.utilizar_controle_sequencia_orcamento||!0===e.utilizar_controle_sequencia_orcamento).change(),a.chk_listar_contatos_entidade.prop("checked","N"!=e.contatos_entidade).change(),a.chk_utilizar_unidade_medida.prop("checked","N"!=e.utilizar_unidade_medida).change(),a.chk_bloquear_unidade_medida.prop("checked","N"!=e.bloquear_unidade_medida).change(),a.chk_utilizar_unidade_medida2.prop("checked","N"!=e.utilizar_unidade_medida2).change(),a.chk_bloquear_unidade_medida2.prop("checked","N"!=e.bloquear_unidade_medida2).change(),a.chk_utilizar_representante2.prop("checked","N"!=e.utilizar_representante2).change(),a.chk_utilizar_itens_orcamento.prop("checked","N"!=e.utilizar_itens_orcamento).change(),a.chk_editar_observacoes_item.prop("checked","N"!=e.editar_observacoes_item).change(),a.chk_imprimir_observacoes_item.prop("checked","N"!=e.imprimir_observacoes_item_orcamento).change(),a.chk_exibir_carteira_representante.prop("checked","N"!=e.exibir_carteira_representante).change(),a.chk_imprimir_foto_item_orcamento.prop("checked","N"!=e.imprimir_foto_item_orcamento).change(),a.chk_utiliza_origem.prop("checked","N"!=e.utiliza_origem).change(),a.chk_utilizar_codigo_pedido_item.prop("checked","N"!=e.utilizar_codigo_pedido_item).change(),a.chk_utilizar_prazo_dias_item.prop("checked","N"!=e.utilizar_prazo_dias_item).change(),a.chk_utilizar_data_validade_orcamento.prop("checked","N"!=e.utilizar_data_validade_orcamento).change(),a.chk_sugerir_condicao_pagamento.prop("checked","N"!=e.sugerir_condicao_pagamento).change(),a.chk_escolha_empresa_ganho_perda.prop("checked","N"!=e.escolha_empresa_ganho_perda).change(),a.chk_exibir_data_abertura_oportunidade.prop("checked","S"==e.exibir_data_abertura_oportunidade).change(),a.chk_efetivar_organizacao_oportunidade_ganha.prop("checked","S"==e.efetivar_organizacao_oportunidade_ganha).change(),a.chk_exibir_organizacao_efetivada_oportunidade.prop("checked","S"==e.exibir_organizacao_efetivada_oportunidade).change(),a.chk_exibir_organizacao_efetivada_filtro.prop("checked","S"==e.exibir_organizacao_efetivada_filtro).change(),a.chk_exibir_razao_social_entidade.prop("checked","S"==e.exibir_razao_social_entidade).trigger("change"),a.chk_considera_situacao_de_referencias.prop("checked","S"==e.considera_situacao_de_referencias).trigger("change"),a.chk_exibir_info_lucro.prop("checked","N"!=e.exibir_info_lucro).change(),set_value_combobox(a.cbo_condicao_pagamento,e.condicao_pagamento_id,e.condicao_pagamento_descricao),"S"==e.sugerir_condicao_pagamento?a.div_condicao_pagamento.removeClass("hidden"):a.div_condicao_pagamento.addClass("hidden"),a.chk_nao_permitir_item_repetido.prop("checked","N"!=e.nao_permitir_item_repetido).change(),a.chk_utilizar_tabela_preco_cliente.prop("checked","N"!=e.utilizar_tabela_preco_cliente).change(),a.edt_descricao.val(e.descricao_evento_oportunidade),a.edt_dias_apos.val(e.dias_apos_evento_oportunidade),a.listar_eventos(e.tipo_agenda_oportunidade_id),a.edt_hora_inicial.val(e.hora_inicial_evento),a.edt_hora_final.val(e.hora_final_evento),a.chk_representante_especifico_acessar_funil.prop("checked",e.representante_especifico_acessar_funil).change(),a.chk_notificar_outras_entidades.prop("checked","N"!=e.notificar_outras_entidades).change(),a.chk_permitir_tabela_preco_vencida.prop("checked","N"!=e.permitir_tabela_preco_vencida).change(),a.chk_arredondamento_automatico_preco_com_desconto.prop("checked","N"!=e.arredondamento_automatico_preco_com_desconto).change(),a.arr_representante=e.arr_representante,a.listar_representante(),a.arr_etapas=e.arr_etapas,a.render_etapas(),a.formulario_id=e.formulario_oportunidade_id,a.formulario_alterado_id=e.formulario_oportunidade_id,a.render_formulario(e.formulario_oportunidade_id)})},a.cbo_vincular_form.unbind("change").change(function(e){a.formulario_alterado_id=a.cbo_vincular_form.val()}),this.render_formulario=function(e){a.cbo_vincular_form.find("option").remove(),add_option(a.cbo_vincular_form,"","Nenhum"),WS.get("formulario/listar/",{tipo_formulario:a.tipo_formulario},function(i){$(i).each(function(e,i){add_option(a.cbo_vincular_form,i.formulario_id,i.nome)}),e&&a.cbo_vincular_form.val(e),a.cbo_vincular_form.selectpicker("refresh")})},a.chk_exibir_carteira_representante.change(function(e){1==$(this).prop("checked")?a.div_exibir_notificar_entidades.removeClass("hidden"):(a.div_exibir_notificar_entidades.addClass("hidden"),a.chk_notificar_outras_entidades.prop("checked",!1).change())}),this.organizar_ordem=function(){$(a.tab_listagem_etapas).find(".rows").each(function(e,i){$(i).find("[template-field='numerador']").text(e+1);var o=$(i).find("[template-field='numerador']").text(),t=$(i).find("[template-field='novo_registro']").text(),_=$(i).find("[template-field='funil_vendas_etapa_id']").text();$(a.arr_etapas).each(function(e,a){a.novo_registro?t==a.novo_registro&&(a.ordem=o):_==a.funil_vendas_etapa_id&&(a.ordem=o)})})},this.render_etapas=function(){var e=a.tab_listagem_etapas.find("tbody"),i=e.find("tr:first");$(e).sortable({start:function(e,a){},change:function(e,a){},update:function(e,a){$(e.target.children).each(function(e,a){$(a).find("[template-field='numerador']").text(parseInt(e,10))})}}),a.organizar_ordem(),a.arr_etapas_filter=a.arr_etapas.filter(function(e){var a=!0;return"S"==e.excluido&&(a=!1),a}),a.arr_etapas_filter=a.arr_etapas_filter.sort(function(e,a){return parseInt(e.ordem,10)>parseInt(a.ordem,10)?1:-1}),a.tab_listagem_etapas.find("tr:gt(1)").remove(),$(a.arr_etapas_filter).each(function(o,t){!function(o){var t=i.clone();t.removeAttr("template-row"),t.css("display",""),t.addClass("rows"),t.find("[template-field='funil_vendas_etapa_id']").text(o.funil_vendas_etapa_id),t.find("[template-field='numerador']").text(o.ordem),$(t.find("[template-field='etapa']")).text(o.nome),$(t.find("[template-field='probabilidade']")).text(o.probabilidade+"%"),o.novo_registro&&$(t.find("[template-field='novo_registro']")).text(o.novo_registro);var _=$(t.find(".btn_editar_etapa"));_.unbind("click"),_.click(function(){View.load("funil_vendas_etapa/detalhes",function(e,i){var t=a.processo_id;i.show(function(e){a.render_etapas()},FORMULARIO.EDITAR,o,t)})});var r=$(t.find(".btn_deletar_etapa"));r.unbind("click"),r.click(function(){o.funil_vendas_etapa_id>0?WS.get("oportunidade/consultar_oportunidades_by_funil_venda_etapa/",{funil_vendas_etapa_id:o.funil_vendas_etapa_id},function(e){if(1==e){var i=new Validation;return i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Etapa não pode ser excluída pois existem oportunidades ligadas a ela.")),void alert_modal("Validação",i)}View.load("funil_vendas_etapa/detalhes",function(e,i){i.show(function(e){t.removeClass("rows"),a.render_etapas()},FORMULARIO.EXCLUIR,o)})}):View.load("funil_vendas_etapa/detalhes",function(e,i){i.show(function(e){t.removeClass("rows"),a.render_etapas()},FORMULARIO.EXCLUIR,o)})}),t.appendTo(e)}(t)}),a.organizar_ordem(),App.aplicar_mascaras(e)},this.listar_condicao_pagamento=function(e){var i=new Object;i.descricao=a.edt_condicao_pagamento.val(),i.bloqueado="N",WS.get("condicao_pagamento/listar/",i,function(i){limpar_combobox(a.cbo_condicao_pagamento),$(i).each(function(e,i){var o=[];o["Descrição"]=i.descricao,add_option_combobox(a.cbo_condicao_pagamento,e,i.condicao_pagamento_id,o)}),e(!0)})},this.render_representantes=function(e){WS.get("representante/listar/",{nome_fantasia:a.edt_representante.val()},function(i){limpar_combobox(a.cbo_representante),a.arr_listagem_representante=i,$(i).each(function(e,i){var o=[];o.Nome=i.nome_fantasia,add_option_combobox(a.cbo_representante,e,i.representante_id,o)}),a.cbo_representante.parent().find(".ul_row").click(function(){var e=$(this).parent().attr("id_registro");a.relacionar_representante_existente(e)}),e(!0)})},this.relacionar_representante_existente=function(e){if(e>0){var i=a.cbo_representante.parent(),o=i.find(".edt_combobox");if(1==i.find(".btn_novo").hasClass("hidden")){var t=!1;if($(a.arr_representante).each(function(a,i){i.representante_id==e&&0==i.removido&&(t=!0)}),t)o.val(""),set_focus(o);else{var _=new Object;_.representante_id=e,_.editar_preco=!1,_.removido=!1,$(a.arr_listagem_representante).each(function(e,a){a.representante_id==_.representante_id&&(_.nome=a.nome_fantasia)}),a.arr_representante.push(_),a.listar_representante(),setTimeout(function(){o.val(""),set_focus(o)},100)}}}},this.listar_representante=function(){var e=a.tab_listagem_representante.find("tbody"),i=e.find("tr:first");$(a.arr_representante).each(function(e,i){void 0===a.arr_representante[e].removido&&(a.arr_representante[e].removido=!1)}),a.arr_representante_filtrados=a.arr_representante.filter(function(e){var a=!0;return!0===e.removido&&(a=!1),a}),a.tab_listagem_representante.find("tr:gt(1)").remove(),$(a.arr_representante_filtrados).each(function(o,t){!function(o,t){var _=i.clone();_.removeAttr("template-row"),_.css("display",""),$(_.find("[template-field='nome']")).text(t.nome);var r=$(_.find("[template-field='chk_editar_preco']"));r.removeClass("template_switch"),r.prop("checked",t.editar_preco),r.unbind("change"),r.change(function(){a.arr_representante[o].editar_preco=$(this).prop("checked")});var n=$(_.find("[template-field='chk_editar_desconto']"));n.removeClass("template_switch"),n.prop("checked",t.editar_desconto),n.unbind("change"),n.change(function(){a.arr_representante[o].editar_desconto=$(this).prop("checked")}),$(_.find("[template-field='email']")).text(t.email_principal);var c=$(_.find(".btn_deletar_representante"));c.unbind("click"),c.click(function(){alert_modal("Representante","Deseja remover?","Remover",function(){$(a.arr_representante).each(function(e,i){i.representante_id==t.representante_id&&(a.arr_representante[e].removido=!0,a.listar_representante())})},!0)}),_.appendTo(e)}(o,t)}),App.aplicar_mascaras(e),App.aplicar_checkbox(e)},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){a.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){if(""!=a.cbo_processo.val()){var e=a.funil_vendas_etapa_processo.dxDataGrid("instance").getVisibleRows();$.each(e,function(e,i){var o={};o.etapa_id=i.data.funil_vendas_etapa_id;var t=$(i.cells[0].cellElement).find(".dx-tagbox").dxTagBox("instance");if(t){var _=t.option("selectedItems");if(_.length>0){var r=[];$.each(_,function(e,a){a.id>0&&r.push(a.id)}),o.atividades=r,a.dados_vinculo_atividade_processo_funil.push(o)}}})}a.formulario_alterado_id!=a.formulario_id&&null!=a.formulario_alterado_id?(a.formulario_id=a.formulario_alterado_id,alert_modal("Atenção","Tem certeza que deseja alterar o formulário vinculado ao Funil ?","Confirmar",a.acao_salvar,!0,"Cancelar",null,null,"modal-lg")):a.acao_salvar()}),this.acao_salvar=function(){a.organizar_ordem(),WS.post("funil_vendas/salvar",{funil_vendas_id:a.funil_vendas_id,nome:a.edt_nome.val(),arr_etapas:JSON.stringify(a.arr_etapas),padrao:a.chk_padrao.prop("checked"),redimensionar_etapas:a.chk_redimensionar_etapas.prop("checked"),gerar_evento_apos_orcamento:a.chk_gerar_evento.prop("checked"),aprovacao_supervisor:a.chk_aprovacao_supervisor.prop("checked"),utiliza_contato:a.chk_utiliza_contato.prop("checked"),tipo_agenda_oportunidade_id:a.cbo_evento_tipo.val(),descricao_evento_oportunidade:a.edt_descricao.val(),dias_apos_evento_oportunidade:a.edt_dias_apos.val(),hora_inicial_evento:a.edt_hora_inicial.val(),hora_final_evento:a.edt_hora_final.val(),mensagem_email:get_tinymce(a.edt_mensagem_padrao),nome_oportunidade_padrao:a.edt_nome_oportunidade_padrao.val(),observacao_padrao:a.edt_observacao_padrao.val(),sugerir_data_atual:a.chk_sugerir_data_atual.prop("checked"),sugerir_situacao_negocio_ganho:a.chk_sugerir_situacao_negocio_ganho.prop("checked"),obrigar_regra_tabela_preco:a.chk_obrigar_regra_tabela_preco.prop("checked"),notificar_regra_tabela_preco:a.chk_notificar_regra_tabela_preco.prop("checked"),imprimir_impostos_orcamento:a.chk_imprimir_impostos_orcamento.prop("checked"),aprovacao_representante_envia_email:a.chk_aprovacao_representante_envia_email.prop("checked"),utilizar_motivo_desconto:a.chk_utilizar_motivo_desconto.prop("checked"),utilizar_controle_sequencia_orcamento:a.chk_utilizar_controle_sequencia_orcamento.prop("checked"),contatos_entidade:a.chk_listar_contatos_entidade.prop("checked"),utilizar_unidade_medida:a.chk_utilizar_unidade_medida.prop("checked"),bloquear_unidade_medida:a.chk_bloquear_unidade_medida.prop("checked"),utilizar_unidade_medida2:a.chk_utilizar_unidade_medida2.prop("checked"),bloquear_unidade_medida2:a.chk_bloquear_unidade_medida2.prop("checked"),utilizar_representante2:a.chk_utilizar_representante2.prop("checked"),utilizar_itens_orcamento:a.chk_utilizar_itens_orcamento.prop("checked"),editar_observacoes_item:a.chk_editar_observacoes_item.prop("checked"),exibir_carteira_representante:a.chk_exibir_carteira_representante.prop("checked"),imprimir_foto_item_orcamento:a.chk_imprimir_foto_item_orcamento.prop("checked"),exibir_itens_sem_tabela_preco:a.chk_exibir_itens_sem_tabela_preco.prop("checked"),utiliza_origem:a.chk_utiliza_origem.prop("checked"),sugerir_condicao_pagamento:a.chk_sugerir_condicao_pagamento.prop("checked"),escolha_empresa_ganho_perda:a.chk_escolha_empresa_ganho_perda.prop("checked"),exibir_data_abertura_oportunidade:a.chk_exibir_data_abertura_oportunidade.prop("checked"),efetivar_organizacao_oportunidade_ganha:a.chk_efetivar_organizacao_oportunidade_ganha.prop("checked"),exibir_organizacao_efetivada_oportunidade:a.chk_exibir_organizacao_efetivada_oportunidade.prop("checked"),exibir_organizacao_efetivada_filtro:a.chk_exibir_organizacao_efetivada_filtro.prop("checked"),exibir_razao_social_entidade:a.chk_exibir_razao_social_entidade.prop("checked"),considera_situacao_de_referencias:a.chk_considera_situacao_de_referencias.prop("checked"),exibir_info_lucro:a.chk_exibir_info_lucro.prop("checked"),nao_permitir_item_repetido:a.chk_nao_permitir_item_repetido.prop("checked"),imprimir_observacoes_item_orcamento:a.chk_imprimir_observacoes_item.prop("checked"),condicao_pagamento_id:get_value_combobox(a.cbo_condicao_pagamento),utilizar_tabela_preco_cliente:a.chk_utilizar_tabela_preco_cliente.prop("checked"),arr_representante:JSON.stringify(a.arr_representante_filtrados),representante_especifico_acessar_funil:a.chk_representante_especifico_acessar_funil.prop("checked"),notificar_outras_entidades:a.chk_notificar_outras_entidades.prop("checked"),utilizar_codigo_pedido_item:a.chk_utilizar_codigo_pedido_item.prop("checked"),utilizar_prazo_dias_item:a.chk_utilizar_prazo_dias_item.prop("checked"),utilizar_data_validade_orcamento:a.chk_utilizar_data_validade_orcamento.prop("checked"),permitir_tabela_preco_vencida:a.chk_permitir_tabela_preco_vencida.prop("checked"),arredondamento_automatico_preco_com_desconto:a.chk_arredondamento_automatico_preco_com_desconto.prop("checked"),formulario_oportunidade_id:a.formulario_id,processo_id:a.cbo_processo.val(),dados_vinculo_processo_funil:a.dados_vinculo_atividade_processo_funil,ordenacao_colunas:JSON.stringify(a.arr_ordenacao_colunas)},function(e){a.funil_vendas_id=e.id,alert_saved(e.nome+" salvo com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()})},this.get_colunas_ordem=function(){+a.funil_vendas_id>0?WS.get("funil_vendas/get_colunas_ordem/",{funil_vendas_id:a.funil_vendas_id},function(e){e.length>0&&(a.arr_ordenacao_colunas=e),a.render_grid_ordenacao()}):a.render_grid_ordenacao()},this.render_grid_ordenacao=function(){a.grid_ordenacao.dxDataGrid({dataSource:a.arr_ordenacao_colunas,columns:[{dataField:"coluna_nome",dataType:"text",caption:"Coluna"},{dataField:"visivel",caption:"Visível",width:100,dataType:"boolean",calculateCellValue:function(e){return 1==e.visivel||!0===e.visivel||"S"==e.visivel}}],showBorders:!0,editing:{mode:"cell",allowUpdating:!0,allowAdding:!1,allowDeleting:!1,useIcons:!0},scrolling:{mode:"virtual"},sorting:{mode:"none"},rowDragging:{allowReordering:!0,showDragIcons:!0,onReorder:function(e){var i=e.component.getVisibleRows(),o=a.arr_ordenacao_colunas.indexOf(i[e.toIndex].data),t=a.arr_ordenacao_colunas.indexOf(e.itemData);a.arr_ordenacao_colunas.splice(t,1),a.arr_ordenacao_colunas.splice(o,0,e.itemData),e.component.refresh()}},onRowUpdated:function(e){var i=a.arr_ordenacao_colunas.indexOf(e.data);a.arr_ordenacao_colunas[i].visivel=e.data.visivel}})},this.chk_gerar_evento.unbind("change"),this.chk_gerar_evento.change(function(e,i){!0===$(this).prop("checked")?a.div_parametros_evento.removeClass("hidden"):a.div_parametros_evento.addClass("hidden")}),this.chk_sugerir_condicao_pagamento.unbind("change"),this.chk_sugerir_condicao_pagamento.change(function(e,i){$(this).prop("checked")?a.div_condicao_pagamento.removeClass("hidden"):(a.div_condicao_pagamento.addClass("hidden"),set_value_combobox(a.cbo_condicao_pagamento,"",""))}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("funil_vendas/excluir",{funil_vendas_id:a.funil_vendas_id},function(e){alert_saved(e.nome+" excluido com sucesso"),a.unload()})}),this.btn_incluir_etapa.unbind("click"),this.btn_incluir_etapa.click(function(){View.load("funil_vendas_etapa/detalhes",function(e,i){var o=a.processo_id;i.show(function(e){a.arr_etapas.push(e),a.render_etapas()},FORMULARIO.NOVO,null,o)})}),a.cbo_processo.unbind("change"),a.cbo_processo.change(function(e){var i=$(this).val();$.each($(".dx-tagbox"),function(e,a){$(a).dxTagBox("option","values",[]),$(a).dxTagBox("instance").repaint(),$(a).dxTagBox("instance").reset(),$(a).dxTagBox("option","disabled",!0)}),""!=i&&null!=i?($(".dx-tagbox").dxTagBox("option","disabled",!0),i!=a.processo_id&&(a.aux_dados_vinculo_atividade_processo_funil=[],a.processo_id=i,a.popula_tag_boxes(),a.div_vinculo_atividade_processo_funil.removeClass("hidden"))):(a.dados_vinculo_atividade_processo_funil=[],a.itens_array=[])}),this.chk_representante_especifico_acessar_funil.unbind("change"),this.chk_representante_especifico_acessar_funil.change(function(){$(this).prop("checked")?a.div_representante.removeClass("hidden"):(a.arr_representante=[],a.arr_representante_filtrados=[],a.listar_representante(),a.div_representante.addClass("hidden"))}),this.chk_bloquear_unidade_medida2.unbind("change").change(function(e){$(this).prop("checked")&&a.chk_bloquear_unidade_medida.prop("checked",!1).change()}),this.chk_bloquear_unidade_medida.unbind("change").change(function(e){$(this).prop("checked")&&a.chk_bloquear_unidade_medida2.prop("checked",!1).change()}),this.chk_notificar_regra_tabela_preco.change(function(e){!0===$(this).prop("checked")&&(a.chk_obrigar_regra_tabela_preco.prop("checked",!1).change(),a.chk_exibir_itens_sem_tabela_preco.prop("checked",!1).change(),a.chk_utilizar_tabela_preco_cliente.prop("checked",!1).change(),a.chk_permitir_tabela_preco_vencida.prop("checked",!1).change()),a.chk_exibir_itens_sem_tabela_preco.prop("disabled",$(this).prop("checked")).change(),a.chk_utilizar_tabela_preco_cliente.prop("disabled",$(this).prop("checked")).change(),a.chk_permitir_tabela_preco_vencida.prop("disabled",$(this).prop("checked")).change()}),this.chk_obrigar_regra_tabela_preco.change(function(e){!0===$(this).prop("checked")&&!0===a.chk_notificar_regra_tabela_preco.prop("checked")&&a.chk_notificar_regra_tabela_preco.prop("checked",!1).change()}),this.chk_exibir_itens_sem_tabela_preco.change(function(e){!0===$(this).prop("checked")&&!0===a.chk_notificar_regra_tabela_preco.prop("checked")&&a.chk_notificar_regra_tabela_preco.prop("checked",!1).change()}),this.chk_utilizar_tabela_preco_cliente.change(function(e){!0===$(this).prop("checked")&&!0===a.chk_notificar_regra_tabela_preco.prop("checked")&&a.chk_notificar_regra_tabela_preco.prop("checked",!1).change()}),this.chk_permitir_tabela_preco_vencida.change(function(e){!0===$(this).prop("checked")&&!0===a.chk_notificar_regra_tabela_preco.prop("checked")&&a.chk_notificar_regra_tabela_preco.prop("checked",!1).change()}),this.btn_alterar_imagem.unbind("click").click(function(){View.load("funil_vendas/alterar_imagem",function(e,i){i.onclose=a.listar,i.show(FORMULARIO.NOVO,a.funil_vendas_id,a.imagem_id)})})}});