define([],function(){return function(i){"use strict";var a=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Saída de E-mails",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_enviar=this.dialog.find(".btn_enviar"),this.btn_limpar_semaforo=this.dialog.find(".btn_limpar_semaforo"),this.btn_listar=this.dialog.find(".btn_listar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.div_carregar_mais=this.dialog.find(".div_carregar_mais"),this.btn_carregar_mais=this.dialog.find(".btn_carregar_mais"),this.scrollview=this.dialog.find(".scrollview"),this.limite=0,this.pode_buscar=!0;var t=[];this.show=function(){a.scrollview.dxScrollView().dxScrollView("instance"),a.scrollview.css("height","calc(100vh - 75px)"),a.listar()},this.listar=function(){a.btn_limpar_semaforo.hide();var i=a.tab_listagem.find("tbody"),r=i.find("tr:first");t=[],a.btn_excluir_refresh(),WS.get("email_job/listar_caixa_saida/",{limite:a.limite},function(e){a.div_carregar_mais.removeClass("hidden"),a.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.carregar_mais_registros),a.btn_carregar_mais.find("span.icn_carregar_mais").remove(),a.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-arrow-down"></span>'),0===e.lista.length&&(a.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.todos_carregados),a.btn_carregar_mais.find("span.icn_carregar_mais").remove(),a.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-check"></span>'),a.pode_buscar=!1),0===a.limite&&a.tab_listagem.find("tr:gt(1)").remove(),a.pode_buscar&&($(e.lista).each(function(e,n){!function(e){var n=r.clone();n.removeAttr("template-row"),n.css("display",""),$(n.find("[template-field='data_solicitacao_envio']")).text(e.data_solicitacao_envio.format_date_time()),$(n.find("[template-field='de_nome']")).text(e.de_nome),$(n.find("[template-field='para']")).text(e.para),$(n.find("[template-field='assunto']")).text(e.assunto);var s=$(n.find("[template-field='status']"));e.data_envio?(s.addClass("label-success"),s.text("Enviado")):parseInt(e.erro_quantidade,10)>0?(s.addClass("label-warning"),s.text("Falhou  ("+e.erro_quantidade+")"),s.tooltip({title:e.erro_mensagem,placement:"left",trigger:"hover"})):(s.addClass("label-default"),s.text("Aguardando"),s.tooltip("hide"));var l=$(n.find(".btn_visualizar_corpo_email"));l.unbind("click"),l.click(function(){View.load("email_job/detalhes",function(i,a){a.show(e.email_job_id)})}),n.click(function(){if("true"!=n.attr("selecionado"))n.addClass("bg-primary"),n.find("td").addClass("bg-primary"),n.attr("selecionado",!0),t.push(e.email_job_id);else{n.removeClass("bg-primary"),n.find("td").removeClass("bg-primary"),n.attr("selecionado",!1);var i=t.indexOf(e.email_job_id);t.splice(i,1)}a.btn_excluir_refresh()}),n.appendTo(i)}(n)}),e.semaforo&&""!=e.semaforo.trim()?a.btn_limpar_semaforo.show():a.btn_limpar_semaforo.hide())},[a.btn_enviar,a.btn_limpar_semaforo,a.btn_listar,a.btn_excluir])},this.btn_listar.unbind("click"),this.btn_listar.click(function(){a.limpar_listar()}),this.btn_enviar.unbind("click"),this.btn_enviar.click(function(){WS.post("email_job/processar_envios_pendentes/",null,function(i){i.log_ultima_execucao&&alert_modal("Validação",nl2br(i.log_ultima_execucao)),a.limpar_listar()},[a.btn_enviar,a.btn_listar,a.btn_excluir])}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("email_job/excluir/",{email_job_ids:JSON.stringify(t)},function(i){a.limpar_listar()},[a.btn_enviar,a.btn_listar,a.btn_excluir])}),this.btn_excluir_refresh=function(){t.length>0?a.btn_excluir.show():a.btn_excluir.hide()},this.btn_limpar_semaforo.unbind("click"),this.btn_limpar_semaforo.click(function(){WS.post("email_job/limpar_semaforo/",null,function(i){a.limpar_listar()},[a.btn_limpar_semaforo])}),this.btn_carregar_mais.unbind("click").click(function(){a.btn_carregar_mais.find("span.txt_carregar_mais").text(App.lang.btn_carregar_mais.aguarde),a.btn_carregar_mais.find("span.icn_carregar_mais").remove(),a.btn_carregar_mais.append('<span class="icn_carregar_mais fa fa-spinner fa-spin">'),a.pode_buscar&&(a.limite=a.limite+100),a.listar()}),this.limpar_listar=function(){a.limpar_limite(),a.listar()},this.limpar_limite=function(){a.limite=0,a.pode_buscar=!0},this.unload=function(){View.unload(this.html_id)},this.show()}});