define([],function(){return function(a){"use strict";var e=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Envio Multiplo",this.div_dropabled_file2=document.getElementsByClassName("div_dropabled_file")[0],this.div_dropabled_file=this.dialog.find(".div_dropabled_file"),this.edt_files=this.dialog.find(".edt_files"),this.div_tab_files=this.dialog.find(".div_tab_files"),this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.span_normal=this.dialog.find(".span_normal"),this.cbo_opcao_cadastro=this.dialog.find(".cbo_opcao_cadastro"),this.cbo_assunto_documento_principal=this.dialog.find(".cbo_assunto_documento_principal"),this.cbo_tipo_documento_principal=this.dialog.find(".cbo_tipo_documento_principal"),this.cbo_local_armazenamento_principal=this.dialog.find(".cbo_local_armazenamento_principal"),this.edt_data_vigencia_principal=this.dialog.find(".edt_data_vigencia_principal"),this.div_esconder=this.dialog.find(".div_esconder"),this.arr_file=[],this.arr_todos_files=[],this.documento_pasta_id=null,this.count=0,this.arr_arquivos_id=[],this.arr_names=null,this.arr_path=[],this.lista_html_id=null,this.tags_padrao=null,this.assunto_padrao=null,this.tipo_documento_padrao=null,this.uploads_realizados=!1,this.arr_assunto_documentos=[],this.arr_tipo_documentos=[],this.arr_local_armazenamento_documentos=[],this.onclose=null,this.exibir_codigo=!1,this.tela_upload=null,this.referencia_tabela=null,this.referencia_id=null,this.show=function(a){WS.get("documento/get_parametros/",null,function(a){e.exibir_codigo="N"!=a.documentos_informar_codigo_documento_pasta}),e.documento_pasta_id=a,e.cbo_opcao_cadastro.selectpicker("refresh"),e.listar_pasta(),e.listar_assunto(),e.listar_tipo_documento(),e.listar_local_armazenamento(),set_datepicker(e.edt_data_vigencia_principal),setTimeout(function(){App.is_nativo()||e.span_normal.removeClass("hidden"),clearTimeout(this)},150)},this.listar_pasta=function(){WS.get("documento_pasta/objeto/",{documento_pasta_id:e.documento_pasta_id},function(a){e.tags_padrao=null!=a.tags_padrao||""!=a.tags_padrao?a.tags_padrao:null,e.assunto_padrao=null!=a.assunto_id||""!=a.assunto_id?a.assunto_id:null,e.tipo_documento_padrao=null!=a.tipo_documento_id||""!=a.tipo_documento_id?a.tipo_documento_id:null})},this.listar_assunto=function(a){e.cbo_assunto_documento_principal.find("option").remove(),add_option(e.cbo_assunto_documento_principal,"","Nenhum"),WS.get("assunto/listar/",null,function(t){e.arr_assunto_documentos=t;for(var o=0;o<t.length;o++){var n=t[o];"S"===n.padrao_documentos.toString()?add_option(e.cbo_assunto_documento_principal,n.assunto_id,n.descricao,"selected"):add_option(e.cbo_assunto_documento_principal,n.assunto_id,n.descricao)}(a=a||null)&&e.cbo_assunto_documento_principal.val(a).trigger("change"),e.cbo_assunto_documento_principal.selectpicker("refresh")})},this.listar_tipo_documento=function(a){e.cbo_tipo_documento_principal.find("option").remove(),add_option(e.cbo_tipo_documento_principal,"","Nenhum"),WS.get("tipo_documento/listar/",null,function(t){e.arr_tipo_documentos=t;for(var o=0;o<t.length;o++){var n=t[o];"S"===n.padrao_documentos.toString()?add_option(e.cbo_tipo_documento_principal,n.tipo_documento_id,n.nome,"selected"):add_option(e.cbo_tipo_documento_principal,n.tipo_documento_id,n.nome)}a&&e.cbo_tipo_documento_principal.val(a).trigger("change"),e.cbo_tipo_documento_principal.selectpicker("refresh")})},this.listar_local_armazenamento=function(a){e.cbo_local_armazenamento_principal.find("option").remove(),add_option(e.cbo_local_armazenamento_principal,"","Nenhum"),WS.get("local_armazenamento/listar/",null,function(t){e.arr_local_armazenamento_documentos=t;for(var o=0;o<t.length;o++){var n=t[o];"true"===n.padrao_documentos.toString()?add_option(e.cbo_local_armazenamento_principal,n.local_armazenamento_id,n.nome,"selected"):add_option(e.cbo_local_armazenamento_principal,n.local_armazenamento_id,n.nome)}a&&e.cbo_local_armazenamento_principal.val(a).trigger("change"),e.cbo_local_armazenamento_principal.selectpicker("refresh")})},this.listar_files=function(){var a=e.arr_file,t=e.tab_listagem.find("tbody"),o=t.find("[template-row]"),n=function(a,t,o){var n=null;if(a.find("option").remove(),add_option(a,"","Nenhum"),o)WS.get("assunto/listar/",null,function(e){for(var o=0;o<e.length;o++){var i=e[o];"S"===i.padrao_documentos.toString()?(add_option(a,i.assunto_id,i.descricao,"selected"),n=i.assunto_id):add_option(a,i.assunto_id,i.descricao)}(t=t||(n>0?n:null))&&a.val(t).trigger("change")});else{for(var i=0;i<e.arr_assunto_documentos.length;i++){var l=e.arr_assunto_documentos[i];"S"===l.padrao_documentos.toString()?(add_option(a,l.assunto_id,l.descricao,"selected"),n=l.assunto_id):add_option(a,l.assunto_id,l.descricao)}(t=t||(n>0?n:null))&&a.val(t).trigger("change")}},i=function(a,t,o){var n=null;if(a.find("option").remove(),add_option(a,"","Nenhum"),o)WS.get("tipo_documento/listar/",null,function(e){for(var o=0;o<e.length;o++){var i=e[o];"S"===i.padrao_documentos.toString()?(add_option(a,i.tipo_documento_id,i.nome,"selected"),n=i.tipo_documento_id):add_option(a,i.tipo_documento_id,i.nome)}(t=t||(n>0?n:null))&&a.val(t).trigger("change")});else{for(var i=0;i<e.arr_tipo_documentos.length;i++){var l=e.arr_tipo_documentos[i];"S"===l.padrao_documentos.toString()?(add_option(a,l.tipo_documento_id,l.nome,"selected"),n=l.tipo_documento_id):add_option(a,l.tipo_documento_id,l.nome)}(t=t||(n>0?n:null))&&a.val(t).trigger("change")}},l=function(a,t,o){var n=null;if(a.find("option").remove(),add_option(a,"","Nenhum"),o)WS.get("local_armazenamento/listar/",null,function(e){for(var o=0;o<e.length;o++){var i=e[o];"true"===i.padrao_documentos.toString()?(add_option(a,i.local_armazenamento_id,i.nome,"selected"),n=i.local_armazenamento_id):add_option(a,i.local_armazenamento_id,i.nome)}(t=t||(n>0?n:null))&&a.val(t).trigger("change")});else{for(var i=0;i<e.arr_local_armazenamento_documentos.length;i++){var l=e.arr_local_armazenamento_documentos[i];"true"===l.padrao_documentos.toString()?(add_option(a,l.local_armazenamento_id,l.nome,"selected"),n=l.local_armazenamento_id):add_option(a,l.local_armazenamento_id,l.nome)}(t=t||(n>0?n:null))&&a.val(t).trigger("change")}};$(a).each(function(_,r){!function(a,d){var _=o.clone();_.removeAttr("template-row"),_.css("display",""),_.addClass("documento");var r=d.elem_key_parent;delete d.elem_key_parent;var c={arquivo_id:md5(elem_key_random()+d.name+d.size+d.type),nome:null,tag:e.tags_padrao,tipo_documento_id:e.tipo_documento_padrao,assunto_id:e.assunto_padrao,local_armazenamento_id:null,arquivo:null,controle_acessos:!1,documento_pasta_id:e.documento_pasta_id,referencia_tabela:e.referencia_tabela,referencia_id:e.referencia_id,excluido:"N",elem_key_parent:r};d.id=c.arquivo_id,e.arr_arquivos_id.push(d.id),c.arquivo=d;var s=$(_.find("[template-field='nome']"));s.change(function(){$(_.find("[template-field='nome']")).val(this.value),c.nome=this.value}),s.val(c.arquivo.name).trigger("change");var u=$(_.find("[template-field='codigo']"));0==e.exibir_codigo&&u.prop("readonly",!0),u.change(function(){$(_.find("[template-field='codigo']")).val(this.value),c.codigo=this.value}),s.val(c.arquivo.name).trigger("change"),$(_.find("[template-field='observacoes']")).change(function(){$(_.find("[template-field='observacoes']")).val(this.value),c.observacoes=this.value});var p=$(_.find("[template-field='data_vigencia']"));set_datepicker(p),p.on("change",function(){c.data_vigencia=get_datepicker(p)});var m=$(_.find("[template-field='tags']"));m.change(function(){$(_.find("[template-field='tags']")).val(this.value),c.tag=this.value}),m.val(c.tag);var f=$(_.find("[template-field='cbo_tipo_documento']"));f.unbind("change"),f.change(function(){$(_.find("[template-field='cbo_tipo_documento']")).val(this.value),c.tipo_documento_id=this.value});var h=$(_.find("[template-field='cbo_assunto']"));h.unbind("change"),h.change(function(){$(_.find("[template-field='cbo_assunto']")).val(this.value),c.assunto_id=this.value});var v=$(_.find("[template-field='cbo_local_armazenamento']"));v.unbind("change"),v.change(function(){$(_.find("[template-field='cbo_local_armazenamento']")).val(this.value),c.local_armazenamento_id=this.value}),n(h,c.assunto_id),i(f,c.tipo_documento_id),l(v);var g=$(_.find("[template-button='btn_excluir']"));g.unbind("click"),g.click(function(){_.remove(),e.arr_todos_files[a].excluido="S",0==t.find(".documento").length&&e.tab_listagem.addClass("hidden")});var b=$(_.find("[template-button='btn_assunto_visualizar']"));b.unbind("click"),b.click(function(){""!=h.val()&&View.load("assunto/detalhes",function(a,e){e.show(h.val(),FORMULARIO.VISUALIZAR)})});var z=$(_.find("[template-button='btn_assunto_novo']"));z.unbind("click"),z.click(function(){View.load("assunto/detalhes",function(a,t){t.onclose=function(){t.assunto_id&&e.dialog.find("[template-field='cbo_assunto']").each(function(a,e){n($(e),t.assunto_id,!0)})},t.show(null,FORMULARIO.NOVO)})});var k=$(_.find("[template-button='btn_tipo_documento_visualizar']"));k.unbind("click"),k.click(function(){""!=f.val()&&View.load("tipo_documento/detalhes",function(a,e){e.show(f.val(),FORMULARIO.VISUALIZAR)})});var y=$(_.find("[template-button='btn_tipo_documento_novo']"));y.unbind("click"),y.click(function(){View.load("tipo_documento/detalhes",function(a,t){t.onclose=function(){t.tipo_documento_id&&e.dialog.find("[template-field='cbo_tipo_documento']").each(function(a,e){i($(e),t.tipo_documento_id,!0)})},t.show(null,FORMULARIO.NOVO)})});var S=$(_.find("[template-button='btn_local_armazenamento_visualizar']"));S.unbind("click"),S.click(function(){""!=v.val()&&View.load("local_armazenamento/detalhes",function(a,e){e.show(v.val(),FORMULARIO.VISUALIZAR)})});var w=$(_.find("[template-button='btn_local_armazenamento_novo']"));w.unbind("click"),w.click(function(){View.load("local_armazenamento/detalhes",function(a,t){t.onclose=function(){t.local_armazenamento_id&&e.dialog.find("[template-field='cbo_local_armazenamento']").each(function(a,e){l($(e),t.local_armazenamento_id,!0)})},t.show(null,FORMULARIO.NOVO)})}),e.arr_todos_files.push(c),_.appendTo(t),e.div_tab_files.removeClass("hidden")}(e.count,a[_]),e.count++,e.count==a.length&&setTimeout(function(){d()},150)});var d=function(){null==e.lista_html_id?View.load("upload/listar",function(t,o){e.lista_html_id=t,e.tela_upload=o,o.oncomplete=function(a){if(e.uploads_realizados=!0,void 0!==a)if(e.arr_names.length>0)for(var t=a.length-1;t>=0;t--)e.arr_names[e.arr_names.length]=a[t];else e.arr_names=a},o.onclose=function(){e.lista_html_id=null},o.show(a,e.html_id)},View.ABA.SIM):View.show(e.lista_html_id)}},this.upload_drag_drop=function(a){if(a.stopPropagation(),a.preventDefault(),"dragleave"==a.type)e.div_dropabled_file.show("slow"),e.div_dropabled_file.fadeIn(500),e.edt_files.show("slow"),e.edt_files.fadeIn(500);else if("dragover"==a.type);else if("drop"==a.type){e.arr_file=[],e.arr_path=[];var t=function(a,o,n){var i={path_parent:o=o||"",nome:a.name,elem_key_parent:n||null,elem_key:md5(new Date+Math.random()+a.name+o+Math.random()),documento_pasta_id:e.documento_pasta_id,excluido:"N",obj_directory:a};e.arr_path.push(i);var l=parseInt(e.arr_path.length,10)-1;e.arr_path[l].indice=e.arr_path.length,o=o+a.name+"/",window.enumerateDirectoryWithManyFiles(a).then(function(a){var n=!1;if(a.length>0)for(var l=0;l<a.length;l++){a[l].isDirectory&&(n=!0,t(a[l],o,i.elem_key));var d=parseInt(l,10)+1;0==n&&d==a.length&&i.indice==e.arr_path.length&&$(e.arr_path).each(function(a,t){window.enumerateDirectoryWithManyFiles(t.obj_directory).then(function(o){for(var n=0,i=o,l=0;l<i.length;l++)i[l].isFile&&n++;var d=0;for(l=0;l<o.length;l++)o[l].isFile&&o[l].file(function(o){d++,o.elem_key_parent=t.elem_key,e.arr_file.push(o),parseInt(a,10)+1==e.arr_path.length&&d==n&&($(e.div_dropabled_file).hide("fast"),e.div_dropabled_file.fadeOut(300),e.edt_files.hide("fast"),e.edt_files.fadeOut(300),setTimeout(function(){e.listar_files()},900))})})})}else i.indice==e.arr_path.length&&$(e.arr_path).each(function(a,t){window.enumerateDirectoryWithManyFiles(t.obj_directory).then(function(a){for(var o=0;o<a.length;o++)a[o].isFile&&a[o].file(function(a){a.elem_key_parent=t.elem_key,e.arr_file.push(a)})}),parseInt(a,10)+1==e.arr_path.length&&($(e.div_dropabled_file).hide("fast"),e.div_dropabled_file.fadeOut(300),e.edt_files.hide("fast"),e.edt_files.fadeOut(300),setTimeout(function(){e.listar_files()},900))})})},o=!1,n=a.dataTransfer.items.length;$(a.dataTransfer.items).each(function(a,i){var l=i.webkitGetAsEntry();l.isDirectory?(o=!0,t(l)):l.isFile&&l.file(function(t){t.elem_key_parent=null,e.arr_file.push(t);var i=parseInt(a,10)+1;!1===o&&i==n&&($(e.div_dropabled_file).hide("fast"),e.div_dropabled_file.fadeOut(300),e.edt_files.hide("fast"),e.edt_files.fadeOut(300),setTimeout(function(){e.listar_files()},900))})})}},this.close=function(){void 0!==e.onclose&&e.onclose&&e.onclose(),e.arr_arquivos_id.length>0&&WS.post("documento/exclui_arquivo_upload",{arr_arquivos_id:JSON.stringify(e.arr_arquivos_id)},function(a){})},this.unload=function(){e.close(),View.unload(this.html_id)},this.valida_data_vigencia=function(){for(var a=$('input[template-field="data_vigencia"]'),e=!1,t=(new Date).toISOString().substr(0,10),o=0;o<a.length;o++){var n=a[o],i=get_datepicker($(n));if(""!==i&&null!==i&&i.length>0&&i<t){e=!0;break}}return!e||(alertaPopUp("Atenção","Há um ou mais documentos com data de vigência expirada!",null,null,null,null,null,150),!1)},App.is_nativo()||(document.addEventListener("dragleave",e.upload_drag_drop,!1),document.addEventListener("dragover",e.upload_drag_drop,!1),e.div_dropabled_file2.addEventListener("drop",e.upload_drag_drop,!1)),this.edt_files.unbind("change"),this.edt_files.change(function(){var a=$(this).get(0).files;a.length>0&&(e.div_dropabled_file.hide("fast"),e.div_dropabled_file.fadeOut(300),e.edt_files.hide("fast"),e.edt_files.fadeOut(300),e.arr_file=[],e.arr_file=a,setTimeout(function(){e.listar_files()},900))}),this.cbo_opcao_cadastro.unbind("change"),this.cbo_opcao_cadastro.change(function(a){1==this.value?e.div_esconder.removeClass("hidden"):e.div_esconder.addClass("hidden")}),this.cbo_assunto_documento_principal.unbind("change"),this.cbo_assunto_documento_principal.change(function(a){$('[template-field="cbo_assunto"]').val(this.value).trigger("change")}),this.cbo_tipo_documento_principal.unbind("change"),this.cbo_tipo_documento_principal.change(function(a){$('[template-field="cbo_tipo_documento"]').val(this.value).trigger("change")}),this.cbo_local_armazenamento_principal.unbind("change"),this.cbo_local_armazenamento_principal.change(function(a){$('[template-field="cbo_local_armazenamento"]').val(this.value).trigger("change")}),this.edt_data_vigencia_principal.on("change",function(a){var e=get_datepicker($(this));set_datepicker($('input[template-field="data_vigencia"]'),e),$('input[template-field="data_vigencia"]').trigger("change")}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){WS.post("documento/exclui_arquivo_upload",{arr_arquivos_id:JSON.stringify(e.arr_arquivos_id)},function(a){e.unload()},[e.btn_confirmar,e.btn_cancelar,e.dialog.find('[template-button="btn_excluir"]'),$('[aba-id-md5="'+e.html_id+'"]').find(".btn_fechar")])}),this.btn_confirmar.unbind("click"),this.btn_confirmar.click(function(){e.valida_data_vigencia()&&(e.arr_todos_files.forEach(function(a,t){e.arr_todos_files[t].nome_original=a.arquivo.name}),e.uploads_realizados?WS.post("documento/salvar_massa",{arr_names:e.arr_names,array_documentos:JSON.stringify(e.arr_todos_files),arr_pastas:JSON.stringify(e.arr_path)},function(a){alert_saved("Documentos salvos com sucesso"),e.tela_upload.unload(),e.unload()},[e.btn_confirmar,e.btn_cancelar,e.dialog.find('[template-button="btn_excluir"]'),$('[aba-id-md5="'+e.html_id+'"]').find(".btn_fechar")]):alertaPopUp("Atenção","Aguarde! Os arquivos ainda estão sendo enviados, você pode acompanhar o envio na aba 'Uploads Pendentes'",null,null,null,null,null,150))})}});