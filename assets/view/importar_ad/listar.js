define([],function(){return function(a){"use strict";var i=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Importação de Usuários",this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.tipo=null,this.onsave=null,this.onclose=null,this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_configuracoes=this.dialog.find(".btn_configuracoes"),this.btn_importar=this.dialog.find(".btn_importar"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.btn_trocar_servidor=this.dialog.find(".btn_trocar_servidor"),this.cbo_area=this.dialog.find(".cbo_area"),this.cbo_calendario_trabalho=this.dialog.find(".cbo_calendario_trabalho"),this.btn_area_novo=this.dialog.find(".btn_area_novo"),this.btn_calendario_trabalho_novo=this.dialog.find(".btn_calendario_trabalho_novo"),this.cbo_usuario_bp=this.dialog.find(".cbo_usuario_bp"),this.btn_remover=this.dialog.find(".btn_remover"),this.cbo_usuarios=this.dialog.find(".cbo_usuarios"),this.div_usuarios=this.dialog.find(".div_usuarios"),this.cbo_grupo_usuarios=this.dialog.find(".cbo_grupo_usuarios"),this.div_grupo_usuarios=this.dialog.find(".div_grupo_usuarios"),this.nome_usuario=null,this.email=null,this.tipo_usuario="",this.admin=null,this.usuario_id=null,this.bloqueado="N",this.arr_usuarios=[],this.limite=0,this.pode_buscar=!0,this.auxiliar=!1,this.lista_usuarios_ldap=null,this.login_ldap=null,this.senha_ldap=null,this.servidor_ldap_id=null,this.qtde_importacao=0,this.qtde_processadas=0,this.main_progress_bar=null,this.percentual_progresso=0,this.configuracoes_area_id=null,this.configuracoes_calendario_trabalho_id=null,this.configuracoes_nivel=null,this.configuracoes_permissoes=null,this.configuracoes_empresas=null,this.cbo_usuarios_selecionados=null,this.cbo_grupo_usuarios_selecionados=null,this.show=function(){i.listar_usuarios(),i.listar_grupo_usuarios(),i.btn_importar.removeClass("hidden"),i.btn_refresh.removeClass("hidden"),i.btn_trocar_servidor.removeClass("hidden"),i.btn_configuracoes.removeClass("hidden"),i.div_usuarios.removeClass("hidden"),i.div_grupo_usuarios.removeClass("hidden")},this.listar=function(){var a=i.tab_listagem.find("tbody"),o=a.find("tr:first");i.tab_listagem.find("tr:gt(1)").remove();var r=function(r){var s=o.clone();s.removeAttr("template-row"),s.css("display",""),$(s.find("[template-field='nome']")).text(r.nome),$(s.find("[template-field='usuario_ad']")).text(r.usuario);var e=$(s.find("[template-field='email']"));r.email?e.text(r.email):e.text(""),$(s.find(".edt_nivel")).val(i.configuracoes_nivel?i.configuracoes_nivel:10);var t=$(s.find(".btn_area_novo"));t.unbind("click"),t.click(function(){View.load("area/detalhes",function(a,o){o.onclose=function(){o.area_id&&i.listar_areas(o.area_id)},o.show(null,FORMULARIO.NOVO)})}),$(s.find(".cbo_area")).val(i.configuracoes_area_id?i.configuracoes_area_id:"");var n=$(s.find(".btn_calendario_trabalho_novo"));n.unbind("click"),n.click(function(){View.load("calendario_trabalho/detalhes",function(a,o){o.onclose=function(){o.calendario_trabalho_id&&i.listar_calendario_trabalho(o.calendario_trabalho_id)},o.show(null,FORMULARIO.NOVO)})}),$(s.find(".cbo_calendario_trabalho")).val(i.configuracoes_calendario_trabalho_id?i.configuracoes_calendario_trabalho_id:"");var l=$(s.find(".cbo_usuario_bp")),_=$(s.find(".btn_remover"));_.unbind("click"),_.click(function(){$(this).parent().parent().parent().remove()}),create_combobox(l,function(a){var i=l.parent().find(".edt_combobox"),o=new Object;o.nome=i.val(),o.limite=50,WS.get("usuario/listar_usuarios/",o,function(i){limpar_combobox(l),$(i).each(function(a,i){var o=[];o.Nome=i.nome;var r=$('<span class="label lb_tipo" style="margin: 5px;"></span>');r.addClass("label-info"),r.text("U"),r.tooltip(),add_option_combobox(l,a,i.id>0?i.id:null,o,r,JSON.stringify(i))}),i.length>0&&a(!0)})}),s.appendTo(a)};if(i.lista_usuarios_ldap)for(var s=0,e=i.lista_usuarios_ldap.usuarios.length;s<e;s++){var t=!1;if(i.cbo_usuarios_selecionados&&i.cbo_usuarios_selecionados.indexOf(String(i.lista_usuarios_ldap.usuarios[s].id_usuario))>-1&&(r(i.lista_usuarios_ldap.usuarios[s]),t=!0),i.cbo_grupo_usuarios_selecionados&&!t)for(var n=0,l=i.lista_usuarios_ldap.usuarios[s].grupos_usuario.length;n<l;n++)i.cbo_grupo_usuarios_selecionados.indexOf(String(i.lista_usuarios_ldap.usuarios[s].grupos_usuario[n].grupo_id))>-1&&!t&&(r(i.lista_usuarios_ldap.usuarios[s]),t=!0)}},this.listar_usuarios=function(){if(i.cbo_usuarios.children().remove(),i.lista_usuarios_ldap)for(var a=0;a<i.lista_usuarios_ldap.usuarios.length;a++){var o=i.lista_usuarios_ldap.usuarios[a];add_option(i.cbo_usuarios,o.id_usuario,o.nome)}i.cbo_usuarios.selectpicker({countSelectedText:function(a,i){return a+" usuários selecionados"}}),i.cbo_usuarios.selectpicker("refresh")},this.listar_grupo_usuarios=function(){i.cbo_grupo_usuarios.children().remove();for(var a=0;a<i.lista_usuarios_ldap.grupos.length;a++){var o=i.lista_usuarios_ldap.grupos[a];add_option(i.cbo_grupo_usuarios,o.grupo_id,o.grupo_nome)}i.cbo_grupo_usuarios.selectpicker({countSelectedText:function(a,i){return a+" grupos selecionados"}}),i.cbo_grupo_usuarios.selectpicker("refresh")},this.logar_ldap=function(){View.load("servidor_ldap/login",function(a,o){o.show(i,!1),o.onclose=function(){i.servidor_ldap_id||i.unload()}})},this.listar_areas=function(a){i.cbo_area.find("option").remove(),add_option(i.cbo_area,"","Nenhum"),WS.get("area/listar/",null,function(o){for(var r=0;r<o.data.length;r++){var s=o.data[r];add_option(i.cbo_area,s.id,s.nome)}a&&i.cbo_area.val(a).trigger("change"),i.listar_calendario_trabalho()})},this.listar_calendario_trabalho=function(a){i.cbo_calendario_trabalho.find("option").remove(),add_option(i.cbo_calendario_trabalho,"","Nenhum"),WS.get("calendario_trabalho/listar/",null,function(o){for(var r=0;r<o.length;r++){var s=o[r];add_option(i.cbo_calendario_trabalho,s.calendario_trabalho_id,s.nome)}a&&i.cbo_calendario_trabalho.val(a).trigger("change"),i.logar_ldap()})},this.atualizar_perfil=function(){i.qtde=i.tab_listagem.find(".linha_importacao").length;for(var a=1;a<i.qtde;a++){var o=i.tab_listagem.find(".linha_importacao")[a];$(o).find(".edt_nivel").val(i.configuracoes_nivel).trigger("blur"),$(o).find(".cbo_area").val(i.configuracoes_area_id).trigger("blur"),$(o).find(".cbo_calendario_trabalho").val(i.configuracoes_calendario_trabalho_id).trigger("blur")}},this.validar_importacao=function(){alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !','<div class="alert alert-info" style="text-align: center"> <span href="#" class="alert-link"><strong>Com está ação caso você vincule usuários do Next BPMS com usuários do LDAP o usuário irá logar somente com usuário do LDAP<br /> Não é possivel reverter está ação, Deseja continuar ?</strong></span></div>','<i class="fa fa-check-square" aria-hidden="true"></i> Sim',function(){View.load("importar_ad/importacao",function(a,o){i.main_progress_bar=o.show(),i.main_progress_bar.show_progress_bar(),i.qtde_processadas=0,i.percentual_progresso=Number((i.qtde_processadas/(i.qtde_importacao-1)*100).toFixed(2)),i.main_progress_bar.barra_progresso.css("width",i.percentual_progresso+"%"),i.main_progress_bar.barra_progresso.html(i.percentual_progresso+"%"),i.main_progress_bar.painel_importacao_log.html("");for(var r=1;r<i.qtde_importacao;r++){var s=i.tab_listagem.find(".linha_importacao")[r],e=$(s).find(".nome").text(),t=$(s).find(".usuario_ad").text(),n=$(s).find(".email").text(),l=$(s).find(".cbo_area").val(),_=$(s).find(".cbo_calendario_trabalho").val(),u=!!$(s).find(".cbo_usuario_bp").parent().find("[selected-value]").attr("dados-adicionais"),d="";u&&(d=JSON.parse($(s).find(".cbo_usuario_bp").parent().find("[selected-value]").attr("dados-adicionais"))),WS.post("usuario/importar_usuarios_ad/",{nome:e,ldap_login:t,email:n,area_id:l,calendario_trabalho_id:_,vinculo_usuario_bp:u,usuario_bp:d,usuario_empresa:i.configuracoes_empresas,servidor_ldap_id:i.servidor_ldap_id,permissoes:JSON.stringify(i.configuracoes_permissoes),nivel:i.configuracoes_nivel},function(a){i.qtde_processadas++,i.percentual_progresso=Number((i.qtde_processadas/(i.qtde_importacao-1)*100).toFixed(2)),i.main_progress_bar.barra_progresso.css("width",i.percentual_progresso+"%"),i.main_progress_bar.barra_progresso.html(i.percentual_progresso+"%"),i.main_progress_bar.painel_importacao_log.append(a+"\n"),i.main_progress_bar.painel_importacao_log[0].scrollTop=i.main_progress_bar.painel_importacao_log[0].scrollHeight})}})},!0,'<i class="fa fa-undo" aria-hidden="true"></i> Não')},this.listar_usuarios_ldap=function(){WS.get("servidor_ldap/listar_usuarios/",{login_ldap:i.login_ldap,senha_ldap:i.senha_ldap,servidor_ldap:i.servidor_ldap_id},function(a){i.lista_usuarios_ldap=a})},this.btn_configuracoes.unbind("click"),this.btn_configuracoes.click(function(){View.load("importar_ad/configuracoes",function(a,o){o.show(i)})}),this.btn_importar.unbind("click").click(function(){var a=validateForm();i.qtde_importacao=i.tab_listagem.find(".linha_importacao").length,a?alert_fail("Preencha os campos obrigatórios"):i.configuracoes_empresas?i.qtde_importacao-1?i.validar_importacao():alert_fail("Não existem usuários para realizar a importação"):alert_fail("Informe ao menos uma empresa antes de continuar")}),this.btn_refresh.unbind("click").click(function(){i.listar_usuarios_ldap(),i.listar_usuarios(),i.listar_grupo_usuarios(),i.cbo_grupo_usuarios.trigger("change"),i.cbo_usuarios.trigger("change")}),this.btn_trocar_servidor.unbind("click").click(function(){i.logar_ldap(),i.cbo_grupo_usuarios.trigger("change"),i.cbo_usuarios.trigger("change")}),this.cbo_usuarios.change(function(a){var o=$(this);i.cbo_usuarios_selecionados=""!=o.val()?o.val():null,i.listar()}),this.cbo_grupo_usuarios.change(function(a){var o=$(this);i.cbo_grupo_usuarios_selecionados=""!=o.val()?o.val():null,i.listar()}),this.unload=function(){View.unload(this.html_id)},i.listar_areas()}});