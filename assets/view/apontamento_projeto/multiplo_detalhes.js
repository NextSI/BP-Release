define(["react","react-dom","./../componentes_react/CboClientes","./../atividade_projeto/ListarAtividadeProjeto"],function(a,t,e,o){return function(i){"use strict";var n=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Apontamento Atividade",this.onclose=null,$(this.dialog).attr("viewcode",TELAS.APONTAMENTO_PROJETO_MULTIPLO.codigo),this.cbo_consultor=this.dialog.find(".cbo_consultor"),this.div_cbo_consultor=this.dialog.find(".div_cbo_consultor"),this.div_todas_atividades=this.dialog.find(".div_todas_atividades"),this.btn_add_atividade=this.dialog.find(".btn_add_atividade"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.ListarAtividadeProjeto=a.createElement(o,null,null),this.usuario_id=null,this.qtde_atividades=null,this.atividades=null,this.aux=null,this.atividade=null,this.qtde_atv_filhos=null,this.data_fechamento=null,this.show=function(){WS.get("apontamento_projeto/get_parametros/",null,function(a){n.data_fechamento=a.apontamento_data_fechamento}),App.sessao.dados.admin?(n.div_cbo_consultor.removeClass("hidden"),n.listar_consultor(App.sessao.dados.usuario_id)):n.cbo_consultor.prop("disabled",!0),n.adiciona_atividade()},this.listar_consultor=function(a){n.cbo_consultor.find("option").remove(),add_option(n.cbo_consultor,"","-- Selecione --"),WS.get("usuario/listar/",null,function(t){for(var e=0;e<t.length;e++){var o=t[e];add_option(n.cbo_consultor,o.usuario_id,o.nome)}a&&(n.cbo_consultor.val(a).trigger("change"),n.usuario_id=a),n.cbo_consultor.selectpicker("refresh")})},this.incAnexo=function(a,t,e){var o=a.clone();e=1+e,o.find(".anexo_base_label").text("Anexo #"+e);var i=o.find(".checkbox");i.attr("type","checkbox"),i.bootstrapSwitch(!0),o.addClass("anexo_atividade"),o.removeClass("hidden"),o.appendTo(t),o.find('input[type="file"]').trigger("click")},this.adiciona_atividade=function(){var o=n.dialog.find("[template-row='atividade']").clone();o.addClass("div_atividades"),o.removeAttr("template-row"),o.css("display","");var i=$(o).find("[template-field='div_componente_cbo_clientes']"),d=a.createElement(e,{initial_values:{placeholder:"Pesquisar por nome/cnpj"}},null);t.render(d,i[0]),d.props.setConfiguracoes={main_externo:n,exibe_tipo_entidade:!0,placeholder:"Filtro por Cliente",WS_params:{desconsiderar_empresa:!0,desconsiderar_prospect:!0,desconsiderar_fornecedor:!0,cliente_vinculado_projeto:!0,limite:0}},d.props.setFunctionSelect(function(){var a,t,e,o;i.attr("id",d.props.ClienteSelecionado.id),setTimeout(function(){set_value_combobox(r,null,""),c([])}),a=!parseInt(d.props.ClienteSelecionado.id),t=r.parent(),e=t.find(".edt_combobox"),o=t.find("button"),e.attr("disabled",a),e.attr("readonly",a),o.attr("disabled",a)});var r=$(o).find("[template-field='cbo_filtro_projeto']");r.prop("disabled",!0),create_combobox(r,function(a){var t=r.parent().find(".edt_combobox");n.cbo_filtro_projeto=r,WS.get("projeto/get_projeto/",{projeto_nome:t.val(),cliente_id:i.prop("id"),usuario_id:n.usuario_id,apontamento_projeto:!0,limite:50},function(t){if(limpar_combobox(n.cbo_filtro_projeto),t.lista.length){for(var e=0;e<t.lista.length;e++){var o=t.lista[e],i=[],d=$('<span class="label lb_situacao" style="margin: 5px;"></span>');i.Nome=o.nome,o.status==PROJETO_STATUS.CONCLUIDO?(d.addClass("label-success"),d.attr("title","Concluído"),d.text("Concluído")):o.status==PROJETO_STATUS.NAO_INICIADO?(d.addClass("label-warning"),d.attr("title","Não Iniciado"),d.text("Não Iniciado")):o.status==PROJETO_STATUS.ANDAMENTO&&(d.addClass("label-info"),d.attr("title","Andamento"),d.text("Andamento")),add_option_combobox(n.cbo_filtro_projeto,e,o.id>0?o.id:null,i,d,JSON.stringify(o))}a(!0)}$(n.cbo_filtro_projeto.parent()).find(".ul_row").click(function(){var a=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;l(a,t.permitir_apontamento_projeto_concluido)}),n.cbo_filtro_projeto.parent().find(".edt_combobox").one("keypress",function(a){if(13==a.keyCode){var e=$(this).attr("dados-adicionais")?JSON.parse($(this).attr("dados-adicionais")):null;l(e,t.permitir_apontamento_projeto_concluido)}})}),t.keyup(function(a){$(this).val()||l({})})});var l=function(a,t){var e=new Validation;if("S"!=t&&a.projeto_status_id==PROJETO_STATUS.CONCLUIDO)return setTimeout(function(){set_value_combobox(n.cbo_filtro_projeto,null,"")}),n.projeto_id=null,e.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Você não pode realizar apontamentos em projetos concluídos.")),alert_modal("Validação",e),!1;a.id?WS.get({route:"atividade_projeto/listar/",data:{projeto_id:a.id},func_response:function(a){a.atividades.push({atividade_simplificada:a.projeto.nome,id:"raiz",projeto_atividade_sintetica_pai_id:null,tipo_atividade:"P",marco:!1,horas_previstas:"000:00"}),x(),c(a)},html_id:n.html_id}):c([])},s=$(o).find("[template-field='porcentagem_atividade']");s.addClass("porcentagem_atividade"),s.unbind("change").change(function(){$(this).val($(this).val()>100?100:$(this).val()<0?0:$(this).val())});var c=function(a){var e=$(o).find("[template-field='div_componente_atividades']");t.render(n.ListarAtividadeProjeto,e[0]),n.ListarAtividadeProjeto.props.setParams({div:e,html_id:n.html_id,div_porcentagem:s,data:a,dialog:n.dialog,parametro_usuario:"apontamento_projeto",dropdown:!0,somente_leitura:!0})};c([]);var u=function(){var a=C.getVisibleRows().map(function(a){return{dia:C.cellValue(a.rowIndex,"dia")||null,inicio:C.cellValue(a.rowIndex,"inicio")?formatDateTime(C.cellValue(a.rowIndex,"inicio")).substr(-5):null,fim:C.cellValue(a.rowIndex,"fim")?formatDateTime(C.cellValue(a.rowIndex,"fim")).substr(-5):null,ini_intervalo:C.cellValue(a.rowIndex,"ini_intervalo")?formatDateTime(C.cellValue(a.rowIndex,"ini_intervalo")).substr(-5):null,fim_intervalo:C.cellValue(a.rowIndex,"fim_intervalo")?formatDateTime(C.cellValue(a.rowIndex,"fim_intervalo")).substr(-5):null,subtotal:C.cellValue(a.rowIndex,"subtotal")||null,translado:C.cellValue(a.rowIndex,"translado")?formatDateTime(C.cellValue(a.rowIndex,"translado")).substr(-5):null,total:C.cellValue(a.rowIndex,"total")||null,descricao:C.cellValue(a.rowIndex,"descricao")||null,apontar_despesa:C.cellValue(a.rowIndex,"apontar_despesa")||null,km_rodado:C.cellValue(a.rowIndex,"km_rodado")||null,pedagio:C.cellValue(a.rowIndex,"pedagio")||null,refeicao:C.cellValue(a.rowIndex,"refeicao")||null,outras_despesas:C.cellValue(a.rowIndex,"outras_despesas")||null,despesa_descricao:C.cellValue(a.rowIndex,"despesa_descricao")||null,despesa_observacoes:C.cellValue(a.rowIndex,"despesa_observacoes")||null}});C._$element.prop("id",JSON.stringify(a))},_=$(o).find("[template-field='div_componente_apontamentos']"),p=document.createElement("div");p.className="div_componente_apontamentos",p.style="min-width: 100%;",_.find(".div_componente_apontamentos").remove(),_[0].appendChild(p);var m=get_icon_class(),f=[],v=0,b=[],h=function(a){var t=a.inicio&&a.fim?subtrair_horas(formatDateTime(a.fim).substr(-5),formatDateTime(a.inicio).substr(-5)):"00:00",e=a.ini_intervalo&&a.fim_intervalo?subtrair_horas(formatDateTime(a.fim_intervalo).substr(-5),formatDateTime(a.ini_intervalo).substr(-5)):"00:00";return subtrair_horas(t,e).substr(0,5)},g=function(a){var t=a.inicio&&a.fim?subtrair_horas(formatDateTime(a.fim).substr(-5),formatDateTime(a.inicio).substr(-5)):"00:00",e=a.ini_intervalo&&a.fim_intervalo?subtrair_horas(formatDateTime(a.fim_intervalo).substr(-5),formatDateTime(a.ini_intervalo).substr(-5)):"00:00",o=subtrair_horas(t,e),i=a.translado||"00:00";return somar_horas(o,i).substr(0,5)},w=r.parent().find(".edt_combobox"),x=function(){var a=w.attr("dados-adicionais")?JSON.parse(r.parent().find(".edt_combobox").attr("dados-adicionais")):null;if(a){for(var t=C.totalCount(),e="S"===a.sugerir_despesas_no_apontamento_atividades||!0===a.sugerir_despesas_no_apontamento_atividades,o=0;o<t;o++)C.cellValue(o,"apontar_despesa",e),C.cellValue(o,"translado",a.traslado_padrao),C.cellValue(o,"km_rodado",a.quantidade_km_padrao),C.cellValue(o,"pedagio",a.valor_pedagio),C.cellValue(o,"refeicao",a.valor_refeicao),C.cellValue(o,"outras_despesas",a.outras_despesas);var i="S"===a.permite_alterar_padrao_apontamento||!0===a.permite_alterar_padrao_apontamento;C.columnOption("km_rodado","allowEditing",i),C.columnOption("pedagio","allowEditing",i),C.columnOption("refeicao","allowEditing",i),C.columnOption("outras_despesas","allowEditing",i)}},C=_.find(".div_componente_apontamentos").dxDataGrid({dataSource:f,keyExpr:"ID",showBorders:!0,allowColumnResizing:!0,columnResizingMode:"widget",rowAlternationEnabled:!1,paging:{enabled:!1},stateStoring:{enabled:!0,type:"custom",customLoad:function(){return App.get_parametro_usuario("apontamento_projeto_multiplo")},customSave:function(a){App.set_parametro_usuario("apontamento_projeto_multiplo",a)}},focusedRowEnabled:!1,editing:{mode:"cell",allowUpdating:!0,allowDeleting:!0,allowAdding:!0,useIcons:!0},columns:[{dataField:"dia",dataType:"date",format:"dd/MM/yyyy",width:140,calculateCellValue:function(a){return a.dia||new Date}},{dataField:"inicio",caption:"Início",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"fim",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"ini_intervalo",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"fim_intervalo",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"subtotal",width:120,calculateCellValue:function(a){return h(a)}},{dataField:"translado",width:60,dataType:"string"},{dataField:"total",width:120,calculateCellValue:function(a){return g(a)}},{dataField:"descricao",caption:"Descrição",width:160},dx_Apontar_Despesa(),dx_KM_Rodado_Col(),dx_Pedagio_Col(),dx_Refeicao_Col(),dx_Outras_Despesas_Col(),dx_Descricao_da_Despesa_Col(),dx_Despesa_Observacao_Col(),{type:"buttons",fixed:!0,buttons:[{hint:"Duplicar registro",icon:"repeat",cssClass:m,onClick:function(a){var t=$.extend({},a.row.data,{ID:++v});f.splice(a.row.rowIndex,0,t),a.component.refresh(!0),a.event.preventDefault(),setTimeout(function(){u()})}},{hint:"Apagar registro",icon:"fa fa-trash",cssClass:m,onClick:function(a){C.deleteRow(a.row.rowIndex)}}]}],onInitNewRow:function(a){a.data={translado:"",apontar_despesa:!1,km_rodado:0,pedagio:0,refeicao:0,outras_despesas:0,despesa_descricao:"",despesa_observacoes:""};var t=w.attr("dados-adicionais")?JSON.parse(r.parent().find(".edt_combobox").attr("dados-adicionais")):null;if(t){"S"!==t.sugerir_despesas_no_apontamento_atividades&&!0!==t.sugerir_despesas_no_apontamento_atividades||(a.data.apontar_despesa=!0),a.data.translado=t.traslado_padrao,a.data.km_rodado=t.quantidade_km_padrao,a.data.pedagio=t.valor_pedagio,a.data.refeicao=t.tipo_valor_padrao_refeicao==TIPO_VALOR_REFEICAO.TECNICO?parseFloat(t.tecnico_valor_refeicao):parseFloat(t.valor_refeicao),a.data.outras_despesas=t.outras_despesas;var e="S"===t.permite_alterar_padrao_apontamento||!0===t.permite_alterar_padrao_apontamento;a.component.columnOption("km_rodado","allowEditing",e),a.component.columnOption("pedagio","allowEditing",e),a.component.columnOption("refeicao","allowEditing",e),a.component.columnOption("outras_despesas","allowEditing",e)}},onRowPrepared:function(a){"data"==a.rowType&&a.data.dia&&(formatDate(a.data.dia,!0)<=n.data_fechamento?App.verifica_permissao(App.temp.empresa,"apontamento_projetos_fechado")?a.rowElement.addClass("bg-warning"):a.rowElement.addClass("bg-danger"):a.rowElement.removeClass("bg-warning bg-danger"))},onCellPrepared:function(a){"data"===a.rowType&&$.inArray(a.rowIndex+":"+a.columnIndex,b)>=0&&a.cellElement.css("background-color","#BDBDBD")},onEditorPreparing:function(a){if("dataRow"===a.parentType){var t=a.editorOptions.onValueChanged;a.editorOptions.onValueChanged=function(a){t.apply(this,arguments);for(var e=0;e<b.length;e++){var o=Number(b[e].split(":")[0]),i=Number(b[e].split(":")[1]);C.cellValue(o,i,a.value),C.getCellElement(o,i).css("background-color","")}b=[]}}"dataRow"!=a.parentType||"subtotal"!=a.dataField&&"total"!=a.dataField||(a.editorOptions.disabled=!0)},onEditorPrepared:function(a){"translado"==a.dataField||"total"==a.dataField?a.editorElement.find("input").last().mask("99:99"):"dia"==a.dataField&&a.editorElement.find("input").last().mask("99/99/9999")},onCellClick:function(a){a.event.ctrlKey?b.push(a.rowIndex+":"+a.columnIndex):b.length&&(b=[],a.component.repaint())},summary:{totalItems:[{name:"subtotal",showInColumn:"subtotal",displayFormat:"Soma: {0}",summaryType:"custom"},{name:"total",showInColumn:"total",displayFormat:"Soma: {0}",summaryType:"custom"}],calculateCustomSummary:function(a){"subtotal"===a.name?"start"===a.summaryProcess?a.totalValue=0:"calculate"===a.summaryProcess&&(a.totalValue=somar_horas(a.totalValue,h(a.value).substr(0,5))):"total"===a.name&&("start"===a.summaryProcess?a.totalValue=0:"calculate"===a.summaryProcess&&(a.totalValue=somar_horas(a.totalValue,g(a.value).substr(0,5))))}},onRowInserted:function(a){u()},onRowUpdated:function(a){u()},onRowRemoved:function(a){u()}}).dxDataGrid("instance"),y=$(o).find(".btn_exclui_atividade");y.unbind("click"),y.click(function(){o.remove()}),o.appendTo(n.div_todas_atividades)},this.close=function(){void 0!==n.onclose&&n.onclose&&n.onclose()},this.unload=function(){n.close(),View.unload(this.html_id)},this.cbo_consultor.unbind("change"),this.cbo_consultor.change(function(){n.usuario_id=n.cbo_consultor.val()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){n.unload()}),this.btn_add_atividade.unbind("click"),this.btn_add_atividade.click(function(){n.adiciona_atividade()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var a=[],t=n.dialog.find(".div_atividades");$(t).each(function(t,e){var o={};o.cliente_id=$(e).find(".div_componente_cbo_clientes").attr("id"),o.projeto_id=$(e).find(".projeto_id").parent().find("input").attr("selected-value"),o.atividade_projeto_id=$(e).find(".div_listagem_atividade_projeto").attr("id"),o.porcentagem_atividade=$(e).find(".porcentagem_atividade").val(),o.apontamentos=$(e).find(".div_componente_apontamentos").attr("id"),a.push(o)});var e={usuario_id:n.cbo_consultor.val(),arr_atividades:JSON.stringify(a)};WS.post("apontamento_projeto/salvar_multiplos",e,function(a){n.apontamento_id=a.id,alert_saved("Apontamento salvo com sucesso"),n.unload()})})}});