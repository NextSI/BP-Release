define([],function(){return function(a){"use strict";var e=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.onclose=null,this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.edt_descricao=this.dialog.find(".edt_descricao"),this.edt_observacoes=this.dialog.find(".edt_observacoes"),this.cbo_tipo_agenda=this.dialog.find(".cbo_tipo_agenda"),this.edt_tipo_agenda=null,this.edt_data=this.dialog.find(".edt_data"),this.edt_hora=this.dialog.find(".edt_hora"),this.edt_duracao=this.dialog.find(".edt_duracao"),this.chk_realizado=this.dialog.find(".chk_realizado"),this.chk_exibir=this.dialog.find(".chk_exibir"),this.chk_notificar_envolvidos=this.dialog.find(".chk_notificar_envolvidos"),this.tab_convidados=this.dialog.find(".tab_convidados"),this.edt_descricao_oportunidade=this.dialog.find(".edt_descricao_oportunidade"),this.lbl_tab_convidados=this.dialog.find(".lbl_tab_convidados"),this.lbl_tab_geral=this.dialog.find(".lbl_tab_geral"),this.edt_translado=this.dialog.find(".edt_translado"),this.div_translado=this.dialog.find(".div_translado"),this.grid_emails_acompanhamento=this.dialog.find(".grid_emails_acompanhamento"),this.oportunidade_agenda_id=null,this.representante_usuario_id=null,this.oportunidade_id=null,this.dropdown_tipo_agenda=null,this.tipo=null,this.convidado_evento=null,this.emails_acompanhamento=null,this.flag_permite_alterar=!1,this.arr_convidados=[],this.show=function(a,i,o,d,t,r){create_combobox(e.cbo_tipo_agenda,e.listar_tipo_agenda);var n=e.cbo_tipo_agenda.parent();switch(e.edt_tipo_agenda=n.find(".edt_combobox"),e.dropdown_tipo_agenda=n.find(".btn_combobox"),e.edt_observacoes.attr("id","edt_observacoes"+e.html_id),set_datepicker(e.edt_data),e.representante_usuario_id=o,e.oportunidade_id=d,e.edt_descricao_oportunidade.val(t),e.tipo=i,e.convidado_evento=r,i){case FORMULARIO.NOVO:e.chk_notificar_envolvidos.prop("checked",!0).trigger("change"),e.btn_salvar.show(),e.btn_excluir.hide(),e.permite_alterar(!0);break;case FORMULARIO.EDITAR:e.chk_notificar_envolvidos.prop("checked",!0).trigger("change"),e.btn_salvar.show(),e.btn_excluir.hide(),e.permite_alterar(!0,r);break;case FORMULARIO.VISUALIZAR:e.chk_notificar_envolvidos.prop("disabled",!0),e.btn_salvar.hide(),e.btn_excluir.hide(),e.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:e.chk_notificar_envolvidos.prop("disabled",!0).prop("checked",!0).trigger("change"),e.btn_salvar.hide(),e.btn_excluir.show(),e.permite_alterar(!1)}if(void 0!==a&&a)e.oportunidade_agenda_id=a,e.preencher();else{e.edt_hora.val("08:00"),e.edt_duracao.val("18:00");const a=formatDate(new Date,!0);set_datepicker(e.edt_data,a),set_tinymce(e.edt_observacoes,"",!1)}e.render_convidados(),e.preencher_emails_acompanhamento(),show_modal(e.modal.attr("id")),set_focus(e.edt_tipo_agenda)},this.close=function(){close_modal(e.modal.attr("id")),void 0!==e.onclose&&e.onclose&&e.onclose()},this.unload=function(){e.close(),View.unload(this.html_id)},this.permite_alterar=function(a,i){e.flag_permite_alterar=(void 0===i||!0!==i)&&a,App.sessao.dados.usuario_id!=e.representante_usuario_id&&1!=App.sessao.dados.admin||(e.flag_permite_alterar=a),e.edt_tipo_agenda.prop("readonly",!e.flag_permite_alterar),e.edt_descricao.prop("readonly",!e.flag_permite_alterar),e.dropdown_tipo_agenda.prop("disabled",!e.flag_permite_alterar),e.edt_data.prop("readonly",!e.flag_permite_alterar),e.edt_hora.prop("readonly",!e.flag_permite_alterar),e.edt_duracao.prop("readonly",!e.flag_permite_alterar),e.chk_notificar_envolvidos.prop("disabled",!e.flag_permite_alterar),e.chk_realizado.prop("disabled",!e.flag_permite_alterar),e.chk_exibir.prop("disabled",!e.flag_permite_alterar),e.flag_permite_alterar||e.btn_salvar.hide()},this.preencher=function(){WS.get("oportunidade_agenda/objeto/",{oportunidade_agenda_id:e.oportunidade_agenda_id},function(a){set_value_combobox(e.cbo_tipo_agenda,a.tipo_agenda_oportunidade_id,a.tipo_agenda_oportunidade_descricao),e.edt_descricao.val(a.descricao),set_tinymce(e.edt_observacoes,a.observacoes,!!e.convidado_evento||!e.flag_permite_alterar),set_datepicker(e.edt_data,a.data),e.edt_hora.val(a.hora),e.edt_duracao.val(a.duracao),e.edt_translado.val(a.translado),e.edt_descricao_oportunidade.val(a.oportunidade_descricao),"S"==a.atividade_realizada&&e.chk_realizado.prop("checked",!0).trigger("change"),"S"==a.exibir_agenda&&e.chk_exibir.prop("checked",!0).trigger("change"),"S"==a.exibir_translado&&e.div_translado.removeClass("hidden"),e.responsavel_nome=a.responsavel_nome,e.representante_usuario_id=a.representante_usuario_id},[e.btn_salvar,e.btn_excluir])},this.listar_tipo_agenda=function(a){var i=new Object;i.descricao=e.edt_tipo_agenda.val(),WS.get("tipo_agenda_oportunidade/listar/",i,function(i){limpar_combobox(e.cbo_tipo_agenda),$(i).each(function(a,i){var o=[];o.Nome=i.descricao,add_option_combobox(e.cbo_tipo_agenda,a,i.tipo_agenda_oportunidade_id,o,null,JSON.stringify(i))}),a(!0),$(e.cbo_tipo_agenda.parent()).find(".ul_row").click(function(){var a=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;null!=a&&("S"==a.exibir_agenda?e.chk_exibir.prop("checked",!0).trigger("change"):e.chk_exibir.prop("checked",!1).trigger("change")),"S"==a.exibir_translado?e.div_translado.removeClass("hidden"):e.div_translado.addClass("hidden")})})},this.render_convidados=function(){e.lbl_tab_convidados.removeClass("hidden");var a=e.tab_convidados.find("tbody"),i=a.find("tr:first");WS.get("oportunidade_agenda/listar_convidados/",{oportunidade_id:e.oportunidade_id,oportunidade_agenda_id:e.oportunidade_agenda_id},function(o){e.tab_convidados.find("tr:gt(1)").remove(),e.arr_convidados=o,$(e.arr_convidados).each(function(o,d){!function(o,d){var t=i.clone();t.removeAttr("template-row"),t.css("display",""),"S"==d.excluido&&$(t).addClass("hidden");var r=$(t.find(".carrega_img"));null!=d.logo_id?r.attr("src",WS_URI+"documento/midia/?documento_id="+d.logo_id+"&token_midia="+App.sessao.token_midia):r.attr("src","assets/img/imagem_usuario_padrao.svg"),$(t.find(".descricao")).text(d.nome);var n=$(t.find(".chk_convidado"));n.attr("type","checkbox"),n.addClass("checkbox_bootstrap_toggle"),n.prop("checked","S"==d.convidado),n.prop("disabled",!e.flag_permite_alterar),n.unbind("change"),n.change(function(){d.convidado=$(this).prop("checked")?"S":"N"}),t.appendTo(a)}(0,d)}),App.aplicar_checkbox(a)})},this.preencher_emails_acompanhamento=function(){WS.get("oportunidade_agenda/listar_emails_acompanhamento/",{oportunidade_agenda_id:e.oportunidade_agenda_id},function(a){e.gridEmailsAcompanhamento(a)})},this.gridEmailsAcompanhamento=function(a){var i=get_icon_class(),o=(e.tipo==FORMULARIO.NOVO||e.tipo==FORMULARIO.EDITAR)&&!e.convidado_evento;e.grid_emails_acompanhamento=e.grid_emails_acompanhamento.dxDataGrid({dataSource:a,showBorders:!0,paging:{enabled:!1},editing:{mode:"cell",allowUpdating:o,allowDeleting:o,allowAdding:o},columns:[{dataField:"email",caption:"E-mails adicionais para acompanhamento",dataType:"string",validationRules:[{type:"email"}],fixed:!0,fixedPosition:"left"},{type:"buttons",fixed:!0,fixedPosition:"right",buttons:[{hint:"Remover e-mail",icon:"fa fa-trash",cssClass:i,onClick:function(a){o&&e.grid_emails_acompanhamento.deleteRow(a.row.rowIndex)}}]}]}).dxDataGrid("instance")},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){e.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var a,i=function(){e.emails_acompanhamento=e.grid_emails_acompanhamento.getDataSource().store()._array.map(function(a){return a.email});var a={oportunidade_agenda_id:e.oportunidade_agenda_id,tipo_agenda_oportunidade_id:get_value_combobox(e.cbo_tipo_agenda),descricao:e.edt_descricao.val(),observacoes:get_tinymce(e.edt_observacoes),data:get_datepicker(e.edt_data),hora:e.edt_hora.val(),duracao:e.edt_duracao.val(),atividade_realizada:1==e.chk_realizado.prop("checked")?"S":"N",exibir_agenda:1==e.chk_exibir.prop("checked")?"S":"N",representante_usuario_id:e.representante_usuario_id,oportunidade_id:e.oportunidade_id,arr_convidados:JSON.stringify(e.arr_convidados.filter(a=>"S"==a.convidado).map(a=>+a.representante_usuario_id)),translado:e.edt_translado.val(),emails_acompanhamento:JSON.stringify(e.emails_acompanhamento),notificar_envolvidos:e.chk_notificar_envolvidos.prop("checked")};WS.post("oportunidade_agenda/salvar",a,function(a){e.oportunidade_agenda_id=a.id,alert_saved(a.descricao+" salvo com sucesso"),e.unload()},[e.btn_excluir,e.btn_salvar,e.btn_cancelar])};a={usuario_id:e.representante_usuario_id,dia:get_datepicker(e.edt_data),hora_inicio:e.edt_hora.val(),hora_fim:e.edt_duracao.val(),descricao:e.edt_descricao.val(),realizado:1==e.chk_realizado.prop("checked")?"S":"N",agenda_evento_id:null,arr_convidados:JSON.stringify(e.arr_convidados)},WS.post("agenda_evento/validar_evento_oportunidade/",a,function(a){if(a.representante||a.convidados.length)if(!1===e.chk_realizado.prop("checked")){var o="";if(a.representante&&a.convidados.length){App.sessao.dados.usuario_id==e.representante_usuario_id?o+=" Você e os usuários abaixo contêm evento para esta data e horário <br /><br />":o+=" O representante "+a.representante.nome+" e os usuários abaixo contêm evento para esta data e horário <br /><br />",a.convidados.length&&(o+="<ul>");for(var d=0;d<a.convidados.length;d++)o+="<li>"+a.convidados[d].nome+" </li>";a.convidados.length&&(o+="</ul>")}else if(a.representante)App.sessao.dados.usuario_id==e.representante_usuario_id?o+=" Você possui evento para esta data e horário":o+=" O representante "+a.representante.nome+" possui evento para esta data e horário ";else if(a.convidados.length){for(o+=" Os usuários abaixo contêm evento para esta data e horário <br /><br />",o+="<ul>",d=0;d<a.convidados.length;d++)o+="<li>"+a.convidados[d].nome+" </li>";o+="</ul>"}o+="<br /> Deseja prosseguir?",alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',o,App.lang.modal_validacao.sim,function(){i()},!0,App.lang.modal_validacao.nao,null,function(){e.btn_salvar.removeClass("disabled").removeAttr("disabled"),e.btn_cancelar.removeClass("disabled").removeAttr("disabled")})}else i();else i()},[e.btn_salvar,e.btn_excluir])})}});