define([],function(){return function(e){"use strict";var i=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onsave=null,this.tab_executores=this.dialog.find(".tab_executores"),this.cbo_executores=this.dialog.find(".cbo_executores"),this.cbo_responsavel=this.dialog.find(".cbo_responsavel"),this.edt_inicio=this.dialog.find(".edt_inicio"),this.edt_prazo=this.dialog.find(".edt_prazo"),this.div_datas=this.dialog.find(".div_datas"),this.div_recursos=this.dialog.find(".div_recursos"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.th_horas_previstas=this.dialog.find(".th_horas_previstas"),this.th_valor_hora=this.dialog.find(".th_valor_hora"),this.th_valor_total=this.dialog.find(".th_valor_total"),this.th_btn_excluir=this.dialog.find(".th_btn_excluir"),this.projeto_id=null,this.atividades_id=[],this.arr_executores=[],this.arr_grupo_executores=[],this.grupo_usuarios_equipe=[],this.equipe=[],this.executores_selecionados=[],this.grupo_usuarios_executores_selecionados=[],this.show=function(e,o,a,r,s,t,n){set_datepicker(i.edt_inicio),set_datepicker(i.edt_prazo),i.grupo_usuarios_equipe=s,i.equipe=r,i.executores_selecionados=t,i.grupo_usuarios_executores_selecionados=n;var u=Array.prototype.filter;for(var d in Array.prototype.filter=function(e){for(var i=0;i<this.length;i++)if(e==this[i].id)return!0;return!1},i.executores_selecionados)if("clean"!=d){var l=i.executores_selecionados[d];i.arr_executores.length>0?$(i.arr_executores).each(function(e,o){$(l).each(function(e,o){i.arr_executores.filter(o.id)||i.arr_executores.push(o)})}):i.arr_executores=l}for(var d in i.grupo_usuarios_executores_selecionados)"clean"!=d&&(n=i.grupo_usuarios_executores_selecionados[d],i.arr_grupo_executores.length>0?$(i.arr_grupo_executores).each(function(e,o){$(n).each(function(e,o){i.arr_grupo_executores.filter(o.id)||i.arr_grupo_executores.push(o)})}):i.arr_grupo_executores=n);for(var _ in i.render_executores(),"S"==a&&i.div_datas.hide(),i.equipe)if("clean"!=_){var c=i.equipe[_];c.usuario_id==App.sessao.dados.usuario_id&&!0!==App.sessao.dados.admin?(!0!==c.planejamento_atividade&&"S"!==c.planejamento_atividade||!0===App.sessao.dados.admin||i.th_horas_previstas.removeClass("hidden"),!0!==c.planejamento_financeiro&&"S"!==c.planejamento_financeiro||!0===App.sessao.dados.admin||(i.th_valor_hora.removeClass("hidden"),i.th_valor_total.removeClass("hidden")),!0!==c.planejamento_recursos&&"S"!==c.planejamento_recursos||!0===App.sessao.dados.admin||(i.div_recursos.removeClass("hidden"),i.th_btn_excluir.removeClass("hidden")),!0!==c.planejamento_datas&&"S"!==c.planejamento_datas||!0===App.sessao.dados.admin||i.div_datas.removeClass("hidden")):!0===App.sessao.dados.admin&&(i.div_datas.removeClass("hidden"),i.th_horas_previstas.removeClass("hidden"),i.th_valor_hora.removeClass("hidden"),i.th_valor_total.removeClass("hidden"),i.th_btn_excluir.removeClass("hidden"),i.div_recursos.removeClass("hidden"))}i.projeto_id=e,i.atividades_id=o,i.listar_responsavel(),create_combobox(i.cbo_executores,i.listar_executores),Array.prototype.filter=u,show_modal(i.modal.attr("id"))},this.listar_executores=function(e,o){var a=i.cbo_executores.parent(),r=a.find(".edt_combobox");if(null!=i.grupo_usuarios_equipe&&"undefined"!=i.grupo_usuarios_equipe&&i.grupo_usuarios_equipe.length>0||null!=i.equipe&&"undefined"!=i.equipe){var s=[];if(void 0!==r.val()&&""!=r.val()){if(null!=i.equipe&&"undefined"!=i.equipe)for(var t in i.equipe)"clean"!=t&&(n=i.equipe[t]).nome.toUpperCase().indexOf(r.val().toUpperCase())>-1&&s.push(n);null!=i.grupo_usuarios_equipe&&"undefined"!=i.grupo_usuarios_equipe&&i.grupo_usuarios_equipe.length>0&&$(i.grupo_usuarios_equipe).each(function(e,i){i.nome.toUpperCase().indexOf(r.val().toUpperCase())>-1&&s.push(i)})}else if(null!=i.grupo_usuarios_equipe&&"undefined"!=i.grupo_usuarios_equipe&&i.grupo_usuarios_equipe.length>0&&$(i.grupo_usuarios_equipe).each(function(e,i){s.push(i)}),null!=i.equipe&&"undefined"!=i.equipe)for(var t in i.equipe)if("clean"!=t){var n=i.equipe[t];s.push(n)}limpar_combobox(i.cbo_executores);for(var u=0;u<s.length;u++){n=s[u];var d=[];d.Nome=n.nome;var l=$('<span class="label lb_tipo" style="margin-right: 5px;"></span>');n.usuario_id>0?(l.addClass("tipo_executor label-info"),l.attr("title","Usuário"),l.attr("data-original-title","Usuário"),l.text("U"),l.attr("tipo","usuario")):n.grupo_usuarios_id>0&&(l.addClass("tipo_executor label-warning"),l.attr("title","Grupo de Usuários"),l.attr("data-original-title","Grupo de Usuários"),l.text("GU"),l.attr("tipo","grupo_usuarios")),l.tooltip(),add_option_combobox(i.cbo_executores,u,n.usuario_id>0?n.usuario_id:n.grupo_usuarios_id,d,l)}e(!0),r.keypress(function(e){if(13==e.keyCode){var o=i.cbo_executores.parent().find(".ncbo_scroll").find(".row_selected"),a=o.attr("id_registro"),s=o.find(".tipo_executor").attr("tipo");if(a>0){var t=!1;if("usuario"==s?$(i.arr_executores).each(function(e,o){a==o.id&&("N"==o.excluido?t=!0:i.arr_executores[e].excluido="S")}):"grupo_usuarios"==s&&$(i.arr_grupo_executores).each(function(e,o){a==o.id&&("N"==o.excluido?t=!0:i.arr_grupo_executores[e].excluido="S")}),!t){var n={id:a,nome:r.val(),tipo:s,valor_hora:null,horas_previstas:null,excluido:"N"};i.render_executores(n)}r.val(""),set_focus(r)}}}),a.find(".ul_row").click(function(){var e=$(this).parent().attr("id_registro"),o=$(this).find(".tipo_executor").attr("tipo");if(e>0){var a=!1;"usuario"==o?$(i.arr_executores).each(function(i,o){e==o.id&&(a=!0)}):"grupo_usuarios"==o&&$(i.arr_grupo_executores).each(function(i,o){e==o.id&&(a=!0)}),setTimeout(function(){if(!a){var s={id:e,nome:r.val(),tipo:o,valor_hora:null,horas_previstas:null,excluido:"N"};i.render_executores(s)}},150)}r.val(""),set_focus(r)})}},this.render_executores=function(e){var o=i.tab_executores.find("tbody"),a=o.find("tr:first"),r=function(e,i,o){var a=e.val().substring(0,3),r=e.val().substring(4,6),s=60*parseInt(a,10)+parseInt(r,10),t=i.val(),n=s*(parseInt(t,10)/60);o.maskMoney("mask",parseFloat(n)),o.trigger("change")},s=function(e){var i=new Validation,o=e.split(":"),a=o[1];return o.length,a>59||e.length>0&&6!=e.length?(i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Campo "Horas Previstas" inválido!')),alert_modal("Validação",i),!1):!(e>"838:59"&&(i.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Campo "Horas Previstas" deve ser menor que 838:59 horas!')),alert_modal("Validação",i),1))},t=function(e,t){t.horas_previstas=function(e){try{if(""!=e&&null!=e){if(e.toString().indexOf("-")>-1){if((e=(e=e.toString().replace("-","")).trim()).length>6){for(var i=9-(a=e).length,o=0;o<i;o++)a=0==o&&i>1?"0"+a:"-0"+a;return a.substring(0,7)}return"000:00"}if(e.length>6){var a;for(i=9-(a=e).length,o=0;o<i;o++)a="0"+a;return a.substring(0,6)}return"000:00"}return"000:00"}catch(e){}}(t.horas_previstas);var n=a.clone();n.removeAttr("template-row"),n.css("display",""),n.addClass("existe_item"),$(n.find("[template-field='nome']")).text(t.nome);var u=$(n.find("[template-field='tipo']"));"usuario"==t.tipo?(u.addClass("label-info"),u.attr("title","Usuário"),u.attr("data-original-title","Usuário"),u.text("U")):"grupo_usuarios"==t.tipo&&(u.addClass("label-warning"),u.attr("title","Grupo de Usuários"),u.attr("data-original-title","Grupo de Usuários"),u.text("GU"));var d=$(n.find(".edt_valor_total")),l=$(n.find("[template-field='edt_valor_hora']")),_=$(n.find("[template-field='edt_horas_previstas']")),c=$(n.find("[template-button='btn_usuario_remover']"));for(var p in d.addClass("hidden"),l.addClass("hidden"),_.addClass("hidden"),c.addClass("hidden"),i.equipe)if("clean"!=p){var h=i.equipe[p];h.usuario_id==App.sessao.dados.usuario_id&&!0!==App.sessao.dados.admin?(!0!==h.planejamento_atividade&&"S"!==h.planejamento_atividade||!0===App.sessao.dados.admin||(_.removeClass("hidden"),_.unbind("change"),_.change(function(){s($(this).val())&&($(n.find("[template-field='edt_horas_previstas']")).val(this.value),r(_,l,d),t.horas_previstas=$(this).val())})),!0!==h.planejamento_financeiro&&"S"!==h.planejamento_financeiro||!0===App.sessao.dados.admin||(d.removeClass("hidden"),l.removeClass("hidden"),d.unbind("change"),d.change(function(){$(n.find(".edt_valor_total")).prop("disabled",!0),d.val(this.value)}),l.unbind("change"),l.change(function(){$(n.find("[template-field='edt_valor_hora']")).val(this.value),r(_,l,d),t.valor_hora=$(this).maskMoney("unmasked")[0]}),d.trigger("change")),!0!==h.planejamento_recursos&&"S"!==h.planejamento_recursos||!0===App.sessao.dados.admin||(c.removeClass("hidden"),c.unbind("click"),c.click(function(){n.remove(),"usuario"==t.tipo?i.arr_executores[e].excluido="S":"grupo_usuarios"==t.tipo&&(i.arr_grupo_executores[e].excluido="S"),0==i.tab_executores.find(".existe_item").length&&i.tab_executores.addClass("hidden")}))):!0===App.sessao.dados.admin&&(d.removeClass("hidden"),l.removeClass("hidden"),_.removeClass("hidden"),c.removeClass("hidden"),d.unbind("change"),d.change(function(){$(n.find(".edt_valor_total")).prop("disabled",!0),d.val(this.value)}),l.unbind("change"),l.change(function(){$(n.find("[template-field='edt_valor_hora']")).val(this.value),r(_,l,d),t.valor_hora=$(this).maskMoney("unmasked")[0]}),_.unbind("change"),_.change(function(){s($(this).val())&&($(n.find("[template-field='edt_horas_previstas']")).val(this.value),r(_,l,d),t.horas_previstas=$(this).val())}),d.trigger("change"),c.unbind("click"),c.click(function(){n.remove(),"usuario"==t.tipo?i.arr_executores[e].excluido="S":"grupo_usuarios"==t.tipo&&(i.arr_grupo_executores[e].excluido="S"),0==i.tab_executores.find(".existe_item").length&&i.tab_executores.addClass("hidden")}))}l.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),d.maskMoney({thousands:"",decimal:",",allowZero:!0,suffix:"",precision:2}),_.mask("000:00"),e!=i.arr_executores.length&&"usuario"==t.tipo?i.arr_executores[e]=t:e!=i.arr_executores.length&&"grupo_usuarios"==t.tipo?i.arr_grupo_executores[e]=t:"usuario"==t.tipo?i.arr_executores.push(t):"grupo_usuarios"==t.tipo&&i.arr_grupo_executores.push(t),n.appendTo(o)};e?(i.tab_executores.removeClass("hidden"),"usuario"==e.tipo?"N"==e.excluido&&t(i.arr_executores.length,e):"grupo_usuarios"==e.tipo&&"N"==e.excluido&&t(i.arr_grupo_executores.length,e)):((i.arr_executores.length>0||i.arr_grupo_executores.length>0)&&i.tab_executores.removeClass("hidden"),i.tab_executores.find("tr:gt(1)").remove(),$(i.arr_executores).each(function(e,i){i.excluido="N",t(e,i)}),$(i.arr_grupo_executores).each(function(e,i){i.excluido="N",t(e,i)}))},this.listar_responsavel=function(e){for(var o in i.cbo_responsavel.unbind("change"),i.cbo_responsavel.find("option").remove(),add_option(i.cbo_responsavel,"","-- Selecione --"),i.equipe)if("clean"!=o){var a=i.equipe[o];add_option(i.cbo_responsavel,a.usuario_id,a.nome)}e&&i.cbo_responsavel.val(e).trigger("change"),i.cbo_responsavel.selectpicker("refresh")},this.close=function(){close_modal(i.modal.attr("id")),void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){i.close(),View.unload(this.html_id)},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),this.btn_confirmar.unbind("click"),this.btn_confirmar.click(function(){WS.post("atividade_projeto/salvar_massa/",{inicio:get_datepicker(i.edt_inicio),prazo:get_datepicker(i.edt_prazo),responsavel_id:i.cbo_responsavel.val(),projeto_id:i.projeto_id,atividade_projeto_id:JSON.stringify(i.atividades_id),arr_executores:JSON.stringify(i.arr_executores),arr_grupo_executores:JSON.stringify(i.arr_grupo_executores)},function(e){alert_saved("Atividades alteradas com sucesso"),void 0!==i.onsave&&i.onsave&&i.onsave(),i.unload()},[i.btn_confirmar,i.btn_cancelar])})}});