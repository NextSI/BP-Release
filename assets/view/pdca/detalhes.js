define(["react","react-dom","./../componentes_react/CboUsuarios"],function(e,i,o){return function(t){"use strict";var a=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onconfirm=null,this.edt_codigo=this.dialog.find(".edt_codigo"),this.edt_objetivo=this.dialog.find(".edt_objetivo"),this.edt_inicio=this.dialog.find(".edt_inicio"),this.edt_fim=this.dialog.find(".edt_fim"),this.cbo_status=this.dialog.find(".cbo_status"),this.div_status=this.dialog.find(".div_status"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_confirmar=this.dialog.find(".btn_confirmar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.tab_equipe=this.dialog.find(".tab_equipe"),this.div_componente_usuario=this.dialog.find(".div_componente_usuario"),this.div_selecao_categoria=this.dialog.find(".div_selecao_categoria"),this.lbl_tab_equipe=this.dialog.find(".lbl_tab_equipe"),this.lbl_tab_anexos=this.dialog.find(".lbl_tab_anexos"),this.tbl_listagem_draft=this.dialog.find("#tbl_listagem_draft > tbody"),this.div_files_upload_draft=this.dialog.find("#div_files_upload_draft"),this.lbl_choose_file=this.dialog.find("#lbl_choose_file"),this.painel_anexos=this.dialog.find(".painel_anexos"),this.pdca=null,this.equipe={usuarios:[],grupo_usuarios:[]},this.categoria_pdca_id=null,this.cboEquipe=e.createElement(o,null,null),this.show=function(e,i){switch(a.renderiza_componentes(),a.initUpload(),a.edt_objetivo.attr("id","edt_objetivo"+a.html_id),void 0!==e&&null!=e?(a.pdca=e,a.preencher()):a.renderiza_selecao_categoria(),i){case FORMULARIO.NOVO:a.btn_confirmar.show(),a.btn_excluir.hide(),a.div_status.addClass("hidden"),a.permite_alterar(!0),a.lbl_tab_anexos.hide(),a.sugere_codigo(),set_datepicker(a.edt_inicio),set_datepicker(a.edt_fim),set_tinymce(a.edt_objetivo),App.sessao.dados.tipo==USUARIO_TIPO.ANALISTA&&(a.equipe.usuarios.push({usuario_id:App.sessao.dados.usuario_id,nome:App.sessao.dados.nome,tipo:App.sessao.dados.tipo,gerente:!1,equipe:!1,acompanhamento:!1}),a.render_equipe()),a.title="Novo PDCA";break;case FORMULARIO.EDITAR:a.btn_excluir.hide(),a.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:a.btn_confirmar.hide(),a.btn_excluir.hide(),a.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:a.btn_confirmar.hide(),a.btn_excluir.show(),a.permite_alterar(!1)}},this.sugere_codigo=function(){WS.get("pdca/get_next_codigo/",null,function(e){e&&(a.edt_codigo.val(e).change(),a.edt_codigo.tooltip({title:"Sugerido automaticamente",placement:"right"}),a.edt_codigo.tooltip("toggle"))})},this.permite_alterar=function(e){a.edt_codigo.prop("readonly",!e),a.edt_objetivo.prop("readonly",!e),a.edt_inicio.prop("readonly",!e),a.edt_fim.prop("readonly",!e),a.cbo_status.prop("disabled",!e),a.valor=e},this.renderiza_componentes=function(){i.render(a.cboEquipe,a.div_componente_usuario[0]),a.cboEquipe.props.setObjParam({Clientes:!1,EmpresaId:App.temp.empresa,ExibirGrupos:!0,EquipeInterna:!0,Modulo:MODULOS.PDCA}),a.cboEquipe.props.setFunctionSelect(a.seleciona_membro_equipe)},this.seleciona_membro_equipe=function(){var e=!1;if($(a.equipe).each(function(i,o){"usuarios"==a.cboEquipe.props.UsuarioSelecionado.tipo?$(o.usuarios).each(function(i,o){if(o.usuario_id==a.cboEquipe.props.UsuarioSelecionado.id)return e=!0,!1}):"grupo_usuarios"==a.cboEquipe.props.UsuarioSelecionado.tipo&&$(o.grupo_usuarios).each(function(i,o){if(o.grupo_usuarios_id==a.cboEquipe.props.UsuarioSelecionado.id)return e=!0,!1})}),!e){switch(a.cboEquipe.props.UsuarioSelecionado.tipo){case"usuarios":a.equipe.usuarios.push({usuario_id:a.cboEquipe.props.UsuarioSelecionado.id,nome:a.cboEquipe.props.UsuarioSelecionado.nome,tipo:a.cboEquipe.props.UsuarioSelecionado.tipo,gerente:!1,equipe:!1,acompanhamento:!1});break;case"grupo_usuarios":a.equipe.grupo_usuarios.push({grupo_usuarios_id:a.cboEquipe.props.UsuarioSelecionado.id,nome:a.cboEquipe.props.UsuarioSelecionado.nome,tipo:a.cboEquipe.props.UsuarioSelecionado.tipo,gerente:!1,equipe:!1,acompanhamento:!1})}a.render_equipe()}a.cboEquipe.props.setUsuario({usuario_id:null,usuario_nome:""})},this.render_equipe=function(){var e=a.tab_equipe.find("tbody"),i=e.find("tr:first"),o=function(o,t,n){var d=i.clone(),s=$(d.find("[template-field='tipo']")),r=$(d.find(".btn_usuario_remover")),c=$(d.find("[template-field='nome']")),u=$(d.find(".chk_gerente")),p=$(d.find(".chk_equipe")),l=$(d.find(".chk_acompanhamento")),_=$(d.find(".div_esconder"));d.removeAttr("template-row"),d.css("display",""),t?(s.addClass("label-warning"),s.attr("title","Grupo de Usuários"),s.attr("data-original-title","Grupo de Usuários"),s.text("GU")):"usuario_cliente"==o.tipo||o.tipo==USUARIO_TIPO.CLIENTE?(s.addClass("label-info"),s.attr("title","Usuário Cliente"),s.attr("data-original-title","Usuário Cliente"),s.text("C")):(s.addClass("label-info"),s.attr("title","Usuário"),s.attr("data-original-title","Usuário"),s.text("U")),s.tooltip(),c.text(o.nome),u.attr("type","checkbox"),u.addClass("checkbox_bootstrap_toggle"),p.attr("type","checkbox"),p.addClass("checkbox_bootstrap_toggle"),l.attr("type","checkbox"),l.addClass("checkbox_bootstrap_toggle"),1==o.gerente?(u.prop("checked",!0),l.parent().parent().parent().addClass("hidden"),p.parent().parent().parent().addClass("hidden"),d.addClass("bg-info"),d.find("td").addClass("bg-info"),a.lbl_tab_equipe.show()):(l.parent().parent().parent().removeClass("hidden"),p.parent().parent().parent().removeClass("hidden"),d.removeClass("bg-info"),d.find("td").removeClass("bg-info")),1==o.equipe&&p.prop("checked",!0),1==o.acompanhamento&&l.prop("checked",!0),$(l).prop("disabled",!a.valor),$(p).prop("disabled",!a.valor),$(u).prop("disabled",!a.valor),$(r).prop("disabled",!a.valor),a.valor||$(r).addClass("hidden"),p.parent().unbind("click").click(function(e){var i=t?a.equipe.grupo_usuarios[n]:a.equipe.usuarios[n];i.equipe=!$(this).find(".chk_equipe").prop("checked"),i.acompanhamento=!1,l.prop("checked",!1).change()}),l.parent().unbind("click").click(function(e){var i=t?a.equipe.grupo_usuarios[n]:a.equipe.usuarios[n];i.acompanhamento=!$(this).find(".chk_acompanhamento").prop("checked"),i.equipe=!1,p.prop("checked",!1).change()}),u.unbind("change"),u.change(function(){var e=t?a.equipe.grupo_usuarios[n]:a.equipe.usuarios[n];$(this).prop("checked")?(d.addClass("bg-info"),d.find("td").addClass("bg-info"),_.addClass("hidden")):(d.removeClass("bg-info"),d.find("td").removeClass("bg-info"),_.removeClass("hidden")),p.prop("checked",!1).change(),l.prop("checked",!1).change(),e.gerente=$(this).prop("checked"),e.acompanhamento=!1,e.equipe=!1}),r.unbind("click"),r.click(function(){t?alert_modal(a.title.text(),"Deseja remover o Grupo de Usuários?","Remover",function(){$(a.equipe.grupo_usuarios).each(function(e,i){i.grupo_usuarios_id==o.grupo_usuarios_id&&(d.remove(),a.equipe.grupo_usuarios.splice(e,1),a.render_equipe())})},!0):alert_modal(a.title.text(),"Deseja remover o Usuário?","Remover",function(){$(a.equipe.usuarios).each(function(e,i){i.usuario_id==o.usuario_id&&(d.remove(),a.equipe.usuarios.splice(e,1),a.render_equipe())})},!0)}),d.appendTo(e)};a.tab_equipe.find("tr:gt(1)").remove(),$(a.equipe.usuarios).each(function(e,i){o(i,!1,e)}),$(a.equipe.grupo_usuarios).each(function(e,i){o(i,!0,e)}),App.aplicar_checkbox(e)},this.preencher=function(){WS.get("pdca/objeto/",{pdca_id:a.pdca.pdca_id},function(e){App.titulo_aba(a.html_id,"PDCA "+e.numero),a.edt_codigo.val(e.numero),set_tinymce(a.edt_objetivo,e.objetivo),set_datepicker(a.edt_inicio,e.data_inicio),set_datepicker(a.edt_fim,e.data_fim),a.cbo_status.val(e.situacao),a.equipe.usuarios=e.equipe,a.equipe.grupo_usuarios=e.grupo_usuarios_equipe,a.categoria_pdca_id=e.categoria_pdca_id,a.render_equipe(),a.listaDocumentos(),a.renderiza_selecao_categoria()})},this.initUpload=function(){var e=$('<input type="file">');e[0].addEventListener("change",a.selecionouArquivo,!1),a.lbl_choose_file.click(function(){e.click()})},this.selecionouArquivo=function(e){var i=e.target.files;i&&(a.upload_files=i,a.uploadFile())},this.uploadFile=function(e){var i=new FormData;$.each(a.upload_files,function(e,o){i.append(e,o)}),WS.post("pdca_documento/salvar",{pdca_id:a.pdca.pdca_id,mobile:App.is_nativo()?"S":"N",data:a.upload_files},function(e){a.listaDocumentos()},null,null,!0)},this.removerArquivo=function(e){WS.post("pdca_documento/excluir",{pdca_documento_id:e.pdca_documento_id},function(e){a.listaDocumentos()})},this.listaDocumentos=function(){WS.get("pdca_documento/listar/",{pdca_id:a.pdca.pdca_id},function(e){a.tbl_listagem_draft.find(".rows").remove(),$.each(e,function(e,i){!function(e,i){var o=a.tbl_listagem_draft.find("tr:first").clone();o.addClass("rows").attr("indice",e).removeAttr("template-row").css("display","");var t=$(o.find("[template-field='file']"));t.text(i.nome),t.click(function(){App.obter_token_publico(function(e){App.download(WS_URI+"documento/download/?documento_revisao_id="+i.documento_revisao_id+"&token_publico="+e)})}),$(o.find("[template-field='size']")).text(i.tamanho+" kb");var n=o.find("[template-button='remove']");n.attr("template-ref",i.id),n.click(function(){alert_modal("Atenção","Deseja remover o arquivo "+i.nome+"?","Remover",function(){a.removerArquivo(i)},!0)}),o.appendTo(tbl_listagem_draft)}(e,i)})})},this.renderiza_selecao_categoria=function(){i.render(e.createElement(window.components.SelecaoCategoriaPDCA.default,{selecionado:a.categoria_pdca_id,columns:[{dataField:"nome",caption:"Nome",dataType:"string"}],aoAlterar:e=>{a.categoria_pdca_id=e}}),a.div_selecao_categoria[0])},this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("pdca/excluir",{pdca_id:a.pdca.pdca_id},function(e){alert_saved(e.objetivo+" excluido com sucesso"),a.unload()},[a.btn_excluir])}),this.btn_confirmar.unbind("click"),this.btn_confirmar.click(function(){WS.post("pdca/salvar",{pdca_id:null===a.pdca?0:a.pdca.pdca_id,numero:a.edt_codigo.val(),objetivo:get_tinymce(a.edt_objetivo),data_inicio:get_datepicker(a.edt_inicio),data_fim:get_datepicker(a.edt_fim),situacao:a.cbo_status.val(),equipe:JSON.stringify(a.equipe.usuarios),grupo_usuarios_equipe:JSON.stringify(a.equipe.grupo_usuarios),categoria_pdca_id:a.categoria_pdca_id},function(e){alert_saved("Registro "+(null===a.pdca_id?"inserido":"alterado")+" com sucesso!"),a.unload()},[a.btn_cancelar])}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){a.unload()}),this.close=function(){close_modal(a.modal.attr("id")),void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)}}});