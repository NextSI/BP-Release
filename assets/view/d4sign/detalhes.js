define([],function(){return function(a){"use strict";var i=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title="Histórico Documentos - D4Sign",this.onclose=null,this.onsave=null,this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.btn_solicitar_assinaturas=this.dialog.find(".btn_solicitar_assinaturas"),this.treelist_historico_documento_d4sign=this.dialog.find(".treelist_historico_documento_d4sign"),this.documento_revisao_id=null,this.usuario_permissao_escrita=null,this.grupo_usuario_permissao_escrita=null,this.mensagem_padrao_d4sign=null,this.solicitacao_id=null,this.show=function(a,o,t,n){i.documento_revisao_id=a,i.mensagem_padrao_d4sign=t||null,i.solicitacao_id=n||null,null!==o&&"object"==typeof o&&(i.usuario_permissao_escrita=o.usuario_permissao_escrita||"S",i.grupo_usuario_permissao_escrita=o.grupo_usuario_permissao_escrita||"S"),i.listar(),show_modal(i.modal.attr("id"))},this.listar=function(){WS.get("documento_revisao_assinatura/listar_eventos_por_revisao/",{documento_revisao_id:i.documento_revisao_id},function(a){i.montaTreeList(a)})},this.montaTreeList=function(a){i.treelist_historico_documento_d4sign.dxTreeList({dataSource:a,showBorders:!0,keyExpr:"id",parentIdExpr:"pai_id",editing:{useIcons:!0},rowAlternationEnabled:!1,onRowPrepared:function(a){"data"===a.rowType&&"C"===a.data.situacao&&a.rowElement.find("td").css("background","#ffcdd2")},columns:[{dataField:"solicitante_nome",caption:"Solicitante"},{dataField:"data_envio",caption:"Data de Envio",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{dataField:"situacao",caption:"Situação",alignment:"center",cellTemplate:function(a,i){var o="",t="";switch(i.data.situacao){case"A":t="Aguardando",o="label label-warning";break;case"F":t="Finalizado",o="label label-success";break;case"C":t="Cancelado",o="label label-danger"}$("<span class='"+o+"'>"+t+"</span>").appendTo(a)}},{dataField:"nome_arquivo",caption:"Nome do Arquivo"},{dataField:"nome_completo",caption:"Signatário"},{dataField:"event_occurred_at",caption:"Data Assinatura",width:130,dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{type:"buttons",buttons:[{hint:"Download",icon:"fa fa-download",visible:function(a){return 0===a.row.level&&"A"!==a.row.data.situacao&&parseInt(a.row.data.signed_document_tamanho,10)>0},onClick:function(a){var o=a.row.data.documento_revisao_assinatura_id;App.obter_token_publico(function(a){App.download(WS_URI+"documento/download/?documento_revisao_id="+i.documento_revisao_id+"&documento_revisao_assinatura_id="+o+"&token_publico="+a)})}},{hint:"Cancelar Assinatura",icon:"fa fa-thumbs-down",cssClass:"icon_red",visible:function(a){return 0===a.row.level&&("S"===i.usuario_permissao_escrita||"S"===i.grupo_usuario_permissao_escrita)&&"F"!==a.row.data.situacao&&"C"!==a.row.data.situacao},onClick:function(a){i.cancelar_documento_assinado(a.row.data.d4sign_document_key)}}]}],showRowLines:!0})},this.cancelar_documento_assinado=function(a){alert_modal("Aviso","Deseja cancelar esta solicitação de assinatura?","Sim",function(){WS.get("d4sign/cancelar_assinatura/",{d4sign_document_key:a},function(a){alert_modal("Atenção","Solicitação de cancelamento enviado com sucesso! <br><br> A situação será atualizada automaticamente após o D4Sing confirmar o cancelamento.","OK")})},!0,"Não")},this.close=function(){close_modal(i.modal.attr("id")),void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){i.close(),View.unload(this.html_id)},this.btn_refresh.unbind("click"),this.btn_refresh.click(function(){i.listar()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),this.btn_solicitar_assinaturas.unbind("click"),this.btn_solicitar_assinaturas.click(function(){View.load("d4sign/configurar_signatarios",function(a,o){o.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==i.html_id&&i.listar()})},o.show(i.documento_revisao_id,!0,null,null,i.solicitacao_id,i.mensagem_padrao_d4sign)},View.ABA.MULTIPLAS)})}});