define([],function(){return function(e){"use strict";var n=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.form_login_padrao=this.dialog.find(".form_login_padrao"),this.div_autenticacao=this.dialog.find(".div_autenticacao"),this.frm=this.dialog.find(".form-signin"),this.lbl_admin=this.dialog.find(".lbl_admin"),this.select_user=this.dialog.find("#select_user"),this.select_ldap_server=this.dialog.find("#select_ldap_server"),this.username=this.dialog.find("#username"),this.password=this.dialog.find("#password"),this.dxButtonEsqueciSenha=this.dialog.find("#dxButtonEsqueciSenha"),this.div_opcoes_usuario=this.dialog.find(".div_opcoes_usuario"),this.checkEntrarAutomaticamente=this.dialog.find("#checkEntrarAutomaticamente"),this.checkMemorizarSenha=this.dialog.find("#checkMemorizarSenha"),this.dxButtonEntrar=this.dialog.find("#dxButtonEntrar"),this.dxButtonEsquecerUsuario=this.dialog.find("#dxButtonEsquecerUsuario"),this.img_logo=this.dialog.find(".img_logo"),this.version=this.dialog.find("#version"),this.usuarios=[],this.usuario={},this.selectUserInstance=null,this.usernameInstance=null,this.passwordInstance=null,this.dxButtonEsquecerUsuarioInstance=null,this.dxButtonEntrarInstance=null,this.ldap_servers=[{id:0,nome:"Servidor Next BP"}],this.storageLdapServer=null,this.form_email=this.dialog.find(".form_email"),this.email_anonimo=this.dialog.find(".email_anonimo"),this.btnLoginAnonimo=this.dialog.find(".btnLoginAnonimo"),this.construct=function(){let e=window.location.hash,t=e.substr(window.location.hash.indexOf("/")+1).split("/");if(t.length>0&&""!==t[0].trim()&&"#"!==t[0].trim()&&"solicitacao_atividade"==t[0]&&"executar_externo"==t[1]){n.form_email.removeClass("hidden");let o=e.substring(e.indexOf("chave_acesso=")+"chave_acesso=".length),i=t[2].substring(0,t[2].indexOf("?"));const s=n.email_anonimo.dxTextBox({placeholder:"Digite seu e-mail",showClearButton:!0,onEnterKey:function(e){}}).dxTextBox("instance");function a(e,n){WS.post("login/login_anonimo/",{email:e,permissoes:JSON.stringify(["gestao_processos"]),chaves_acesso:JSON.stringify({chave_acesso_solicitacao_atividade:n})},function(e){View.unload(),App.login_anonimo(e),View.load("solicitacao/detalhes",function(e,n){n.show(i,SOLICITACAO_TIPO_VISUALIZACAO.ATIVIDADE)},View.ABA.MULTIPLAS),setTimeout(()=>{$("[aba-id-md5]").css({pointerEvents:"none",color:"rgba(0,0,0,0.3)"})},950)})}n.btnLoginAnonimo.dxButton({text:"Entrar",useSubmitBehavior:!0,hoverStateEnabled:!1,template:function(e,n){$("<i class='dx-icon dx-icon-chevronright pull-right' style='color: #FFF; font-size: xx-large; margin-top: 2px;'></i><span class='dx-button-text'>"+e.text+"</span>").appendTo(n),$(n).parent().addClass("btn-primary"),$(n).addClass("btn-primary")},onClick:function(e){let n=s.option("value");!function(e,n,t){WS.get("/solicitacao/verificar_acesso_anonimo_atividade/",{solicitacao_atividade_id:e,email:n,chave_acesso:t},function(e){e?a(n,t):DevExpress.ui.dialog.alert("O e-mail informado não tem permissão para realizar a operação","Aviso")})}(i,n,o)}})}else n.form_login_padrao.removeClass("hidden"),n.loadSelectUser(),n.loadButtonEsqueciSenha(),n.loadCheckMemorizarSenha(),n.loadCheckEntrarAutomaticamente(),n.loadTextBoxUsername(),n.loadTextBoxPassword(),n.loadButtonEsquecerUsuario(),n.version.text(App.version),n.img_logo.attr("src","assets/img/logo_transp.png?anticache="+(new Date).getTime()).on("error",function(){$(this).hide()}),1==SYS_ADMIN?(n.checkMemorizarSenha.dxCheckBox("instance").option("visible",!1),n.checkEntrarAutomaticamente.dxCheckBox("instance").option("visible",!1),n.dxButtonEsqueciSenha.dxButton("instance").option("visible",!1),n.lbl_admin.show(),n.usernameInstance.focus(),n.autenticacao()):AUTH_TOKEN?n.entrar():n.list_ldap_servers()},this.listar_usuarios=function(){if(n.div_autenticacao.hide(),n.form_login_padrao.hide(),n.usernameInstance.option("value",null),n.passwordInstance.option("value",null),n.usuarios=[],"undefined"!=typeof Storage){if(localStorage.getItem("bp_usuarios")&&"undefined"!=localStorage.getItem("bp_usuarios")&&(n.usuarios=JSON.parse(localStorage.getItem("bp_usuarios"))),0==n.usuarios.length){var e=localStorage.getItem("bp_lg_u"),t=localStorage.getItem("bp_lg_p"),a=localStorage.getItem("bp_ws");e&&(n.salvar_usuario({nome:e,login:e,senha:t,entrar_automaticamente:t&&""!=t,webservice_nome:a,webservice_url:a}),localStorage.removeItem("bp_lg_u"),localStorage.removeItem("bp_lg_p"),localStorage.removeItem("bp_ws"))}n.selectUserInstance.option("dataSource",n.usuarios),n.autenticacao(),1===n.usuarios.length&&n.selectUserInstance.option("value",n.usuarios[0])}},this.entrar=function(){if("ie"==getBrowser())alert("Este navegador não é compatível com o Next BP. Recomenda-se usar os seguintes navegadores: \n- Google Chrome \n- Opera \n- Mozilla Firefox \n- Safari \n- Microsoft Edge \n");else if(1==SYS_ADMIN)WS.post("login/validar_admin/",{username:cripto(n.usernameInstance.option("value")),senha:cripto(n.passwordInstance.option("value"))},function(e){App.sessao=e.session_id,View.unload(),View.load("admin/painel",function(e){})},[n.dxButtonEntrar],null,!0,null,function(e){n.dxButtonEntrarInstance&&n.dxButtonEntrarInstance.option({text:"Por favor, aguarde..."})},n.html_id,function(){n.dxButtonEntrarInstance&&n.dxButtonEntrarInstance.option({text:"Entrar"})});else if(AUTH_TOKEN)WS.post("login/validar/",{token:AUTH_TOKEN},function(e){View.unload(),App.login(e)},[n.dxButtonEntrar],null,!0,null,function(e){n.dxButtonEntrarInstance&&n.dxButtonEntrarInstance.option({text:"Por favor, aguarde..."})},n.html_id,function(){n.dxButtonEntrarInstance&&n.dxButtonEntrarInstance.option({text:"Entrar"})});else{var e=new Validation;if(""!=n.usernameInstance.option("value")&&""!=n.passwordInstance.option("value")||e.add(new ValidationMessage(Validation.CODES.ERR,"Digite o usuário e senha")),!e.is_valid())return void alert_modal("Validação",e);WS.post("login/validar/",{username:n.usernameInstance.option("value")?cripto(n.usernameInstance.option("value")):null,senha:n.passwordInstance.option("value")?cripto(n.passwordInstance.option("value")):null,token:window.location.search.substring(1),servidor_ldap_id:n.select_ldap_server.dxSelectBox("instance").option("value")},function(e){var t=n.checkMemorizarSenha.dxCheckBox("instance").option("value"),a=n.checkEntrarAutomaticamente.dxCheckBox("instance").option("value");if(View.unload(),App.login(e),App.menu=e.menu_personalizado,"undefined"!=typeof Storage){var o=null;t&&(o=cripto(n.passwordInstance.option("value")));var i={nome:e.dados.nome,login:e.dados.username,ldap_login:e.dados.ldap_login,senha:o,entrar_automaticamente:a,time:(new Date).getTime(),servidor_ldap_id:null!==e.dados.servidor_ldap_id&&""!==e.dados.servidor_ldap_id?e.dados.servidor_ldap_id:0};App.temp.usuario=i,n.salvar_usuario(i)}},[n.dxButtonEntrar],null,!0,null,function(e){n.dxButtonEntrarInstance&&n.dxButtonEntrarInstance.option({text:"Por favor, aguarde..."})},n.html_id,function(){n.dxButtonEntrarInstance&&n.dxButtonEntrarInstance.option({text:"Entrar"})})}},this.salvar_usuario=function(e){var t=!1;n.usuarios.map(function(a,o){e.login==a.login&&e.webservice_url==a.webservice_url&&(t=!0,n.usuarios[o]=e)}),t||n.usuarios.push(e),n.salvar_usuarios()},this.salvar_usuarios=function(){n.usuarios=n.usuarios.sort(function(e,n){return(e.time||0)-n.time}),n.usuarios.reverse(),"undefined"!=typeof Storage&&localStorage.setItem("bp_usuarios",JSON.stringify(n.usuarios))},this.autenticacao=function(e){if(n.usuario=e,n.div_autenticacao.show(),n.form_login_padrao.show(),n.usernameInstance.option("value",null),n.passwordInstance.option("value",null),1==SYS_ADMIN?n.div_opcoes_usuario.hide():n.div_opcoes_usuario.show(),n.checkMemorizarSenha.dxCheckBox("instance").option("disabled",!1),n.checkEntrarAutomaticamente.dxCheckBox("instance").option("disabled",!1),n.checkMemorizarSenha.dxCheckBox("instance").option("value",!1),n.checkEntrarAutomaticamente.dxCheckBox("instance").option("value",!1),void 0!==e&&e)if(n.dxButtonEsquecerUsuarioInstance.option("visible",!0),n.usernameInstance.option("value",e.login?e.login:e.ldap_login),n.usernameInstance.option("readOnly",!0),e.senha&&n.passwordInstance.option("value",e.senha?base64_decode(e.senha):""),e.entrar_automaticamente&&n.checkEntrarAutomaticamente.dxCheckBox("instance").option("value",!0),e.senha&&n.checkMemorizarSenha.dxCheckBox("instance").option("value",!0),n.passwordInstance.focus(),null!==e.ldap_login&&""!=e.ldap_login)if(""==e.servidor_ldap_id||null==e.servidor_ldap_id){const e=n.ldap_servers.filter(e=>"S"==e.padrao);n.loadSelectLdap(e.length>0?e[0].id:void 0)}else n.loadSelectLdap(e.servidor_ldap_id);else n.loadSelectLdap(e.servidor_ldap_id);else{n.usernameInstance.option("readOnly",!1),n.dxButtonEsquecerUsuarioInstance.option("visible",!1),n.usuario=null,n.checkMemorizarSenha.dxCheckBox("instance").option("value",!0);const e=n.ldap_servers.filter(e=>"S"==e.padrao);n.loadSelectLdap(e.length>0?e[0].id:void 0)}},this.unload=function(){View.unload(this.html_id)},this.list_ldap_servers=function(){WS.get("/servidor_ldap/listar_basico/",null,function(e){if(e.map(function(e){n.ldap_servers.push(e)}),n.listar_usuarios(),n.usuarios&&!LOGOUT)for(var t=0;t<n.usuarios.length;t++)if(n.usuarios[t].entrar_automaticamente){n.autenticacao(n.usuarios[t]),n.entrar();break}})},this.loadSelectUser=function(){n.selectUserInstance=n.select_user.dxSelectBox({dataSource:[],displayExpr:"nome",onSelectionChanged:function(e){n.autenticacao(e.selectedItem),e.selectedItem||n.usernameInstance.focus()},placeholder:"Usuários salvos",showClearButton:!0}).dxSelectBox("instance")},this.loadSelectLdap=function(e){var t="";1==n.ldap_servers.length?t=n.ldap_servers[0].id:null!=e&&""!==e&&(t=e),n.select_ldap_server.dxSelectBox({dataSource:n.ldap_servers,visible:n.ldap_servers.length>1,displayExpr:"nome",valueExpr:"id",placeholder:"Servidor de autenticação",showClearButton:!0,value:1==n.ldap_servers.length?n.ldap_servers[0].id:t}).dxValidator({validationRules:[{type:"required",message:"Campo obrigatório"}]}),n.dxButtonEntrarInstance=n.dxButtonEntrar.dxButton({text:"Entrar",useSubmitBehavior:!0,hoverStateEnabled:!1,template:function(e,n){$("<i class='dx-icon dx-icon-chevronright pull-right' style='color: #FFF; font-size: xx-large; margin-top: 2px;'></i><span class='dx-button-text'>"+e.text+"</span>").appendTo(n),$(n).parent().addClass("btn-primary"),$(n).addClass("btn-primary")},onClick:function(e){SYS_ADMIN||AUTH_TOKEN?n.entrar():e.validationGroup.validate().isValid&&n.entrar()}}).dxButton("instance")},this.loadButtonEsqueciSenha=function(){n.dxButtonEsqueciSenha.dxButton({text:"Esqueceu a senha ?",stylingMode:"text",width:"auto",onClick:function(e){View.load("login/solicitar_senha",function(e,t){t.onclose=n.listar,t.show(n.usernameInstance.option("value"))})}})},this.loadCheckMemorizarSenha=function(){n.checkMemorizarSenha.dxCheckBox({text:"Memorizar senha"})},this.loadCheckEntrarAutomaticamente=function(){n.checkEntrarAutomaticamente.dxCheckBox({text:"Entrar automaticamente",onValueChanged:function(e){e.component.option("value")?(n.checkMemorizarSenha.dxCheckBox("instance").option("value",!0),n.checkMemorizarSenha.dxCheckBox("instance").option("disabled",!0)):n.checkMemorizarSenha.dxCheckBox("instance").option("disabled",!1)}})},this.loadTextBoxUsername=function(){n.usernameInstance=n.username.dxTextBox({placeholder:"Nome de usuário",showClearButton:!0,onFocusIn:function(e){e.component.option("readOnly")||n.selectUserInstance.option("visible",!1)},onFocusOut:function(e){e.component.option("value")||n.selectUserInstance.option("visible",!0)},onEnterKey:function(e){n.dxButtonEntrar.trigger("click")}}).dxTextBox("instance")},this.loadTextBoxPassword=function(){n.passwordInstance=n.password.dxTextBox({placeholder:"senha",mode:"password",onEnterKey:function(e){n.dxButtonEntrar.trigger("click")},buttons:[{name:"password",location:"after",options:{width:"25px",icon:"fas fa-eye",type:"default",onClick:function(e){e.component.option("icon","text"===n.passwordInstance.option("mode")?"fas fa-eye":"fas fa-eye-slash"),n.passwordInstance.option("mode","text"===n.passwordInstance.option("mode")?"password":"text")}}}]}).dxTextBox("instance")},this.loadButtonEsquecerUsuario=function(){n.dxButtonEsquecerUsuarioInstance=n.dxButtonEsquecerUsuario.dxButton({visible:!1,text:"Esquecer usuário",onClick:function(e){alert_modal(App.lang.login.esquecer_conta,App.lang.login.esquecer_conta_pergunta,App.lang.login.sim_esquecer_agora,function(){n.usuarios.map(function(e,t){if(e==n.usuario)return n.usuarios.splice(t,1),n.salvar_usuarios(),void n.listar_usuarios()})},!0,App.lang.generico.cancelar,function(){})}}).dxButton("instance")},this.construct()}});