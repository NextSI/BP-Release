define([],function(){var Dashboard_Vendas=function(html_id){"use strict";var main=this;this.html_id=html_id,this.dialog=$("#"+this.html_id),this.title="Dashboard Vendas",this.cbo_funil_vendas=this.dialog.find(".cbo_funil_vendas"),this.edt_funil=this.dialog.find(".edt_funil"),this.nome_status=this.dialog.find(".nome_status"),this.total_status=this.dialog.find(".nome_status"),this.oportunidade_status=this.dialog.find(".oportunidade_status"),this.edt_day_end=this.dialog.find(".edt_day_end"),this.div_velocimetro=this.dialog.find(".div_velocimetro"),this.div_grafico_anual=this.dialog.find(".div_grafico_anual"),this.div_grafico_trimestral=this.dialog.find(".div_grafico_trimestral"),this.btn_search=this.dialog.find(".btn_search"),this.div_grafico_regiao=this.dialog.find(".div_grafico_regiao"),this.div_grafico_regiao_anual=this.dialog.find(".div_grafico_regiao_anual"),this.div_grafico_segmento=this.dialog.find(".div_grafico_segmento"),this.cbo_mes_inicio=this.dialog.find(".cbo_mes_inicio"),this.edt_ano_inicio=this.dialog.find(".edt_ano_inicio"),this.cbo_mes_fim=this.dialog.find(".cbo_mes_fim"),this.edt_ano_fim=this.dialog.find(".edt_ano_fim"),this.info_status=this.dialog.find(".info_status"),this.info_metas=this.dialog.find(".info_metas"),this.div_oportunidades_totalizadas_status_situacao=this.dialog.find(".div_oportunidades_totalizadas_status_situacao"),this.div_historico_vendas=this.dialog.find(".div_historico_vendas"),this.div_meta=this.dialog.find(".div_meta"),this.edt_meta_inicial=this.dialog.find(".edt_meta_inicial"),this.edt_meta_final=this.dialog.find(".edt_meta_final"),this.estagnadas_quantidade=this.dialog.find(".estagnadas_quantidade"),this.estagnadas_valor=this.dialog.find(".estagnadas_valor"),this.em_aberto_quantidade=this.dialog.find(".em_aberto_quantidade"),this.em_aberto_valor=this.dialog.find(".em_aberto_valor"),this.atrasadas_quantidade=this.dialog.find(".atrasadas_quantidade"),this.atrasadas_valor=this.dialog.find(".atrasadas_valor"),this.perdidas_quantidade=this.dialog.find(".perdidas_quantidade"),this.perdidas_valor=this.dialog.find(".perdidas_valor"),this.ganhas_quantidade=this.dialog.find(".ganhas_quantidade"),this.ganhas_valor=this.dialog.find(".ganhas_valor"),this.remanescentes_quantidade=this.dialog.find(".remanescentes_quantidade"),this.remanescentes_valor=this.dialog.find(".remanescentes_valor"),this.total_quantidade=this.dialog.find(".total_quantidade"),this.total_valor=this.dialog.find(".total_valor"),this.funil_selecionado=null,this.total_oportunidades=null,this.porcentagem_ganhas=null,this.total_oportunidades_ganhas=0,this.show=function(){create_combobox(main.cbo_funil_vendas,main.listar_funil);var a=main.cbo_funil_vendas.parent();main.edt_funil=a.find(".edt_combobox"),main.edt_funil.prop("readonly",!0),main.info_status.tooltip(),main.info_metas.tooltip(),WS.get("funil_vendas/listar/",null,function(a){main.arr_funil_vendas=a,$(a).each(function(a,t){if("S"==t.padrao){set_value_combobox(main.cbo_funil_vendas,t.id,t.nome);var i=new Date,e=parseInt(i.getMonth(),10)+1,n=i.getFullYear();e<10&&(e="0"+e),main.cbo_mes_inicio.val(e),main.cbo_mes_fim.val(e),main.edt_ano_inicio.val(n),main.edt_ano_fim.val(n),set_datepicker(main.edt_meta_inicial),set_datepicker(main.edt_meta_final);var o=new Date,s=(n=o.getFullYear(),e=("0"+(o.getMonth()+1)).slice(-2),new Date(n,e,1)),d=new Date(n,e,0),r=n+"-"+e+"-"+("0"+s.getDate()).slice(-2),l=n+"-"+e+"-"+("0"+d.getDate()).slice(-2);setTimeout(function(){set_datepicker(main.edt_meta_inicial,r),set_datepicker(main.edt_meta_final,l),main.btn_search.click()},150)}})})},this.listar_funil=function(a){var t=new Object;t.nome=main.edt_funil.val(),WS.get("funil_vendas/listar/",t,function(t){limpar_combobox(main.cbo_funil_vendas),$(t).each(function(a,t){var i=[];i["Descrição"]=t.nome,add_option_combobox(main.cbo_funil_vendas,a,t.id,i)}),a(!0)})},main.btn_search.unbind("click"),main.btn_search.click(function(){var a={id_funil:get_value_combobox(main.cbo_funil_vendas),mes_inicio:main.cbo_mes_inicio.val(),ano_inicio:main.edt_ano_inicio.val(),mes_fim:main.cbo_mes_fim.val(),ano_fim:main.edt_ano_fim.val(),dt_meta_inicial:get_datepicker(main.edt_meta_inicial),dt_meta_final:get_datepicker(main.edt_meta_final)};WS.get({route:"oportunidade/get_dashboard_vendas/",data:a,func_response:function(a){if(a){main.div_oportunidades_totalizadas_status_situacao.removeClass("hidden"),main.div_historico_vendas.removeClass("hidden"),main.div_meta.removeClass("hidden");var t=a.geral;main.em_aberto_quantidade.text(0),main.em_aberto_valor.text("0,00"),main.remanescentes_quantidade.text(0),main.remanescentes_valor.text("0,00"),main.atrasadas_quantidade.text(0),main.atrasadas_valor.text("0,00"),main.estagnadas_quantidade.text(0),main.estagnadas_valor.text("0,00"),main.perdidas_quantidade.text(0),main.perdidas_valor.text("0,00"),main.ganhas_quantidade.text(0),main.ganhas_valor.text("0,00"),main.total_quantidade.text(0),main.total_valor.text("0,00"),$(t.situacao).each(function(a,t){t.oportunidade_quantidade,t.oportunidade_valor;"A"==t.situacao?(main.em_aberto_quantidade.text(t.oportunidade_quantidade),main.em_aberto_valor.text(t.oportunidade_valor.format_number(2,!0))):"R"==t.situacao?(main.remanescentes_quantidade.text(t.oportunidade_quantidade),main.remanescentes_valor.text(t.oportunidade_valor.format_number(2,!0))):"AT"==t.situacao?(main.atrasadas_quantidade.text(t.oportunidade_quantidade),main.atrasadas_valor.text(t.oportunidade_valor.format_number(2,!0))):"E"==t.situacao?(main.estagnadas_quantidade.text(t.oportunidade_quantidade),main.estagnadas_valor.text(t.oportunidade_valor.format_number(2,!0))):"P"==t.situacao?(main.perdidas_quantidade.text(t.oportunidade_quantidade),main.perdidas_valor.text(t.oportunidade_valor.format_number(2,!0))):"G"==t.situacao?(main.ganhas_quantidade.text(t.oportunidade_quantidade),main.ganhas_valor.text(t.oportunidade_valor.format_number(2,!0)),main.total_oportunidades_ganhas=t.oportunidade_valor):"T"==t.situacao&&(main.total_quantidade.text(t.oportunidade_quantidade),main.total_valor.text(t.oportunidade_valor.format_number(2,!0)))}),t.status.length>0?(main.oportunidade_status.find(".class-rows-status").remove(),main.listar_status(t.status)):main.oportunidade_status.find(".class-rows-status").remove(),main.grafico_barras_trimestral(a.tres_meses),main.velocimetro(a.meta),main.grafico_barras_anual(a.anual),main.grafico_pizza_regiao(a.vendas_por_regiao),main.grafico_pizza_segmento(a.vendas_por_segmento)}}})}),this.listar_status=function(a){var t=main.dialog.find("[template-status]");$.each(a,function(a,i){!function(a){var i=t.clone();i.removeAttr("template-status"),i.removeClass("hidden"),i.addClass("class-rows-status");var e=$(i.find(".nome_status")),n=$(i.find(".total_status"));e.text(a.nome).addClass("badge"),e.css("background-color",a.status_cor),n.text("  R$ "+a.soma.format_number(2,!0)),i.appendTo(main.oportunidade_status)}(i)})},this.grafico_barras_trimestral=function(a){var t=[],i=[],e=[];$(a).each(function(a,n){"G"==n.situacao_oportunidade?(i.push(parseFloat(n.valor_negocio)),t.push(n.mes+" - "+n.ano)):e.push(parseFloat(n.valor_negocio))}),Highcharts.setOptions({lang:{decimalPoint:",",thousandsSep:".",numericSymbols:null}}),main.div_grafico_trimestral.highcharts({chart:{type:"column"},exporting:{enabled:!1},title:{text:"Vendas Últimos 3 meses"},credits:{enabled:!1},subtitle:{text:""},xAxis:{categories:t,crosshair:!0},yAxis:{min:0,title:{text:"Valor de Vendas"},labels:{formatter:function(){return"R$"+this.axis.defaultLabelFormatter.call(this)+",00"}}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>R${point.y:,.2f}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!0,format:"R${point.y:,.2f}"}}},series:[{name:"Ganho",data:i},{name:"Perdido",data:e}]})},this.velocimetro=function(a){var t=0,i="",e=0;void 0!==a&&null!=a&&$.each(a,function(a,e){t=parseFloat(t)+parseFloat(e.valor),i=i+e.meta_descricao+": "+e.valor.format_number(2,!0)+" | "}),""!=i&&(i=i.substring(0,i.length-2)),e=parseFloat(main.total_oportunidades_ganhas)/parseFloat(t)*100,e=parseFloat(e.toFixed(2)),(void 0!==a&&!a[0]||void 0===a)&&(e=0);var n=[];n=e<=60?[60,"#DF5353"]:e<=80?[80,"#DDDF0D"]:e<=95?[95,"#55BF3B"]:[100,"#0000cc"];var o={chart:{backgroundColor:"#DDD",type:"solidgauge"},exporting:{enabled:!1},title:{text:"% Atingimento"},subtitle:{text:i},pane:{center:["50%","85%"],size:"150%",startAngle:-90,endAngle:90,background:{backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"#EEE",innerRadius:"60%",outerRadius:"100%",shape:"arc"}},tooltip:{enabled:!1},yAxis:{stops:[n],lineWidth:0,minorTickInterval:null,tickAmount:2,title:{y:-125},labels:{y:16}},plotOptions:{solidgauge:{dataLabels:{y:-70,borderWidth:0,useHTML:!0}}}};main.div_velocimetro.highcharts(Highcharts.merge(o,{yAxis:{min:0,max:100,title:{}},credits:{enabled:!1},series:[{name:"Speed",data:[e],dataLabels:{format:'<div style="text-align:center"><span style="font-size:25px;color:'+(Highcharts.theme&&Highcharts.theme.contrastTextColor||"black")+'">{y}%</span><br/>'},tooltip:{valueSuffix:""}}]}))},this.grafico_barras_anual=function(a){var t=[],i=[];$(a.dados_ano_atual).each(function(a,i){t.push(parseFloat(i.valor))}),$(a.dados_ano_anterior).each(function(a,t){i.push(parseFloat(t.valor))}),Highcharts.setOptions({lang:{decimalPoint:",",thousandsSep:".",numericSymbols:null}}),main.div_grafico_anual.highcharts({chart:{type:"column"},exporting:{enabled:!1},title:{text:"Vendas "+a.ano_anterior+" x "+a.ano_atual},subtitle:{text:"Oportunidades Ganhas"},credits:{enabled:!1},xAxis:{categories:a.meses,crosshair:!1},yAxis:{min:0,title:{text:"Valor de Vendas"},labels:{formatter:function(){return"R$"+this.axis.defaultLabelFormatter.call(this)+",00"}}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>R${point.y:,.2f}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!0,format:"R${point.y:,.2f}"}}},series:[{name:a.ano_anterior,data:i},{name:a.ano_atual,data:t}]})},this.grafico_pizza_regiao=function(arr_regiao_venda){var arr_pais=eval(arr_regiao_venda.pais),arr_filhos=eval(arr_regiao_venda.filhos);main.div_grafico_regiao.highcharts({chart:{backgroundColor:"#DDD",type:"pie"},exporting:{enabled:!1},title:{text:"Vendas por Região"},xAxis:{type:"category"},credits:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b> | <b>R${point.valor_oportunidade}</b>"},plotOptions:{series:{borderWidth:1,dataLabels:{enabled:!0}}},series:[{id:"0_0",name:"Região de Venda",borderColor:"#DDD",data:arr_pais}],drilldown:{series:arr_filhos}})},this.grafico_pizza_segmento=function(arr_segmento){arr_segmento=eval(arr_segmento),main.div_grafico_segmento.highcharts({chart:{backgroundColor:"#DDD",type:"pie"},title:{text:"Vendas por Segmento"},xAxis:{type:"category"},credits:{enabled:!1},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b> | <b>R${point.valor_negocio}</b>"},plotOptions:{series:{borderWidth:1,dataLabels:{enabled:!0}}},series:[{name:"Percentual de Venda",borderColor:"#DDD",data:arr_segmento}]})}};return Dashboard_Vendas});